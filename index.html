<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI å°æ‰‹æœº</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #000;
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        .phone {
            width: 100%;
            max-width: 360px;
            height: 90vh;
            max-height: 700px;
            background-color: #1a1a1a;
            border-radius: 36px;
            border: 12px solid #2c2c2c;
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }
        .status-bar {
            height: 44px;
            background-color: #111;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 16px;
            font-size: 12px;
        }
        .screen {
            flex: 1;
            background-color: #000;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 20px;
            font-size: 14px;
            line-height: 1.4;
        }
        .user-msg {
            background-color: #007aff;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        .ai-msg {
            background-color: #2c2c2c;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        .input-area {
            background-color: #111;
            padding: 12px;
            display: flex;
            gap: 8px;
        }
        #userInput {
            flex: 1;
            background-color: #2c2c2c;
            border: none;
            border-radius: 20px;
            padding: 12px 16px;
            color: #fff;
            font-size: 14px;
            outline: none;
        }
        #sendBtn {
            background-color: #007aff;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            color: #fff;
            font-size: 18px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #sendBtn:hover {
            background-color: #0056b3;
        }
        .config-panel {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 12px;
            padding: 24px;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }
        .config-panel.active {
            transform: translateY(0);
        }
        .config-item {
            width: 100%;
            max-width: 300px;
        }
        .config-item label {
            display: block;
            font-size: 12px;
            color: #888;
            margin-bottom: 4px;
        }
        .config-item select,
        .config-item input {
            width: 100%;
            background-color: #2c2c2c;
            border: none;
            border-radius: 8px;
            padding: 12px;
            color: #fff;
            font-size: 14px;
            outline: none;
        }
        .btn-group {
            display: flex;
            gap: 8px;
            width: 100%;
            max-width: 300px;
        }
        .btn {
            flex: 1;
            background-color: #007aff;
            border: none;
            border-radius: 20px;
            padding: 12px;
            color: #fff;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn:hover {
            background-color: #0056b3;
        }
        .btn-secondary {
            background-color: #2c2c2c;
        }
        .btn-secondary:hover {
            background-color: #3a3a3a;
        }
        .config-toggle {
            position: absolute;
            top: 60px;
            right: 16px;
            background-color: #2c2c2c;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            color: #fff;
            font-size: 16px;
            cursor: pointer;
            z-index: 10;
        }
    </style>
</head>
<body>
    <div class="phone">
        <div class="status-bar">
            <span>9:41</span>
            <span>ğŸ“¶ ğŸ”‹</span>
        </div>
        <div class="screen" id="screen"></div>
        <div class="input-area">
            <input type="text" id="userInput" placeholder="è¾“å…¥æ¶ˆæ¯..." autocomplete="off">
            <button id="sendBtn">â¤</button>
        </div>
        <button class="config-toggle" id="configToggle">âš™ï¸</button>
        <div class="config-panel" id="configPanel">
            <div class="config-item">
                <label>åç§°</label>
                <input type="text" id="configName" value="APIè¿æ¥ 18">
            </div>
            <div class="config-item">
                <label>æ¨¡å‹å¹³å°</label>
                <select id="platformSelect">
                    <option value="openai">OpenAI</option>
                    <option value="doubao">Doubao (è±†åŒ…/ç«å±±äº‘/å­—èŠ‚è·³åŠ¨)</option>
                    <option value="deepseek">DeepSeek (æ·±åº¦æ±‚ç´¢)</option>
                    <option value="openrouter">OpenRouter</option>
                    <option value="custom-openai">è‡ªå®šä¹‰ (OpenAI åè®®)</option>
                </select>
            </div>
            <div class="config-item" id="apiUrlItem" style="display: none;">
                <label>API æ¥å£åœ°å€</label>
                <input type="text" id="apiUrlInput" placeholder="https://api.example.com/v1">
            </div>
            <div class="config-item">
                <label>API å¯†é’¥</label>
                <input type="password" id="apiKeyInput" placeholder="è¾“å…¥ä½ çš„ API Key">
            </div>
            <div class="config-item">
                <label>æ¨¡å‹</label>
                <select id="modelSelect">
                    <option value="gpt-3.5-turbo">GPT-3.5-turbo</option>
                </select>
            </div>
            <div class="btn-group">
                <button id="fetchModelsBtn" class="btn btn-secondary" style="display: none;">æ‹‰å–æ¨¡å‹</button>
                <button id="testConnectionBtn" class="btn btn-secondary" style="display: none;">æµ‹è¯•é“¾æ¥</button>
            </div>
            <div class="btn-group">
                <button id="saveConfig" class="btn">ä¿å­˜</button>
            </div>
        </div>
    </div>
    <script>
        const screen = document.getElementById('screen');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const configToggle = document.getElementById('configToggle');
        const configPanel = document.getElementById('configPanel');
        const saveConfig = document.getElementById('saveConfig');
        const platformSelect = document.getElementById('platformSelect');
        const apiUrlItem = document.getElementById('apiUrlItem');
        const apiUrlInput = document.getElementById('apiUrlInput');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const modelSelect = document.getElementById('modelSelect');
        const configName = document.getElementById('configName');
        const fetchModelsBtn = document.getElementById('fetchModelsBtn');
        const testConnectionBtn = document.getElementById('testConnectionBtn');
        // å¹³å°ä¸æ¨¡å‹çš„æ˜ å°„å…³ç³»
        const platformModels = {
            'openai': ['gpt-3.5-turbo', 'gpt-4', 'gpt-4-turbo'],
            'doubao': ['doubao-pro', 'doubao-4k', 'doubao-32k'],
            'deepseek': ['deepseek-chat', 'deepseek-coder'],
            'openrouter': ['openrouter/auto', 'anthropic/claude-3-sonnet'],
            'custom-openai': [] // è‡ªå®šä¹‰å¹³å°çš„æ¨¡å‹å°†é€šè¿‡æ‹‰å–è·å–
        };
        let currentConfig = {
            name: 'APIè¿æ¥ 18',
            platform: 'openai',
            apiUrl: '',
            apiKey: '',
            model: 'gpt-3.5-turbo'
        };
        // åŠ è½½ä¿å­˜çš„é…ç½®
        if (localStorage.getItem('aiPhoneConfig')) {
            currentConfig = JSON.parse(localStorage.getItem('aiPhoneConfig'));
            configName.value = currentConfig.name;
            platformSelect.value = currentConfig.platform;
            apiUrlInput.value = currentConfig.apiUrl;
            apiKeyInput.value = currentConfig.apiKey;
            updateModelList();
            modelSelect.value = currentConfig.model;
            toggleApiUrlVisibility();
        }
        // åˆ‡æ¢é…ç½®é¢æ¿
        configToggle.addEventListener('click', () => {
            configPanel.classList.toggle('active');
        });
        // åˆ‡æ¢å¹³å°æ—¶æ›´æ–°æ¨¡å‹åˆ—è¡¨å’ŒAPIåœ°å€è¾“å…¥æ¡†
        platformSelect.addEventListener('change', () => {
            updateModelList();
            toggleApiUrlVisibility();
        });
        // æ‹‰å–æ¨¡å‹æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        fetchModelsBtn.addEventListener('click', fetchModels);
        // æµ‹è¯•é“¾æ¥æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        testConnectionBtn.addEventListener('click', testConnection);
        // ä¿å­˜é…ç½®
        saveConfig.addEventListener('click', () => {
            currentConfig = {
                name: configName.value,
                platform: platformSelect.value,
                apiUrl: apiUrlInput.value,
                apiKey: apiKeyInput.value,
                model: modelSelect.value
            };
            localStorage.setItem('aiPhoneConfig', JSON.stringify(currentConfig));
            configPanel.classList.remove('active');
            addMessage('é…ç½®å·²ä¿å­˜', 'ai-msg');
        });
        // å‘é€æ¶ˆæ¯
        sendBtn.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // 1. å‘é€æ¶ˆæ¯ï¼šè‡ªå®šä¹‰å¹³å°ç›´è¿ä¼˜å…ˆï¼Œè·¨åŸŸå¤±è´¥èµ°åç«¯è½¬å‘ï¼›å…¶ä»–å¹³å°é»˜è®¤èµ°åç«¯
        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text || !currentConfig.model) return;
            addMessage(text, 'user-msg');
            userInput.value = '';
            try {
                let fetchUrl;
                let requestBody;
                // è‡ªå®šä¹‰OpenAIå¹³å°ï¼šç›´è¿ä¼˜å…ˆ
                if (currentConfig.platform === 'custom-openai') {
                    fetchUrl = `${currentConfig.apiUrl}/chat/completions`;
                    requestBody = {
                        model: currentConfig.model,
                        messages: [{ role: 'user', content: text }]
                    };
                    // ç¬¬ä¸€æ­¥ï¼šå°è¯•ç›´è¿å‘é€
                    const directResponse = await fetch(fetchUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${currentConfig.apiKey}`
                        },
                        body: JSON.stringify(requestBody)
                    });
                    if (!directResponse.ok) {
                        throw new Error(`ç›´è¿å¤±è´¥: HTTP ${directResponse.status}`);
                    }
                    const data = await directResponse.json();
                    const reply = data.choices?.[0]?.message?.content || 'å›å¤å¤±è´¥';
                    addMessage(reply, 'ai-msg');
                } else {
                    // å…¶ä»–å¹³å°ï¼šé»˜è®¤èµ°åç«¯è½¬å‘ï¼ˆåŸæœ‰é€»è¾‘ï¼Œä¸å˜ï¼‰
                    fetchUrl = 'https://ai-phone-3jj5kynr2.vercel.app/api/chat';
                    requestBody = {
                        platform: currentConfig.platform,
                        apiKey: currentConfig.apiKey,
                        model: currentConfig.model,
                        messages: [{ role: 'user', content: text }]
                    };
                    const response = await fetch(fetchUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${currentConfig.apiKey}`
                        },
                        body: JSON.stringify(requestBody)
                    });
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    const reply = data.choices?.[0]?.message?.content || 'å›å¤å¤±è´¥';
                    addMessage(reply, 'ai-msg');
                }
            } catch (error) {
                // è‡ªå®šä¹‰å¹³å°ç›´è¿å¤±è´¥ï¼Œè‡ªåŠ¨èµ°åç«¯è½¬å‘å…œåº•
                if (currentConfig.platform === 'custom-openai') {
                    addMessage(`âš ï¸ ç›´è¿å‘é€å¤±è´¥(${error.message})ï¼Œå°è¯•åç«¯è½¬å‘...`, 'ai-msg');
                    try {
                        const fetchUrl = 'https://ai-phone-3jj5kynr2.vercel.app/api/chat';
                        const requestBody = {
                            platform: 'custom-openai',
                            apiUrl: currentConfig.apiUrl,
                            apiKey: currentConfig.apiKey,
                            model: currentConfig.model,
                            messages: [{ role: 'user', content: text }]
                        };
                        const forwardResponse = await fetch(fetchUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${currentConfig.apiKey}`
                            },
                            body: JSON.stringify(requestBody)
                        });
                        if (!forwardResponse.ok) {
                            throw new Error(`è½¬å‘å¤±è´¥: HTTP ${forwardResponse.status}`);
                        }
                        const data = await forwardResponse.json();
                        const reply = data.choices?.[0]?.message?.content || 'å›å¤å¤±è´¥';
                        addMessage(reply, 'ai-msg');
                    } catch (forwardError) {
                        addMessage(`âŒ å‘é€å¤±è´¥ï¼š${forwardError.message}`, 'ai-msg');
                    }
                } else {
                    // å…¶ä»–å¹³å°å¤±è´¥ï¼Œç›´æ¥æç¤º
                    addMessage(`âŒ å‘é€å¤±è´¥: ${error.message}`, 'ai-msg');
                }
            }
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°å±å¹•
        function addMessage(text, className) {
            const message = document.createElement('div');
            message.className = `message ${className}`;
            message.textContent = text;
            screen.appendChild(message);
            screen.scrollTop = screen.scrollHeight;
        }

        // æ›´æ–°æ¨¡å‹åˆ—è¡¨
        function updateModelList() {
            const selectedPlatform = platformSelect.value;
            const models = platformModels[selectedPlatform] || [];
            modelSelect.innerHTML = '';
            if (models.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'è¯·å…ˆæ‹‰å–æ¨¡å‹';
                modelSelect.appendChild(option);
            } else {
                models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model;
                    option.textContent = model;
                    modelSelect.appendChild(option);
                });
            }
        }

        // åˆ‡æ¢APIåœ°å€è¾“å…¥æ¡†å’ŒæŒ‰é’®çš„å¯è§æ€§
        function toggleApiUrlVisibility() {
            if (platformSelect.value === 'custom-openai') {
                apiUrlItem.style.display = 'block';
                fetchModelsBtn.style.display = 'block';
                testConnectionBtn.style.display = 'block';
            } else {
                apiUrlItem.style.display = 'none';
                fetchModelsBtn.style.display = 'none';
                testConnectionBtn.style.display = 'none';
            }
        }

        // 2. æ‹‰å–æ¨¡å‹ï¼šç›´è¿ä¼˜å…ˆï¼Œè·¨åŸŸå¤±è´¥åˆ™èµ°åç«¯è½¬å‘
        async function fetchModels() {
            const apiUrl = apiUrlInput.value.trim();
            const apiKey = apiKeyInput.value.trim();
            if (!apiUrl || !apiKey) {
                addMessage('âŒ è¯·å…ˆå¡«å†™APIæ¥å£åœ°å€å’Œå¯†é’¥', 'ai-msg');
                return;
            }
            try {
                addMessage('ğŸ”„ æ­£åœ¨æ‹‰å–æ¨¡å‹åˆ—è¡¨(ç›´è¿)...', 'ai-msg');
                // ç¬¬ä¸€æ­¥ï¼šå°è¯•ç›´è¿ç¬¬ä¸‰æ–¹APIï¼ˆé€Ÿåº¦å¿«ï¼‰
                const directResponse = await fetch(`${apiUrl}/models`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    }
                });
                if (!directResponse.ok) {
                    throw new Error(`ç›´è¿å¤±è´¥: HTTP ${directResponse.status}`);
                }
                const data = await directResponse.json();
                const models = data.data || [];
                if (models.length === 0) {
                    addMessage('âŒ æœªè·å–åˆ°ä»»ä½•æ¨¡å‹', 'ai-msg');
                    return;
                }
                platformModels['custom-openai'] = models.map(m => m.id);
                updateModelList();
                modelSelect.value = models[0].id;
                addMessage(`âœ… ç›´è¿æˆåŠŸï¼æ‹‰å–åˆ° ${models.length} ä¸ªæ¨¡å‹`, 'ai-msg');
            } catch (error) {
                // ç¬¬äºŒæ­¥ï¼šç›´è¿å¤±è´¥ï¼ˆå¤§æ¦‚ç‡CORSï¼‰ï¼Œè‡ªåŠ¨èµ°åç«¯è½¬å‘å…œåº•
                addMessage(`âš ï¸ ç›´è¿å¤±è´¥(${error.message})ï¼Œå°è¯•åç«¯è½¬å‘...`, 'ai-msg');
                try {
                    const forwardResponse = await fetch('https://ai-phone-3jj5kynr2.vercel.app/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            platform: 'custom-openai',
                            apiUrl: apiUrl,
                            action: 'fetchModels'
                        })
                    });
                    if (!forwardResponse.ok) {
                        throw new Error(`è½¬å‘å¤±è´¥: HTTP ${forwardResponse.status}`);
                    }
                    const data = await forwardResponse.json();
                    const models = data.data || [];
                    if (models.length === 0) {
                        addMessage('âŒ è½¬å‘æ‹‰å–ï¼šæœªè·å–åˆ°ä»»ä½•æ¨¡å‹', 'ai-msg');
                        return;
                    }
                    platformModels['custom-openai'] = models.map(m => m.id);
                    updateModelList();
                    modelSelect.value = models[0].id;
                    addMessage(`âœ… è½¬å‘æˆåŠŸï¼æ‹‰å–åˆ° ${models.length} ä¸ªæ¨¡å‹`, 'ai-msg');
                } catch (forwardError) {
                    addMessage(`âŒ æ‹‰å–å¤±è´¥ï¼š${forwardError.message}`, 'ai-msg');
                }
            }
        }

        // 3. æµ‹è¯•é“¾æ¥ï¼šç›´è¿ä¼˜å…ˆï¼Œè·¨åŸŸå¤±è´¥åˆ™èµ°åç«¯è½¬å‘
        async function testConnection() {
            const apiUrl = apiUrlInput.value.trim();
            const apiKey = apiKeyInput.value.trim();
            if (!apiUrl || !apiKey) {
                addMessage('âŒ è¯·å…ˆå¡«å†™APIæ¥å£åœ°å€å’Œå¯†é’¥', 'ai-msg');
                return;
            }
            try {
                addMessage('ğŸ”„ æ­£åœ¨æµ‹è¯•é“¾æ¥(ç›´è¿)...', 'ai-msg');
                // ç¬¬ä¸€æ­¥ï¼šå°è¯•ç›´è¿ç¬¬ä¸‰æ–¹APIï¼ˆé€Ÿåº¦å¿«ï¼‰
                const directResponse = await fetch(`${apiUrl}/models`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    }
                });
                if (directResponse.ok) {
                    addMessage('âœ… ç›´è¿æˆåŠŸï¼é“¾æ¥æœ‰æ•ˆ', 'ai-msg');
                } else {
                    throw new Error(`ç›´è¿å¤±è´¥: HTTP ${directResponse.status}`);
                }
            } catch (error) {
                // ç¬¬äºŒæ­¥ï¼šç›´è¿å¤±è´¥ï¼Œè‡ªåŠ¨èµ°åç«¯è½¬å‘å…œåº•
                addMessage(`âš ï¸ ç›´è¿å¤±è´¥(${error.message})ï¼Œå°è¯•åç«¯è½¬å‘...`, 'ai-msg');
                try {
                    const forwardResponse = await fetch('https://ai-phone-3jj5kynr2.vercel.app/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            platform: 'custom-openai',
                            apiUrl: apiUrl,
                            action: 'testConnection'
                        })
                    });
                    if (forwardResponse.ok) {
                        addMessage('âœ… è½¬å‘æˆåŠŸï¼é“¾æ¥æœ‰æ•ˆ', 'ai-msg');
                    } else {
                        throw new Error(`è½¬å‘å¤±è´¥: HTTP ${forwardResponse.status}`);
                    }
                } catch (forwardError) {
                    addMessage(`âŒ è¿æ¥å¤±è´¥ï¼š${forwardError.message}`, 'ai-msg');
                }
            }
        }
    </script>
</body>
</html>
