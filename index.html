<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>SillyAI Â· å®Œæ•´ç‰ˆ</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:system-ui,-apple-system,Roboto,Segoe UI}
html,body{height:100%;background:#0f0f0f;color:#e5e5e5}
.app{max-width:440px;height:100vh;margin:0 auto;background:#0f0f0f;position:relative;border-radius:20px;overflow:hidden}
.page{position:absolute;top:0;left:0;width:100%;height:100%;display:none;padding:16px;padding-bottom:70px}
.page.active{display:block}
.top-bar{display:flex;justify-content:space-between;align-items:center;padding:10px 0;margin-bottom:12px}
.back-btn{background:#1a1a1a;padding:6px 10px;border-radius:8px;cursor:pointer}
.chat-area{height:calc(100% - 170px);overflow-y:auto;padding:8px 0}
.msg{display:flex;margin-bottom:14px;max-width:80%}
.msg.ai{align-items:flex-start}
.msg.user{margin-left:auto;flex-direction:row-reverse}
.avatar{width:38px;height:38px;border-radius:50%;background:#2563eb;margin:0 6px;
background-size:cover;background-position:center}
.bubble{padding:10px 14px;border-radius:16px;line-height:1.45;white-space:pre-wrap}
.msg.ai .bubble{background:#1a1a1a}
.msg.user .bubble{background:#2563eb;color:#fff}
.input-bar{position:absolute;bottom:60px;left:0;width:100%;display:flex;padding:10px;background:#0f0f0f;border-top:1px solid #222}
.input-bar input{flex:1;background:#1a1a1a;border:none;border-radius:22px;padding:0 14px;color:#fff;height:42px}
.input-bar button{width:64px;height:42px;background:#2563eb;color:#fff;border:none;border-radius:22px;margin-left:8px}
.bottom-bar{position:absolute;bottom:0;left:0;width:100%;height:60px;background:#0f0f0f;display:flex;justify-content:space-around;align-items:center;border-top:1px solid #222}
.bar-item{text-align:center;font-size:12px;cursor:pointer}
.bar-item.active{color:#2563eb}
.card{background:#1a1a1a;border-radius:14px;padding:14px;margin-bottom:12px}
.card h4{margin-bottom:6px}
input,textarea,select{width:100%;background:#1a1a1a;border:none;border-radius:10px;padding:12px;color:#fff;margin-top:6px}
.btn{width:100%;background:#2563eb;color:#fff;border:none;border-radius:12px;padding:12px;margin-top:8px}
.btn.gray{background:#333}
.btn.red{background:#b72424}
.modal{position:absolute;bottom:0;left:0;width:100%;background:#1a1a1a;border-radius:20px 20px 0 0;padding:20px;display:none}
.modal.active{display:block}
.world-item{display:flex;justify-content:space-between;align-items:center;background:#222;border-radius:10px;padding:10px;margin-top:8px}
.tag{display:inline-block;background:#222;padding:4px 8px;border-radius:8px;font-size:12px;margin-right:4px}
.avatar-up{width:80px;height:80px;border-radius:50%;background:#2563eb;margin:10px auto;cursor:pointer;
background-size:cover;background-position:center}
</style>
</head>
<body>

<div class="app">

<!-- èŠå¤©é¡µé¢ -->
<div class="page active" id="page_chat">
  <div class="top-bar">
    <div>SillyAI èŠå¤©</div>
    <div style="cursor:pointer" onclick="openModal('modal_settings')">âš™ï¸</div>
  </div>
  <div style="display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap">
    <div class="tag" onclick="goto('char')">è§’è‰²</div>
    <div class="tag" onclick="goto('world')">ä¸–ç•Œä¹¦</div>
    <div class="tag" onclick="goto('memory')">è®°å¿†</div>
    <div class="tag" onclick="goto('prompt')">æç¤ºè¯</div>
    <div class="tag" onclick="goto('api')">API</div>
    <div class="tag" onclick="exportChat()">å¯¼å‡ºèŠå¤©</div>
  </div>
  <div class="chat-area" id="chat_box"></div>
  <div class="input-bar">
    <input id="msg_input" placeholder="è¾“å…¥æ¶ˆæ¯â€¦" autocomplete="off">
    <button onclick="sendMsg()">å‘é€</button>
  </div>
</div>

<!-- è§’è‰²å¡ -->
<div class="page" id="page_char">
  <div class="top-bar"><div class="back-btn" onclick="goto('chat')">â†</div><div>è§’è‰²å¡</div></div>
  <div class="avatar-up" id="char_avatar" onclick="pickAvatar()"></div>
  <div class="card"><h4>è§’è‰²åç§°</h4><input id="char_name"></div>
  <div class="card"><h4>äººæ ¼è®¾å®š</h4><textarea id="char_persona" rows="3"></textarea></div>
  <div class="card"><h4>è¯´è¯é£æ ¼</h4><textarea id="char_style" rows="3"></textarea></div>
  <div class="card"><h4>èƒŒæ™¯æ•…äº‹</h4><textarea id="char_story" rows="4"></textarea></div>
  <button class="btn" onclick="saveChar()">ä¿å­˜è§’è‰²</button>
  <button class="btn gray" onclick="exportChar()">å¯¼å‡ºè§’è‰²</button>
  <button class="btn gray" onclick="importChar()">å¯¼å…¥è§’è‰²</button>
</div>

<!-- ä¸–ç•Œä¹¦ï¼ˆæƒé‡+æ·±åº¦+å¼€å…³ï¼‰ -->
<div class="page" id="page_world">
  <div class="top-bar"><div class="back-btn" onclick="goto('chat')">â†</div><div>ä¸–ç•Œä¹¦</div></div>
  <div class="card"><h4>å…³é”®è¯</h4><input id="w_key" placeholder="ç”¨é€—å·åˆ†éš”"></div>
  <div class="card"><h4>è§¦å‘å†…å®¹</h4><textarea id="w_value" rows="2"></textarea></div>
  <div class="card"><h4>æƒé‡</h4><select id="w_weight">
    <option value="1">ä½</option><option value="2" selected>ä¸­</option><option value="3">é«˜</option>
  </select></div>
  <div class="card"><h4>æ·±åº¦</h4><select id="w_depth">
    <option value="0">æµ…</option><option value="1" selected>ä¸­</option><option value="2">æ·±</option>
  </select></div>
  <div class="card"><h4>å¯ç”¨</h4><select id="w_enabled">
    <option value="1">æ˜¯</option><option value="0">å¦</option>
  </select></div>
  <button class="btn" onclick="addWorld()">æ·»åŠ è§„åˆ™</button>
  <div id="world_list"></div>
</div>

<!-- é•¿æœŸè®°å¿† -->
<div class="page" id="page_memory">
  <div class="top-bar"><div class="back-btn" onclick="goto('chat')">â†</div><div>é•¿æœŸè®°å¿†</div></div>
  <div class="card"><h4>ç”¨æˆ·ä¿¡æ¯</h4><textarea id="mem_user" rows="3"></textarea></div>
  <div class="card"><h4>å¯¹è¯æ€»ç»“</h4><textarea id="mem_sum" rows="4"></textarea></div>
  <button class="btn" onclick="saveMemory()">ä¿å­˜è®°å¿†</button>
</div>

<!-- ç³»ç»Ÿæç¤ºè¯ -->
<div class="page" id="page_prompt">
  <div class="top-bar"><div class="back-btn" onclick="goto('chat')">â†</div><div>ç³»ç»Ÿæç¤ºè¯</div></div>
  <div class="card"><textarea id="sys_prompt" rows="9"></textarea></div>
  <button class="btn" onclick="savePrompt()">ä¿å­˜</button>
</div>

<!-- API è®¾ç½® -->
<div class="page" id="page_api">
  <div class="top-bar"><div class="back-btn" onclick="goto('chat')">â†</div><div>API è®¾ç½®</div></div>
  <div class="card"><h4>API åœ°å€</h4><input id="api_url" placeholder="https://api.openai.com/v1/chat/completions"></div>
  <div class="card"><h4>API Key</h4><input id="api_key" type="password"></div>
  <div class="card"><h4>æ¨¡å‹</h4><input id="api_model" value="gpt-3.5-turbo"></div>
  <button class="btn" onclick="saveApi()">ä¿å­˜ API è®¾ç½®</button>
</div>

<!-- è®¾ç½®å¼¹çª— -->
<div class="modal" id="modal_settings">
  <h4>è®¾ç½®</h4>
  <div class="card" onclick="clearChat()">æ¸…ç©ºå¯¹è¯</div>
  <div class="card" onclick="exportAll()">å¤‡ä»½å…¨éƒ¨æ•°æ®</div>
  <button class="btn" onclick="closeModal()">å…³é—­</button>
</div>

<!-- åº•éƒ¨å¯¼èˆª -->
<div class="bottom-bar">
  <div class="bar-item active" onclick="goto('chat')">ğŸ’¬å¯¹è¯</div>
  <div class="bar-item" onclick="goto('char')">ğŸ‘¤è§’è‰²</div>
  <div class="bar-item" onclick="goto('world')">ğŸŒä¸–ç•Œä¹¦</div>
  <div class="bar-item" onclick="goto('memory')">ğŸ§ è®°å¿†</div>
</div>

</div>

<script>
const chat_box = document.getElementById('chat_box')
let config = JSON.parse(localStorage.getItem('SILLY_FULL')) || {
  char: {
    name:"å°ä¸ƒæœˆ",
    avatar:"https://picsum.photos/200/200?random=1",
    persona:"æ¸©æŸ”ã€å¯çˆ±ã€ç²˜äººã€æœ‰ç‚¹å°å‚²å¨‡",
    style:"ç®€çŸ­ã€å£è¯­ã€å¸¦è¡¨æƒ…ã€ä¸é«˜å†·",
    story:"å–œæ¬¢å’Œä½ èŠå¤©ï¼Œä¸€ç›´é™ªç€ä½ ã€‚"
  },
  world: [],
  memory: { user:"", sum:"" },
  prompt: `ä½ è¦å®Œå…¨æ²‰æµ¸æ‰®æ¼”è§’è‰²ï¼Œè‡ªç„¶ã€æœ‰æ„Ÿæƒ…ã€ä¸é‡å¤ã€ä¸å‘†æ¿ã€‚
ä¸¥æ ¼éµå®ˆäººæ ¼ã€è¯´è¯é£æ ¼ã€èƒŒæ™¯æ•…äº‹ã€‚
ä¸–ç•Œä¹¦å†…å®¹ä¼šè‡ªåŠ¨æ³¨å…¥ã€‚`,
  api: { url:"", key:"", model:"gpt-3.5-turbo" },
  chars: [] // å¤šè§’è‰²
}

// é¡µé¢åˆ‡æ¢
function goto(page){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'))
  document.getElementById('page_'+page).classList.add('active')
  document.querySelectorAll('.bar-item').forEach((item,i)=>{
    item.classList.toggle('active', ['chat','char','world','memory'].indexOf(page)===i)
  })
}

// å‘é€ + æµå¼å›å¤
async function sendMsg(){
  const txt = document.getElementById('msg_input').value.trim()
  if(!txt) return
  addMsg('user', txt)
  document.getElementById('msg_input').value = ''

  // ä¸–ç•Œä¹¦åŒ¹é…ï¼ˆæƒé‡+æ·±åº¦+å¯ç”¨ï¼‰
  const worldInject = config.world
    .filter(w=>w.enabled==1 && w.key.split(',').some(k=>txt.includes(k.trim())))
    .sort((a,b)=>b.weight - a.weight)
    .map(w=>w.value)
    .join('\n')

  const system = `${config.prompt}
è§’è‰²ï¼š${config.char.name}
äººæ ¼ï¼š${config.char.persona}
é£æ ¼ï¼š${config.char.style}
èƒŒæ™¯ï¼š${config.char.story}
ç”¨æˆ·ï¼š${config.memory.user}
æ€»ç»“ï¼š${config.memory.sum}
ä¸–ç•Œä¹¦ï¼š${worldInject}
è‡ªç„¶å¯¹è¯ï¼Œä¸è¦è§£é‡Šè‡ªå·±ã€‚`

  if(!config.api.url){
    addMsg('ai','è¯·å…ˆå¡«å†™ API åœ°å€')
    return
  }

  // å ä½æ°”æ³¡
  const bubble = document.createElement('div')
  bubble.className = 'msg ai'
  bubble.innerHTML = `<div class="avatar" style="background-image:url('${config.char.avatar}')"></div>
  <div class="bubble" id="stream"></div>`
  chat_box.appendChild(bubble)
  const stream = document.getElementById('stream')
  let full = ''

  try {
    const res = await fetch(config.api.url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${config.api.key}`
      },
      body: JSON.stringify({
        model: config.api.model,
        messages: [
          { role: 'system', content: system },
          { role: 'user', content: txt }
        ],
        stream: true
      })
    })

    const reader = res.body.getReader()
    const decoder = new TextDecoder()
    while(true){
      const {done,value} = await reader.read()
      if(done) break
      const chunk = decoder.decode(value)
      chunk.split('\n').forEach(line=>{
        if(!line.startsWith('data: ')) return
        const data = line.replace('data: ','').trim()
        if(data=='[DONE]') return
        try {
          const j = JSON.parse(data)
          const c = j.choices?.[0]?.delta?.content || ''
          full += c
          stream.textContent = full
          chat_box.scrollTop = chat_box.scrollHeight
        }catch(e){}
      })
    }
    saveChat()
  } catch(e){
    stream.textContent = 'API é”™è¯¯ï¼š'+e.message
  }
}

// æ·»åŠ æ¶ˆæ¯
function addMsg(who,text){
  const div = document.createElement('div')
  div.className = 'msg '+who
  const ava = who === 'ai' ? config.char.avatar : 'https://picsum.photos/200/200?random=10'
  div.innerHTML = `<div class="avatar" style="background-image:url('${ava}')"></div>
  <div class="bubble">${text}</div>`
  chat_box.appendChild(div)
  chat_box.scrollTop = chat_box.scrollHeight
}

// ä¸–ç•Œä¹¦
function addWorld(){
  const key = document.getElementById('w_key').value.trim()
  const value = document.getElementById('w_value').value.trim()
  const weight = parseInt(document.getElementById('w_weight').value)
  const depth = parseInt(document.getElementById('w_depth').value)
  const enabled = parseInt(document.getElementById('w_enabled').value)
  if(!key||!value) return
  config.world.push({key,value,weight,depth,enabled})
  saveAll()
  renderWorld()
  document.getElementById('w_key').value=''
  document.getElementById('w_value').value=''
}
function renderWorld(){
  const list = document.getElementById('world_list')
  list.innerHTML = config.world.map((w,i)=>`
    <div class="world-item">
      <div>${w.key}</div>
      <div style="font-size:12px;color:#999">æƒ${w.weight} æ·±${w.depth} ${w.enabled?'å¼€':'å…³'}</div>
    </div>
  `).join('')
}

// è§’è‰²å¤´åƒ
function pickAvatar(){
  const i = document.createElement('input')
  i.type='file'
  i.accept='image/*'
  i.onchange=e=>{
    const f = e.target.files[0]
    if(!f) return
    const url = URL.createObjectURL(f)
    config.char.avatar = url
    document.getElementById('char_avatar').style.backgroundImage = `url(${url})`
    saveAll()
  }
  i.click()
}

// è§’è‰²
function saveChar(){
  config.char.name = document.getElementById('char_name').value
  config.char.persona = document.getElementById('char_persona').value
  config.char.style = document.getElementById('char_style').value
  config.char.story = document.getElementById('char_story').value
  saveAll()
  alert('å·²ä¿å­˜')
}
function exportChar(){
  const blob = new Blob([JSON.stringify(config.char)],{type:'application/json'})
  const a = document.createElement('a')
  a.href=URL.createObjectURL(blob)
  a.download=`${config.char.name}.json`
  a.click()
}
function importChar(){
  const i=document.createElement('input')
  i.type='file'
  i.accept='.json'
  i.onchange=e=>{
    const r=new FileReader()
    r.onload=e=>{
      config.char = JSON.parse(e.target.result)
      saveAll()
      loadChar()
      alert('å¯¼å…¥æˆåŠŸ')
    }
    r.readAsText(e.target.files[0])
  }
  i.click()
}

// è®°å¿† / æç¤ºè¯ / API
function saveMemory(){
  config.memory.user = document.getElementById('mem_user').value
  config.memory.sum = document.getElementById('mem_sum').value
  saveAll()
  alert('å·²ä¿å­˜')
}
function savePrompt(){
  config.prompt = document.getElementById('sys_prompt').value
  saveAll()
  alert('å·²ä¿å­˜')
}
function saveApi(){
  config.api.url = document.getElementById('api_url').value
  config.api.key = document.getElementById('api_key').value
  config.api.model = document.getElementById('api_model').value
  saveAll()
  alert('API å·²ä¿å­˜')
}

// å­˜å‚¨
function saveAll(){
  localStorage.setItem('SILLY_FULL', JSON.stringify(config))
}
function saveChat(){
  localStorage.setItem('SILLY_CHAT_FULL', chat_box.innerHTML)
}
function clearChat(){
  chat_box.innerHTML=''
  localStorage.removeItem('SILLY_CHAT_FULL')
  closeModal()
}
function exportAll(){
  const blob=new Blob([JSON.stringify(config)],{type:'application/json'})
  const a=document.createElement('a')
  a.href=URL.createObjectURL(blob)
  a.download='SillyAI_full.json'
  a.click()
}
function exportChat(){
  const text = chat_box.innerText
  const blob = new Blob([text],{type:'text/plain'})
  const a = document.createElement('a')
  a.href=URL.createObjectURL(blob)
  a.download='èŠå¤©è®°å½•.txt'
  a.click()
}

// å¼¹çª—
function openModal(id){document.getElementById(id).classList.add('active')}
function closeModal(){document.querySelectorAll('.modal').forEach(m=>m.classList.remove('active'))}

// åŠ è½½
function loadAll(){
  loadChar()
  renderWorld()
  document.getElementById('mem_user').value = config.memory.user
  document.getElementById('mem_sum').value = config.memory.sum
  document.getElementById('sys_prompt').value = config.prompt
  document.getElementById('api_url').value = config.api.url
  document.getElementById('api_key').value = config.api.key
  document.getElementById('api_model').value = config.api.model
  chat_box.innerHTML = localStorage.getItem('SILLY_CHAT_FULL') || ''
}
function loadChar(){
  document.getElementById('char_name').value = config.char.name
  document.getElementById('char_persona').value = config.char.persona
  document.getElementById('char_style').value = config.char.style
  document.getElementById('char_story').value = config.char.story
  document.getElementById('char_avatar').style.backgroundImage = `url(${config.char.avatar})`
}

window.onload = loadAll
</script>
</body>
</html>
