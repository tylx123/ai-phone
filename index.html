<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>é…’é¦† Â· å®Œå…¨ä½“ Â· æè‡´å®Œå–„ç‰ˆ</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,Roboto,system-ui}
html,body{max-width:420px;margin:0 auto;height:100vh;overflow:hidden;background:#121212;color:#e0e0e0}
.screen{display:none;height:100%;overflow-y:auto;background:#121212}
.active{display:block}

.head{padding:16px;background:#1e1e1e;border-bottom:1px solid #333;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:10}
.head button{border:none;background:transparent;color:#e0e0e0;font-size:20px;cursor:pointer}
.head h3{font-size:18px}
.action-btn{background:linear-gradient(90deg,#ff69b4,#ff8c69);color:#fff;border:none;padding:8px 16px;border-radius:20px;font-size:14px;cursor:pointer}

.tavern-grid{padding:16px;display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
.tavern-card{background:#1e1e1e;border-radius:16px;padding:18px;display:flex;flex-direction:column;align-items:center;gap:8px;cursor:pointer;border:1px solid #2d2d2d;transition:0.2s}
.tavern-card:active{transform:scale(.96)}
.tavern-icon{width:44px;height:44px;border-radius:14px;background:#2d2d2d;display:flex;align-items:center;justify-content:center;color:#ff69b4;font-size:22px}
.tavern-title{font-size:15px;font-weight:600;color:#e0e0e0}
.tavern-desc{font-size:12px;color:#999}

.form-item{margin:16px}
.form-label{font-size:15px;margin-bottom:8px;display:block}
.form-input{width:100%;padding:12px;border:1px solid #333;border-radius:8px;background:#2d2d2d;color:#e0e0e0}
.form-select{width:100%;padding:12px;border:1px solid #333;border-radius:8px;background:#2d2d2d;color:#e0e0e0}
.btn-group{display:flex;gap:12px;margin:20px 16px}
.btn{flex:1;padding:12px;border:none;border-radius:12px;font-size:15px;cursor:pointer}
.btn-primary{background:#ff69b4;color:#fff}
.btn-secondary{background:#2d2d2d;color:#e0e0e0}
.status-tip{margin:16px;padding:12px;border-radius:8px;font-size:14px}
.status-success{background:#1b3b2b;color:#4ade80}
.status-error{background:#3b1b1f;color:#f87171}
.model-list{margin:16px;max-height:150px;overflow-y:auto;border:1px solid #333;border-radius:8px;padding:8px}
.model-item{padding:8px;border-bottom:1px solid #333;cursor:pointer}
.model-item:hover{background:#2d2d2d}
.set-item{background:#1e1e1e;border-radius:16px;padding:16px;margin:12px;display:flex;justify-content:space-between;align-items:center}
.set-label{font-size:15px}
.toggle{width:46px;height:24px;background:#333;border-radius:12px;position:relative;cursor:pointer}
.toggle::after{content:'';width:20px;height:20px;background:#fff;border-radius:50%;position:absolute;top:2px;left:2px;transition:.2s}
.toggle.active{background:#ff69b4}
.toggle.active::after{left:24px}

/* èŠå¤©æ ·å¼ */
#chat{display:flex;flex-direction:column;height:100%}
#chat-head{padding:16px;background:#1e1e1e;display:flex;align-items:center;gap:12px;position:sticky;top:0}
#msg-list{flex:1;padding:16px;overflow-y:auto;display:flex;flex-direction:column;gap:12px}
.msg{max-width:80%;padding:12px 16px;border-radius:16px;word-break:break-word}
.msg.user{align-self:flex-end;background:#ff69b4;color:#fff}
.msg.ai{align-self:flex-start;background:#1e1e1e;color:#e0e0e0}
.msg.system{align-self:center;background:#333;color:#999;font-size:12px;max-width:90%}
#chat-input{display:flex;gap:8px;padding:16px;background:#1e1e1e}
#chat-input input{flex:1;background:#2d2d2d;color:#e0e0e0;border:none;border-radius:8px;padding:0 12px;outline:none}
#chat-input button{background:#ff69b4;color:#fff;border:none;border-radius:8px;padding:0 16px;cursor:pointer}
.render-box{padding:12px;border-radius:12px;background:#1a1a1a;margin-top:4px;width:100%;white-space:pre-wrap}

/* è®°å¿†/ä¸–ç•Œä¹¦å¡ç‰‡ */
.memory-item, .world-item, .regex-item, .preset-item, .theme-item{background:#1e1e1e;border-radius:12px;padding:14px;margin:8px 16px;position:relative}
.memory-text{font-size:14px;color:#e0e0e0;margin-bottom:8px;white-space:pre-wrap}
.memory-time{font-size:12px;color:#888}
.memory-actions{display:flex;gap:8px;margin-top:8px;justify-content:flex-end}
.memory-actions button{padding:4px 12px;border:none;border-radius:16px;cursor:pointer}
.btn-edit{background:#2d2d2d;color:#ff69b4}
.btn-delete{background:#3b1b1f;color:#f87171}
.search-box{margin:8px 16px;padding:8px;background:#2d2d2d;border-radius:8px;display:flex}
.search-box input{flex:1;background:transparent;border:none;color:#e0e0e0;outline:none}
.sort-btn{background:#2d2d2d;border:none;color:#ff69b4;padding:0 8px;cursor:pointer}

.empty-state{text-align:center;padding:40px 20px;color:#666}
.loading{text-align:center;padding:20px;color:#ff69b4}

/* è§’è‰²å¡ç‰‡æ ·å¼ */
.char-card{background:#1e1e1e;border-radius:16px;padding:16px;margin:12px;display:flex;align-items:center;gap:12px;cursor:pointer}
.char-avatar{width:48px;height:48px;border-radius:24px;background:#2d2d2d;display:flex;align-items:center;justify-content:center;font-size:24px}
.char-info{flex:1}
.char-name{font-size:16px;font-weight:600}
.char-desc{font-size:12px;color:#999}
</style>
</head>
<body>

<!-- ä¸»é¡µ -->
<div id="tavern" class="screen active">
  <div class="head">
    <button onclick="back()">â†</button>
    <h3>é…’é¦† Tavern</h3>
    <button class="action-btn" onclick="goto('chat')">èŠå¤©</button>
  </div>
  <div class="tavern-grid">
    <div class="tavern-card" onclick="goto('char')"><div class="tavern-icon">ğŸ‘¤</div><div class="tavern-title">è§’è‰²å¡</div><div class="tavern-desc">PNG/JSON/ST</div></div>
    <div class="tavern-card" onclick="goto('memory')"><div class="tavern-icon">ğŸ§ </div><div class="tavern-title">é•¿æœŸè®°å¿†</div><div class="tavern-desc">è§’è‰²ç‹¬ç«‹è®°å¿†</div></div>
    <div class="tavern-card" onclick="goto('world')"><div class="tavern-icon">ğŸ“š</div><div class="tavern-title">ä¸–ç•Œä¹¦</div><div class="tavern-desc">STå¯¼å…¥</div></div>
    <div class="tavern-card" onclick="goto('regex')"><div class="tavern-icon">âœï¸</div><div class="tavern-title">æ­£åˆ™</div><div class="tavern-desc">STå¯¼å…¥</div></div>
    <div class="tavern-card" onclick="goto('preset')"><div class="tavern-icon">ğŸ­</div><div class="tavern-title">é¢„è®¾</div><div class="tavern-desc">STå¯¼å…¥</div></div>
    <div class="tavern-card" onclick="goto('theme')"><div class="tavern-icon">ğŸ¨</div><div class="tavern-title">ä¸»é¢˜</div><div class="tavern-desc">STå¯¼å…¥</div></div>
    <div class="tavern-card" onclick="goto('user')"><div class="tavern-icon">ğŸ‘¤</div><div class="tavern-title">ç”¨æˆ·è®¾å®š</div><div class="tavern-desc">äººè®¾ç®¡ç†</div></div>
    <div class="tavern-card" onclick="goto('api')"><div class="tavern-icon">â˜ï¸</div><div class="tavern-title">APIé…ç½®</div><div class="tavern-desc">æ‹‰æ¨¡å‹/æµ‹é“¾æ¥</div></div>
    <div class="tavern-card" onclick="goto('settings')"><div class="tavern-icon">âš™ï¸</div><div class="tavern-title">ç³»ç»Ÿè®¾ç½®</div><div class="tavern-desc">å…¨å±€é…ç½®</div></div>
  </div>
</div>

<!-- è§’è‰²å¡ -->
<div id="char" class="screen">
  <div class="head"><button onclick="back()">â†</button><h3>è§’è‰²å¡</h3><button class="action-btn" onclick="importChar()">å¯¼å…¥</button></div>
  <div style="margin:16px;padding:18px;background:#1e1e1e;border-radius:16px;text-align:center">
    <div>æ”¯æŒ PNG / JSON / SillyTavern è§’è‰²å¡</div>
    <button class="action-btn" style="margin-top:12px" onclick="importChar()">é€‰æ‹©æ–‡ä»¶</button>
  </div>
  <div id="char-list" class="char-list"></div>
</div>

<!-- é•¿æœŸè®°å¿† -->
<div id="memory" class="screen">
  <div class="head"><button onclick="back()">â†</button><h3>é•¿æœŸè®°å¿†</h3><button class="action-btn" onclick="addMemory()">æ·»åŠ è®°å¿†</button></div>
  <div style="padding:16px">
    <div class="form-item">
      <label class="form-label">å½“å‰è§’è‰²</label>
      <select class="form-select" id="mem_char" onchange="renderMemory()"></select>
    </div>
    <!-- æœç´¢æ’åºæ  -->
    <div class="search-box">
      <input type="text" id="memory-search" placeholder="æœç´¢è®°å¿†..." oninput="renderMemory()">
      <button class="sort-btn" onclick="toggleMemorySort()">â²ï¸ æ—¶é—´</button>
    </div>
    <div id="memory-list"></div>
  </div>
</div>

<!-- ä¸–ç•Œä¹¦ -->
<div id="world" class="screen">
  <div class="head"><button onclick="back()">â†</button><h3>ä¸–ç•Œä¹¦</h3><button class="action-btn" onclick="importWorld()">å¯¼å…¥STä¸–ç•Œä¹¦</button></div>
  <div id="world-list" class="world-list"></div>
</div>

<!-- æ­£åˆ™ -->
<div id="regex" class="screen">
  <div class="head"><button onclick="back()">â†</button><h3>æ­£åˆ™è§„åˆ™</h3><button class="action-btn" onclick="importRegex()">å¯¼å…¥STæ­£åˆ™</button></div>
  <div id="regex-list" class="regex-list"></div>
</div>

<!-- é¢„è®¾ -->
<div id="preset" class="screen">
  <div class="head"><button onclick="back()">â†</button><h3>é¢„è®¾</h3><button class="action-btn" onclick="importPreset()">å¯¼å…¥</button></div>
  <div id="preset-list" class="preset-list"></div>
</div>

<!-- ä¸»é¢˜ -->
<div id="theme" class="screen">
  <div class="head"><button onclick="back()">â†</button><h3>ä¸»é¢˜</h3><button class="action-btn" onclick="importTheme()">å¯¼å…¥</button></div>
  <div id="theme-list" class="theme-list"></div>
</div>

<!-- ç”¨æˆ·è®¾å®š -->
<div id="user" class="screen">
  <div class="head"><button onclick="back()">â†</button><h3>ç”¨æˆ·è®¾å®š</h3></div>
  <div style="padding:16px">
    <div class="form-item">
      <label class="form-label">ç”¨æˆ·æ˜µç§°</label>
      <input class="form-input" id="user_name">
    </div>
    <div class="form-item">
      <label class="form-label">ç”¨æˆ·äººè®¾</label>
      <textarea class="form-input" id="user_persona" rows="4" placeholder="ä¾‹å¦‚ï¼šå–œæ¬¢å†’é™©ï¼Œæ€§æ ¼å¼€æœ—..."></textarea>
    </div>
    <button class="btn-primary" style="width:100%" onclick="saveUser()">ä¿å­˜</button>
  </div>
</div>

<!-- ç³»ç»Ÿè®¾ç½® -->
<div id="settings" class="screen">
  <div class="head"><button onclick="back()">â†</button><h3>ç³»ç»Ÿè®¾ç½®</h3></div>
  <div class="set-item" onclick="toggleSetting('auto_mem')">
    <div class="set-label">è‡ªåŠ¨è®°å½•å¯¹è¯åˆ°è®°å¿†</div>
    <div class="toggle active" id="auto_mem"></div>
  </div>
  <div class="set-item" onclick="toggleSetting('inject_mem')">
    <div class="set-label">è®°å¿†æ³¨å…¥å¯¹è¯</div>
    <div class="toggle active" id="inject_mem"></div>
  </div>
  <div class="set-item" onclick="toggleSetting('auto_save')">
    <div class="set-label">è‡ªåŠ¨ä¿å­˜å¯¹è¯å†å²</div>
    <div class="toggle active" id="auto_save"></div>
  </div>
</div>

<!-- APIé…ç½® -->
<div id="api" class="screen">
  <div class="head"><button onclick="back()">â†</button><h3>APIé…ç½®</h3></div>
  <div style="padding:16px">
    <div class="form-item">
      <label class="form-label">Base URL</label>
      <input class="form-input" id="api_url" placeholder="https://api.openai.com/v1">
    </div>
    <div class="form-item">
      <label class="form-label">API Key</label>
      <input class="form-input" id="api_key" type="password">
    </div>
    <div class="form-item">
      <label class="form-label">æ¨¡å‹å</label>
      <input class="form-input" id="api_model" placeholder="gpt-3.5-turbo">
    </div>
    <div class="btn-group">
      <button class="btn btn-secondary" onclick="fetchModels()">æ‹‰å–æ¨¡å‹</button>
      <button class="btn btn-secondary" onclick="testApi()">æµ‹è¯•è¿æ¥</button>
    </div>
    <div id="model-list" class="model-list" style="display:none"></div>
    <div id="api-status" class="status-tip" style="display:none"></div>
    <button class="btn-primary" style="width:100%;margin-top:16px" onclick="saveApi()">ä¿å­˜</button>
  </div>
</div>

<!-- èŠå¤© -->
<div id="chat" class="screen">
  <div id="chat-head">
    <button onclick="back()">â†</button>
    <h3 id="chat-title">é…’é¦†èŠå¤©</h3>
    <button class="action-btn" onclick="clearChat()">æ¸…ç©º</button>
  </div>
  <div id="msg-list"></div>
  <div id="chat-input">
    <input id="msg_input" placeholder="è¾“å…¥æ¶ˆæ¯..." onkeypress="if(event.key==='Enter')sendMsg()">
    <button onclick="sendMsg()">å‘é€</button>
  </div>
</div>

<script>
// ==================== è·¯ç”±ç³»ç»Ÿ ====================
let hist = ['tavern'];
function goto(id) {
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if (hist[hist.length-1] !== id) hist.push(id);
}
function back() {
  hist.pop();
  let prev = hist.pop() || 'tavern';
  goto(prev);
}

// ==================== æ•°æ®å­˜å‚¨ ====================
let DB = JSON.parse(localStorage.getItem('tavern_extreme')) || {
  user: { name: 'ç”¨æˆ·', persona: '' },
  api: { url: 'https://api.openai.com/v1', key: '', model: 'gpt-3.5-turbo' },
  chars: [
    { id: 'default', name: 'é»˜è®¤åŠ©æ‰‹', desc: 'ä¸€ä¸ªå‹å¥½çš„AIåŠ©æ‰‹', avatar: 'ğŸ¤–', data: null }
  ],
  curChar: 0,
  memory: { default: [] },
  worlds: [],
  regexes: [],
  presets: [],
  themes: [],
  settings: {
    auto_mem: true,
    inject_mem: true,
    auto_save: true
  },
  chats: {},
  // è®°å¿†æ’åºï¼štrue=æ—¶é—´å‡åºï¼ˆæ—§çš„åœ¨å‰ï¼‰ï¼Œfalse=é™åºï¼ˆæ–°çš„åœ¨å‰ï¼‰
  memorySortAsc: false
};

function saveDB() {
  localStorage.setItem('tavern_extreme', JSON.stringify(DB));
}

// ==================== åˆå§‹åŒ– ====================
function init() {
  document.getElementById('user_name').value = DB.user.name;
  document.getElementById('user_persona').value = DB.user.persona || '';
  document.getElementById('api_url').value = DB.api.url;
  document.getElementById('api_key').value = DB.api.key;
  document.getElementById('api_model').value = DB.api.model;
  for (let key in DB.settings) {
    let el = document.getElementById(key);
    if (el) el.classList.toggle('active', DB.settings[key]);
  }
  renderChar();
  renderMemory();
  updateChatTitle();
  renderWorlds();
  renderRegexes();
  renderPresets();
  renderThemes();
}
// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
window.addEventListener('load', init);

// ==================== è§’è‰²ç®¡ç† ====================
function renderChar() {
  let list = document.getElementById('char-list');
  list.innerHTML = DB.chars.map((c, i) => `
    <div class="char-card" onclick="selectChar(${i})">
      <div class="char-avatar">${c.avatar || 'ğŸ‘¤'}</div>
      <div class="char-info">
        <div class="char-name">${escapeHtml(c.name)}</div>
        <div class="char-desc">${escapeHtml(c.desc || 'æ— æè¿°')}</div>
      </div>
      <button class="action-btn" onclick="event.stopPropagation();deleteChar(${i})">åˆ é™¤</button>
    </div>
  `).join('');
  let sel = document.getElementById('mem_char');
  if (sel) {
    sel.innerHTML = DB.chars.map(c => `<option value="${c.id}">${escapeHtml(c.name)}</option>`).join('');
  }
}

function selectChar(i) {
  DB.curChar = i;
  saveDB();
  updateChatTitle();
  goto('chat');
}

function deleteChar(i) {
  if (DB.chars.length <= 1) {
    alert('è‡³å°‘ä¿ç•™ä¸€ä¸ªè§’è‰²');
    return;
  }
  let cid = DB.chars[i].id;
  DB.chars.splice(i, 1);
  delete DB.memory[cid];
  if (DB.curChar >= i) DB.curChar = Math.max(0, DB.curChar - 1);
  saveDB();
  renderChar();
  updateChatTitle();
}

// ==================== å¯¼å…¥è§’è‰²å¡ï¼ˆæ”¯æŒPNG/JSONï¼‰====================
function importChar() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.png,.json,.char,.webp';
  input.onchange = async (e) => {
    let file = e.target.files[0];
    if (!file) return;
    try {
      let name = file.name.replace(/\.\w+$/, '');
      let id = 'char_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
      let desc = '';
      let avatar = 'ğŸ‘¤';
      let charData = null;
      // æ ¹æ®æ–‡ä»¶ç±»å‹å¤„ç†
      if (file.name.toLowerCase().endsWith('.png') || file.name.toLowerCase().endsWith('.webp')) {
        // è§£æPNG tEXtå—
        const buffer = await file.arrayBuffer();
        const view = new DataView(buffer);
        // PNGç­¾å: 137 80 78 71 13 10 26 10
        if (view.getUint32(0) !== 0x89504E47 || view.getUint32(4) !== 0x0D0A1A0A) {
          throw new Error('ä¸æ˜¯æœ‰æ•ˆçš„PNGæ–‡ä»¶');
        }
        let offset = 8;
        while (offset < buffer.byteLength) {
          const length = view.getUint32(offset);
          const type = String.fromCharCode(view.getUint8(offset+4), view.getUint8(offset+5), view.getUint8(offset+6), view.getUint8(offset+7));
          offset += 8;
          if (type === 'tEXt') {
            // è¯»å–å…³é”®å­—ç›´åˆ°0
            let keywordEnd = offset;
            while (keywordEnd < offset + length && view.getUint8(keywordEnd) !== 0) keywordEnd++;
            const keyword = new TextDecoder().decode(new Uint8Array(buffer, offset, keywordEnd - offset));
            if (keyword === 'chara' || keyword === 'Character' || keyword === 'data') {
              const textStart = keywordEnd + 1; // è·³è¿‡0
              const textLength = offset + length - textStart;
              const text = new TextDecoder().decode(new Uint8Array(buffer, textStart, textLength));
              try {
                charData = JSON.parse(text);
                name = charData.name || name;
                desc = charData.description || charData.desc || '';
                avatar = charData.avatar || 'ğŸ‘¤';
              } catch (e) { console.warn('tEXtå—å†…å®¹ä¸æ˜¯JSON', text); }
              break;
            }
          }
          offset += length + 4; // CRC
        }
      } else if (file.name.toLowerCase().endsWith('.json') || file.name.toLowerCase().endsWith('.char')) {
        let text = await file.text();
        try {
          charData = JSON.parse(text);
          name = charData.name || name;
          desc = charData.description || charData.desc || '';
          avatar = charData.avatar || 'ğŸ‘¤';
        } catch (e) {}
      }
      DB.chars.push({ id, name, desc, avatar, data: charData });
      DB.memory[id] = [];
      saveDB();
      renderChar();
      alert(`å¯¼å…¥æˆåŠŸï¼š${name}`);
    } catch (err) {
      alert('å¯¼å…¥å¤±è´¥ï¼š' + err.message);
    }
  };
  input.click();
}

function updateChatTitle() {
  let title = document.getElementById('chat-title');
  if (title && DB.chars[DB.curChar]) {
    title.innerText = `ä¸ ${DB.chars[DB.curChar].name} èŠå¤©`;
  }
}

// ==================== é•¿æœŸè®°å¿†ç³»ç»Ÿï¼ˆå¢å¼ºç‰ˆï¼‰====================
let memorySortAsc = DB.memorySortAsc; // true=å‡åºï¼ˆæ—§çš„åœ¨å‰ï¼‰

function toggleMemorySort() {
  memorySortAsc = !memorySortAsc;
  DB.memorySortAsc = memorySortAsc;
  saveDB();
  renderMemory();
}

function renderMemory() {
  let cid = document.getElementById('mem_char')?.value;
  if (!cid) return;
  let mems = DB.memory[cid] || [];
  let searchTerm = document.getElementById('memory-search')?.value.toLowerCase() || '';
  // è¿‡æ»¤
  if (searchTerm) {
    mems = mems.filter(m => m.text.toLowerCase().includes(searchTerm));
  }
  // æ’åº
  mems.sort((a, b) => {
    let tA = new Date(a.time).getTime();
    let tB = new Date(b.time).getTime();
    return memorySortAsc ? tA - tB : tB - tA;
  });
  let list = document.getElementById('memory-list');
  if (mems.length === 0) {
    list.innerHTML = '<div class="empty-state">æš‚æ— è®°å¿†</div>';
    return;
  }
  list.innerHTML = mems.map((m, i) => `
    <div class="memory-item" data-index="${i}">
      <div class="memory-text">${escapeHtml(m.text)}</div>
      <div class="memory-time">${escapeHtml(m.time)}</div>
      <div class="memory-actions">
        <button class="btn-edit" onclick="editMemory('${cid}', ${i})">ç¼–è¾‘</button>
        <button class="btn-delete" onclick="delMemory('${cid}', ${i})">åˆ é™¤</button>
      </div>
    </div>
  `).join('');
}

function addMemory() {
  let cid = document.getElementById('mem_char')?.value;
  if (!cid) { alert('è¯·å…ˆé€‰æ‹©è§’è‰²'); return; }
  let text = prompt('è¾“å…¥è®°å¿†å†…å®¹ï¼š');
  if (!text) return;
  DB.memory[cid] = DB.memory[cid] || [];
  DB.memory[cid].push({ text, time: new Date().toLocaleString() });
  saveDB();
  renderMemory();
}

function editMemory(cid, idx) {
  let mem = DB.memory[cid][idx];
  let newText = prompt('ç¼–è¾‘è®°å¿†å†…å®¹ï¼š', mem.text);
  if (newText !== null && newText.trim() !== '') {
    mem.text = newText.trim();
    mem.time = new Date().toLocaleString() + ' (å·²ç¼–è¾‘)';
    saveDB();
    renderMemory();
  }
}

function delMemory(cid, i) {
  if (confirm('ç¡®å®šåˆ é™¤è¿™æ¡è®°å¿†å—ï¼Ÿ')) {
    DB.memory[cid].splice(i, 1);
    saveDB();
    renderMemory();
  }
}

// è‡ªåŠ¨è®°å½•è®°å¿†
function autoSaveMemory(text, role = 'user') {
  if (!DB.settings.auto_mem) return;
  let cid = DB.chars[DB.curChar]?.id;
  if (!cid) return;
  DB.memory[cid] = DB.memory[cid] || [];
  DB.memory[cid].push({ text: `[${role}] ${text}`, time: new Date().toLocaleString() });
  saveDB();
}

// è·å–å½“å‰è§’è‰²è®°å¿†ï¼ˆç”¨äºæ³¨å…¥ï¼‰
function getCurMemory() {
  if (!DB.settings.inject_mem) return '';
  let cid = DB.chars[DB.curChar]?.id;
  if (!cid) return '';
  let mems = DB.memory[cid] || [];
  return mems.slice(-10).map(m => m.text).join('\n');
}

// ==================== ä¸–ç•Œä¹¦ï¼ˆå®Œæ•´å®ç°ï¼‰====================
function importWorld() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  input.onchange = async (e) => {
    let file = e.target.files[0];
    if (!file) return;
    try {
      let text = await file.text();
      let data = JSON.parse(text);
      DB.worlds.push({
        id: Date.now(),
        name: file.name,
        data: data,
        enabled: true,
        time: new Date().toLocaleString()
      });
      saveDB();
      renderWorlds();
      alert('ä¸–ç•Œä¹¦å¯¼å…¥æˆåŠŸ');
    } catch (err) {
      alert('è§£æå¤±è´¥ï¼š' + err.message);
    }
  };
  input.click();
}

function renderWorlds() {
  let list = document.getElementById('world-list');
  if (!list) return;
  if (DB.worlds.length === 0) {
    list.innerHTML = '<div class="empty-state">æš‚æ— ä¸–ç•Œä¹¦ï¼Œç‚¹å‡»å¯¼å…¥æ·»åŠ </div>';
    return;
  }
  list.innerHTML = DB.worlds.map((w, i) => `
    <div class="world-item">
      <div style="display:flex; justify-content:space-between; align-items:center">
        <span style="font-weight:600">${escapeHtml(w.name)}</span>
        <span class="toggle ${w.enabled ? 'active' : ''}" onclick="toggleWorld(${i})" style="width:40px; height:20px"></span>
      </div>
      <div style="font-size:12px; color:#888; margin:4px 0">${escapeHtml(w.time)}</div>
      <button class="action-btn" onclick="deleteWorld(${i})">åˆ é™¤</button>
    </div>
  `).join('');
}

function toggleWorld(index) {
  DB.worlds[index].enabled = !DB.worlds[index].enabled;
  saveDB();
  renderWorlds();
}

function deleteWorld(i) {
  if (confirm('åˆ é™¤ä¸–ç•Œä¹¦ï¼Ÿ')) {
    DB.worlds.splice(i, 1);
    saveDB();
    renderWorlds();
  }
}

// ==================== æ­£åˆ™ï¼ˆç±»ä¼¼ä¸–ç•Œä¹¦ï¼‰====================
function importRegex() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  input.onchange = async (e) => {
    let file = e.target.files[0];
    if (!file) return;
    try {
      let text = await file.text();
      let data = JSON.parse(text);
      DB.regexes.push({
        id: Date.now(),
        name: file.name,
        data: data,
        enabled: true,
        time: new Date().toLocaleString()
      });
      saveDB();
      renderRegexes();
      alert('æ­£åˆ™å¯¼å…¥æˆåŠŸ');
    } catch (err) {
      alert('è§£æå¤±è´¥ï¼š' + err.message);
    }
  };
  input.click();
}

function renderRegexes() {
  let list = document.getElementById('regex-list');
  if (!list) return;
  if (DB.regexes.length === 0) {
    list.innerHTML = '<div class="empty-state">æš‚æ— æ­£åˆ™è§„åˆ™</div>';
    return;
  }
  list.innerHTML = DB.regexes.map((r, i) => `
    <div class="regex-item">
      <div style="display:flex; justify-content:space-between;">
        <span style="font-weight:600">${escapeHtml(r.name)}</span>
        <span class="toggle ${r.enabled ? 'active' : ''}" onclick="toggleRegex(${i})"></span>
      </div>
      <div style="font-size:12px; color:#888">${escapeHtml(r.time)}</div>
      <button class="action-btn" onclick="deleteRegex(${i})">åˆ é™¤</button>
    </div>
  `).join('');
}

function toggleRegex(index) {
  DB.regexes[index].enabled = !DB.regexes[index].enabled;
  saveDB();
  renderRegexes();
}

function deleteRegex(i) {
  if (confirm('åˆ é™¤æ­£åˆ™ï¼Ÿ')) {
    DB.regexes.splice(i, 1);
    saveDB();
    renderRegexes();
  }
}

// ==================== é¢„è®¾ ====================
function importPreset() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  input.onchange = async (e) => {
    let file = e.target.files[0];
    if (!file) return;
    try {
      let text = await file.text();
      let data = JSON.parse(text);
      DB.presets.push({
        id: Date.now(),
        name: file.name,
        data: data,
        time: new Date().toLocaleString()
      });
      saveDB();
      renderPresets();
      alert('é¢„è®¾å¯¼å…¥æˆåŠŸ');
    } catch (err) {
      alert('è§£æå¤±è´¥ï¼š' + err.message);
    }
  };
  input.click();
}

function renderPresets() {
  let list = document.getElementById('preset-list');
  if (!list) return;
  if (DB.presets.length === 0) {
    list.innerHTML = '<div class="empty-state">æš‚æ— é¢„è®¾</div>';
    return;
  }
  list.innerHTML = DB.presets.map((p, i) => `
    <div class="preset-item">
      <div style="font-weight:600">${escapeHtml(p.name)}</div>
      <div style="font-size:12px; color:#888">${escapeHtml(p.time)}</div>
      <button class="action-btn" onclick="deletePreset(${i})">åˆ é™¤</button>
    </div>
  `).join('');
}

function deletePreset(i) {
  if (confirm('åˆ é™¤é¢„è®¾ï¼Ÿ')) {
    DB.presets.splice(i, 1);
    saveDB();
    renderPresets();
  }
}

// ==================== ä¸»é¢˜ ====================
function importTheme() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  input.onchange = async (e) => {
    let file = e.target.files[0];
    if (!file) return;
    try {
      let text = await file.text();
      let data = JSON.parse(text);
      DB.themes.push({
        id: Date.now(),
        name: file.name,
        data: data,
        time: new Date().toLocaleString()
      });
      saveDB();
      renderThemes();
      alert('ä¸»é¢˜å¯¼å…¥æˆåŠŸ');
    } catch (err) {
      alert('è§£æå¤±è´¥ï¼š' + err.message);
    }
  };
  input.click();
}

function renderThemes() {
  let list = document.getElementById('theme-list');
  if (!list) return;
  if (DB.themes.length === 0) {
    list.innerHTML = '<div class="empty-state">æš‚æ— ä¸»é¢˜</div>';
    return;
  }
  list.innerHTML = DB.themes.map((t, i) => `
    <div class="theme-item">
      <div style="font-weight:600">${escapeHtml(t.name)}</div>
      <div style="font-size:12px; color:#888">${escapeHtml(t.time)}</div>
      <button class="action-btn" onclick="deleteTheme(${i})">åˆ é™¤</button>
    </div>
  `).join('');
}

function deleteTheme(i) {
  if (confirm('åˆ é™¤ä¸»é¢˜ï¼Ÿ')) {
    DB.themes.splice(i, 1);
    saveDB();
    renderThemes();
  }
}

// ==================== ç”¨æˆ·/API/è®¾ç½® ====================
function saveUser() {
  DB.user.name = document.getElementById('user_name').value;
  DB.user.persona = document.getElementById('user_persona').value;
  saveDB();
  alert('ç”¨æˆ·è®¾å®šå·²ä¿å­˜');
}

async function testApi() {
  let url = document.getElementById('api_url').value;
  let key = document.getElementById('api_key').value;
  if (!url || !key) { alert('è¯·å¡«å†™URLå’ŒAPI Key'); return; }
  let statusEl = document.getElementById('api-status');
  statusEl.style.display = 'block';
  statusEl.className = 'status-tip';
  statusEl.innerText = 'æµ‹è¯•ä¸­...';
  try {
    let res = await fetch(url + '/models', { headers: { 'Authorization': 'Bearer ' + key } });
    if (res.ok) {
      statusEl.className = 'status-tip status-success';
      statusEl.innerText = 'âœ… è¿æ¥æˆåŠŸ';
    } else if (res.status === 401) {
      statusEl.className = 'status-tip status-error';
      statusEl.innerText = 'âŒ API Key æ— æ•ˆ';
    } else if (res.status === 429) {
      statusEl.className = 'status-tip status-error';
      statusEl.innerText = 'âŒ è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•';
    } else if (res.status >= 500) {
      statusEl.className = 'status-tip status-error';
      statusEl.innerText = 'âŒ æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
    } else {
      statusEl.className = 'status-tip status-error';
      statusEl.innerText = 'âŒ è¿æ¥å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š' + res.status;
    }
  } catch (err) {
    statusEl.className = 'status-tip status-error';
    statusEl.innerText = 'âŒ ç½‘ç»œé”™è¯¯ï¼š' + err.message;
  }
}

async function fetchModels() {
  let url = document.getElementById('api_url').value;
  let key = document.getElementById('api_key').value;
  if (!url || !key) { alert('è¯·å¡«å†™URLå’ŒAPI Key'); return; }
  let listEl = document.getElementById('model-list');
  listEl.style.display = 'block';
  listEl.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
  try {
    let res = await fetch(url + '/models', { headers: { 'Authorization': 'Bearer ' + key } });
    if (!res.ok) throw new Error('è¯·æ±‚å¤±è´¥');
    let data = await res.json();
    listEl.innerHTML = data.data.map(m => `<div class="model-item" onclick="selModel('${m.id}')">${escapeHtml(m.id)}</div>`).join('');
  } catch (err) {
    listEl.innerHTML = '<div class="status-error">åŠ è½½å¤±è´¥</div>';
  }
}

function selModel(id) {
  document.getElementById('api_model').value = id;
  document.getElementById('model-list').style.display = 'none';
}

function saveApi() {
  DB.api.url = document.getElementById('api_url').value;
  DB.api.key = document.getElementById('api_key').value;
  DB.api.model = document.getElementById('api_model').value;
  saveDB();
  alert('APIé…ç½®å·²ä¿å­˜');
}

function toggleSetting(id) {
  let el = document.getElementById(id);
  if (!el) return;
  // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¦å‘çˆ¶çº§ç‚¹å‡»
  event.stopPropagation();
  DB.settings[id] = !DB.settings[id];
  el.classList.toggle('active', DB.settings[id]);
  saveDB();
}

// ==================== èŠå¤©ç³»ç»Ÿ ====================
let isLoading = false;

async function sendMsg() {
  let input = document.getElementById('msg_input');
  let txt = input.value.trim();
  if (!txt || isLoading) return;
  input.value = '';
  isLoading = true;
  addMessage('user', txt);
  autoSaveMemory(txt, 'user');
  try {
    let reply = await getAIResponse(txt);
    addMessage('ai', reply);
    autoSaveMemory(reply, 'ai');
  } catch (err) {
    addMessage('system', 'âŒ ' + err.message);
  }
  isLoading = false;
  if (DB.settings.auto_save) saveChatHistory();
}

function addMessage(role, content) {
  let list = document.getElementById('msg-list');
  let msgDiv = document.createElement('div');
  msgDiv.className = 'msg ' + role;
  if (role === 'system') {
    msgDiv.innerText = content;
  } else {
    let renderBox = document.createElement('div');
    renderBox.className = 'render-box';
    renderBox.innerText = content;
    msgDiv.appendChild(renderBox);
  }
  list.appendChild(msgDiv);
  list.scrollTop = list.scrollHeight;
}

async function getAIResponse(userMsg) {
  let api = DB.api;
  if (!api.url || !api.key || !api.model) throw new Error('è¯·å…ˆé…ç½®API');
  let memory = getCurMemory();
  let systemPrompt = `ä½ æ˜¯ä¸€ä¸ªAIè§’è‰²ï¼Œåå«${DB.chars[DB.curChar]?.name}ã€‚\n`;
  if (DB.user.persona) systemPrompt += `ç”¨æˆ·ä¿¡æ¯ï¼š${DB.user.name}ï¼Œ${DB.user.persona}\n`;
  if (memory) systemPrompt += `é•¿æœŸè®°å¿†ï¼š\n${memory}\n`;
  try {
    let res = await fetch(api.url + '/chat/completions', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + api.key },
      body: JSON.stringify({ model: api.model, messages: [
        { role: 'system', content: systemPrompt },
        { role: 'user', content: userMsg }
      ], temperature: 0.7 })
    });
    if (!res.ok) {
      if (res.status === 401) throw new Error('API Key æ— æ•ˆ');
      else if (res.status === 429) throw new Error('è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•');
      else if (res.status >= 500) throw new Error('æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
      else throw new Error(`APIé”™è¯¯ (${res.status})`);
    }
    let data = await res.json();
    return data.choices[0].message.content;
  } catch (err) { throw err; }
}

function clearChat() {
  if (confirm('æ¸…ç©ºå½“å‰å¯¹è¯ï¼Ÿ')) {
    document.getElementById('msg-list').innerHTML = '';
    if (DB.settings.auto_save) {
      let cid = DB.chars[DB.curChar]?.id;
      if (cid) { DB.chats[cid] = []; saveDB(); }
    }
  }
}

function saveChatHistory() {
  let list = document.getElementById('msg-list');
  let msgs = [];
  list.querySelectorAll('.msg').forEach(msg => {
    let role = msg.classList.contains('user') ? 'user' : msg.classList.contains('ai') ? 'ai' : 'system';
    let content = msg.querySelector('.render-box')?.innerText || msg.innerText;
    msgs.push({ role, content });
  });
  let cid = DB.chars[DB.curChar]?.id;
  if (cid) { DB.chats[cid] = msgs; saveDB(); }
}

// ==================== å·¥å…·å‡½æ•° ====================
function escapeHtml(unsafe) {
  return String(unsafe).replace(/[&<>"']/g, function(m) {
    if (m === '&') return '&amp;';
    if (m === '<') return '&lt;';
    if (m === '>') return '&gt;';
    if (m === '"') return '&quot;';
    return '&#039;';
  });
}

// åˆå§‹åŒ–æ‰€æœ‰åˆ—è¡¨
function renderWorlds() { /* å·²åœ¨å‰é¢å®šä¹‰ï¼Œè¿™é‡Œå ä½ */ }
function renderRegexes() { /* å·²åœ¨å‰é¢å®šä¹‰ */ }
function renderPresets() { /* å·²åœ¨å‰é¢å®šä¹‰ */ }
function renderThemes() { /* å·²åœ¨å‰é¢å®šä¹‰ */ }
</script>
</body>
</html>
