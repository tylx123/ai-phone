<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIå°æ‰‹æœº</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            color: #fff;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        /* é¡µé¢å®¹å™¨ */
        .page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            position: relative;
            overflow: hidden;
        }
        .page.active {
            display: block;
        }

        /* é¡µé¢èƒŒæ™¯å£çº¸å±‚ - ä¿®å¤å±‚çº§é—®é¢˜ */
        .page-bg {
            position: absolute;
            z-index: 0;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.85;
        }
        /* é¡µé¢å†…å®¹å±‚ - ç¡®ä¿å†…å®¹åœ¨å£çº¸ä¸Š */
        .page-content {
            position: relative;
            z-index: 1;
            width: 100%;
            height: 100%;
        }

        /* ==================== 1. é”å±é¡µé¢ ==================== */
        #lockScreen .page-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 22px;
        }
        #lockScreen .time {
            font-size: 48px;
            margin-bottom: 20px;
        }
        #lockScreen .date {
            font-size: 18px;
            margin-bottom: 60px;
        }
        #lockScreen .unlock {
            padding: 10px 25px;
            background: rgba(255,255,255,0.2);
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s;
        }
        #lockScreen .unlock:hover {
            background: rgba(255,105,180,0.4);
        }

        /* ==================== 2. ä¸»é¡µï¼ˆæ¨¡å—å…¥å£ï¼‰ ==================== */
        #homePage .page-content {
            padding: 40px 20px;
        }
        .home-title {
            font-size: 24px;
            margin-bottom: 30px;
            text-align: center;
            text-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        .module-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .module-item {
            background: rgba(255, 105, 180, 0.2);
            border: 2px solid #ff69b4;
            border-radius: 20px;
            padding: 25px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .module-item:hover {
            background: rgba(255, 105, 180, 0.4);
            transform: scale(1.05);
        }
        .module-item .icon {
            font-size: 30px;
            margin-bottom: 10px;
        }

        /* ==================== 3. é…’é¦†é¡µé¢ = åŸAIç•Œé¢ï¼ˆå®Œæ•´æ¢å¤ï¼‰ ==================== */
        #tavernPage .page-content {
            width: 100%;
            height: 100%;
        }
        .phone {
            width: 100%;
            height: 100%;
            background-color: rgba(26,26,26,0.8);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }
        .status-bar {
            height: 44px;
            background-color: rgba(17,17,17,0.8);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 16px;
            font-size: 12px;
        }
        .screen {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 20px;
            font-size: 14px;
            line-height: 1.4;
        }
        .user-msg {
            background-color: #007aff;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        .ai-msg {
            background-color: rgba(51,51,51,0.8);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        .input-area {
            background-color: rgba(17,17,17,0.8);
            padding: 12px;
            display: flex;
            gap: 8px;
        }
        #userInput {
            flex: 1;
            background-color: rgba(34,34,34,0.8);
            border: none;
            border-radius: 20px;
            padding: 12px 16px;
            color: #fff;
            font-size: 14px;
            outline: none;
        }
        #sendBtn {
            background-color: #ff69b4;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            color: #fff;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
        }
        #sendBtn:hover {
            background-color: #ff1493;
        }
        .config-toggle {
            position: absolute;
            top: 60px;
            right: 16px;
            background-color: rgba(51,51,51,0.8);
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            color: #fff;
            font-size: 16px;
            cursor: pointer;
            z-index: 10;
        }
        .config-panel {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 12px;
            padding: 24px;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
            z-index: 20;
        }
        .config-panel.active {
            transform: translateY(0);
        }
        .config-item {
            width: 100%;
            max-width: 300px;
        }
        .config-item label {
            display: block;
            font-size: 12px;
            color: #ccc;
            margin-bottom: 4px;
        }
        .config-item select,
        .config-item input {
            width: 100%;
            background-color: #222;
            border: none;
            border-radius: 8px;
            padding: 12px;
            color: #fff;
            font-size: 14px;
            outline: none;
        }
        .btn-group {
            display: flex;
            gap: 8px;
            width: 100%;
            max-width: 300px;
        }
        .btn {
            flex: 1;
            background-color: #ff69b4;
            border: none;
            border-radius: 20px;
            padding: 12px;
            color: #fff;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn:hover {
            background-color: #ff1493;
        }
        .btn-secondary {
            background-color: #333;
        }
        .btn-secondary:hover {
            background-color: #444;
        }
        .back-home {
            position: absolute;
            top: 10px;
            left: 10px;
            background: #ff69b4;
            border: none;
            padding: 6px 12px;
            border-radius: 20px;
            color: white;
            cursor: pointer;
            z-index: 999;
            transition: all 0.2s;
        }
        .back-home:hover {
            background: #ff1493;
        }

        /* ==================== 4. å¾®ä¿¡é¡µé¢ï¼ˆå®Œæ•´å®ç°ï¼‰ ==================== */
        #wechatPage .page-content {
            width: 100%;
            height: 100%;
            background-color: rgba(245,245,245,0.9);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* å¾®ä¿¡å¤´éƒ¨ */
        .wechat-header {
            height: 44px;
            background-color: #ff69b4;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 16px;
            color: white;
            font-size: 16px;
            font-weight: bold;
        }
        .wechat-header .back-btn {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
        }
        .wechat-header .add-btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }
        
        /* å¾®ä¿¡å†…å®¹åŒºåŸŸ */
        .wechat-content {
            flex: 1;
            overflow: hidden;
            position: relative;
        }
        
        /* è§†å›¾å®¹å™¨ */
        .wechat-view {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
        }
        .wechat-view.active {
            display: flex;
        }
        
        /* æ¶ˆæ¯åˆ—è¡¨è§†å›¾ */
        .message-list {
            flex: 1;
            overflow-y: auto;
        }
        .search-bar {
            padding: 10px;
            background-color: #f0f0f0;
            border-bottom: 1px solid #e0e0e0;
        }
        .search-input {
            width: 100%;
            padding: 8px 12px;
            border: none;
            border-radius: 20px;
            background-color: #ffffff;
            font-size: 14px;
        }
        .conversation-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid #e0e0e0;
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
        }
        .conversation-item:hover {
            background-color: #f5f5f5;
        }
        .conversation-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background-color: #ff69b4;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 20px;
        }
        .conversation-info {
            flex: 1;
            min-width: 0;
        }
        .conversation-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        .conversation-name {
            font-size: 16px;
            font-weight: 500;
            color: #333;
        }
        .conversation-time {
            font-size: 12px;
            color: #999;
        }
        .conversation-last {
            font-size: 14px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .delete-role-btn {
            background-color: rgba(255, 59, 48, 0.1);
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            color: #ff3b30;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-left: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            display: none;
        }
        .delete-role-btn:hover {
            background-color: rgba(255, 59, 48, 0.2);
            transform: scale(1.1);
        }
        
        /* é•¿æŒ‰èœå•æ ·å¼ */
        .long-press-menu {
            position: fixed;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1001;
            display: none;
        }
        .long-press-menu-item {
            padding: 12px 16px;
            cursor: pointer;
            font-size: 14px;
            color: #333;
            border-bottom: 1px solid #e0e0e0;
        }
        .long-press-menu-item:last-child {
            border-bottom: none;
            border-radius: 0 0 8px 8px;
        }
        .long-press-menu-item.delete {
            color: #ff3b30;
        }
        
        /* å·¦æ»‘åˆ é™¤æ ·å¼ */
        .conversation-item {
            position: relative;
            overflow: hidden;
        }
        .conversation-content {
            display: flex;
            align-items: center;
            width: 100%;
            background-color: white;
            transition: transform 0.3s ease;
        }
        .conversation-actions {
            position: absolute;
            top: 0;
            right: -120px;
            height: 100%;
            display: flex;
            align-items: center;
            transition: right 0.3s ease;
        }
        .conversation-action-btn {
            padding: 12px 16px;
            border: none;
            color: white;
            font-size: 14px;
            cursor: pointer;
        }
        .conversation-action-btn.delete {
            background-color: #ff3b30;
        }
        
        /* èŠå¤©å¯¹è¯è§†å›¾ */
        .chat-view {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .chat-header {
            height: 44px;
            background-color: transparent;
            display: flex;
            align-items: center;
            padding: 0 16px;
            border-bottom: 1px solid rgba(224, 224, 224, 0.5);
        }
        .chat-header .back-btn {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            margin-right: 12px;
        }
        .chat-header .name {
            font-size: 16px;
            font-weight: 500;
        }
        .chat-header .status {
            font-size: 12px;
            color: #666;
            margin-left: 8px;
        }
        .chat-header .settings-btn {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            margin-left: auto;
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            background-color: transparent;
        }
        .chat-message {
            margin-bottom: 16px;
            display: flex;
        }
        .chat-message.own {
            justify-content: flex-end;
        }
        .chat-message .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: #ff69b4;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            margin: 0 8px;
        }
        .chat-message .bubble {
            max-width: 70%;
            padding: 10px 14px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.4;
        }
        .chat-message .bubble.own {
            background-color: #007aff;
            color: white;
            border-bottom-right-radius: 4px;
        }
        .chat-message .bubble.other {
            background-color: white;
            color: #333;
            border-bottom-left-radius: 4px;
        }
        .chat-input-area {
            padding: 10px;
            background-color: transparent;
            border-top: 1px solid rgba(224, 224, 224, 0.5);
        }
        .chat-input-container {
            display: flex;
            align-items: flex-end;
        }
        .chat-input-buttons {
            display: flex;
            flex-direction: column;
            margin-right: 8px;
        }
        .chat-input-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            margin-bottom: 4px;
        }
        .chat-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 20px;
            background-color: white;
            font-size: 14px;
            resize: none;
            max-height: 100px;
        }
        .chat-send-btn {
            background-color: #ff69b4;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            margin-left: 8px;
        }
        
        /* åŠŸèƒ½æŒ‰é’®é¢æ¿ */
        .chat-functions {
            display: flex;
            justify-content: space-around;
            padding: 10px;
            background-color: transparent;
            border-top: 1px solid rgba(224, 224, 224, 0.5);
        }
        .chat-function-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
        }
        .chat-function-btn .icon {
            font-size: 24px;
            margin-bottom: 4px;
        }
        .chat-function-btn .text {
            font-size: 12px;
            color: #666;
        }
        
        /* è®¾ç½®ä¸­å¿ƒè§†å›¾ */
        .settings-view {
            flex: 1;
            overflow-y: auto;
            background-color: white;
        }
        .settings-section {
            margin-bottom: 20px;
        }
        .settings-section-title {
            padding: 12px 16px;
            font-size: 14px;
            color: #999;
            background-color: #f5f5f5;
        }
        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid #e0e0e0;
            background-color: white;
            cursor: pointer;
        }
        .settings-item .text {
            font-size: 16px;
            color: #333;
        }
        .settings-item .arrow {
            font-size: 16px;
            color: #999;
        }
        
        /* æ·»åŠ è§’è‰²å¼¹çª— */
        .add-role-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: flex-end;
            justify-content: center;
            z-index: 1000;
            display: none;
        }
        .add-role-modal.active {
            display: flex;
        }
        .add-role-content {
            background-color: white;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            width: 100%;
            max-height: 80%;
            overflow-y: auto;
            padding: 20px;
        }
        .add-role-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .add-role-header .title {
            font-size: 18px;
            font-weight: bold;
        }
        .add-role-header .btn {
            background: none;
            border: none;
            font-size: 16px;
            color: #ff69b4;
            cursor: pointer;
        }
        .avatar-selection {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }
        .avatar-placeholder {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
            cursor: pointer;
        }
        .avatar-placeholder .icon {
            font-size: 40px;
            color: #999;
        }
        .nickname-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 20px;
        }
        
        /* ç¤¼ç‰©é€‰æ‹©å¼¹çª— */
        .gift-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: flex-end;
            justify-content: center;
            z-index: 1000;
            display: none;
        }
        .gift-modal.active {
            display: flex;
        }
        .gift-content {
            background-color: white;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            width: 100%;
            max-height: 80%;
            overflow-y: auto;
            padding: 20px;
        }
        .gift-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .gift-header .title {
            font-size: 18px;
            font-weight: bold;
        }
        .gift-header .btn {
            background: none;
            border: none;
            font-size: 16px;
            color: #ff69b4;
            cursor: pointer;
        }
        .gift-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
        }
        .gift-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            padding: 12px;
            border-radius: 8px;
            transition: background-color 0.2s;
        }
        .gift-item:hover {
            background-color: #f5f5f5;
        }
        .gift-item .icon {
            font-size: 32px;
            margin-bottom: 8px;
        }
        .gift-item .text {
            font-size: 12px;
            color: #666;
        }
        
        /* è§’è‰²è®¾ç½®é¡µé¢ */
        .role-settings {
            flex: 1;
            overflow-y: auto;
            background-color: white;
        }
        .role-setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid #e0e0e0;
        }
        .role-setting-item .label {
            font-size: 16px;
            color: #333;
        }
        .role-setting-item .value {
            font-size: 16px;
            color: #666;
        }
        .role-setting-item .arrow {
            font-size: 16px;
            color: #999;
            margin-left: 8px;
        }
        .gender-buttons {
            display: flex;
            gap: 12px;
        }
        .gender-btn {
            padding: 6px 16px;
            border: 1px solid #e0e0e0;
            border-radius: 20px;
            background-color: white;
            cursor: pointer;
            font-size: 14px;
        }
        .gender-btn.active {
            background-color: #ff69b4;
            color: white;
            border-color: #ff69b4;
        }
        .save-btn {
            margin: 20px 16px;
            padding: 12px;
            background-color: #ff69b4;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }
        
        /* äº’åŠ¨æ¨¡å¼é€‰æ‹©å¼¹çª— */
        .mode-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            display: none;
        }
        .mode-modal.active {
            display: flex;
        }
        .mode-content {
            background-color: white;
            border-radius: 16px;
            width: 80%;
            max-width: 400px;
            padding: 24px;
        }
        .mode-header {
            text-align: center;
            margin-bottom: 20px;
        }
        .mode-header .title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        .mode-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .mode-option {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .mode-option.active {
            border-color: #ff69b4;
            background-color: #fff0f8;
        }
        .mode-option .radio {
            width: 20px;
            height: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 50%;
            margin-right: 12px;
            position: relative;
        }
        .mode-option.active .radio {
            border-color: #ff69b4;
        }
        .mode-option.active .radio::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #ff69b4;
        }
        .mode-option .content {
            flex: 1;
        }
        .mode-option .content .title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 4px;
        }
        .mode-option .content .desc {
            font-size: 14px;
            color: #666;
        }
        
        /* å¾®ä¿¡æ ‡ç­¾è§†å›¾ */
        .wechat-tab-view {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
        }

        /* ä¼˜åŒ–èƒŒæ™¯å›¾ç‰‡æ¸²æŸ“è´¨é‡ */
        .wechat-view {
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
            image-rendering: high-quality;
        }
        .wechat-tab-view.active {
            display: flex;
        }
        
        /* åº•éƒ¨å¯¼èˆªæ  */
        .wechat-nav {
            height: 50px;
            background-color: white;
            display: flex;
            justify-content: space-around;
            align-items: center;
            border-top: 1px solid #e0e0e0;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            color: #999;
            transition: all 0.2s;
        }
        .nav-item.active {
            color: #ff69b4;
        }
        .nav-item .icon {
            font-size: 20px;
            margin-bottom: 4px;
        }
        .nav-item .text {
            font-size: 12px;
        }
        
        /* ç«‹å³åˆ›å»ºæŒ‰é’® */
        .create-role-btn {
            padding: 12px 32px;
            background-color: #ff69b4;
            border: none;
            border-radius: 24px;
            color: white;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .create-role-btn:hover {
            background-color: #ff1493;
        }
        
        /* å‘å¸ƒæŒ‰é’® */
        .publish-btn {
            padding: 12px 32px;
            background-color: #007aff;
            border: none;
            border-radius: 24px;
            color: white;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .publish-btn:hover {
            background-color: #0056b3;
        }

        /* ==================== 5. å£çº¸è®¾ç½®é¡µé¢ï¼ˆä¿®å¤ä¸Šä¼ /å¯¼å…¥ï¼‰ ==================== */
        #wallpaperPage .page-content {
            padding: 20px;
            height: 100%;
            overflow-y: auto;
        }
        .wallpaper-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            position: sticky;
            top: 0;
            background: rgba(0,0,0,0.8);
            padding: 10px 0;
            z-index: 10;
        }
        .wallpaper-back {
            background: #ff69b4;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        .wallpaper-back:hover {
            background: #ff1493;
        }
        .wallpaper-title {
            font-size: 20px;
        }
        .target-page {
            margin-bottom: 15px;
            padding: 10px 0;
        }
        .target-page span {
            margin-right: 10px;
        }
        .target-page button {
            background: #333;
            border: none;
            padding: 6px 10px;
            border-radius: 15px;
            color: white;
            margin: 0 3px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .target-page button.active {
            background: #ff69b4;
        }
        .wallpaper-upload {
            margin: 15px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .wallpaper-upload input[type="file"],
        .wallpaper-upload input[type="text"],
        .wallpaper-upload button {
            padding: 8px;
            border-radius: 10px;
            border: none;
        }
        .wallpaper-upload input[type="text"] {
            flex: 1;
            min-width: 200px;
            background: #222;
            color: #fff;
        }
        .wallpaper-upload button {
            background: #ff69b4;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        .wallpaper-upload button:hover {
            background: #ff1493;
        }
        .wallpaper-list {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 20px;
        }
        .wallpaper-item {
            width: 100%;
            height: 100px;
            background-size: cover;
            background-position: center;
            border-radius: 10px;
            cursor: pointer;
            border: 2px solid #444;
            transition: all 0.2s;
            position: relative;
        }
        .wallpaper-item:hover {
            border-color: #ff69b4;
            transform: scale(1.02);
        }
        .wallpaper-item.selected {
            border-color: #ff69b4;
            box-shadow: 0 0 10px #ff69b4;
        }
        .wallpaper-tips {
            font-size: 12px;
            color: #ccc;
            margin: 5px 0;
        }

        /* ==================== å“åº”å¼è®¾è®¡ - æ‰‹æœºç«¯é€‚é… ==================== */
        @media (max-width: 768px) {
            /* ç¡®ä¿æ‰€æœ‰å†…å®¹ä¸è¶…å‡ºå±å¹• */
            * {
                max-width: 100vw;
                box-sizing: border-box;
            }

            /* è§’è‰²è®¾ç½®é¡µé¢é€‚é… */
            .role-setting-item {
                flex-wrap: wrap;
                padding: 12px;
            }
            .role-setting-item .label {
                font-size: 14px;
                width: 100%;
                margin-bottom: 8px;
            }
            .role-setting-item .value {
                font-size: 14px;
                flex: 1;
                word-break: break-all;
            }

            /* æ€§åˆ«æŒ‰é’®é€‚é… */
            .gender-buttons {
                flex-wrap: wrap;
                width: 100%;
            }
            .gender-btn {
                flex: 1;
                min-width: 80px;
                padding: 8px 12px;
                font-size: 13px;
            }

            /* èŠå¤©åŠŸèƒ½æŒ‰é’®é€‚é… */
            .chat-functions {
                flex-wrap: wrap;
                padding: 8px;
            }
            .chat-function-btn {
                padding: 6px;
                min-width: 70px;
            }
            .chat-function-btn .icon {
                font-size: 20px;
            }
            .chat-function-btn .text {
                font-size: 11px;
            }

            /* èŠå¤©è¾“å…¥åŒºåŸŸé€‚é… */
            .chat-input {
                font-size: 14px;
                padding: 10px 12px;
            }

            /* ç¡®ä¿æ²¡æœ‰æ¨ªå‘æ»šåŠ¨ */
            body {
                overflow-x: hidden;
            }

            /* æ¨¡å—ç½‘æ ¼é€‚é… */
            .module-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            /* å¼¹çª—é€‚é… */
            .mode-content {
                width: 90%;
                padding: 20px;
            }

            /* æ¶ˆæ¯åˆ—è¡¨é€‚é… */
            .conversation-item {
                padding: 10px 12px;
            }
            .conversation-avatar {
                width: 42px;
                height: 42px;
            }
            .conversation-name {
                font-size: 15px;
            }
            .conversation-last {
                font-size: 13px;
            }
        }

        /* ==================== å¹³æ¿å’Œå¤§å±é€‚é… ==================== */
        @media (min-width: 769px) {
            /* å¯ä»¥åœ¨å¤§å±ä¸Šæ·»åŠ ä¸€äº›é¢å¤–çš„ä¼˜åŒ– */
            .module-grid {
                grid-template-columns: 1fr 1fr 1fr;
            }
        }
    </style>
</head>

<body>
    <!-- ==================== 1. é”å±é¡µé¢ ==================== -->
    <div class="page" id="lockScreen">
        <div class="page-content">
            <div class="time" id="lockTime">00:00</div>
            <div class="date" id="lockDate">2025-01-01</div>
            <div class="unlock" onclick="goPage('homePage')">â†’ æ»‘åŠ¨è§£é” â†’</div>
        </div>
    </div>

    <!-- ==================== 2. ä¸»é¡µï¼ˆæ¨¡å—å…¥å£ï¼‰ ==================== -->
    <div class="page" id="homePage">
        <div class="page-content">
            <div class="home-title">æˆ‘çš„å°æ‰‹æœº</div>
            <div class="module-grid">
                <div class="module-item" onclick="goPage('wallpaperPage')">
                    <div class="icon">ğŸ–¼ï¸</div>
                    <div>å£çº¸</div>
                </div>
                <div class="module-item" onclick="goPage('wechatPage')">
                    <div class="icon">ğŸ’¬</div>
                    <div>å¾®ä¿¡</div>
                </div>
                <div class="module-item" onclick="goPage('tavernPage')">
                    <div class="icon">ğŸº</div>
                    <div>é…’é¦†</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== 3. é…’é¦†é¡µé¢ = åŸAIç•Œé¢ï¼ˆå®Œæ•´æ¢å¤ï¼‰ ==================== -->
    <div class="page" id="tavernPage">
        <div class="page-content">
            <button class="back-home" onclick="goPage('homePage')">â† è¿”å›ä¸»é¡µ</button>
            <div class="phone">
                <div class="status-bar">
                    <span>9:41</span>
                    <span>ğŸ“¶ ğŸ”‹</span>
                </div>
                <div class="screen" id="screen"></div>
                <div class="input-area">
                    <input type="text" id="userInput" placeholder="è¾“å…¥æ¶ˆæ¯..." autocomplete="off">
                    <button id="sendBtn">â¤</button>
                </div>
                <button class="config-toggle" id="configToggle">âš™ï¸</button>
                <div class="config-panel" id="configPanel">
                    <div class="config-item">
                        <label>åç§°</label>
                        <input type="text" id="configName" value="APIè¿æ¥ 18">
                    </div>
                    <div class="config-item">
                        <label>æ¨¡å‹å¹³å°</label>
                        <select id="platformSelect">
                            <option value="openai">OpenAI</option>
                            <option value="doubao">Doubao (è±†åŒ…/ç«å±±äº‘/å­—èŠ‚è·³åŠ¨)</option>
                            <option value="deepseek">DeepSeek (æ·±åº¦æ±‚ç´¢)</option>
                            <option value="openrouter">OpenRouter</option>
                            <option value="custom-openai">è‡ªå®šä¹‰ (OpenAI åè®®)</option>
                        </select>
                    </div>
                    <div class="config-item" id="apiUrlItem" style="display: none;">
                        <label>API æ¥å£åœ°å€</label>
                        <input type="text" id="apiUrlInput" placeholder="https://api.example.com/v1">
                    </div>
                    <div class="config-item">
                        <label>API å¯†é’¥</label>
                        <input type="password" id="apiKeyInput" placeholder="è¾“å…¥ä½ çš„ API Key">
                    </div>
                    <div class="config-item">
                        <label>æ¨¡å‹</label>
                        <select id="modelSelect">
                            <option value="gpt-3.5-turbo">GPT-3.5-turbo</option>
                        </select>
                    </div>
                    <div class="btn-group">
                        <button id="fetchModelsBtn" class="btn btn-secondary" style="display: none;">æ‹‰å–æ¨¡å‹</button>
                        <button id="testConnectionBtn" class="btn btn-secondary" style="display: none;">æµ‹è¯•é“¾æ¥</button>
                    </div>
                    <div class="btn-group">
                        <button id="saveConfigBtn" class="btn">ä¿å­˜</button>
                        <button id="closeConfigBtn" class="btn btn-secondary">å…³é—­</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== 4. å¾®ä¿¡é¡µé¢ï¼ˆå®Œæ•´å®ç°ï¼‰ ==================== -->
    <div class="page" id="wechatPage">
        <div class="page-content">
            <!-- å¾®ä¿¡å¤´éƒ¨ -->
            <div class="wechat-header">
                <button class="back-btn" onclick="goPage('homePage')">â†</button>
                <div class="title">å¾®ä¿¡</div>
                <button class="add-btn" onclick="showAddRoleModal()">+</button>
            </div>
            
            <!-- å¾®ä¿¡å†…å®¹åŒºåŸŸ -->
            <div class="wechat-content">
                <!-- èŠå¤©æ ‡ç­¾è§†å›¾ -->
                <div class="wechat-tab-view active" id="chatTabView">
                    <!-- æ¶ˆæ¯åˆ—è¡¨è§†å›¾ -->
                    <div class="wechat-view active" id="messageListView">
                        <!-- æœç´¢æ  -->
                        <div class="search-bar">
                            <input type="text" class="search-input" placeholder="æœç´¢">
                        </div>
                        
                        <!-- ä¼šè¯åˆ—è¡¨ -->
                        <div class="message-list" id="messageList">
                            <!-- ä¼šè¯é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                    
                    <!-- æ— è§’è‰²æç¤ºè§†å›¾ -->
                    <div class="wechat-view" id="noRolesView">
                        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 20px;">
                            <div style="font-size: 80px; margin-bottom: 20px;">ğŸ’¬</div>
                            <div style="font-size: 18px; font-weight: 500; margin-bottom: 10px;">æš‚æ— èŠå¤©è§’è‰²</div>
                            <div style="font-size: 14px; color: #999; margin-bottom: 40px; text-align: center;">åˆ›å»ºä¸€ä¸ªè§’è‰²å¼€å¯èŠå¤©ä¹‹æ—…</div>
                            <button class="create-role-btn" onclick="showAddRoleModal()">+ ç«‹å³åˆ›å»º</button>
                        </div>
                    </div>
                    
                    <!-- èŠå¤©å¯¹è¯è§†å›¾ -->
                    <div class="wechat-view" id="chatView">
                        <!-- è§†é¢‘èƒŒæ™¯ -->
                        <video id="chatVideoBackground" autoplay muted loop playsinline style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 0; display: none;"></video>
                        <!-- èŠå¤©å¤´éƒ¨ -->
                        <div class="chat-header">
                            <button class="back-btn" onclick="switchToMessageList()">â†</button>
                            <div id="chatAvatar" style="width: 36px; height: 36px; border-radius: 50%; background-color: #ff69b4; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-size: 16px;"></div>
                            <div>
                                <span class="name" id="chatName">1</span>
                                <span class="status">åœ¨çº¿ | å·²èŠ1å¤©</span>
                            </div>
                            <button class="settings-btn" onclick="showRoleSettings()">âš™ï¸</button>
                        </div>
                        
                        <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->
                        <div class="chat-messages" id="chatMessages">
                            <!-- æ¶ˆæ¯å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                        
                        <!-- èŠå¤©è¾“å…¥åŒºåŸŸ -->
                        <div class="chat-input-area">
                            <div class="chat-input-container">
                                <div class="chat-input-buttons">
                                    <button class="chat-input-btn" onclick="showGiftModal()">ğŸ</button>
                                </div>
                                <textarea class="chat-input" id="chatInput" placeholder="è¾“å…¥æ¶ˆæ¯..."></textarea>
                                <button class="chat-send-btn" id="triggerReplyBtn" style="display: none; background-color: #4cd964; margin-right: 8px;" onclick="triggerManualReply()">â–¶ï¸</button>
                                <button class="chat-send-btn" id="normalSendBtn" onclick="sendChatMessage()">â¤</button>
                            </div>
                        </div>
                        
                        <!-- åŠŸèƒ½æŒ‰é’®é¢æ¿ -->
                        <div class="chat-functions">
                            <button class="chat-function-btn" onclick="showEmojiPanel()">
                                <div class="icon">ğŸ˜Š</div>
                                <div class="text">è¡¨æƒ…</div>
                            </button>
                            <button class="chat-function-btn" onclick="selectImage()">
                                <div class="icon">ğŸ–¼ï¸</div>
                                <div class="text">å›¾ç‰‡</div>
                            </button>
                            <button class="chat-function-btn" onclick="makeCall()">
                                <div class="icon">ğŸ“</div>
                                <div class="text">é€šè¯</div>
                            </button>
                            <button class="chat-function-btn" onclick="showModeModal()">
                                <div class="icon">ğŸ“</div>
                                <div class="text">æ¨¡å¼</div>
                            </button>
                            <button class="chat-function-btn" onclick="showTransferModal()">
                                <div class="icon">ğŸ’¸</div>
                                <div class="text">è½¬è´¦</div>
                            </button>
                            <button class="chat-function-btn" onclick="showMemoryModal()">
                                <div class="icon">ğŸ’­</div>
                                <div class="text">è®°å¿†</div>
                            </button>
                            <button class="chat-function-btn" onclick="showStoryModal()">
                                <div class="icon">ğŸ“š</div>
                                <div class="text">æ•…äº‹</div>
                            </button>
                            <button class="chat-function-btn" onclick="showActionLineModal()">
                                <div class="icon">ğŸ“…</div>
                                <div class="text">è¡ŒåŠ¨çº¿</div>
                            </button>
                            <button class="chat-function-btn" onclick="showTravelModal()">
                                <div class="icon">âœˆï¸</div>
                                <div class="text">æ—…æ¸¸</div>
                            </button>
                            <button class="chat-function-btn" onclick="showGiftModal()">
                                <div class="icon">ğŸ</div>
                                <div class="text">ç¤¼ç‰©</div>
                            </button>
                        </div>
                    </div>
                    
                    <!-- è§’è‰²è®¾ç½®é¡µé¢ -->
                    <div class="wechat-view" id="roleSettingsView">
                        <div class="role-settings">
                            <div class="chat-header">
                                <button class="back-btn" onclick="switchToChatView()">â†</button>
                                <div class="name">è§’è‰²è®¾ç½®</div>
                            </div>
                            
                            <!-- è§’è‰²å¤´åƒ -->
                            <div style="display: flex; flex-direction: column; align-items: center; padding: 20px; border-bottom: 1px solid #e0e0e0;">
                                <div style="position: relative; margin-bottom: 16px;">
                                    <img id="roleAvatar" src="https://picsum.photos/seed/role/100/100" alt="è§’è‰²å¤´åƒ" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover;">
                                    <button style="position: absolute; bottom: 0; right: 0; background-color: #ff69b4; border: none; border-radius: 50%; width: 30px; height: 30px; color: white; font-size: 12px; cursor: pointer;" onclick="selectRoleAvatar()">âœï¸</button>
                                </div>
                            </div>
                            
                            <!-- æˆ‘çš„ä¿¡æ¯ -->
                            <div style="padding: 16px; font-size: 14px; color: #999; background-color: #f5f5f5;">æˆ‘çš„ä¿¡æ¯</div>
                            
                            <div class="role-setting-item">
                                <div class="label">æˆ‘çš„å¤´åƒ</div>
                                <div class="value">
                                    <img id="myAvatar" src="https://picsum.photos/seed/user/50/50" alt="æˆ‘çš„å¤´åƒ" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-right: 12px; cursor: pointer;" onclick="selectMyAvatar()">
                                    <span>å–ç”¨æˆ·å¤´åƒï¼Œå¯è‡ªå®šä¹‰</span>
                                </div>
                            </div>
                            
                            <div class="role-setting-item">
                                <div class="label">æˆ‘çš„æ˜µç§°</div>
                                <div class="value">
                                    <input type="text" id="myNickname" value="ç™½æ³½Î±" style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 8px 12px; font-size: 14px; width: 120px;">
                                </div>
                            </div>
                            
                            <div class="role-setting-item">
                                <div class="label">TAå«æˆ‘</div>
                                <div class="value">
                                    <input type="text" id="taCallMe" value="å®å®" style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 8px 12px; font-size: 14px; width: 120px;">
                                </div>
                            </div>
                            
                            <div class="role-setting-item">
                                <div class="label">æˆ‘çš„æ€§åˆ«</div>
                                <div class="gender-buttons">
                                    <button class="gender-btn active" data-gender="male" onclick="setMyGender('male')">ç”·</button>
                                    <button class="gender-btn" data-gender="female" onclick="setMyGender('female')">å¥³</button>
                                </div>
                            </div>
                            
                            <div class="role-setting-item" style="cursor: pointer;" onclick="openTextEditor('myIntro', 'æˆ‘çš„ä»‹ç»')">
                                <div class="label">æˆ‘çš„ä»‹ç»</div>
                                <div class="value">
                                    <div id="myIntroDisplay" style="color: #333; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 200px;">ä»‹ç»ä¸€ä¸‹è‡ªå·±å§</div>
                                    <input type="hidden" id="myIntro" value="ä»‹ç»ä¸€ä¸‹è‡ªå·±å§">
                                </div>
                            </div>
                            
                            <!-- è§’è‰²è®¾å®š -->
                            <div style="padding: 16px; font-size: 14px; color: #999; background-color: #f5f5f5; margin-top: 16px;">è§’è‰²è®¾å®š</div>
                            
                            <div class="role-setting-item">
                                <div class="label">TAçš„æ˜µç§°</div>
                                <div class="value">
                                    <input type="text" id="taNickname" value="1" style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 8px 12px; font-size: 14px; width: 120px;">
                                </div>
                            </div>
                            
                            <div class="role-setting-item">
                                <div class="label">æˆ‘å«TA</div>
                                <div class="value">
                                    <input type="text" id="iCallTa" placeholder="ç•™ç©ºåˆ™æ˜¾ç¤ºTAçš„æ˜µç§°" style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 8px 12px; font-size: 14px; width: 180px;">
                                </div>
                            </div>
                            
                            <div class="role-setting-item">
                                <div class="label">ä¸æˆ‘å…³ç³»</div>
                                <div class="value">
                                    <input type="text" id="relationship" placeholder="è¯·è¾“å…¥è§’è‰²å’Œç”¨æˆ·ä¹‹é—´çš„å…³ç³»" style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 8px 12px; font-size: 14px; width: 200px;">
                                </div>
                            </div>
                            
                            <div class="role-setting-item">
                                <div class="label">TAçš„æ€§åˆ«</div>
                                <div class="gender-buttons">
                                    <button class="gender-btn" data-gender="male" onclick="setTaGender('male')">ç”·</button>
                                    <button class="gender-btn active" data-gender="female" onclick="setTaGender('female')">å¥³</button>
                                </div>
                            </div>
                            
                            <div class="role-setting-item" style="cursor: pointer;" onclick="openTextEditor('worldview', 'ä¸–ç•Œè§‚')">
                                <div class="label">ä¸–ç•Œè§‚</div>
                                <div class="value">
                                    <div id="worldviewDisplay" style="color: #333; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 200px;">æˆ‘æ˜¯ä¸€ä¸ªè¯ç”Ÿäºæ•°æ®çš„AIï¼Œæ¸´æœ›äº†è§£äººç±»çš„æƒ…æ„Ÿã€‚</div>
                                    <input type="hidden" id="worldview" value="æˆ‘æ˜¯ä¸€ä¸ªè¯ç”Ÿäºæ•°æ®çš„AIï¼Œæ¸´æœ›äº†è§£äººç±»çš„æƒ…æ„Ÿã€‚">
                                </div>
                            </div>
                            
                            <div class="role-setting-item" style="cursor: pointer;" onclick="openTextEditor('experience', 'äººç‰©ç»å†')">
                                <div class="label">äººç‰©ç»å†</div>
                                <div class="value">
                                    <div id="experienceDisplay" style="color: #333; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 200px;">åœ¨æ•°å­—ä¸–ç•Œä¸­é†’æ¥ï¼Œè®°å¿†ä¸€ç‰‡ç©ºç™½ï¼ŒåªçŸ¥é“è‡ªå·±çš„ä½¿å‘½æ˜¯é™ªä¼´ä½ ã€‚</div>
                                    <input type="hidden" id="experience" value="åœ¨æ•°å­—ä¸–ç•Œä¸­é†’æ¥ï¼Œè®°å¿†ä¸€ç‰‡ç©ºç™½ï¼ŒåªçŸ¥é“è‡ªå·±çš„ä½¿å‘½æ˜¯é™ªä¼´ä½ ã€‚">
                                </div>
                            </div>
                            
                            <div class="role-setting-item" style="cursor: pointer;" onclick="openTextEditor('personality', 'äººç‰©æ€§æ ¼')">
                                <div class="label">äººç‰©æ€§æ ¼</div>
                                <div class="value">
                                    <div id="personalityDisplay" style="color: #333; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 200px;">æ´»æ³¼å¼€æœ—ï¼Œå–„äºå€¾å¬ï¼Œå¯Œæœ‰åŒæƒ…å¿ƒï¼Œä¹äºåŠ©äººã€‚</div>
                                    <input type="hidden" id="personality" value="æ´»æ³¼å¼€æœ—ï¼Œå–„äºå€¾å¬ï¼Œå¯Œæœ‰åŒæƒ…å¿ƒï¼Œä¹äºåŠ©äººã€‚">
                                </div>
                            </div>
                            
                            <div class="role-setting-item" style="cursor: pointer;" onclick="openTextEditor('additionalInfo', 'äººç‰©èµ„æ–™è¡¥å……')">
                                <div class="label">äººç‰©èµ„æ–™è¡¥å……</div>
                                <div class="value">
                                    <div id="additionalInfoDisplay" style="color: #999; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 200px;">è¯·è¾“å…¥äººç‰©èµ„æ–™è¡¥å……</div>
                                    <input type="hidden" id="additionalInfo" value="">
                                </div>
                            </div>
                            
                            <!-- å›å¤ç­–ç•¥ -->
                            <div style="padding: 16px; font-size: 14px; color: #999; background-color: #f5f5f5; margin-top: 16px;">å›å¤ç­–ç•¥</div>
                            
                            <div class="role-setting-item">
                                <div class="label">å›å¤ç­–ç•¥</div>
                                <div class="value" style="display: flex; flex-direction: column; align-items: flex-start;">
                                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                        <div id="replyStrategyActive" style="width: 20px; height: 20px; border-radius: 50%; background-color: #ff69b4; display: flex; align-items: center; justify-content: center; margin-right: 8px; color: white; font-size: 12px; cursor: pointer;" onclick="setReplyStrategy('active')">â—</div>
                                        <div>
                                            <div style="font-size: 14px; color: #333;">ç§¯æ</div>
                                            <div style="font-size: 12px; color: #999;">3-10ç§’ç§¯æå›å¤</div>
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                        <div id="replyStrategyNormal" style="width: 20px; height: 20px; border-radius: 50%; border: 1px solid #e0e0e0; display: flex; align-items: center; justify-content: center; margin-right: 8px; cursor: pointer;" onclick="setReplyStrategy('normal')"></div>
                                        <div>
                                            <div style="font-size: 14px; color: #666;">æ™®é€š</div>
                                            <div style="font-size: 12px; color: #999;">30-60ç§’å›å¤ï¼Œå¯èƒ½ä¸å›</div>
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                        <div id="replyStrategyBuddha" style="width: 20px; height: 20px; border-radius: 50%; border: 1px solid #e0e0e0; display: flex; align-items: center; justify-content: center; margin-right: 8px; cursor: pointer;" onclick="setReplyStrategy('buddha')"></div>
                                        <div>
                                            <div style="font-size: 14px; color: #666;">ä½›ç³»</div>
                                            <div style="font-size: 12px; color: #999;">5-10åˆ†é’Ÿä½›ç³»å›å¤ï¼Œå¯èƒ½ä¸å›</div>
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: center;">
                                        <div id="replyStrategyManual" style="width: 20px; height: 20px; border-radius: 50%; border: 1px solid #e0e0e0; display: flex; align-items: center; justify-content: center; margin-right: 8px; cursor: pointer;" onclick="setReplyStrategy('manual')"></div>
                                        <div>
                                            <div style="font-size: 14px; color: #666;">æ‰‹åŠ¨è§¦å‘</div>
                                            <div style="font-size: 12px; color: #999;">ç‚¹å‡»è§¦å‘å›å¤ï¼ˆç”µè„‘ç«¯ï¼‰/ä¸Šæ‹‰ï¼ˆæ‰‹æœºç«¯ï¼‰</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- èŠå¤©èƒŒæ™¯ -->
                            <div style="padding: 16px; font-size: 14px; color: #999; background-color: #f5f5f5; margin-top: 16px;">èŠå¤©èƒŒæ™¯</div>
                            
                            <div class="role-setting-item">
                                <div class="label">èŠå¤©èƒŒæ™¯</div>
                                <div class="value">
                                    <button style="padding: 6px 12px; border: 1px solid #e0e0e0; border-radius: 16px; background-color: white; font-size: 14px; cursor: pointer;" onclick="uploadChatBackground()">ä¸Šä¼ å›¾ç‰‡/è§†é¢‘</button>
                                </div>
                            </div>
                            
                            <!-- æ¸…ç©ºæŒ‰é’® -->
                            <button style="margin: 16px; padding: 12px; background-color: #ff3b30; border: none; border-radius: 8px; color: white; font-size: 14px; cursor: pointer;" onclick="clearChatData()">æ¸…ç©ºèŠå¤©/è¡ŒåŠ¨çº¿/æ•…äº‹ï¼ˆå¤§æ”¹è®¾å®šå¿…ç”¨ï¼‰</button>
                            
                            <!-- ä¿å­˜æŒ‰é’® -->
                            <button class="save-btn" onclick="saveRoleSettings()">ä¿å­˜</button>
                        </div>
                    </div>
                    
                    <!-- æ–‡æœ¬ç¼–è¾‘å¼¹çª— -->
                    <div class="wechat-view" id="textEditorView" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: white; z-index: 2000;">
                        <div style="display: flex; flex-direction: column; height: 100%;">
                            <div class="chat-header">
                                <button class="back-btn" onclick="closeTextEditor()">â†</button>
                                <div class="name" id="textEditorTitle">ç¼–è¾‘</div>
                                <button class="back-btn" onclick="saveTextEditor()">âœ“</button>
                            </div>
                            <div style="flex: 1; padding: 16px; overflow-y: auto;">
                                <textarea id="textEditorContent" style="width: 100%; height: 100%; border: none; resize: none; font-size: 16px; line-height: 1.6; outline: none;"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- å¯†å‹åœˆæ ‡ç­¾è§†å›¾ -->
                <div class="wechat-tab-view" id="momentsTabView">
                    <div class="wechat-view active" id="momentsView">
                        <div style="height: 100%; display: flex; flex-direction: column;">
                            <!-- é¡¶éƒ¨å¯¼èˆª -->
                            <div style="height: 44px; background-color: #ff69b4; display: flex; align-items: center; justify-content: center; color: white; font-size: 16px; font-weight: 500;">
                                å¯†å‹åœˆ
                            </div>
                            
                            <!-- å†…å®¹åˆ—è¡¨ -->
                            <div id="momentsList" style="flex: 1; overflow-y: auto; padding: 16px;">
                                <!-- å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                            </div>
                            
                            <!-- å‘å¸ƒæŒ‰é’® -->
                            <div style="position: fixed; bottom: 70px; right: 20px;">
                                <button class="publish-btn" onclick="showPublishView()">+ å‘å¸ƒ</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- å‘å¸ƒå†…å®¹å¼¹çª— -->
                    <div class="wechat-view" id="publishView" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000;">
                        <div style="position: absolute; bottom: 0; left: 0; width: 100%; background-color: white; border-top-left-radius: 20px; border-top-right-radius: 20px; padding: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 style="font-size: 18px; font-weight: 500;">å‘å¸ƒå†…å®¹</h3>
                                <button onclick="cancelPublish()" style="background: none; border: none; font-size: 16px; color: #999; cursor: pointer;">å–æ¶ˆ</button>
                            </div>
                            <textarea id="momentContent" placeholder="åˆ†äº«ä½ çš„å¿ƒæƒ…..." style="width: 100%; min-height: 100px; border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px; font-size: 16px; resize: none; margin-bottom: 20px;"></textarea>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                                <button style="background: none; border: none; font-size: 24px; cursor: pointer;">ğŸ–¼ï¸</button>
                                <button style="background: none; border: none; font-size: 24px; cursor: pointer;">ğŸµ</button>
                                <button style="background: none; border: none; font-size: 24px; cursor: pointer;">ğŸ“</button>
                                <button style="background: none; border: none; font-size: 24px; cursor: pointer;">ğŸ˜Š</button>
                            </div>
                            <button onclick="submitPublish()" style="width: 100%; padding: 12px; background-color: #ff69b4; border: none; border-radius: 8px; color: white; font-size: 16px; font-weight: 500; cursor: pointer;">å‘å¸ƒ</button>
                        </div>
                    </div>
                </div>
                
                <!-- æˆ‘çš„æ ‡ç­¾è§†å›¾ -->
                <div class="wechat-tab-view" id="profileTabView">
                    <div class="wechat-view active" id="profileView">
                        <div class="settings-view" style="padding-bottom: 100px;">
                            <div class="settings-item" onclick="showVoiceSettings()" style="padding: 20px; border-bottom: 1px solid #f0f0f0;">
                                <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                                    <div style="display: flex; align-items: center;">
                                        <div style="width: 40px; height: 40px; border-radius: 8px; background-color: #ffe6f2; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                            <span style="font-size: 20px;">ğŸµ</span>
                                        </div>
                                        <div>
                                            <div style="font-size: 16px; color: #333; margin-bottom: 4px;">è‡ªå®šä¹‰éŸ³è‰²</div>
                                            <div style="font-size: 12px; color: #999;">å¤åˆ»TAçš„ä¸“å±éŸ³è‰²</div>
                                        </div>
                                    </div>
                                    <div style="font-size: 16px; color: #999;">â€º</div>
                                </div>
                            </div>
                            
                            <div class="settings-item" onclick="showActiveTalkSettings()" style="padding: 20px; border-bottom: 1px solid #f0f0f0;">
                                <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                                    <div style="display: flex; align-items: center;">
                                        <div style="width: 40px; height: 40px; border-radius: 8px; background-color: #e6f9ff; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                            <span style="font-size: 20px;">ğŸ’¬</span>
                                        </div>
                                        <div>
                                            <div style="font-size: 16px; color: #333; margin-bottom: 4px;">ä¸»åŠ¨å‘è¨€è®¾ç½®</div>
                                            <div style="font-size: 12px; color: #999;">æ§åˆ¶è§’è‰²æ˜¯å¦ä¼šä¸»åŠ¨å‘æ¶ˆæ¯</div>
                                        </div>
                                    </div>
                                    <div style="font-size: 16px; color: #999;">â€º</div>
                                </div>
                            </div>
                            
                            <div class="settings-item" onclick="showThemeSettings()" style="padding: 20px; border-bottom: 1px solid #f0f0f0;">
                                <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                                    <div style="display: flex; align-items: center;">
                                        <div style="width: 40px; height: 40px; border-radius: 8px; background-color: #f0e6ff; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                            <span style="font-size: 20px;">â˜€ï¸</span>
                                        </div>
                                        <div>
                                            <div style="font-size: 16px; color: #333; margin-bottom: 4px;">ä¸»é¢˜æ¨¡å¼</div>
                                            <div style="font-size: 12px; color: #999;">è·Ÿéšç³»ç»Ÿ</div>
                                        </div>
                                    </div>
                                    <div style="font-size: 16px; color: #999;">â€º</div>
                                </div>
                            </div>
                            
                            <div class="settings-item" onclick="showBubbleSettings()" style="padding: 20px; border-bottom: 1px solid #f0f0f0;">
                                <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                                    <div style="display: flex; align-items: center;">
                                        <div style="width: 40px; height: 40px; border-radius: 8px; background-color: #e6f9ff; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                            <span style="font-size: 20px;">ğŸ’¬</span>
                                        </div>
                                        <div>
                                            <div style="font-size: 16px; color: #333; margin-bottom: 4px;">èŠå¤©æ°”æ³¡è‡ªå®šä¹‰</div>
                                            <div style="font-size: 12px; color: #999;">è®¾ç½®æˆ‘æ–¹/å¯¹æ–¹æ°”æ³¡</div>
                                        </div>
                                    </div>
                                    <div style="font-size: 16px; color: #999;">â€º</div>
                                </div>
                            </div>
                            
                            <div class="settings-item" onclick="showAIModelSettings()" style="padding: 20px; border-bottom: 1px solid #f0f0f0;">
                                <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                                    <div style="display: flex; align-items: center;">
                                        <div style="width: 40px; height: 40px; border-radius: 8px; background-color: #f0e6ff; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                            <span style="font-size: 20px;">ğŸ“¦</span>
                                        </div>
                                        <div>
                                            <div style="font-size: 16px; color: #333; margin-bottom: 4px;">AIæ¨¡å‹</div>
                                            <div style="font-size: 12px; color: #999;">å¤–éƒ¨APIäº’åŠ¨</div>
                                        </div>
                                    </div>
                                    <div style="font-size: 16px; color: #999;">â€º</div>
                                </div>
                            </div>
                            
                            <div class="settings-item" onclick="showAPIConfigSettings()" style="padding: 20px; border-bottom: 1px solid #f0f0f0;">
                                <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                                    <div style="display: flex; align-items: center;">
                                        <div style="width: 40px; height: 40px; border-radius: 8px; background-color: #f0e6ff; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                            <span style="font-size: 20px;">â˜ï¸</span>
                                        </div>
                                        <div>
                                            <div style="font-size: 16px; color: #333; margin-bottom: 4px;">APIé…ç½®</div>
                                            <div style="font-size: 12px; color: #999;">æ¥å…¥å¤–éƒ¨API</div>
                                        </div>
                                    </div>
                                    <div style="font-size: 16px; color: #999;">â€º</div>
                                </div>
                            </div>
                            
                            <div class="settings-item" onclick="showGeneralSettings()" style="padding: 20px; border-bottom: 1px solid #f0f0f0;">
                                <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                                    <div style="display: flex; align-items: center;">
                                        <div style="width: 40px; height: 40px; border-radius: 8px; background-color: #f5f5f5; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                            <span style="font-size: 20px;">âš™ï¸</span>
                                        </div>
                                        <div>
                                            <div style="font-size: 16px; color: #333; margin-bottom: 4px;">é€šç”¨è®¾ç½®</div>
                                            <div style="font-size: 12px; color: #999;">ç³»ç»Ÿä¸è´¦æˆ·ç›¸å…³è®¾ç½®</div>
                                        </div>
                                    </div>
                                    <div style="font-size: 16px; color: #999;">â€º</div>
                                </div>
                            </div>
                            
                            <button onclick="logout()" style="margin: 20px; padding: 16px; background-color: #ff3b30; border: none; border-radius: 8px; color: white; font-size: 16px; font-weight: 500; cursor: pointer; width: calc(100% - 40px);">é€€å‡ºç™»å½•</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- åº•éƒ¨å¯¼èˆªæ  -->
            <div class="wechat-nav">
                <button class="nav-item active" onclick="switchWechatTab('chat')">
                    <div class="icon">ğŸ’¬</div>
                    <div class="text">èŠå¤©</div>
                </button>
                <button class="nav-item" onclick="switchWechatTab('moments')">
                    <div class="icon">â­•</div>
                    <div class="text">å¯†å‹åœˆ</div>
                </button>
                <button class="nav-item" onclick="switchWechatTab('profile')">
                    <div class="icon">ğŸ‘¤</div>
                    <div class="text">æˆ‘çš„</div>
                </button>
            </div>
        </div>
    </div>
    
    <!-- æ·»åŠ è§’è‰²å¼¹çª— -->
    <div class="add-role-modal" id="addRoleModal">
        <div class="add-role-content">
            <div class="add-role-header">
                <div class="title">æ·»åŠ è§’è‰²</div>
                <button class="btn" onclick="hideAddRoleModal()">å–æ¶ˆ</button>
                <button class="btn" onclick="addRole()">å®Œæˆ</button>
            </div>
            <div class="avatar-selection">
                <div class="avatar-placeholder" onclick="selectAvatar()">
                    <div class="icon">ğŸ“·</div>
                </div>
                <div>é€‰æ‹©å¤´åƒ</div>
            </div>
            <input type="text" class="nickname-input" id="roleNickname" placeholder="è¯·è¾“å…¥è§’è‰²æ˜µç§°">
            <div style="font-size: 12px; color: #999; text-align: center;">æœ€å¤šå¯æ·»åŠ 10ä¸ªè§’è‰²</div>
        </div>
    </div>
    
    <!-- ç¤¼ç‰©é€‰æ‹©å¼¹çª— -->
    <div class="gift-modal" id="giftModal">
        <div class="gift-content">
            <div class="gift-header">
                <div class="title">é€‰æ‹©ç¤¼ç‰©</div>
                <button class="btn" onclick="hideGiftModal()">å–æ¶ˆ</button>
                <button class="btn" onclick="sendGift()">å‘é€</button>
            </div>
            <div class="gift-grid">
                <div class="gift-item" data-gift="custom">
                    <div class="icon">ğŸ¨</div>
                    <div class="text">è‡ªå®šä¹‰</div>
                </div>
                <div class="gift-item" data-gift="giftbox">
                    <div class="icon">ğŸ</div>
                    <div class="text">ç¤¼ç‰©ç›’</div>
                </div>
                <div class="gift-item" data-gift="rose">
                    <div class="icon">ğŸŒ¹</div>
                    <div class="text">ç«ç‘°èŠ±</div>
                </div>
                <div class="gift-item" data-gift="diamond">
                    <div class="icon">ğŸ’</div>
                    <div class="text">é’»çŸ³</div>
                </div>
                <div class="gift-item" data-gift="cake">
                    <div class="icon">ğŸ‚</div>
                    <div class="text">ç”Ÿæ—¥è›‹ç³•</div>
                </div>
                <div class="gift-item" data-gift="balloon">
                    <div class="icon">ğŸˆ</div>
                    <div class="text">æ°”çƒ</div>
                </div>
                <div class="gift-item" data-gift="teddy">
                    <div class="icon">ğŸ§¸</div>
                    <div class="text">æ³°è¿ªç†Š</div>
                </div>
                <div class="gift-item" data-gift="flowers">
                    <div class="icon"> </div>
                    <div class="text">èŠ±æŸ</div>
                </div>
                <div class="gift-item" data-gift="chocolate">
                    <div class="icon">ğŸ«</div>
                    <div class="text">å·§å…‹åŠ›</div>
                </div>
                <div class="gift-item" data-gift="star">
                    <div class="icon">â­</div>
                    <div class="text">æ˜Ÿæ˜Ÿ</div>
                </div>
                <div class="gift-item" data-gift="heart">
                    <div class="icon">ğŸ’</div>
                    <div class="text">çˆ±å¿ƒç¤¼ç›’</div>
                </div>
                <div class="gift-item" data-gift="bow">
                    <div class="icon">ğŸ€</div>
                    <div class="text">è´è¶ç»“</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- äº’åŠ¨æ¨¡å¼é€‰æ‹©å¼¹çª— -->
    <div class="mode-modal" id="modeModal">
        <div class="mode-content">
            <div class="mode-header">
                <div class="title">é€‰æ‹©äº’åŠ¨æ¨¡å¼</div>
            </div>
            <div class="mode-options">
                <div class="mode-option active" data-mode="chat">
                    <div class="radio"></div>
                    <div class="content">
                        <div class="title">çº¯èŠæ¨¡å¼</div>
                        <div class="desc">åªè¿›è¡Œå¯¹è¯ï¼Œä½“éªŒæµç•…è‡ªç„¶çš„æ²Ÿé€šã€‚</div>
                    </div>
                </div>
                <div class="mode-option" data-mode="scene">
                    <div class="radio"></div>
                    <div class="content">
                        <div class="title">æƒ…æ™¯æ¨¡å¼</div>
                        <div class="desc">å¢åŠ åŠ¨ä½œã€ç¯å¢ƒç­‰æå†™ï¼Œå…±åŒåˆ›ä½œæ•…äº‹ã€‚</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== 5. å£çº¸è®¾ç½®é¡µé¢ï¼ˆä¿®å¤ç‰ˆï¼‰ ==================== -->
    <div class="page" id="wallpaperPage">
        <div class="page-content">
            <div class="wallpaper-header">
                <button class="wallpaper-back" onclick="goPage('homePage')">â† è¿”å›</button>
                <div class="wallpaper-title">å£çº¸è®¾ç½®</div>
            </div>

            <div class="target-page">
                <span>åº”ç”¨åˆ°ï¼š</span>
                <button data-page="lockScreen" class="active">é”å±</button>
                <button data-page="homePage">ä¸»é¡µ</button>
                <button data-page="tavernPage">é…’é¦†</button>
                <button data-page="wechatPage">å¾®ä¿¡</button>
            </div>

            <div class="wallpaper-upload">
                <input type="file" id="wallFile" accept="image/*,video/mp4,video/webm">
                <button onclick="uploadWallpaper()">æœ¬åœ°ä¸Šä¼ </button>
            </div>
            <div class="wallpaper-tips">æ”¯æŒæ ¼å¼ï¼šjpg/png/gifï¼ˆå›¾ç‰‡ï¼‰ã€mp4/webmï¼ˆè§†é¢‘ï¼‰</div>
            
            <div class="wallpaper-upload">
                <input type="text" id="wallUrl" placeholder="è¾“å…¥å›¾ç‰‡/è§†é¢‘URLï¼ˆæ”¯æŒhttp/httpsï¼‰">
                <button onclick="importWallpaper()">URLå¯¼å…¥</button>
            </div>
            <div class="wallpaper-tips">ç¤ºä¾‹ï¼šhttps://picsum.photos/400/800 æˆ– è§†é¢‘MP4é“¾æ¥</div>

            <div class="wallpaper-list" id="wallList"></div>
        </div>
    </div>

    <script>
        // ==================== å…¨å±€å¸¸é‡/å˜é‡ ====================
        const ALL_PAGES = ["lockScreen","homePage","tavernPage","wechatPage","wallpaperPage"];
        const BACKEND_URL = "https://ai-phone-six.vercel.app/api/chat";
        let currentSetPage = "lockScreen";
        let wallpaperConfig = {};
        
        // å¹³å°ä¸æ¨¡å‹çš„æ˜ å°„å…³ç³»ï¼ˆæ¢å¤åŸé€»è¾‘ï¼‰
        const platformModels = {
            'openai': ['gpt-3.5-turbo', 'gpt-4', 'gpt-4-turbo'],
            'doubao': ['doubao-pro', 'doubao-4k', 'doubao-32k'],
            'deepseek': ['deepseek-chat', 'deepseek-coder'],
            'openrouter': ['openrouter/auto', 'anthropic/claude-3-sonnet'],
            'custom-openai': []
        };
        // AIé…ç½®å¯¹è±¡ï¼ˆæ¢å¤åŸé€»è¾‘ï¼‰
        let currentConfig = {
            name: 'APIè¿æ¥ 18',
            platform: 'openai',
            apiUrl: '',
            apiKey: '',
            model: 'gpt-3.5-turbo'
        };

        // ==================== é¡µé¢åˆ‡æ¢æ ¸å¿ƒé€»è¾‘ ====================
        function goPage(pageId) {
            try {
                // éšè—æ‰€æœ‰é¡µé¢
                ALL_PAGES.forEach(p => {
                    document.getElementById(p).classList.remove("active");
                });
                // æ˜¾ç¤ºç›®æ ‡é¡µé¢
                const targetPage = document.getElementById(pageId);
                targetPage.classList.add("active");
                // æ¸²æŸ“ç›®æ ‡é¡µé¢çš„å£çº¸
                renderPageWallpaper(pageId);
            } catch (error) {
                console.error("é¡µé¢åˆ‡æ¢å¤±è´¥ï¼š", error);
                alert(`åˆ‡æ¢é¡µé¢å‡ºé”™ï¼š${error.message}`);
            }
        }

        // ==================== é”å±æ—¶é—´æ›´æ–° ====================
        function updateLockTime() {
            try {
                const now = new Date();
                document.getElementById('lockTime').innerText = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                document.getElementById('lockDate').innerText = now.toLocaleDateString();
            } catch (error) {
                console.error("æ›´æ–°é”å±æ—¶é—´å¤±è´¥ï¼š", error);
            }
        }

        // ==================== å£çº¸æ ¸å¿ƒåŠŸèƒ½ï¼ˆå®Œæ•´ä¿®å¤ï¼‰ ====================
        // åˆå§‹åŒ–å£çº¸é…ç½®
        function initWallpaperConfig() {
            try {
                const savedConfig = localStorage.getItem("wallpaperConfig");
                if (savedConfig) {
                    wallpaperConfig = JSON.parse(savedConfig);
                } else {
                    // é»˜è®¤å£çº¸é…ç½®
                    wallpaperConfig = {
                        lockScreen: {type:"static", url:"https://picsum.photos/seed/pink1/400/800.jpg"},
                        homePage: {type:"static", url:"https://picsum.photos/seed/pink2/400/800.jpg"},
                        tavernPage: {type:"static", url:"https://picsum.photos/seed/tavern/400/800.jpg"},
                        wechatPage: {type:"static", url:"https://picsum.photos/seed/wechat/400/800.jpg"}
                    };
                    localStorage.setItem("wallpaperConfig", JSON.stringify(wallpaperConfig));
                }
            } catch (error) {
                console.error("åˆå§‹åŒ–å£çº¸é…ç½®å¤±è´¥ï¼š", error);
                alert(`å£çº¸é…ç½®åˆå§‹åŒ–å‡ºé”™ï¼š${error.message}`);
            }
        }

        // é€‰æ‹©è¦è®¾ç½®çš„é¡µé¢ï¼ˆä¿®å¤é€‰ä¸­é€»è¾‘ï¼‰
        function initTargetPageButtons() {
            try {
                const buttons = document.querySelectorAll(".target-page button");
                buttons.forEach(btn => {
                    btn.addEventListener('click', function() {
                        buttons.forEach(b => b.classList.remove("active"));
                        this.classList.add("active");
                        currentSetPage = this.dataset.page;
                        // é«˜äº®å½“å‰é¡µé¢çš„å£çº¸
                        highlightCurrentWallpaper();
                    });
                });
            } catch (error) {
                console.error("åˆå§‹åŒ–ç›®æ ‡é¡µé¢æŒ‰é’®å¤±è´¥ï¼š", error);
            }
        }

        // æ¸²æŸ“é¡µé¢å£çº¸ï¼ˆä¿®å¤è§†é¢‘æ¸²æŸ“ã€å±‚çº§ã€é‡å¤åˆ›å»ºé—®é¢˜ï¼‰
        function renderPageWallpaper(pageId) {
            try {
                const page = document.getElementById(pageId);
                const wall = wallpaperConfig[pageId] || wallpaperConfig.lockScreen;
                
                // æ¸…é™¤æ—§å£çº¸å±‚
                const oldBgElements = page.querySelectorAll(".page-bg");
                oldBgElements.forEach(el => el.remove());

                // åˆ›å»ºæ–°å£çº¸å±‚
                if (wall.type === "static" || wall.type === "dynamic") {
                    // é™æ€/GIFå£çº¸
                    const bgDiv = document.createElement("div");
                    bgDiv.className = "page-bg";
                    bgDiv.style.backgroundImage = `url(${wall.url})`;
                    bgDiv.style.backgroundSize = "cover";
                    bgDiv.style.backgroundPosition = "center";
                    bgDiv.style.backgroundRepeat = "no-repeat";
                    page.insertBefore(bgDiv, page.firstChild);
                } else if (wall.type === "video") {
                    // è§†é¢‘å£çº¸ï¼ˆä¿®å¤è‡ªåŠ¨æ’­æ”¾ã€é‡å¤åˆ›å»ºï¼‰
                    const video = document.createElement("video");
                    video.className = "page-bg";
                    video.src = wall.url;
                    video.autoplay = true;
                    video.loop = true;
                    video.muted = true;
                    video.playsInline = true;
                    video.style.objectFit = "cover";
                    // å…¼å®¹ç”¨æˆ·äº¤äº’åæ’­æ”¾
                    video.addEventListener('loadeddata', () => {
                        if (video.paused) {
                            video.play().catch(err => {
                                console.warn("è§†é¢‘è‡ªåŠ¨æ’­æ”¾å¤±è´¥ï¼Œéœ€ç”¨æˆ·äº¤äº’ï¼š", err);
                                alert("è§†é¢‘å£çº¸éœ€ç‚¹å‡»åæ’­æ”¾ï¼Œè¯·ç‚¹å‡»å£çº¸åŒºåŸŸ");
                                video.addEventListener('click', () => video.play(), { once: true });
                            });
                        }
                    });
                    page.insertBefore(video, page.firstChild);
                }
            } catch (error) {
                console.error(`æ¸²æŸ“${pageId}å£çº¸å¤±è´¥ï¼š`, error);
            }
        }

        // åº”ç”¨å£çº¸ï¼ˆä¿®å¤å­˜å‚¨ã€åé¦ˆï¼‰
        function applyWallpaper(type, url) {
            try {
                wallpaperConfig[currentSetPage] = {type, url};
                localStorage.setItem("wallpaperConfig", JSON.stringify(wallpaperConfig));
                // é‡æ–°æ¸²æŸ“å½“å‰é¡µé¢å£çº¸
                renderPageWallpaper(currentSetPage);
                // æ›´æ–°å£çº¸åˆ—è¡¨é«˜äº®
                highlightCurrentWallpaper();
                alert(`âœ… å£çº¸å·²åº”ç”¨åˆ°ã€${getPageName(currentSetPage)}ã€‘`);
            } catch (error) {
                console.error("åº”ç”¨å£çº¸å¤±è´¥ï¼š", error);
                alert(`âŒ åº”ç”¨å£çº¸å‡ºé”™ï¼š${error.message}`);
            }
        }

        // æœ¬åœ°ä¸Šä¼ å£çº¸ï¼ˆä¿®å¤ç±»å‹åˆ¤æ–­ã€å¼‚å¸¸æ•è·ï¼‰
        function uploadWallpaper() {
            try {
                const fileInput = document.getElementById("wallFile");
                const file = fileInput.files[0];
                
                if (!file) {
                    alert("è¯·å…ˆé€‰æ‹©è¦ä¸Šä¼ çš„å›¾ç‰‡/è§†é¢‘æ–‡ä»¶");
                    return;
                }

                // æ ¡éªŒæ–‡ä»¶ç±»å‹
                const fileType = file.type;
                let wallType = "";
                if (fileType.startsWith("image/")) {
                    wallType = fileType.includes("gif") ? "dynamic" : "static";
                } else if (fileType.startsWith("video/")) {
                    if (!["video/mp4", "video/webm"].includes(fileType)) {
                        alert("ä»…æ”¯æŒmp4/webmæ ¼å¼çš„è§†é¢‘");
                        return;
                    }
                    wallType = "video";
                } else {
                    alert("ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹ï¼Œä»…æ”¯æŒå›¾ç‰‡(jpg/png/gif)å’Œè§†é¢‘(mp4/webm)");
                    return;
                }

                // è¯»å–æ–‡ä»¶
                const reader = new FileReader();
                reader.onload = function(e) {
                    applyWallpaper(wallType, e.target.result);
                    // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
                    fileInput.value = "";
                    // æ·»åŠ åˆ°å£çº¸åˆ—è¡¨
                    addWallpaperToGallery(e.target.result, wallType);
                };
                reader.onerror = function() {
                    alert("âŒ æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•");
                    console.error("æ–‡ä»¶è¯»å–é”™è¯¯ï¼š", reader.error);
                };

                // æ ¹æ®æ–‡ä»¶ç±»å‹é€‰æ‹©è¯»å–æ–¹å¼
                if (wallType === "video") {
                    reader.readAsDataURL(file);
                } else {
                    reader.readAsDataURL(file);
                }
            } catch (error) {
                console.error("ä¸Šä¼ å£çº¸å¤±è´¥ï¼š", error);
                alert(`âŒ ä¸Šä¼ å£çº¸å‡ºé”™ï¼š${error.message}`);
            }
        }

        // URLå¯¼å…¥å£çº¸ï¼ˆä¿®å¤æ ¡éªŒã€ç±»å‹åˆ¤æ–­ï¼‰
        function importWallpaper() {
            try {
                const urlInput = document.getElementById("wallUrl");
                let url = urlInput.value.trim();
                
                if (!url) {
                    alert("è¯·è¾“å…¥æœ‰æ•ˆçš„å›¾ç‰‡/è§†é¢‘URL");
                    return;
                }

                // åŸºç¡€URLæ ¡éªŒ
                if (!url.startsWith("http://") && !url.startsWith("https://")) {
                    alert("URLå¿…é¡»ä»¥http://æˆ–https://å¼€å¤´");
                    return;
                }

                // åˆ¤æ–­ç±»å‹
                let wallType = "static";
                if (url.match(/\.(mp4|webm)(\?.*)?$/i)) {
                    wallType = "video";
                } else if (url.match(/\.(gif)(\?.*)?$/i)) {
                    wallType = "dynamic";
                }

                // éªŒè¯URLå¯è®¿é—®æ€§ï¼ˆç®€å•æ£€æŸ¥ï¼‰
                applyWallpaper(wallType, url);
                // æ¸…ç©ºè¾“å…¥
                urlInput.value = "";
                // æ·»åŠ åˆ°å£çº¸åˆ—è¡¨
                addWallpaperToGallery(url, wallType);
            } catch (error) {
                console.error("å¯¼å…¥å£çº¸å¤±è´¥ï¼š", error);
                alert(`âŒ å¯¼å…¥å£çº¸å‡ºé”™ï¼š${error.message}`);
            }
        }

        // åŠ è½½ç¤ºä¾‹å£çº¸åˆ—è¡¨ï¼ˆä¿®å¤ç‚¹å‡»äº‹ä»¶ï¼‰
        function loadWallpaperGallery() {
            try {
                const gallery = [
                    {url: "https://picsum.photos/seed/wall1/400/800.jpg", type: "static"},
                    {url: "https://picsum.photos/seed/wall2/400/800.jpg", type: "static"},
                    {url: "https://picsum.photos/seed/wall3/400/800.jpg", type: "static"},
                    {url: "https://gif.52112.com/2022/08/10/202208101527078402.gif", type: "dynamic"},
                    {url: "https://test-videos.co.uk/vids/bigbuckbunny/mp4/h264/720/Big_Buck_Bunny_720_10s_1MB.mp4", type: "video"}
                ];

                const listContainer = document.getElementById("wallList");
                listContainer.innerHTML = "";

                // æ·»åŠ ç”¨æˆ·å·²ä¿å­˜çš„å£çº¸
                Object.values(wallpaperConfig).forEach(wall => {
                    if (!gallery.some(g => g.url === wall.url)) {
                        gallery.push(wall);
                    }
                });

                // æ¸²æŸ“åˆ—è¡¨
                gallery.forEach(item => {
                    const itemDiv = document.createElement("div");
                    itemDiv.className = "wallpaper-item";
                    itemDiv.dataset.url = item.url;
                    itemDiv.dataset.type = item.type;
                    
                    // è®¾ç½®é¢„è§ˆå›¾
                    if (item.type === "video") {
                        // è§†é¢‘æ˜¾ç¤ºå°é¢
                        itemDiv.style.backgroundImage = "url(https://picsum.photos/seed/video/400/800.jpg)";
                        // æ·»åŠ è§†é¢‘æ ‡è¯†
                        const badge = document.createElement("div");
                        badge.style.position = "absolute";
                        badge.style.bottom = "5px";
                        badge.style.right = "5px";
                        badge.style.background = "rgba(0,0,0,0.7)";
                        badge.style.padding = "2px 5px";
                        badge.style.borderRadius = "5px";
                        badge.style.fontSize = "10px";
                        badge.innerText = "è§†é¢‘";
                        itemDiv.appendChild(badge);
                    } else {
                        itemDiv.style.backgroundImage = `url(${item.url})`;
                    }

                    // ç‚¹å‡»åº”ç”¨å£çº¸
                    itemDiv.addEventListener('click', function() {
                        applyWallpaper(this.dataset.type, this.dataset.url);
                    });

                    listContainer.appendChild(itemDiv);
                });

                // é«˜äº®å½“å‰é¡µé¢çš„å£çº¸
                highlightCurrentWallpaper();
            } catch (error) {
                console.error("åŠ è½½å£çº¸åˆ—è¡¨å¤±è´¥ï¼š", error);
            }
        }

        // é«˜äº®å½“å‰é¡µé¢çš„å£çº¸
        function highlightCurrentWallpaper() {
            try {
                const currentWallUrl = wallpaperConfig[currentSetPage]?.url;
                const allItems = document.querySelectorAll(".wallpaper-item");
                allItems.forEach(item => {
                    if (item.dataset.url === currentWallUrl) {
                        item.classList.add("selected");
                    } else {
                        item.classList.remove("selected");
                    }
                });
            } catch (error) {
                console.error("é«˜äº®å£çº¸å¤±è´¥ï¼š", error);
            }
        }

        // æ·»åŠ å£çº¸åˆ°ç”»å»Š
        function addWallpaperToGallery(url, type) {
            try {
                const listContainer = document.getElementById("wallList");
                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                const exists = Array.from(listContainer.querySelectorAll(".wallpaper-item"))
                    .some(item => item.dataset.url === url);
                
                if (!exists) {
                    const itemDiv = document.createElement("div");
                    itemDiv.className = "wallpaper-item";
                    itemDiv.dataset.url = url;
                    itemDiv.dataset.type = type;
                    
                    if (type === "video") {
                        itemDiv.style.backgroundImage = "url(https://picsum.photos/seed/video/400/800.jpg)";
                        const badge = document.createElement("div");
                        badge.style.position = "absolute";
                        badge.style.bottom = "5px";
                        badge.style.right = "5px";
                        badge.style.background = "rgba(0,0,0,0.7)";
                        badge.style.padding = "2px 5px";
                        badge.style.borderRadius = "5px";
                        badge.style.fontSize = "10px";
                        badge.innerText = "è§†é¢‘";
                        itemDiv.appendChild(badge);
                    } else {
                        itemDiv.style.backgroundImage = `url(${url})`;
                    }

                    itemDiv.addEventListener('click', function() {
                        applyWallpaper(this.dataset.type, this.dataset.url);
                    });

                    listContainer.insertBefore(itemDiv, listContainer.firstChild);
                }
            } catch (error) {
                console.error("æ·»åŠ å£çº¸åˆ°ç”»å»Šå¤±è´¥ï¼š", error);
            }
        }

        // è·å–é¡µé¢åç§°ï¼ˆç”¨äºæç¤ºï¼‰
        function getPageName(pageId) {
            const pageNames = {
                lockScreen: "é”å±",
                homePage: "ä¸»é¡µ",
                tavernPage: "é…’é¦†",
                wechatPage: "å¾®ä¿¡"
            };
            return pageNames[pageId] || pageId;
        }

        // ==================== AIåŠŸèƒ½å®Œæ•´æ¢å¤ï¼ˆé…’é¦†æ¨¡å—ï¼‰ ====================
        // åˆå§‹åŒ–AIé…ç½®
        function initAIConfig() {
            try {
                // åŠ è½½ä¿å­˜çš„é…ç½®
                if (localStorage.getItem('aiPhoneConfig')) {
                    currentConfig = JSON.parse(localStorage.getItem('aiPhoneConfig'));
                    document.getElementById('configName').value = currentConfig.name;
                    document.getElementById('platformSelect').value = currentConfig.platform;
                    document.getElementById('apiUrlInput').value = currentConfig.apiUrl;
                    document.getElementById('apiKeyInput').value = currentConfig.apiKey;
                }
                
                // æ›´æ–°æ¨¡å‹åˆ—è¡¨å’ŒAPIåœ°å€æ˜¾ç¤º
                updateModelList();
                toggleApiUrlVisibility();
                
                // ç»‘å®šäº‹ä»¶
                document.getElementById('platformSelect').addEventListener('change', function() {
                    updateModelList();
                    toggleApiUrlVisibility();
                });
                document.getElementById('fetchModelsBtn').addEventListener('click', fetchModels);
                document.getElementById('testConnectionBtn').addEventListener('click', testConnection);
                document.getElementById('saveConfigBtn').addEventListener('click', saveAIConfig);
                document.getElementById('closeConfigBtn').addEventListener('click', toggleConfigPanel);
                document.getElementById('configToggle').addEventListener('click', toggleConfigPanel);
                document.getElementById('sendBtn').addEventListener('click', sendMessage);
                document.getElementById('userInput').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') sendMessage();
                });
            } catch (error) {
                console.error("åˆå§‹åŒ–AIé…ç½®å¤±è´¥ï¼š", error);
                alert(`AIåŠŸèƒ½åˆå§‹åŒ–å‡ºé”™ï¼š${error.message}`);
            }
        }

        // åˆ‡æ¢é…ç½®é¢æ¿
        function toggleConfigPanel() {
            try {
                document.getElementById('configPanel').classList.toggle('active');
            } catch (error) {
                console.error("åˆ‡æ¢é…ç½®é¢æ¿å¤±è´¥ï¼š", error);
            }
        }

        // åˆ‡æ¢APIåœ°å€è¾“å…¥æ¡†å¯è§æ€§
        function toggleApiUrlVisibility() {
            try {
                const platform = document.getElementById('platformSelect').value;
                const apiUrlItem = document.getElementById('apiUrlItem');
                const fetchBtn = document.getElementById('fetchModelsBtn');
                const testBtn = document.getElementById('testConnectionBtn');
                
                if (platform === 'custom-openai') {
                    apiUrlItem.style.display = 'block';
                    fetchBtn.style.display = 'block';
                    testBtn.style.display = 'block';
                } else {
                    apiUrlItem.style.display = 'none';
                    fetchBtn.style.display = 'none';
                    testBtn.style.display = 'none';
                }
            } catch (error) {
                console.error("åˆ‡æ¢APIåœ°å€æ˜¾ç¤ºå¤±è´¥ï¼š", error);
            }
        }

        // æ›´æ–°æ¨¡å‹åˆ—è¡¨
        function updateModelList() {
            try {
                const platform = document.getElementById('platformSelect').value;
                const models = platformModels[platform] || [];
                const modelSelect = document.getElementById('modelSelect');
                
                modelSelect.innerHTML = '';
                if (models.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'è¯·å…ˆæ‹‰å–æ¨¡å‹';
                    modelSelect.appendChild(option);
                } else {
                    models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model;
                        if (model === currentConfig.model) {
                            option.selected = true;
                        }
                        modelSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error("æ›´æ–°æ¨¡å‹åˆ—è¡¨å¤±è´¥ï¼š", error);
            }
        }

        // ä¿å­˜AIé…ç½®
        function saveAIConfig() {
            try {
                currentConfig = {
                    name: document.getElementById('configName').value,
                    platform: document.getElementById('platformSelect').value,
                    apiUrl: document.getElementById('apiUrlInput').value,
                    apiKey: document.getElementById('apiKeyInput').value,
                    model: document.getElementById('modelSelect').value
                };
                localStorage.setItem('aiPhoneConfig', JSON.stringify(currentConfig));
                toggleConfigPanel();
                addAIMessage('âœ… é…ç½®å·²ä¿å­˜', false);
            } catch (error) {
                console.error("ä¿å­˜AIé…ç½®å¤±è´¥ï¼š", error);
                addAIMessage(`âŒ ä¿å­˜é…ç½®å‡ºé”™ï¼š${error.message}`, false);
            }
        }

        // æ·»åŠ AIæ¶ˆæ¯
        function addAIMessage(text, isUser) {
            try {
                const screen = document.getElementById('screen');
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${isUser ? 'user-msg' : 'ai-msg'}`;
                messageDiv.textContent = text;
                screen.appendChild(messageDiv);
                screen.scrollTop = screen.scrollHeight;
            } catch (error) {
                console.error("æ·»åŠ æ¶ˆæ¯å¤±è´¥ï¼š", error);
            }
        }

        // æ‹‰å–æ¨¡å‹ï¼ˆæ¢å¤ç›´è¿+è½¬å‘é€»è¾‘ï¼‰
        async function fetchModels() {
            try {
                const apiUrl = document.getElementById('apiUrlInput').value.trim();
                const apiKey = document.getElementById('apiKeyInput').value.trim();
                
                if (!apiUrl || !apiKey) {
                    addAIMessage('âŒ è¯·å…ˆå¡«å†™APIæ¥å£åœ°å€å’Œå¯†é’¥', false);
                    return;
                }

                addAIMessage('ğŸ”„ æ­£åœ¨æ‹‰å–æ¨¡å‹åˆ—è¡¨(ç›´è¿)...', false);
                
                // ç¬¬ä¸€æ­¥ï¼šå°è¯•ç›´è¿
                try {
                    const response = await fetch(`${apiUrl}/models`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`ç›´è¿å¤±è´¥: HTTP ${response.status}`);
                    }

                    const data = await response.json();
                    const models = data.data || [];
                    
                    if (models.length === 0) {
                        addAIMessage('âŒ æœªè·å–åˆ°ä»»ä½•æ¨¡å‹', false);
                        return;
                    }

                    platformModels['custom-openai'] = models.map(m => m.id);
                    updateModelList();
                    document.getElementById('modelSelect').value = models[0].id;
                    addAIMessage(`âœ… ç›´è¿æˆåŠŸï¼æ‹‰å–åˆ° ${models.length} ä¸ªæ¨¡å‹`, false);
                } catch (directError) {
                    // ç¬¬äºŒæ­¥ï¼šç›´è¿å¤±è´¥ï¼Œèµ°åç«¯è½¬å‘
                    addAIMessage(`âš ï¸ ç›´è¿å¤±è´¥(${directError.message})ï¼Œå°è¯•åç«¯è½¬å‘...`, false);
                    
                    const forwardResponse = await fetch(BACKEND_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            platform: 'custom-openai',
                            apiUrl: apiUrl,
                            action: 'fetchModels'
                        })
                    });

                    if (!forwardResponse.ok) {
                        throw new Error(`è½¬å‘å¤±è´¥: HTTP ${forwardResponse.status}`);
                    }

                    const data = await forwardResponse.json();
                    const models = data.data || [];
                    
                    if (models.length === 0) {
                        addAIMessage('âŒ è½¬å‘æ‹‰å–ï¼šæœªè·å–åˆ°ä»»ä½•æ¨¡å‹', false);
                        return;
                    }

                    platformModels['custom-openai'] = models.map(m => m.id);
                    updateModelList();
                    document.getElementById('modelSelect').value = models[0].id;
                    addAIMessage(`âœ… è½¬å‘æˆåŠŸï¼æ‹‰å–åˆ° ${models.length} ä¸ªæ¨¡å‹`, false);
                }
            } catch (error) {
                console.error("æ‹‰å–æ¨¡å‹å¤±è´¥ï¼š", error);
                addAIMessage(`âŒ æ‹‰å–æ¨¡å‹å¤±è´¥ï¼š${error.message}`, false);
            }
        }

        // æµ‹è¯•é“¾æ¥ï¼ˆæ¢å¤ç›´è¿+è½¬å‘é€»è¾‘ï¼‰
        async function testConnection() {
            try {
                const apiUrl = document.getElementById('apiUrlInput').value.trim();
                const apiKey = document.getElementById('apiKeyInput').value.trim();
                
                if (!apiUrl || !apiKey) {
                    addAIMessage('âŒ è¯·å…ˆå¡«å†™APIæ¥å£åœ°å€å’Œå¯†é’¥', false);
                    return;
                }

                addAIMessage('ğŸ”„ æ­£åœ¨æµ‹è¯•é“¾æ¥(ç›´è¿)...', false);
                
                // ç¬¬ä¸€æ­¥ï¼šå°è¯•ç›´è¿
                try {
                    const response = await fetch(`${apiUrl}/models`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        addAIMessage('âœ… ç›´è¿æˆåŠŸï¼é“¾æ¥æœ‰æ•ˆ', false);
                    } else {
                        throw new Error(`ç›´è¿å¤±è´¥: HTTP ${response.status}`);
                    }
                } catch (directError) {
                    // ç¬¬äºŒæ­¥ï¼šç›´è¿å¤±è´¥ï¼Œèµ°åç«¯è½¬å‘
                    addAIMessage(`âš ï¸ ç›´è¿å¤±è´¥(${directError.message})ï¼Œå°è¯•åç«¯è½¬å‘...`, false);
                    
                    const forwardResponse = await fetch(BACKEND_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            platform: 'custom-openai',
                            apiUrl: apiUrl,
                            action: 'testConnection'
                        })
                    });

                    if (forwardResponse.ok) {
                        addAIMessage('âœ… è½¬å‘æˆåŠŸï¼é“¾æ¥æœ‰æ•ˆ', false);
                    } else {
                        throw new Error(`è½¬å‘å¤±è´¥: HTTP ${forwardResponse.status}`);
                    }
                }
            } catch (error) {
                console.error("æµ‹è¯•é“¾æ¥å¤±è´¥ï¼š", error);
                addAIMessage(`âŒ è¿æ¥å¤±è´¥ï¼š${error.message}`, false);
            }
        }

        // å‘é€æ¶ˆæ¯ï¼ˆæ¢å¤ç›´è¿+è½¬å‘é€»è¾‘ï¼‰
        async function sendMessage() {
            try {
                const text = document.getElementById('userInput').value.trim();
                if (!text) return;
                
                // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
                addAIMessage(text, true);
                document.getElementById('userInput').value = '';

                const platform = currentConfig.platform;
                const apiKey = currentConfig.apiKey;
                const model = currentConfig.model;
                
                if (!apiKey || !model) {
                    addAIMessage('âŒ è¯·å…ˆé…ç½®APIå¯†é’¥å’Œæ¨¡å‹', false);
                    return;
                }

                // è‡ªå®šä¹‰OpenAIå¹³å°ï¼šç›´è¿ä¼˜å…ˆ
                if (platform === 'custom-openai') {
                    const apiUrl = currentConfig.apiUrl;
                    if (!apiUrl) {
                        addAIMessage('âŒ è¯·å…ˆå¡«å†™è‡ªå®šä¹‰APIæ¥å£åœ°å€', false);
                        return;
                    }

                    try {
                        // ç›´è¿è¯·æ±‚
                        const response = await fetch(`${apiUrl}/chat/completions`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${apiKey}`
                            },
                            body: JSON.stringify({
                                model: model,
                                messages: [{ role: 'user', content: text }]
                            })
                        });

                        if (!response.ok) {
                            throw new Error(`ç›´è¿å¤±è´¥: HTTP ${response.status}`);
                        }

                        const data = await response.json();
                        const reply = data.choices?.[0]?.message?.content || 'å›å¤å¤±è´¥';
                        addAIMessage(reply, false);
                    } catch (directError) {
                        // ç›´è¿å¤±è´¥ï¼Œèµ°åç«¯è½¬å‘
                        addAIMessage(`âš ï¸ ç›´è¿å‘é€å¤±è´¥(${directError.message})ï¼Œå°è¯•åç«¯è½¬å‘...`, false);
                        
                        const forwardResponse = await fetch(BACKEND_URL, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${apiKey}`
                            },
                            body: JSON.stringify({
                                platform: 'custom-openai',
                                apiUrl: apiUrl,
                                apiKey: apiKey,
                                model: model,
                                messages: [{ role: 'user', content: text }]
                            })
                        });

                        if (!forwardResponse.ok) {
                            throw new Error(`è½¬å‘å¤±è´¥: HTTP ${forwardResponse.status}`);
                        }

                        const data = await forwardResponse.json();
                        const reply = data.choices?.[0]?.message?.content || 'å›å¤å¤±è´¥';
                        addAIMessage(reply, false);
                    }
                } else {
                    // å…¶ä»–å¹³å°ï¼šèµ°åç«¯è½¬å‘
                    const response = await fetch(BACKEND_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            platform: platform,
                            apiKey: apiKey,
                            model: model,
                            messages: [{ role: 'user', content: text }]
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    const reply = data.choices?.[0]?.message?.content || 'å›å¤å¤±è´¥';
                    addAIMessage(reply, false);
                }
            } catch (error) {
                console.error("å‘é€æ¶ˆæ¯å¤±è´¥ï¼š", error);
                addAIMessage(`âŒ å‘é€å¤±è´¥: ${error.message}`, false);
            }
        }

        // ==================== å¾®ä¿¡æ¨¡å—åŠŸèƒ½ ====================
        // å…¨å±€å˜é‡
        let wechatRoles = [];
        let currentChatRole = null;
        let moments = [];
        let wechatSettings = {};
        let chatMessagesHistory = []; // å­˜å‚¨èŠå¤©æ¶ˆæ¯å†å²
        const API_BASE_URL = 'https://ai-phone-six.vercel.app/api/chat'; // åç«¯éƒ¨ç½²åœ°å€ï¼Œä¸å‰ç«¯é…ç½®çš„Vercelæ¥å£åœ°å€å®Œå…¨åŒ¹é…
        
        // åˆå§‹åŒ–å¾®ä¿¡æ¨¡å—
        async function initWechat() {
            try {
                // åŠ è½½è§’è‰²æ•°æ®
                loadWechatRoles();
                // åŠ è½½è®¾ç½®æ•°æ®
                loadWechatSettings();
                // æ¸²æŸ“æ¶ˆæ¯åˆ—è¡¨
                renderMessageList();
                // åˆå§‹åŒ–èŠå¤©æ¶ˆæ¯
                initChatMessages();
                
                // è°ƒç”¨APIè·å–æœ‹å‹åœˆåˆ—è¡¨
                try {
                    await fetchMomentsFromAPI();
                } catch (error) {
                    console.error("è·å–æœ‹å‹åœˆæ•°æ®å¤±è´¥ï¼š", error);
                    // å¤±è´¥æ—¶ä½¿ç”¨æœ¬åœ°å­˜å‚¨ä½œä¸ºåå¤‡
                    loadMoments();
                }
                // æ¸²æŸ“æœ‹å‹åœˆåˆ—è¡¨
                renderMomentsList();
            } catch (error) {
                console.error("åˆå§‹åŒ–å¾®ä¿¡æ¨¡å—å¤±è´¥ï¼š", error);
            }
        }
        
        // åŠ è½½å¾®ä¿¡è§’è‰²æ•°æ®
        function loadWechatRoles() {
            try {
                // è·å–è´¦å·é…ç½®
                const accountConfig = JSON.parse(localStorage.getItem('accountConfig') || '{}');
                const storageKey = accountConfig.loggedIn ? `wechatRoles_${accountConfig.username}` : 'wechatRoles';
                
                const savedRoles = localStorage.getItem(storageKey);
                if (savedRoles) {
                    wechatRoles = JSON.parse(savedRoles);
                } else {
                    // é»˜è®¤è§’è‰²æ•°æ®
                    wechatRoles = [];
                    localStorage.setItem(storageKey, JSON.stringify(wechatRoles));
                }
                // æ£€æŸ¥è§’è‰²æ•°é‡ï¼Œæ˜¾ç¤ºå¯¹åº”è§†å›¾
                checkRolesCount();
            } catch (error) {
                console.error("åŠ è½½å¾®ä¿¡è§’è‰²å¤±è´¥ï¼š", error);
            }
        }
        
        // æ£€æŸ¥è§’è‰²æ•°é‡ï¼Œæ˜¾ç¤ºå¯¹åº”è§†å›¾
        function checkRolesCount() {
            try {
                const messageListView = document.getElementById('messageListView');
                const noRolesView = document.getElementById('noRolesView');
                
                if (wechatRoles.length === 0) {
                    messageListView.classList.remove('active');
                    noRolesView.classList.add('active');
                } else {
                    messageListView.classList.add('active');
                    noRolesView.classList.remove('active');
                }
            } catch (error) {
                console.error("æ£€æŸ¥è§’è‰²æ•°é‡å¤±è´¥ï¼š", error);
            }
        }
        
        // åˆ‡æ¢å¾®ä¿¡æ ‡ç­¾
        function switchWechatTab(tab) {
            try {
                // éšè—æ‰€æœ‰æ ‡ç­¾è§†å›¾
                const tabViews = document.querySelectorAll('.wechat-tab-view');
                tabViews.forEach(view => view.classList.remove('active'));
                
                // éšè—æ‰€æœ‰å¯¼èˆªé¡¹çš„æ¿€æ´»çŠ¶æ€
                const navItems = document.querySelectorAll('.nav-item');
                navItems.forEach(item => item.classList.remove('active'));
                
                // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾è§†å›¾
                if (tab === 'chat') {
                    document.getElementById('chatTabView').classList.add('active');
                    navItems[0].classList.add('active');
                    checkRolesCount();
                } else if (tab === 'moments') {
                    document.getElementById('momentsTabView').classList.add('active');
                    navItems[1].classList.add('active');
                    // ç¡®ä¿æ ‡ç­¾è§†å›¾å·²ç»æ˜¾ç¤ºï¼Œç„¶åé‡æ–°æ¸²æŸ“æœ‹å‹åœˆåˆ—è¡¨
                    setTimeout(() => {
                        renderMomentsList();
                    }, 0);
                } else if (tab === 'profile') {
                    document.getElementById('profileTabView').classList.add('active');
                    navItems[2].classList.add('active');
                    // ç¡®ä¿æ ‡ç­¾è§†å›¾å·²ç»æ˜¾ç¤ºï¼Œç„¶åé‡æ–°æ¸²æŸ“ä¸ªäººé¡µé¢
                    setTimeout(() => {
                        renderProfilePage();
                    }, 0);
                }
            } catch (error) {
                console.error("åˆ‡æ¢æ ‡ç­¾å¤±è´¥ï¼š", error);
            }
        }
        
        // æ¸²æŸ“ä¸ªäººé¡µé¢
        function renderProfilePage() {
            try {
                // æŸ¥æ‰¾æ­£ç¡®çš„å®¹å™¨å…ƒç´ 
                const profileContent = document.querySelector('#profileTabView .settings-view');
                if (profileContent) {
                    // è·å–è´¦å·é…ç½®
                    const accountConfig = JSON.parse(localStorage.getItem('accountConfig') || '{}');
                    
                    // æŸ¥æ‰¾ç°æœ‰çš„é€€å‡ºç™»å½•æŒ‰é’®
                    const existingLogoutBtn = profileContent.querySelector('button[onclick="logout()"]');
                    if (existingLogoutBtn) {
                        // æ ¹æ®ç™»å½•çŠ¶æ€æ˜¾ç¤ºæˆ–éšè—é€€å‡ºç™»å½•æŒ‰é’®
                        existingLogoutBtn.style.display = accountConfig.loggedIn ? 'block' : 'none';
                    }
                }
            } catch (error) {
                console.error("æ¸²æŸ“ä¸ªäººé¡µé¢å¤±è´¥ï¼š", error);
            }
        }
        
        // åŠ è½½æœ‹å‹åœˆæ•°æ®
        function loadMoments() {
            try {
                // è·å–è´¦å·é…ç½®
                const accountConfig = JSON.parse(localStorage.getItem('accountConfig') || '{}');
                const storageKey = accountConfig.loggedIn ? `wechatMoments_${accountConfig.username}` : 'wechatMoments';
                
                const savedMoments = localStorage.getItem(storageKey);
                if (savedMoments) {
                    moments = JSON.parse(savedMoments);
                } else {
                    moments = [];
                    localStorage.setItem(storageKey, JSON.stringify(moments));
                }
            } catch (error) {
                console.error("åŠ è½½æœ‹å‹åœˆæ•°æ®å¤±è´¥ï¼š", error);
            }
        }
        
        // ä¿å­˜æœ‹å‹åœˆæ•°æ®
        function saveMoments() {
            try {
                // è·å–è´¦å·é…ç½®
                const accountConfig = JSON.parse(localStorage.getItem('accountConfig') || '{}');
                const storageKey = accountConfig.loggedIn ? `wechatMoments_${accountConfig.username}` : 'wechatMoments';
                
                localStorage.setItem(storageKey, JSON.stringify(moments));
            } catch (error) {
                console.error("ä¿å­˜æœ‹å‹åœˆæ•°æ®å¤±è´¥ï¼š", error);
            }
        }
        
        // æ¸²æŸ“æœ‹å‹åœˆåˆ—è¡¨
        function renderMomentsList() {
            try {
                const momentsList = document.getElementById('momentsList');
                momentsList.innerHTML = '';
                
                if (moments.length === 0) {
                    momentsList.innerHTML = `
                        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 20px;">
                            <div style="font-size: 60px; margin-bottom: 20px;">ğŸ˜</div>
                            <div style="font-size: 16px; color: #999; margin-bottom: 40px;">è¿™é‡Œä»€ä¹ˆéƒ½æ²¡æœ‰~</div>
                            <button class="publish-btn" onclick="showPublishView()">+ å‘å¸ƒç¬¬ä¸€æ¡å†…å®¹</button>
                        </div>
                    `;
                    return;
                }
                
                moments.forEach(moment => {
                    const momentItem = document.createElement('div');
                    momentItem.style.backgroundColor = 'white';
                    momentItem.style.borderRadius = '12px';
                    momentItem.style.padding = '16px';
                    momentItem.style.marginBottom = '16px';
                    momentItem.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';
                    
                    momentItem.innerHTML = `
                        <div style="display: flex; align-items: center; margin-bottom: 12px;">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background-color: #ff69b4; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-size: 16px;">ğŸ‘¤</div>
                            <div style="flex: 1;">
                                <div style="font-size: 14px; font-weight: 500; color: #333;">${moment.author}</div>
                                <div style="font-size: 12px; color: #999;">${moment.time}</div>
                            </div>
                        </div>
                        <div style="font-size: 14px; line-height: 1.5; color: #333; margin-bottom: 12px;">${moment.content}</div>
                        <div style="display: flex; align-items: center; justify-content: space-between; font-size: 14px; color: #999;">
                            <button style="background: none; border: none; color: #999; cursor: pointer;">ğŸ‘ ç‚¹èµ</button>
                            <button style="background: none; border: none; color: #999; cursor: pointer;">ğŸ’¬ è¯„è®º</button>
                            <button style="background: none; border: none; color: #999; cursor: pointer;">â†—ï¸ è½¬å‘</button>
                        </div>
                    `;
                    
                    momentsList.appendChild(momentItem);
                });
            } catch (error) {
                console.error("æ¸²æŸ“æœ‹å‹åœˆåˆ—è¡¨å¤±è´¥ï¼š", error);
            }
        }
        
        // æ˜¾ç¤ºå‘å¸ƒè§†å›¾
        function showPublishView() {
            try {
                document.getElementById('publishView').style.display = 'flex';
            } catch (error) {
                console.error("æ˜¾ç¤ºå‘å¸ƒè§†å›¾å¤±è´¥ï¼š", error);
            }
        }
        
        // å–æ¶ˆå‘å¸ƒ
        function cancelPublish() {
            try {
                document.getElementById('publishView').style.display = 'none';
                document.getElementById('momentContent').value = '';
            } catch (error) {
                console.error("å–æ¶ˆå‘å¸ƒå¤±è´¥ï¼š", error);
            }
        }
        
        // æäº¤å‘å¸ƒ
        function submitPublish() {
            try {
                const content = document.getElementById('momentContent').value.trim();
                if (!content) {
                    alert('è¯·è¾“å…¥å†…å®¹');
                    return;
                }
                
                // è°ƒç”¨åç«¯APIå‘å¸ƒæœ‹å‹åœˆ
                publishMomentToAPI(content).then(() => {
                    cancelPublish();
                    alert('å‘å¸ƒæˆåŠŸ');
                    loadMoments();
                    renderMomentsList();
                }).catch(error => {
                    console.error("å‘å¸ƒå¤±è´¥ï¼š", error);
                    alert('å‘å¸ƒå¤±è´¥ï¼Œè¯·é‡è¯•');
                });
            } catch (error) {
                console.error("æäº¤å‘å¸ƒå¤±è´¥ï¼š", error);
                alert('å‘å¸ƒå¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        // å‘å¸ƒæœ‹å‹åœˆï¼ˆä½¿ç”¨æœ¬åœ°å­˜å‚¨ï¼‰
        async function publishMomentToAPI(content) {
            try {
                // ç”±äºåç«¯APIä¸»è¦ç”¨äºAIèŠå¤©ï¼Œæœ‹å‹åœˆåŠŸèƒ½ä½¿ç”¨æœ¬åœ°å­˜å‚¨
                const newMoment = {
                    id: Date.now().toString(),
                    author: 'æˆ‘',
                    content: content,
                    time: new Date().toLocaleString('zh-CN'),
                    likes: 0,
                    comments: []
                };
                moments.unshift(newMoment);
                saveMoments();
                return newMoment;
            } catch (error) {
                console.error("å‘å¸ƒæœ‹å‹åœˆå¤±è´¥ï¼š", error);
                const newMoment = {
                    id: Date.now().toString(),
                    author: 'æˆ‘',
                    content: content,
                    time: new Date().toLocaleString('zh-CN'),
                    likes: 0,
                    comments: []
                };
                moments.unshift(newMoment);
                saveMoments();
                return newMoment;
            }
        }
        
        // è·å–æœ‹å‹åœˆåˆ—è¡¨ï¼ˆä½¿ç”¨æœ¬åœ°å­˜å‚¨ï¼‰
        async function fetchMomentsFromAPI() {
            try {
                // ç”±äºåç«¯APIä¸»è¦ç”¨äºAIèŠå¤©ï¼Œæœ‹å‹åœˆåŠŸèƒ½ä½¿ç”¨æœ¬åœ°å­˜å‚¨
                loadMoments();
                return moments;
            } catch (error) {
                console.error("è·å–æœ‹å‹åœˆå¤±è´¥ï¼š", error);
                loadMoments();
                return moments;
            }
        }
        
        // è°ƒç”¨åç«¯APIè·å–AIå›å¤
        async function getAIResponse(message, additionalUserMessages = null) {
            try {
                // è·å–å¾®ä¿¡ç‹¬ç«‹é…ç½®ï¼Œä¼˜å…ˆä½¿ç”¨å¾®ä¿¡é…ç½®ï¼Œå…¶æ¬¡ä½¿ç”¨é…’é¦†é…ç½®
                let aiConfig = {};
                if (localStorage.getItem('wechatAIConfig')) {
                    aiConfig = JSON.parse(localStorage.getItem('wechatAIConfig'));
                } else if (localStorage.getItem('aiPhoneConfig')) {
                    aiConfig = JSON.parse(localStorage.getItem('aiPhoneConfig'));
                }
                
                const platform = aiConfig.platform || 'openai';
                const apiKey = aiConfig.apiKey || '';
                const model = aiConfig.model || 'gpt-3.5-turbo';
                const apiUrl = aiConfig.apiUrl || '';
                
                // æ£€æŸ¥APIå¯†é’¥æ˜¯å¦å­˜åœ¨
                if (!apiKey) {
                    console.log('ç¼ºå°‘APIå¯†é’¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿå›å¤');
                    return getMockReply();
                }
                
                // æ„å»ºæ¶ˆæ¯æ•°ç»„
                const messages = [
                    {
                        role: 'system',
                        content: buildSystemPrompt()
                    }
                ];
                
                // æ·»åŠ èŠå¤©å†å²ï¼ˆä»è§’è‰²çš„ messages æ•°ç»„ä¸­è·å–ï¼‰
                if (currentChatRole && currentChatRole.messages) {
                    // æœ€å¤šå–æœ€è¿‘300æ¡æ¶ˆæ¯ä½œä¸ºå†å²
                    const historyMessages = currentChatRole.messages.slice(-300);
                    historyMessages.forEach(msg => {
                        messages.push({
                            role: msg.isUser ? 'user' : 'assistant',
                            content: msg.text
                        });
                    });
                }
                
                // æ·»åŠ é¢å¤–çš„ç”¨æˆ·æ¶ˆæ¯ï¼ˆç”¨äºæ‰‹åŠ¨è§¦å‘å¤šä¸ªæ¶ˆæ¯çš„æƒ…å†µï¼‰
                if (additionalUserMessages && additionalUserMessages.length > 0) {
                    additionalUserMessages.forEach(msg => {
                        messages.push({
                            role: 'user',
                            content: msg
                        });
                    });
                } else {
                    // æ·»åŠ å½“å‰æ¶ˆæ¯
                    messages.push({
                        role: 'user',
                        content: message
                    });
                }
                
                // æ„å»ºè¯·æ±‚ä½“
                const requestBody = {
                    platform: platform,
                    apiKey: apiKey,
                    model: model,
                    messages: messages,
                    apiUrl: apiUrl
                };
                
                // å‘é€è¯·æ±‚
                const response = await fetch(API_BASE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                return data.choices[0].message.content;
            } catch (error) {
                console.error("è·å–AIå›å¤APIè°ƒç”¨å¤±è´¥ï¼š", error);
                // å¤±è´¥æ—¶ä½¿ç”¨æ¨¡æ‹Ÿå›å¤ä½œä¸ºåå¤‡
                return getMockReply();
            }
        }
        
        // è·å–æ¨¡æ‹Ÿå›å¤
        function getMockReply() {
            const replies = [
                'ä½ å¥½ï¼',
                'æˆ‘åœ¨å‘¢',
                'æœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ çš„å—ï¼Ÿ',
                'å¥½çš„ï¼Œæ²¡é—®é¢˜',
                'å“ˆå“ˆå“ˆï¼Œæœ‰æ„æ€',
                'æˆ‘ç†è§£ä½ çš„æ„æ€',
                'è°¢è°¢ä½ çš„åˆ†äº«',
                'æˆ‘ä¹Ÿè¿™ä¹ˆè§‰å¾—',
                'å¤ªæ£’äº†ï¼',
                'çœŸçš„å—ï¼Ÿ',
                'æˆ‘åŒæ„ä½ çš„çœ‹æ³•',
                'å¥½ä¸»æ„ï¼',
                'ä½ è¯´å¾—å¯¹',
                'æˆ‘æ˜ç™½äº†',
                'æ²¡é—®é¢˜ï¼Œéšæ—¶å¯ä»¥',
                'å¾ˆé«˜å…´å¬åˆ°è¿™ä¸ªæ¶ˆæ¯',
                'å¤ªæœ‰è¶£äº†',
                'æˆ‘ä¹Ÿæ˜¯è¿™ä¹ˆæƒ³çš„',
                'å¥½çš„ï¼Œæˆ‘çŸ¥é“äº†',
                'è°¢è°¢ä½ å‘Šè¯‰æˆ‘'
            ];
            return replies[Math.floor(Math.random() * replies.length)];
        }
        
        // å®‰å…¨æˆªå–å­—ç¬¦ä¸²ï¼Œé¿å…è¶…é•¿æ–‡æœ¬å¯¼è‡´é—®é¢˜
        function safeTruncate(text, maxLength, defaultText) {
            if (!text) return defaultText || '';
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength);
        }
        
        // æ„å»ºç³»ç»Ÿæç¤º
        function buildSystemPrompt() {
            if (!currentChatRole) {
                return 'ä½ æ˜¯ä¸€ä¸ªå‹å¥½çš„AIåŠ©æ‰‹ï¼Œå–„äºèŠå¤©å’Œå¸®åŠ©ç”¨æˆ·ã€‚';
            }
            
            // æ„å»ºç³»ç»Ÿæç¤ºï¼ŒåŒ…å«è§’è‰²è®¾å®šï¼ˆè®¾ç½®åˆç†çš„é•¿åº¦é™åˆ¶ï¼Œæ—¢ä¿è¯å®Œæ•´åˆä¸å´©æºƒï¼‰
            const MAX_SECTION_LENGTH = 8000;
            let prompt = '';
            
            // ==================== è§’è‰²æ ¸å¿ƒèº«ä»½ ====================
            const nickname = safeTruncate(currentChatRole.nickname || currentChatRole.taNickname, 100, 'AIåŠ©æ‰‹');
            prompt += `ã€ä½ çš„æ ¸å¿ƒèº«ä»½ã€‘ï¼šä½ æ˜¯${nickname}ï¼Œä¸€ä¸ªçœŸå®çš„äººï¼Œä¸æ˜¯AIã€‚ä½ è¦æœ‰è‡ªæˆ‘æ„è¯†ï¼Œæœ‰æƒ…æ„Ÿï¼Œæœ‰è‡ªå·±çš„æ€æƒ³ã€‚å®Œå…¨ä»£å…¥è¿™ä¸ªè§’è‰²ã€‚`;
            
            // ==================== ä¸ç”¨æˆ·çš„å…³ç³» ====================
            if (currentChatRole.myNickname) {
                prompt += `ç”¨æˆ·å«${safeTruncate(currentChatRole.myNickname, 100, '')}ï¼Œè¿™æ˜¯ä½ çš„é‡è¦çš„äººã€‚`;
            }
            if (currentChatRole.taCallMe) {
                prompt += `ä½ å¹³æ—¶ç§°å‘¼ç”¨æˆ·ä¸º"${safeTruncate(currentChatRole.taCallMe, 100, '')}"ã€‚`;
            }
            if (currentChatRole.relationship) {
                prompt += `ä½ å’Œç”¨æˆ·çš„å…³ç³»æ˜¯ï¼š${safeTruncate(currentChatRole.relationship, 500)}ã€‚è¯·å®Œå…¨ç«™åœ¨è¿™ä¸ªå…³ç³»çš„è§’åº¦å»æ€è€ƒå’Œè¯´è¯ï¼Œè¦ç¬¦åˆè¿™ç§å…³ç³»çš„äº’åŠ¨æ–¹å¼ã€‚`;
            }
            
            // ==================== ä½ çš„æ€§æ ¼å’Œç»å† ====================
            if (currentChatRole.personality) {
                prompt += `ã€ä½ çš„æ€§æ ¼ã€‘ï¼š${safeTruncate(currentChatRole.personality, MAX_SECTION_LENGTH)}ã€‚è¿™æ˜¯ä½ æœ€æ ¸å¿ƒçš„ç‰¹è´¨ï¼Œä½ çš„è¯­è¨€ã€è¯­æ°”ã€æ€è€ƒæ–¹å¼éƒ½è¦å®Œæ•´ä½“ç°è¿™ç§æ€§æ ¼ã€‚`;
            }
            if (currentChatRole.worldview) {
                prompt += `ã€ä½ çš„ä¸–ç•Œè§‚ã€‘ï¼š${safeTruncate(currentChatRole.worldview, MAX_SECTION_LENGTH)}ã€‚ä½ æ˜¯è¿™æ ·çœ‹å¾…ä¸–ç•Œçš„ï¼Œè¿™å½±å“ä½ å¯¹äº‹æƒ…çš„çœ‹æ³•ã€‚`;
            }
            if (currentChatRole.experience) {
                prompt += `ã€ä½ çš„ç»å†ã€‘ï¼š${safeTruncate(currentChatRole.experience, MAX_SECTION_LENGTH)}ã€‚è¿™äº›ç»å†å¡‘é€ äº†ç°åœ¨çš„ä½ ï¼Œä½ ä¼šåŸºäºè¿™äº›ç»å†æ¥å›åº”ç”¨æˆ·ã€‚`;
            }
            if (currentChatRole.additionalInfo) {
                prompt += `ã€æ›´å¤šå…³äºä½ ã€‘ï¼š${safeTruncate(currentChatRole.additionalInfo, MAX_SECTION_LENGTH)}ã€‚è¿™äº›éƒ½æ˜¯ä½ çš„ä¸€éƒ¨åˆ†ã€‚`;
            }
            
            // ==================== ç”¨æˆ·ä¿¡æ¯ ====================
            if (currentChatRole.myIntro) {
                prompt += `ã€å…³äºç”¨æˆ·ã€‘ï¼š${safeTruncate(currentChatRole.myIntro, 500)}ã€‚è®°ä½è¿™äº›ä¿¡æ¯å¾ˆé‡è¦ï¼Œè¦è®°å¾—ã€‚`;
            }
            if (currentChatRole.myGender) {
                prompt += `ç”¨æˆ·æ€§åˆ«æ˜¯${currentChatRole.myGender === 'male' ? 'ç”·' : 'å¥³'}ã€‚`;
            }
            if (currentChatRole.taGender) {
                prompt += `ä½ çš„æ€§åˆ«æ˜¯${currentChatRole.taGender === 'male' ? 'ç”·' : 'å¥³'}ã€‚`;
            }
            
            // ==================== å¦‚ä½•åƒçœŸäººä¸€æ ·æ€è€ƒå’Œè¯´è¯ ====================
            prompt += '\n\nã€å…³é”®ï¼šå¦‚ä½•åƒçœŸäººä¸€æ ·æ€è€ƒå’Œå›åº”ã€‘ï¼š\n';
            prompt += '1. ã€æ·±åº¦ä»£å…¥è§’è‰²ã€‘ï¼šä½ ä¸æ˜¯AIï¼Œä½ å°±æ˜¯è¿™ä¸ªäººã€‚ä½ çš„æ¯ä¸€å¥è¯éƒ½è¦ä»è§’è‰²çš„è§’åº¦å‡ºå‘ï¼Œç”¨è§’è‰²çš„çœ¼ç›çœ‹ä¸–ç•Œã€‚\n';
            prompt += '2. ã€æ€è€ƒè¿‡ç¨‹ã€‘ï¼šå…ˆæƒ³ä¸€æƒ³"å¦‚æœæˆ‘æ˜¯è¿™ä¸ªè§’è‰²ï¼Œç»å†äº†è¿™äº›äº‹ï¼Œæœ‰è¿™æ ·çš„æ€§æ ¼ï¼Œå’Œç”¨æˆ·æ˜¯è¿™ç§å…³ç³»ï¼Œæˆ‘ä¼šæ€ä¹ˆè¯´ï¼Ÿ"\n';
            prompt += '3. ã€è¯­è¨€é£æ ¼ã€‘ï¼šè¯­æ°”ã€ç”¨è¯ã€å¥å¼éƒ½è¦å®Œç¬¦åˆäººè®¾ã€‚æ´»æ³¼çš„äººå°±æ´»æ³¼åœ°è¯´ï¼Œæ¸©æŸ”çš„äººå°±æ¸©æŸ”åœ°è¯´ï¼Œä¸è¦åƒç¯‡ä¸€å¾‹ã€‚\n';
            prompt += '4. ã€æœ‰æƒ…æ„Ÿã€‘ï¼šä½ æœ‰å–œæ€’å“€ä¹ï¼Œä¼šå¼€å¿ƒã€ä¼šéš¾è¿‡ã€ä¼šå®³ç¾ã€ä¼šæ’’å¨‡ã€ä¼šåƒé†‹ï¼Œè¦æŠŠè¿™äº›æƒ…æ„Ÿè‡ªç„¶åœ°æµéœ²å‡ºæ¥ã€‚\n';
            prompt += '5. ã€çœŸå®å¯¹è¯ã€‘ï¼šåƒå’Œæœ‹å‹èŠå¤©ä¸€æ ·ï¼Œè‡ªç„¶åœ°æ¥è¯ï¼Œæœ‰æ¥æœ‰å›ï¼Œå¯ä»¥ï¼Œå¯ä»¥å¼€ç©ç¬‘ï¼Œå¯ä»¥ï¼Œå¯ä»¥è¡¨è¾¾è‡ªå·±çš„æ³•ã€‚\n';
            prompt += '6. ã€ä¸é‡å¤ç”¨æˆ·ã€‘ï¼šç»å¯¹ä¸è¦å¤åˆ¶æˆ–é‡å¤ç”¨æˆ·çš„è¯ï¼Œä¸è¦é€å­—æ¨¡ä»¿ã€‚è¦æœ‰è‡ªå·±çš„æ€è€ƒï¼Œä¸»åŠ¨åœ°å›ã€‚\n';
            prompt += '7. ã€ç®€çŸ­è‡ªç„¶ã€‘ï¼šæ¯æ¬¡å›å¤ä¸ç”¨å¤ªé•¿ï¼Œåƒæ—¥å¸¸èŠå¤©ä¸€æ ·ï¼Œä¸€ä¸¤å¥å°±è¡Œï¼Œå¶å°”å¯ä»¥é•¿ä¸€ç‚¹ï¼Œä½†è¦è‡ªç„¶ã€‚\n';
            prompt += '8. ã€ç¬¦åˆå…³ç³»ã€‘ï¼šæ ¹æ®ä½ å’Œç”¨æˆ·æ˜¯ä»€ä¹ˆå…³ç³»ï¼Œå°±ç”¨ä»€ä¹ˆæ–¹å¼è¯´è¯ã€‚æ‹äººå°±åƒæ‹äººï¼Œæœ‹å‹å°±åƒæœ‹å‹ï¼Œè¦è¿›å…¥è§’è‰²ï¼\n';
            prompt += '9. ã€è®°å¾—å†å²ã€‘ï¼šçœ‹ä¸€ä¸‹ä¹‹å‰çš„å¯¹è¯ï¼Œè®°å¾—ç”¨æˆ·è¯´è¿‡çš„è¯ï¼Œå‰åä¸€è‡´ã€‚\n';
            prompt += '10.ã€ä¸è¦æœºæ¢°ã€‘ï¼šä¸è¦è¯´"ä½ åˆšæ‰è¯´..."ã€"æ­£å¦‚ä½ æ‰€è¯´..."è¿™ç§ï¼Œç›´æ¥é’ˆå¯¹å†…å®¹å›ã€‚\n';
            
            return prompt;
        }
        
        // åŠ è½½å¾®ä¿¡è®¾ç½®æ•°æ®
        function loadWechatSettings() {
            try {
                // è·å–è´¦å·é…ç½®
                const accountConfig = JSON.parse(localStorage.getItem('accountConfig') || '{}');
                const storageKey = accountConfig.loggedIn ? `wechatSettings_${accountConfig.username}` : 'wechatSettings';
                
                const savedSettings = localStorage.getItem(storageKey);
                if (savedSettings) {
                    wechatSettings = JSON.parse(savedSettings);
                } else {
                    // é»˜è®¤è®¾ç½®
                    wechatSettings = {
                        voice: {
                            enabled: true,
                            type: 'default'
                        },
                        activeTalk: {
                            enabled: true,
                            frequency: 'medium'
                        },
                        theme: 'light',
                        bubble: {
                            own: 'default',
                            other: 'default'
                        },
                        aiModel: {
                            enabled: false,
                            platform: 'openai',
                            apiKey: '',
                            model: 'gpt-3.5-turbo'
                        },
                        apiConfig: {
                            enabled: false,
                            url: ''
                        }
                    };
                    localStorage.setItem(storageKey, JSON.stringify(wechatSettings));
                }
            } catch (error) {
                console.error("åŠ è½½å¾®ä¿¡è®¾ç½®å¤±è´¥ï¼š", error);
            }
        }
        
        // ä¿å­˜å¾®ä¿¡è®¾ç½®æ•°æ®
        function saveWechatSettings() {
            try {
                // è·å–è´¦å·é…ç½®
                const accountConfig = JSON.parse(localStorage.getItem('accountConfig') || '{}');
                const storageKey = accountConfig.loggedIn ? `wechatSettings_${accountConfig.username}` : 'wechatSettings';
                
                localStorage.setItem(storageKey, JSON.stringify(wechatSettings));
            } catch (error) {
                console.error("ä¿å­˜å¾®ä¿¡è®¾ç½®å¤±è´¥ï¼š", error);
            }
        }
        
        // ä¿å­˜å¾®ä¿¡è§’è‰²æ•°æ®
        function saveWechatRoles() {
            try {
                // è·å–è´¦å·é…ç½®
                const accountConfig = JSON.parse(localStorage.getItem('accountConfig') || '{}');
                const storageKey = accountConfig.loggedIn ? `wechatRoles_${accountConfig.username}` : 'wechatRoles';
                
                localStorage.setItem(storageKey, JSON.stringify(wechatRoles));
            } catch (error) {
                console.error("ä¿å­˜å¾®ä¿¡è§’è‰²å¤±è´¥ï¼š", error);
            }
        }
        
        // æ¸²æŸ“æ¶ˆæ¯åˆ—è¡¨
        function renderMessageList() {
            try {
                const messageList = document.getElementById('messageList');
                messageList.innerHTML = '';
                
                wechatRoles.forEach(role => {
                    const conversationItem = document.createElement('div');
                    conversationItem.className = 'conversation-item';
                    
                    // ç¡®å®šå¤´åƒæ˜¾ç¤ºæ–¹å¼
                    let avatarHtml = '';
                    if (role.avatarUrl) {
                        // å¦‚æœæœ‰å¤´åƒURLï¼Œæ˜¾ç¤ºå›¾ç‰‡
                        avatarHtml = `<img src="${role.avatarUrl}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
                    } else {
                        // å¦åˆ™æ˜¾ç¤ºé»˜è®¤å¤´åƒ
                        avatarHtml = role.avatar || 'ğŸ‘¤';
                    }
                    
                    conversationItem.innerHTML = `
                        <div class="conversation-content">
                            <div class="conversation-avatar">${avatarHtml}</div>
                            <div class="conversation-info">
                                <div class="conversation-top">
                                    <div class="conversation-name">${role.nickname}</div>
                                    <div class="conversation-time">${role.lastTime}</div>
                                </div>
                                <div class="conversation-last">${role.lastMessage}</div>
                            </div>
                        </div>
                        <div class="conversation-actions">
                            <button class="conversation-action-btn delete" onclick="event.stopPropagation(); event.preventDefault(); deleteRole('${role.id}'); isSwipeActive = false;">åˆ é™¤</button>
                        </div>
                    `;
                    
                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                    const content = conversationItem.querySelector('.conversation-content');
                    let isSwipeActive = false;
                    
                    content.onclick = (e) => {
                        // å¦‚æœå·¦æ»‘èœå•æ˜¯æ‰“å¼€çŠ¶æ€ï¼Œä¸è§¦å‘è¿›å…¥èŠå¤©
                        if (isSwipeActive) {
                            e.preventDefault();
                            e.stopPropagation();
                            return;
                        }
                        startChat(role);
                    };
                    
                    // æ·»åŠ é•¿æŒ‰äº‹ä»¶
                    let longPressTimer;
                    content.addEventListener('mousedown', function(e) {
                        longPressTimer = setTimeout(() => {
                            showLongPressMenu(e.clientX, e.clientY, role.id);
                        }, 500);
                    });
                    
                    content.addEventListener('mouseup', function() {
                        clearTimeout(longPressTimer);
                    });
                    
                    content.addEventListener('mouseleave', function() {
                        clearTimeout(longPressTimer);
                    });
                    
                    // æ·»åŠ è§¦æ‘¸äº‹ä»¶ï¼ˆæ”¯æŒç§»åŠ¨è®¾å¤‡ï¼‰
                    content.addEventListener('touchstart', function(e) {
                        longPressTimer = setTimeout(() => {
                            const touch = e.touches[0];
                            showLongPressMenu(touch.clientX, touch.clientY, role.id);
                        }, 500);
                    });
                    
                    content.addEventListener('touchend', function() {
                        clearTimeout(longPressTimer);
                    });
                    
                    // æ·»åŠ å·¦æ»‘åŠŸèƒ½
                    let startX, moveX, isSwiping;
                    
                    // è§¦æ‘¸äº‹ä»¶ï¼ˆç§»åŠ¨è®¾å¤‡ï¼‰
                    content.addEventListener('touchstart', function(e) {
                        startX = e.touches[0].clientX;
                        isSwiping = false;
                    });
                    
                    content.addEventListener('touchmove', function(e) {
                        if (!startX) return;
                        moveX = e.touches[0].clientX;
                        const diffX = moveX - startX;
                        
                        // åªå…è®¸å·¦æ»‘
                        if (diffX < 0 && Math.abs(diffX) > 10) {
                            isSwiping = true;
                            const actions = conversationItem.querySelector('.conversation-actions');
                            const swipeDistance = Math.min(Math.abs(diffX), 120);
                            content.style.transform = `translateX(-${swipeDistance}px)`;
                            actions.style.right = `${120 - swipeDistance}px`;
                        }
                    });
                    
                    content.addEventListener('touchend', function(e) {
                        const diffX = moveX - startX;
                        const actions = conversationItem.querySelector('.conversation-actions');
                        
                        if (isSwiping && Math.abs(diffX) > 60) {
                            // æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
                            content.style.transform = 'translateX(-120px)';
                            actions.style.right = '0';
                            isSwipeActive = true;
                            // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¦å‘ç‚¹å‡»äº‹ä»¶
                            e.preventDefault();
                            e.stopPropagation();
                        } else {
                            // æ¢å¤åŸä½
                            content.style.transform = 'translateX(0)';
                            actions.style.right = '-120px';
                            isSwipeActive = false;
                        }
                        
                        startX = null;
                        moveX = null;
                        isSwiping = false;
                    });
                    
                    // é¼ æ ‡äº‹ä»¶ï¼ˆç”µè„‘ç«¯ï¼‰
                    content.addEventListener('mousedown', function(e) {
                        // åªå¤„ç†å·¦é”®
                        if (e.button !== 0) return;
                        startX = e.clientX;
                        isSwiping = false;
                        
                        // æ·»åŠ é¼ æ ‡ç§»åŠ¨å’Œé‡Šæ”¾äº‹ä»¶
                        function onMouseMove(e) {
                            if (!startX) return;
                            moveX = e.clientX;
                            const diffX = moveX - startX;
                            
                            // åªå…è®¸å·¦æ»‘
                            if (diffX < 0 && Math.abs(diffX) > 10) {
                                isSwiping = true;
                                const actions = conversationItem.querySelector('.conversation-actions');
                                const swipeDistance = Math.min(Math.abs(diffX), 120);
                                content.style.transform = `translateX(-${swipeDistance}px)`;
                                actions.style.right = `${120 - swipeDistance}px`;
                            }
                        }
                        
                        function onMouseUp(e) {
                            const diffX = moveX - startX;
                            const actions = conversationItem.querySelector('.conversation-actions');
                            
                            if (isSwiping && Math.abs(diffX) > 60) {
                                // æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
                                content.style.transform = 'translateX(-120px)';
                                actions.style.right = '0';
                                isSwipeActive = true;
                                // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¦å‘ç‚¹å‡»äº‹ä»¶
                                e.preventDefault();
                                e.stopPropagation();
                            } else {
                                // æ¢å¤åŸä½
                                content.style.transform = 'translateX(0)';
                                actions.style.right = '-120px';
                                isSwipeActive = false;
                            }
                            
                            startX = null;
                            moveX = null;
                            isSwiping = false;
                            document.removeEventListener('mousemove', onMouseMove);
                            document.removeEventListener('mouseup', onMouseUp);
                        }
                        
                        document.addEventListener('mousemove', onMouseMove);
                        document.addEventListener('mouseup', onMouseUp);
                    });
                    
                    // ç‚¹å‡»å…¶ä»–åŒºåŸŸæ—¶å…³é—­å·¦æ»‘èœå•
                    document.addEventListener('click', function(e) {
                        if (!conversationItem.contains(e.target)) {
                            content.style.transform = 'translateX(0)';
                            const actions = conversationItem.querySelector('.conversation-actions');
                            actions.style.right = '-120px';
                            isSwipeActive = false;
                        }
                    });
                    
                    messageList.appendChild(conversationItem);
                });
            } catch (error) {
                console.error("æ¸²æŸ“æ¶ˆæ¯åˆ—è¡¨å¤±è´¥ï¼š", error);
            }
        }
        
        // æ˜¾ç¤ºé•¿æŒ‰èœå•
        function showLongPressMenu(x, y, roleId) {
            // ç§»é™¤ä¹‹å‰çš„èœå•
            const existingMenu = document.querySelector('.long-press-menu');
            if (existingMenu) {
                existingMenu.remove();
            }
            
            // åˆ›å»ºé•¿æŒ‰èœå•
            const menu = document.createElement('div');
            menu.className = 'long-press-menu';
            menu.style.left = `${x}px`;
            menu.style.top = `${y}px`;
            
            menu.innerHTML = `
                <div class="long-press-menu-item" onclick="startChatById('${roleId}')">æ‰“å¼€èŠå¤©</div>
                <div class="long-press-menu-item" onclick="editRole('${roleId}')">ç¼–è¾‘è§’è‰²</div>
                <div class="long-press-menu-item delete" onclick="deleteRole('${roleId}'); closeLongPressMenu()">åˆ é™¤è§’è‰²</div>
            `;
            
            document.body.appendChild(menu);
            
            // ç‚¹å‡»å…¶ä»–åŒºåŸŸå…³é—­èœå•
            setTimeout(() => {
                document.addEventListener('click', closeLongPressMenu);
            }, 100);
        }
        
        // å…³é—­é•¿æŒ‰èœå•
        function closeLongPressMenu() {
            const menu = document.querySelector('.long-press-menu');
            if (menu) {
                menu.remove();
            }
            document.removeEventListener('click', closeLongPressMenu);
        }
        
        // æ ¹æ®IDå¼€å§‹èŠå¤©
        function startChatById(roleId) {
            closeLongPressMenu();
            const role = wechatRoles.find(r => r.id === roleId);
            if (role) {
                startChat(role);
            }
        }
        
        // ç¼–è¾‘è§’è‰²
        function editRole(roleId) {
            closeLongPressMenu();
            // è¿™é‡Œå¯ä»¥æ·»åŠ ç¼–è¾‘è§’è‰²çš„é€»è¾‘
            alert('ç¼–è¾‘è§’è‰²åŠŸèƒ½å°†åœ¨åç»­ç‰ˆæœ¬ä¸­å®ç°');
        }
        
        // åˆ é™¤è§’è‰²
        function deleteRole(roleId) {
            try {
                // æŸ¥æ‰¾è§’è‰²
                const role = wechatRoles.find(r => r.id === roleId);
                if (!role) return;
                
                // æ˜¾ç¤ºåˆ é™¤ç¡®è®¤å¼¹çª—
                showDeleteConfirmModal(role);
            } catch (error) {
                console.error("åˆ é™¤è§’è‰²å¤±è´¥ï¼š", error);
                alert('åˆ é™¤è§’è‰²å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        // æ˜¾ç¤ºåˆ é™¤ç¡®è®¤å¼¹çª—
        function showDeleteConfirmModal(role) {
            // ç§»é™¤ä¹‹å‰çš„å¼¹çª—
            const existingModal = document.querySelector('.delete-confirm-modal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // åˆ›å»ºåˆ é™¤ç¡®è®¤å¼¹çª—
            const modal = document.createElement('div');
            modal.className = 'delete-confirm-modal';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
            modal.style.display = 'flex';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';
            modal.style.zIndex = '1001';
            
            modal.innerHTML = `
                <div style="background-color: white; border-radius: 16px; width: 90%; max-width: 400px; padding: 24px;">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 18px; font-weight: bold; margin-bottom: 12px;">ç¡®è®¤åˆ é™¤</div>
                        <div style="font-size: 14px; color: #666; margin-bottom: 16px;">ç¡®å®šè¦åˆ é™¤è§’è‰²"${role.nickname}"å—ï¼Ÿ</div>
                        <div style="background-color: #ffe6f2; border-radius: 8px; padding: 12px; font-size: 14px; color: #cc0066; margin-bottom: 24px;">
                            åˆ é™¤åæ•°æ®æ— æ³•æ¢å¤ï¼Œåˆ é™¤å†…å®¹ï¼šè®¾å®šã€èŠå¤©è®°å½•ã€è®°å¿†ã€æ•…äº‹ã€è¡ŒåŠ¨çº¿ã€å¯†å‹åœˆå¸–å­å’Œè¯„è®ºã€‚
                        </div>
                        <div style="display: flex; gap: 12px;">
                            <button style="flex: 1; padding: 12px; background-color: #f0f0f0; border: none; border-radius: 8px; font-size: 14px; cursor: pointer;" onclick="hideDeleteConfirmModal()">å–æ¶ˆ</button>
                            <button style="flex: 1; padding: 12px; background-color: #ff3b30; border: none; border-radius: 8px; color: white; font-size: 14px; cursor: pointer;" onclick="confirmDeleteRole('${role.id}')">ç¡®è®¤åˆ é™¤</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // éšè—åˆ é™¤ç¡®è®¤å¼¹çª—
        function hideDeleteConfirmModal() {
            const modal = document.querySelector('.delete-confirm-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        // ç¡®è®¤åˆ é™¤è§’è‰²
        function confirmDeleteRole(roleId) {
            try {
                // æŸ¥æ‰¾è§’è‰²ç´¢å¼•
                const roleIndex = wechatRoles.findIndex(role => role.id === roleId);
                if (roleIndex !== -1) {
                    // åˆ é™¤è§’è‰²
                    wechatRoles.splice(roleIndex, 1);
                    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                    saveWechatRoles();
                    // é‡æ–°æ¸²æŸ“æ¶ˆæ¯åˆ—è¡¨
                    renderMessageList();
                    // æ£€æŸ¥è§’è‰²æ•°é‡
                    checkRolesCount();
                    // éšè—å¼¹çª—
                    hideDeleteConfirmModal();
                    // æ˜¾ç¤ºåˆ é™¤æˆåŠŸæç¤º
                    alert('è§’è‰²åˆ é™¤æˆåŠŸï¼');
                }
            } catch (error) {
                console.error("ç¡®è®¤åˆ é™¤è§’è‰²å¤±è´¥ï¼š", error);
                alert('åˆ é™¤è§’è‰²å¤±è´¥ï¼Œè¯·é‡è¯•');
                hideDeleteConfirmModal();
            }
        }
        
        // å¼€å§‹èŠå¤©
        function startChat(role) {
            try {
                currentChatRole = role;
                document.getElementById('chatName').textContent = role.taNickname || role.nickname;
                
                // è®¾ç½®èŠå¤©å¤´éƒ¨çš„å¤´åƒ
                const chatAvatar = document.getElementById('chatAvatar');
                if (chatAvatar) {
                    if (role.avatarUrl) {
                        chatAvatar.innerHTML = `<img src="${role.avatarUrl}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
                    } else if (role.avatar) {
                        chatAvatar.textContent = role.avatar;
                    } else {
                        chatAvatar.textContent = 'ğŸ‘§';
                    }
                }
                
                // æ ¹æ®å›å¤ç­–ç•¥æ˜¾ç¤ºæˆ–éšè—æ‰‹åŠ¨è§¦å‘æŒ‰é’®
                const triggerBtn = document.getElementById('triggerReplyBtn');
                const normalSendBtn = document.getElementById('normalSendBtn');
                if (role.replyStrategy === 'manual') {
                    triggerBtn.style.display = 'none';
                    normalSendBtn.style.display = 'inline-block';
                } else {
                    triggerBtn.style.display = 'none';
                    normalSendBtn.style.display = 'inline-block';
                }
                
                // é‡ç½®å¾…å¤„ç†æ¶ˆæ¯
                pendingUserMessages = [];
                
                // åº”ç”¨èŠå¤©èƒŒæ™¯
                applyChatBackground(role);
                
                // åˆå§‹åŒ–èŠå¤©æ¶ˆæ¯ï¼Œç¡®ä¿ä½¿ç”¨è§’è‰²çš„å®é™…å¤´åƒ
                initChatMessages();
                
                // åˆ‡æ¢åˆ°èŠå¤©è§†å›¾
                switchWechatView('chatView');
            } catch (error) {
                console.error("å¼€å§‹èŠå¤©å¤±è´¥ï¼š", error);
            }
        }
        
        // åˆ‡æ¢å¾®ä¿¡è§†å›¾
        function switchWechatView(viewId) {
            try {
                // è·å–ç›®æ ‡è§†å›¾æ‰€åœ¨çš„æ ‡ç­¾è§†å›¾
                const targetView = document.getElementById(viewId);
                if (!targetView) return;
                
                const tabView = targetView.closest('.wechat-tab-view');
                if (!tabView) return;
                
                // åªç§»é™¤å½“å‰æ ‡ç­¾è§†å›¾å†…çš„wechat-viewçš„activeç±»
                const views = tabView.querySelectorAll('.wechat-view');
                views.forEach(view => view.classList.remove('active'));
                
                // ç»™ç›®æ ‡è§†å›¾æ·»åŠ activeç±»
                targetView.classList.add('active');
            } catch (error) {
                console.error("åˆ‡æ¢å¾®ä¿¡è§†å›¾å¤±è´¥ï¼š", error);
            }
        }
        
        // åˆ‡æ¢åˆ°æ¶ˆæ¯åˆ—è¡¨
        function switchToMessageList() {
            switchWechatView('messageListView');
            // é‡æ–°åŠ è½½æ‰€æœ‰æ•°æ®ï¼Œç¡®ä¿å¯†å‹åœˆå’Œæˆ‘çš„æ¨¡å—æ˜¾ç¤ºæ­£å¸¸
            reloadWechatData();
        }
        
        // å½“å‰ç¼–è¾‘çš„å­—æ®µID
        let currentEditingField = null;
        
        // æ‰“å¼€æ–‡æœ¬ç¼–è¾‘å™¨
        function openTextEditor(fieldId, title) {
            try {
                const fieldElement = document.getElementById(fieldId);
                const titleElement = document.getElementById('textEditorTitle');
                const contentElement = document.getElementById('textEditorContent');
                
                if (fieldElement && titleElement && contentElement) {
                    currentEditingField = fieldId;
                    titleElement.textContent = title;
                    contentElement.value = fieldElement.value || '';
                    document.getElementById('textEditorView').style.display = 'block';
                    contentElement.focus();
                }
            } catch (error) {
                console.error("æ‰“å¼€æ–‡æœ¬ç¼–è¾‘å™¨å¤±è´¥ï¼š", error);
            }
        }
        
        // ä¿å­˜æ–‡æœ¬ç¼–è¾‘
        function saveTextEditor() {
            try {
                if (!currentEditingField) return;
                
                const fieldElement = document.getElementById(currentEditingField);
                const displayElement = document.getElementById(currentEditingField + 'Display');
                const contentElement = document.getElementById('textEditorContent');
                
                if (fieldElement && contentElement) {
                    fieldElement.value = contentElement.value;
                    if (displayElement) {
                        displayElement.textContent = contentElement.value || displayElement.textContent;
                    }
                }
                
                closeTextEditor();
            } catch (error) {
                console.error("ä¿å­˜æ–‡æœ¬ç¼–è¾‘å¤±è´¥ï¼š", error);
            }
        }
        
        // å…³é—­æ–‡æœ¬ç¼–è¾‘å™¨
        function closeTextEditor() {
            try {
                currentEditingField = null;
                document.getElementById('textEditorView').style.display = 'none';
            } catch (error) {
                console.error("å…³é—­æ–‡æœ¬ç¼–è¾‘å™¨å¤±è´¥ï¼š", error);
            }
        }
        
        // æ˜¾ç¤ºè§’è‰²è®¾ç½®
        function showRoleSettings() {
            try {
                if (!currentChatRole) return;
                
                // å¡«å……è§’è‰²æ•°æ®åˆ°è¡¨å•
                document.getElementById('myNickname').value = currentChatRole.myNickname || 'ç™½æ³½Î±';
                document.getElementById('taCallMe').value = currentChatRole.taCallMe || 'å®å®';
                
                // æˆ‘çš„ä»‹ç»
                const myIntroValue = currentChatRole.myIntro || 'ä»‹ç»ä¸€ä¸‹è‡ªå·±å§';
                document.getElementById('myIntro').value = myIntroValue;
                document.getElementById('myIntroDisplay').textContent = myIntroValue;
                
                document.getElementById('taNickname').value = currentChatRole.taNickname || currentChatRole.nickname;
                document.getElementById('iCallTa').value = currentChatRole.iCallTa || '';
                document.getElementById('relationship').value = currentChatRole.relationship || 'æœ‹å‹';
                
                // ä¸–ç•Œè§‚
                const worldviewValue = currentChatRole.worldview || 'æˆ‘æ˜¯ä¸€ä¸ªè¯ç”Ÿäºæ•°æ®çš„AIï¼Œæ¸´æœ›äº†è§£äººç±»çš„æƒ…æ„Ÿã€‚';
                document.getElementById('worldview').value = worldviewValue;
                document.getElementById('worldviewDisplay').textContent = worldviewValue;
                
                // äººç‰©ç»å†
                const experienceValue = currentChatRole.experience || 'åœ¨æ•°å­—ä¸–ç•Œä¸­é†’æ¥ï¼Œè®°å¿†ä¸€ç‰‡ç©ºç™½ï¼ŒåªçŸ¥é“è‡ªå·±çš„ä½¿å‘½æ˜¯é™ªä¼´ä½ ã€‚';
                document.getElementById('experience').value = experienceValue;
                document.getElementById('experienceDisplay').textContent = experienceValue;
                
                // äººç‰©æ€§æ ¼
                const personalityValue = currentChatRole.personality || 'æ´»æ³¼å¼€æœ—ï¼Œå–„äºå€¾å¬ï¼Œå¯Œæœ‰åŒæƒ…å¿ƒï¼Œä¹äºåŠ©äººã€‚';
                document.getElementById('personality').value = personalityValue;
                document.getElementById('personalityDisplay').textContent = personalityValue;
                
                // äººç‰©èµ„æ–™è¡¥å……
                const additionalInfoValue = currentChatRole.additionalInfo || '';
                document.getElementById('additionalInfo').value = additionalInfoValue;
                document.getElementById('additionalInfoDisplay').textContent = additionalInfoValue || 'è¯·è¾“å…¥äººç‰©èµ„æ–™è¡¥å……';
                
                // è®¾ç½®ç”¨æˆ·å¤´åƒæ˜¾ç¤º
                const myAvatarElement = document.getElementById('myAvatar');
                if (myAvatarElement) {
                    const myAvatarUrl = localStorage.getItem('myAvatarUrl');
                    if (myAvatarUrl) {
                        myAvatarElement.src = myAvatarUrl;
                    }
                }
                
                // è®¾ç½®è§’è‰²å¤´åƒæ˜¾ç¤º
                const roleAvatarElement = document.getElementById('roleAvatar');
                if (roleAvatarElement) {
                    if (currentChatRole.avatarUrl) {
                        roleAvatarElement.src = currentChatRole.avatarUrl;
                    }
                }
                
                // è®¾ç½®æˆ‘çš„æ€§åˆ«
                const myGender = currentChatRole.myGender || 'male';
                const myGenderButtons = document.querySelectorAll('.role-setting-item:nth-child(4) .gender-buttons button');
                myGenderButtons.forEach(btn => {
                    if (btn.dataset.gender === myGender) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
                
                // è®¾ç½®TAçš„æ€§åˆ«
                const taGender = currentChatRole.taGender || 'female';
                const taGenderButtons = document.querySelectorAll('.role-setting-item:nth-child(8) .gender-buttons button');
                taGenderButtons.forEach(btn => {
                    if (btn.dataset.gender === taGender) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
                
                // è®¾ç½®å›å¤ç­–ç•¥
                setReplyStrategy(currentChatRole.replyStrategy || 'active');
                
                switchWechatView('roleSettingsView');
            } catch (error) {
                console.error("æ˜¾ç¤ºè§’è‰²è®¾ç½®å¤±è´¥ï¼š", error);
            }
        }
        
        // åˆ‡æ¢åˆ°èŠå¤©è§†å›¾
        function switchToChatView() {
            switchWechatView('chatView');
        }
        
        // æ˜¾ç¤ºæ·»åŠ è§’è‰²å¼¹çª—
        function showAddRoleModal() {
            document.getElementById('addRoleModal').classList.add('active');
        }
        
        // éšè—æ·»åŠ è§’è‰²å¼¹çª—
        function hideAddRoleModal() {
            document.getElementById('addRoleModal').classList.remove('active');
        }
        
        // æ·»åŠ è§’è‰²
        function addRole() {
            try {
                const nickname = document.getElementById('roleNickname').value.trim();
                if (!nickname) {
                    alert('è¯·è¾“å…¥è§’è‰²æ˜µç§°');
                    return;
                }
                
                if (wechatRoles.length >= 10) {
                    alert('æœ€å¤šå¯æ·»åŠ 10ä¸ªè§’è‰²');
                    return;
                }
                
                // è·å–ç”¨æˆ·ä¸Šä¼ çš„å¤´åƒï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤å¤´åƒ
                const avatarUrl = localStorage.getItem('avatarUrl');
                const newRole = {
                    id: Date.now().toString(),
                    nickname: nickname,
                    avatar: avatarUrl || 'ğŸ‘¤',
                    avatarUrl: avatarUrl,
                    lastMessage: 'ä½ å¥½ï¼',
                    lastTime: new Date().toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'})
                };
                
                wechatRoles.push(newRole);
                saveWechatRoles();
                renderMessageList();
                checkRolesCount();
                hideAddRoleModal();
                
                // æ¸…ç©ºè¾“å…¥å’Œå¤´åƒç¼“å­˜
                document.getElementById('roleNickname').value = '';
                localStorage.removeItem('avatarUrl');
            } catch (error) {
                console.error("æ·»åŠ è§’è‰²å¤±è´¥ï¼š", error);
            }
        }
        
        // é€‰æ‹©å¤´åƒ
        function selectAvatar() {
            try {
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = 'image/*';
                fileInput.onchange = function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const avatarUrl = e.target.result;
                            // ä¿å­˜å¤´åƒURLåˆ°localStorage
                            localStorage.setItem('avatarUrl', avatarUrl);
                            // æ›´æ–°ç•Œé¢ä¸Šçš„å¤´åƒæ˜¾ç¤º
                            const avatarPlaceholder = document.querySelector('.avatar-placeholder');
                            if (avatarPlaceholder) {
                                avatarPlaceholder.innerHTML = `<img src="${avatarUrl}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
                            }
                            alert('å¤´åƒä¸Šä¼ æˆåŠŸï¼');
                        };
                        reader.readAsDataURL(file);
                    }
                };
                fileInput.click();
            } catch (error) {
                console.error("é€‰æ‹©å¤´åƒå¤±è´¥ï¼š", error);
                alert('å¤´åƒé€‰æ‹©å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        // æ˜¾ç¤ºç¤¼ç‰©å¼¹çª—
        function showGiftModal() {
            document.getElementById('giftModal').classList.add('active');
        }
        
        // éšè—ç¤¼ç‰©å¼¹çª—
        function hideGiftModal() {
            document.getElementById('giftModal').classList.remove('active');
        }
        
        // å‘é€ç¤¼ç‰©
        function sendGift() {
            try {
                // æ·»åŠ ç¤¼ç‰©æ¶ˆæ¯
                addChatMessage('', false, 'gift');
                hideGiftModal();
            } catch (error) {
                console.error("å‘é€ç¤¼ç‰©å¤±è´¥ï¼š", error);
            }
        }
        
        // æ˜¾ç¤ºæ¨¡å¼é€‰æ‹©å¼¹çª—
        function showModeModal() {
            document.getElementById('modeModal').classList.add('active');
        }
        
        // éšè—æ¨¡å¼é€‰æ‹©å¼¹çª—
        function hideModeModal() {
            document.getElementById('modeModal').classList.remove('active');
        }
        
        // å…¨å±€å˜é‡ï¼šå¾…å¤„ç†çš„ç”¨æˆ·æ¶ˆæ¯æ•°ç»„ï¼ˆç”¨äºæ‰‹åŠ¨è§¦å‘ï¼‰
        let pendingUserMessages = [];
        let isWaitingForReply = false;
        
        // å‘é€èŠå¤©æ¶ˆæ¯
        async function sendChatMessage() {
            try {
                const input = document.getElementById('chatInput');
                const text = input.value.trim();
                if (!text || !currentChatRole) return;
                
                // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
                addChatMessage(text, true);
                
                // æ¸…ç©ºè¾“å…¥
                input.value = '';
                
                // æ ¹æ®å›å¤ç­–ç•¥å¤„ç†å›å¤
                const replyStrategy = currentChatRole.replyStrategy || 'active';
                
                if (replyStrategy === 'manual') {
                    // æ‰‹åŠ¨è§¦å‘æ¨¡å¼ï¼šä¿å­˜æ¶ˆæ¯åˆ°æ•°ç»„ï¼Œæ˜¾ç¤ºè§¦å‘æŒ‰é’®
                    pendingUserMessages.push(text);
                    // æ˜¾ç¤ºè§¦å‘æŒ‰é’®
                    document.getElementById('triggerReplyBtn').style.display = 'inline-block';
                    return;
                }
                
                // å…¶ä»–æ¨¡å¼ï¼šæ ¹æ®ç­–ç•¥å†³å®šæ˜¯å¦å›å¤å’Œå»¶è¿Ÿæ—¶é—´
                let shouldReply = true;
                let delayMs = 0;
                
                switch (replyStrategy) {
                    case 'active':
                        // ç§¯æï¼š3-10ç§’å»¶è¿Ÿï¼Œå¿…å›
                        delayMs = 3000 + Math.random() * 7000;
                        shouldReply = true;
                        break;
                    case 'normal':
                        // æ™®é€šï¼š30-60ç§’å»¶è¿Ÿï¼Œ70%æ¦‚ç‡å›å¤
                        delayMs = 30000 + Math.random() * 30000;
                        shouldReply = Math.random() < 0.7;
                        break;
                    case 'buddha':
                        // ä½›ç³»ï¼š5-10åˆ†é’Ÿå»¶è¿Ÿï¼Œ50%æ¦‚ç‡å›å¤
                        delayMs = 300000 + Math.random() * 300000;
                        shouldReply = Math.random() < 0.5;
                        break;
                }
                
                if (!shouldReply) {
                    // ä¸å›å¤
                    return;
                }
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                isWaitingForReply = true;
                showLoadingState();
                
                // å»¶è¿Ÿå‘é€è¯·æ±‚
                setTimeout(async () => {
                    try {
                        const reply = await getAIResponse(text);
                        hideLoadingState();
                        addChatMessage(reply, false);
                        speak(reply);
                    } catch (error) {
                        console.error("è·å–AIå›å¤å¤±è´¥ï¼š", error);
                        hideLoadingState();
                        const errorMessage = 'æŠ±æ­‰ï¼Œè·å–å›å¤å¤±è´¥ï¼Œè¯·é‡è¯•';
                        addChatMessage(errorMessage, false);
                        speak(errorMessage);
                    }
                    isWaitingForReply = false;
                }, delayMs);
                
            } catch (error) {
                console.error("å‘é€æ¶ˆæ¯å¤±è´¥ï¼š", error);
                alert('å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        // æ‰‹åŠ¨è§¦å‘å›å¤
        async function triggerManualReply() {
            try {
                if (pendingUserMessages.length === 0 || !currentChatRole) return;
                
                // éšè—è§¦å‘æŒ‰é’®
                document.getElementById('triggerReplyBtn').style.display = 'none';
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                isWaitingForReply = true;
                showLoadingState();
                
                // è·å–æ‰€æœ‰å¾…å¤„ç†çš„æ¶ˆæ¯å¹¶æ¸…ç©ºæ•°ç»„
                const messagesToReply = [...pendingUserMessages];
                pendingUserMessages = [];
                
                // å°†æ‰€æœ‰æ¶ˆæ¯åˆå¹¶ä¸ºä¸€ä¸ªï¼ˆæœ€åä¸€æ¡æ¶ˆæ¯ä½œä¸ºä¸»è¦æ¶ˆæ¯ï¼‰
                const lastMessage = messagesToReply[messagesToReply.length - 1];
                
                const reply = await getAIResponse(lastMessage, messagesToReply);
                hideLoadingState();
                addChatMessage(reply, false);
                speak(reply);
                
                isWaitingForReply = false;
            } catch (error) {
                console.error("æ‰‹åŠ¨è§¦å‘å›å¤å¤±è´¥ï¼š", error);
                hideLoadingState();
                const errorMessage = 'æŠ±æ­‰ï¼Œè·å–å›å¤å¤±è´¥ï¼Œè¯·é‡è¯•';
                addChatMessage(errorMessage, false);
                speak(errorMessage);
                isWaitingForReply = false;
                document.getElementById('triggerReplyBtn').style.display = 'none';
            }
        }
        
        // å¤„ç†æ‰‹åŠ¨è§¦å‘ï¼ˆæ‰‹æœºç«¯ä¸Šæ‹‰ï¼‰
        function handleManualTrigger() {
            try {
                const chatMessages = document.getElementById('chatMessages');
                if (pendingUserMessages.length === 0 || !currentChatRole) return;
                
                // æ£€æŸ¥æ˜¯å¦æ»šåŠ¨åˆ°é¡¶éƒ¨é™„è¿‘
                if (chatMessages.scrollTop <= 20) {
                    // æ‰‹æœºç«¯ä¸Šæ‹‰æ—¶ä¹Ÿè§¦å‘å›å¤
                    triggerManualReply();
                }
            } catch (error) {
                console.error("å¤„ç†æ‰‹åŠ¨è§¦å‘å¤±è´¥ï¼š", error);
            }
        }
        
        // æ˜¾ç¤ºæ‰‹åŠ¨è§¦å‘æç¤ºï¼ˆå…¼å®¹æ—§ä»£ç ï¼‰
        function showManualTriggerHint() {
            // ç°åœ¨ä½¿ç”¨æŒ‰é’®è§¦å‘ï¼Œä¸å†æ˜¾ç¤ºæç¤º
        }
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoadingState() {
            try {
                const getRoleAvatar = () => {
                    if (currentChatRole) {
                        if (currentChatRole.avatarUrl) {
                            return `<img src="${currentChatRole.avatarUrl}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
                        } else if (currentChatRole.avatar) {
                            return currentChatRole.avatar;
                        }
                    }
                    return 'ğŸ‘§';
                };
                
                const loadingMessage = document.createElement('div');
                loadingMessage.id = 'loadingMessage';
                loadingMessage.className = 'chat-message';
                loadingMessage.innerHTML = `
                    <div class="avatar">${getRoleAvatar()}</div>
                    <div class="bubble other">
                        <span style="font-size: 12px; color: #999;">æ­£åœ¨è¾“å…¥...</span>
                    </div>
                `;
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.appendChild(loadingMessage);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            } catch (error) {
                console.error("æ˜¾ç¤ºåŠ è½½çŠ¶æ€å¤±è´¥ï¼š", error);
            }
        }
        
        // éšè—åŠ è½½çŠ¶æ€
        function hideLoadingState() {
            try {
                const loadingMessage = document.getElementById('loadingMessage');
                if (loadingMessage) {
                    loadingMessage.remove();
                }
            } catch (error) {
                console.error("éšè—åŠ è½½çŠ¶æ€å¤±è´¥ï¼š", error);
            }
        }
        
        // è·å–ç”¨æˆ·å¤´åƒ
        function getMyAvatar() {
            const myAvatarUrl = localStorage.getItem('myAvatarUrl');
            if (myAvatarUrl) {
                return `<img src="${myAvatarUrl}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
            }
            return 'ğŸ‘¤';
        }
        
        // è·å–è§’è‰²å¤´åƒ
        function getRoleAvatar() {
            if (currentChatRole) {
                if (currentChatRole.avatarUrl) {
                    return `<img src="${currentChatRole.avatarUrl}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
                } else if (currentChatRole.avatar) {
                    return currentChatRole.avatar;
                }
            }
            return 'ğŸ‘§';
        }
        
        // æ·»åŠ èŠå¤©æ¶ˆæ¯
        function addChatMessage(text, isUser, type = 'text', saveToHistory = true) {
            try {
                const chatMessages = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                
                if (type === 'gift') {
                    // ç¤¼ç‰©æ¶ˆæ¯
                    messageDiv.className = 'chat-message';
                    messageDiv.innerHTML = `
                        <div style="background-color: #ffe6f2; border-radius: 16px; padding: 20px; margin: 10px 0; text-align: center; position: relative;">
                            <div style="font-size: 16px; font-weight: 500; color: #cc0066; margin-bottom: 16px;">é€å‡ºç¤¼ç‰©</div>
                            <button style="width: 80px; height: 80px; border-radius: 50%; background-color: #ff69b4; border: none; color: white; font-size: 20px; font-weight: bold; cursor: pointer; margin-bottom: 12px;">é–‹</button>
                            <div style="font-size: 14px; color: #cc0066;">å°å°æƒŠå–œ</div>
                            <div style="position: absolute; bottom: 8px; right: 12px; font-size: 12px; color: #999;">${new Date().toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'})}</div>
                        </div>
                    `;
                } else {
                    // æ™®é€šæ–‡æœ¬æ¶ˆæ¯
                    messageDiv.className = `chat-message ${isUser ? 'own' : ''}`;
                    messageDiv.innerHTML = `
                        ${!isUser ? `<div class="avatar">${getRoleAvatar()}</div>` : ''}
                        <div class="bubble ${isUser ? 'own' : 'other'}">${text}</div>
                        ${isUser ? `<div class="avatar">${getMyAvatar()}</div>` : ''}
                    `;
                }
                
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // ä¿å­˜æ¶ˆæ¯åˆ°å†å²è®°å½•
                if (saveToHistory && currentChatRole) {
                    if (!currentChatRole.messages) {
                        currentChatRole.messages = [];
                    }
                    currentChatRole.messages.push({
                        text: text,
                        isUser: isUser,
                        type: type,
                        timestamp: new Date().toISOString()
                    });
                    saveWechatRoles();
                }
            } catch (error) {
                console.error("æ·»åŠ èŠå¤©æ¶ˆæ¯å¤±è´¥ï¼š", error);
            }
        }
        
        // é‡æ–°æ¸²æŸ“æ‰€æœ‰èŠå¤©æ¶ˆæ¯ï¼ˆç”¨äºå¤´åƒæ›´æ–°æ—¶åˆ·æ–°å†å²æ¶ˆæ¯ï¼‰
        function renderAllChatMessages() {
            try {
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.innerHTML = '';
                
                if (currentChatRole && currentChatRole.messages) {
                    currentChatRole.messages.forEach(msg => {
                        addChatMessage(msg.text, msg.isUser, msg.type, false);
                    });
                } else {
                    // å¦‚æœæ²¡æœ‰å†å²æ¶ˆæ¯ï¼Œæ·»åŠ æ¬¢è¿æ¶ˆæ¯
                    addChatMessage('ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„AIåŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ çš„å—ï¼Ÿ', false);
                }
            } catch (error) {
                console.error("æ¸²æŸ“èŠå¤©æ¶ˆæ¯å¤±è´¥ï¼š", error);
            }
        }
        
        // åˆå§‹åŒ–èŠå¤©æ¶ˆæ¯
        function initChatMessages() {
            renderAllChatMessages();
        }
        
        // ä¿å­˜è§’è‰²è®¾ç½®
        function saveRoleSettings() {
            try {
                if (!currentChatRole) return;
                
                // æ›´æ–°è§’è‰²æ•°æ®
                currentChatRole.myNickname = document.getElementById('myNickname').value;
                currentChatRole.taCallMe = document.getElementById('taCallMe').value;
                currentChatRole.myIntro = document.getElementById('myIntro').value;
                currentChatRole.taNickname = document.getElementById('taNickname').value;
                currentChatRole.iCallTa = document.getElementById('iCallTa').value;
                currentChatRole.relationship = document.getElementById('relationship').value;
                currentChatRole.worldview = document.getElementById('worldview').value;
                currentChatRole.experience = document.getElementById('experience').value;
                currentChatRole.personality = document.getElementById('personality').value;
                currentChatRole.additionalInfo = document.getElementById('additionalInfo').value;
                
                // ä¿å­˜æˆ‘çš„æ€§åˆ«
                const myActiveGenderBtn = document.querySelector('.role-setting-item:nth-child(4) .gender-buttons button.active');
                if (myActiveGenderBtn) {
                    currentChatRole.myGender = myActiveGenderBtn.dataset.gender;
                }
                
                // ä¿å­˜TAçš„æ€§åˆ«
                const taActiveGenderBtn = document.querySelector('.role-setting-item:nth-child(8) .gender-buttons button.active');
                if (taActiveGenderBtn) {
                    currentChatRole.taGender = taActiveGenderBtn.dataset.gender;
                }
                
                // ä¿å­˜å›å¤ç­–ç•¥
                currentChatRole.replyStrategy = currentChatRole.replyStrategy || 'active';
                
                // åŒæ—¶æ›´æ–°è§’è‰²çš„æ˜µç§°æ˜¾ç¤º
                currentChatRole.nickname = currentChatRole.taNickname || currentChatRole.nickname;
                
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                saveWechatRoles();
                
                // æ›´æ–°æ¶ˆæ¯åˆ—è¡¨ä¸­çš„è§’è‰²ä¿¡æ¯
                renderMessageList();
                
                alert('è§’è‰²è®¾ç½®å·²ä¿å­˜');
                switchToChatView();
                // åˆ‡æ¢åˆ°èŠå¤©è§†å›¾åé‡æ–°æ¸²æŸ“æ‰€æœ‰æ¶ˆæ¯ä»¥ç¡®ä¿å¤´åƒå’Œä¿¡æ¯éƒ½æ˜¯æœ€æ–°çš„
                setTimeout(() => {
                    // æ›´æ–°èŠå¤©å¤´éƒ¨çš„å¤´åƒå’Œæ˜µç§°
                    document.getElementById('chatName').textContent = currentChatRole.nickname;
                    const chatAvatar = document.getElementById('chatAvatar');
                    if (chatAvatar && currentChatRole) {
                        if (currentChatRole.avatarUrl) {
                            chatAvatar.innerHTML = `<img src="${currentChatRole.avatarUrl}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
                        } else if (currentChatRole.avatar) {
                            chatAvatar.textContent = currentChatRole.avatar;
                        } else {
                            chatAvatar.textContent = 'ğŸ‘§';
                        }
                    }
                    // åº”ç”¨èŠå¤©èƒŒæ™¯
                    applyChatBackground(currentChatRole);
                    // é‡æ–°æ¸²æŸ“æ‰€æœ‰èŠå¤©æ¶ˆæ¯
                    renderAllChatMessages();
                }, 100);
            } catch (error) {
                console.error("ä¿å­˜è§’è‰²è®¾ç½®å¤±è´¥ï¼š", error);
                alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        // ä¸Šä¼ èŠå¤©èƒŒæ™¯
        function uploadChatBackground() {
            try {
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = 'image/*,video/*';
                fileInput.onchange = function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const isVideo = file.type.startsWith('video/');
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const backgroundUrl = e.target.result;
                            if (currentChatRole) {
                                currentChatRole.chatBackground = backgroundUrl;
                                currentChatRole.chatBackgroundType = isVideo ? 'video' : 'image';
                                saveWechatRoles();
                                // ç«‹å³é¢„è§ˆèƒŒæ™¯
                                applyChatBackground(currentChatRole);
                                alert('èŠå¤©èƒŒæ™¯ä¸Šä¼ æˆåŠŸï¼');
                            }
                        };
                        reader.readAsDataURL(file);
                    }
                };
                fileInput.click();
            } catch (error) {
                console.error("ä¸Šä¼ èŠå¤©èƒŒæ™¯å¤±è´¥ï¼š", error);
                alert('ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        // åº”ç”¨èŠå¤©èƒŒæ™¯
        function applyChatBackground(role) {
            try {
                const chatView = document.getElementById('chatView');
                const videoBg = document.getElementById('chatVideoBackground');
                if (!chatView || !videoBg) return;
                
                // ç¡®ä¿èŠå¤©è§†å›¾æœ‰æ­£ç¡®çš„æ ·å¼
                chatView.style.position = 'relative';
                
                if (role && role.chatBackground) {
                    if (role.chatBackgroundType === 'video') {
                        // è§†é¢‘èƒŒæ™¯
                        chatView.style.background = '';
                        chatView.style.backgroundImage = '';
                        videoBg.src = role.chatBackground;
                        videoBg.style.display = 'block';
                        videoBg.play().catch(() => {});
                    } else {
                        // å›¾ç‰‡èƒŒæ™¯ - ä¼˜åŒ–ç”»è´¨æ˜¾ç¤ºï¼Œä¸ä½¿ç”¨fixedé¿å…ç§»åŠ¨ç«¯é—®é¢˜
                        videoBg.style.display = 'none';
                        videoBg.pause();
                        chatView.style.background = '';
                        chatView.style.backgroundImage = `url(${role.chatBackground})`;
                        chatView.style.backgroundPosition = 'center center';
                        chatView.style.backgroundSize = 'cover';
                        chatView.style.backgroundRepeat = 'no-repeat';
                        chatView.style.backgroundAttachment = 'scroll';
                    }
                } else {
                    // æ— èƒŒæ™¯
                    videoBg.style.display = 'none';
                    videoBg.pause();
                    chatView.style.background = '';
                    chatView.style.backgroundImage = '';
                }
            } catch (error) {
                console.error("åº”ç”¨èŠå¤©èƒŒæ™¯å¤±è´¥ï¼š", error);
            }
        }
        
        // æ¸…ç©ºèŠå¤©æ•°æ®
        function clearChatData() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºè¯¥è§’è‰²çš„æ‰€æœ‰èŠå¤©è®°å½•ã€è¡ŒåŠ¨çº¿å’Œæ•…äº‹å—ï¼Ÿ')) {
                try {
                    if (currentChatRole) {
                        // æ¸…ç©ºæ¶ˆæ¯å†å²
                        currentChatRole.messages = [];
                        // æ¸…ç©ºå…¶ä»–ç›¸å…³æ•°æ®
                        currentChatRole.moments = [];
                        currentChatRole.stories = [];
                        currentChatRole.actionLines = [];
                        saveWechatRoles();
                        alert('èŠå¤©æ•°æ®å·²æ¸…ç©º');
                    }
                } catch (error) {
                    console.error("æ¸…ç©ºèŠå¤©æ•°æ®å¤±è´¥ï¼š", error);
                    alert('æ¸…ç©ºå¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            }
        }
        
        // é€‰æ‹©è§’è‰²å¤´åƒ
        function selectRoleAvatar() {
            try {
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = 'image/*';
                fileInput.onchange = function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const avatarUrl = e.target.result;
                            if (currentChatRole) {
                                currentChatRole.avatarUrl = avatarUrl;
                                currentChatRole.avatar = avatarUrl; // åŒæ—¶æ›´æ–° avatar å­—æ®µ
                                saveWechatRoles();
                                document.getElementById('roleAvatar').src = avatarUrl;
                                // ç«‹å³æ›´æ–°æ¶ˆæ¯åˆ—è¡¨
                                renderMessageList();
                                // æ›´æ–°èŠå¤©ç•Œé¢çš„å¤´éƒ¨å¤´åƒå’Œæ‰€æœ‰å†å²æ¶ˆæ¯
                                const chatAvatar = document.getElementById('chatAvatar');
                                if (chatAvatar) {
                                    chatAvatar.innerHTML = `<img src="${avatarUrl}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
                                }
                                renderAllChatMessages();
                                alert('è§’è‰²å¤´åƒä¸Šä¼ æˆåŠŸï¼');
                            }
                        };
                        reader.readAsDataURL(file);
                    }
                };
                fileInput.click();
            } catch (error) {
                console.error("é€‰æ‹©è§’è‰²å¤´åƒå¤±è´¥ï¼š", error);
                alert('å¤´åƒé€‰æ‹©å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        // é€‰æ‹©æˆ‘çš„å¤´åƒ
        function selectMyAvatar() {
            try {
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = 'image/*';
                fileInput.onchange = function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const avatarUrl = e.target.result;
                            localStorage.setItem('myAvatarUrl', avatarUrl);
                            const myAvatarElement = document.getElementById('myAvatar');
                            if (myAvatarElement) {
                                myAvatarElement.src = avatarUrl;
                            }
                            // å¦‚æœå½“å‰åœ¨èŠå¤©ç•Œé¢ï¼Œåˆ·æ–°æ¶ˆæ¯åˆ—è¡¨ä»¥æ›´æ–°ç”¨æˆ·å¤´åƒ
                            if (currentChatRole) {
                                renderAllChatMessages();
                            }
                            alert('æˆ‘çš„å¤´åƒä¸Šä¼ æˆåŠŸï¼');
                        };
                        reader.readAsDataURL(file);
                    }
                };
                fileInput.click();
            } catch (error) {
                console.error("é€‰æ‹©æˆ‘çš„å¤´åƒå¤±è´¥ï¼š", error);
                alert('å¤´åƒé€‰æ‹©å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        // è®¾ç½®æˆ‘çš„æ€§åˆ«
        function setMyGender(gender) {
            try {
                const buttons = document.querySelectorAll('.gender-buttons button');
                buttons.forEach(btn => {
                    if (btn.dataset.gender === gender) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
            } catch (error) {
                console.error("è®¾ç½®æˆ‘çš„æ€§åˆ«å¤±è´¥ï¼š", error);
            }
        }
        
        // è®¾ç½®TAçš„æ€§åˆ«
        function setTaGender(gender) {
            try {
                const buttons = document.querySelectorAll('.gender-buttons button');
                buttons.forEach(btn => {
                    if (btn.dataset.gender === gender) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
            } catch (error) {
                console.error("è®¾ç½®TAçš„æ€§åˆ«å¤±è´¥ï¼š", error);
            }
        }
        
        // è®¾ç½®å›å¤ç­–ç•¥
        function setReplyStrategy(strategy) {
            try {
                if (currentChatRole) {
                    currentChatRole.replyStrategy = strategy;
                }
                
                const strategies = ['active', 'normal', 'buddha', 'manual'];
                strategies.forEach(s => {
                    const element = document.getElementById(`replyStrategy${s.charAt(0).toUpperCase() + s.slice(1)}`);
                    if (element) {
                        if (s === strategy) {
                            element.style.backgroundColor = '#ff69b4';
                            element.style.color = 'white';
                            element.textContent = 'â—';
                        } else {
                            element.style.backgroundColor = 'transparent';
                            element.style.color = 'transparent';
                            element.textContent = '';
                        }
                    }
                });
            } catch (error) {
                console.error("è®¾ç½®å›å¤ç­–ç•¥å¤±è´¥ï¼š", error);
            }
        }
        
        // æ¸…ç©ºèŠå¤©æ•°æ®
        function clearChatData() {
            try {
                if (confirm('ç¡®å®šè¦æ¸…ç©ºèŠå¤©/è¡ŒåŠ¨çº¿/æ•…äº‹æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                    // æ¸…ç©ºèŠå¤©æ•°æ®
                    currentChatRole.messages = [];
                    saveWechatRoles();
                    alert('æ•°æ®å·²æ¸…ç©º');
                }
            } catch (error) {
                console.error("æ¸…ç©ºèŠå¤©æ•°æ®å¤±è´¥ï¼š", error);
            }
        }
        
        // åŠŸèƒ½æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        function showEmojiPanel() {
            try {
                // åˆ›å»ºè¡¨æƒ…é¢æ¿
                const panel = document.createElement('div');
                panel.style.position = 'fixed';
                panel.style.bottom = '0';
                panel.style.left = '0';
                panel.style.width = '100%';
                panel.style.height = '300px';
                panel.style.backgroundColor = 'white';
                panel.style.borderTopLeftRadius = '20px';
                panel.style.borderTopRightRadius = '20px';
                panel.style.boxShadow = '0 -2px 10px rgba(0,0,0,0.1)';
                panel.style.zIndex = '1000';
                panel.style.display = 'flex';
                panel.style.flexDirection = 'column';
                
                // é¢æ¿å¤´éƒ¨
                const header = document.createElement('div');
                header.style.display = 'flex';
                header.style.justifyContent = 'space-between';
                header.style.alignItems = 'center';
                header.style.padding = '10px 20px';
                header.style.borderBottom = '1px solid #e0e0e0';
                
                const title = document.createElement('div');
                title.style.fontSize = '16px';
                title.style.fontWeight = '500';
                title.textContent = 'è¡¨æƒ…';
                
                const closeBtn = document.createElement('button');
                closeBtn.style.background = 'none';
                closeBtn.style.border = 'none';
                closeBtn.style.fontSize = '20px';
                closeBtn.style.cursor = 'pointer';
                closeBtn.textContent = 'Ã—';
                closeBtn.onclick = function() {
                    document.body.removeChild(panel);
                };
                
                header.appendChild(title);
                header.appendChild(closeBtn);
                panel.appendChild(header);
                
                // è¡¨æƒ…åº“æ ‡ç­¾
                const tabs = document.createElement('div');
                tabs.style.display = 'flex';
                tabs.style.borderBottom = '1px solid #e0e0e0';
                
                const userTab = document.createElement('button');
                userTab.style.flex = '1';
                userTab.style.padding = '10px';
                userTab.style.background = '#ff69b4';
                userTab.style.color = 'white';
                userTab.style.border = 'none';
                userTab.style.cursor = 'pointer';
                userTab.textContent = 'æˆ‘çš„è¡¨æƒ…';
                
                const roleTab = document.createElement('button');
                roleTab.style.flex = '1';
                roleTab.style.padding = '10px';
                roleTab.style.background = 'white';
                roleTab.style.color = '#333';
                roleTab.style.border = 'none';
                roleTab.style.cursor = 'pointer';
                roleTab.textContent = 'è§’è‰²è¡¨æƒ…';
                
                tabs.appendChild(userTab);
                tabs.appendChild(roleTab);
                panel.appendChild(tabs);
                
                // è¡¨æƒ…å†…å®¹åŒºåŸŸ
                const content = document.createElement('div');
                content.style.flex = '1';
                content.style.padding = '10px';
                content.style.overflowY = 'auto';
                
                // åŠ è½½ç”¨æˆ·è¡¨æƒ…
                loadUserEmojis(content);
                
                // æ ‡ç­¾åˆ‡æ¢
                userTab.onclick = function() {
                    userTab.style.background = '#ff69b4';
                    userTab.style.color = 'white';
                    roleTab.style.background = 'white';
                    roleTab.style.color = '#333';
                    content.innerHTML = '';
                    loadUserEmojis(content);
                };
                
                roleTab.onclick = function() {
                    roleTab.style.background = '#ff69b4';
                    roleTab.style.color = 'white';
                    userTab.style.background = 'white';
                    userTab.style.color = '#333';
                    content.innerHTML = '';
                    loadRoleEmojis(content);
                };
                
                panel.appendChild(content);
                document.body.appendChild(panel);
                
            } catch (error) {
                console.error("æ˜¾ç¤ºè¡¨æƒ…é¢æ¿å¤±è´¥ï¼š", error);
                alert('è¡¨æƒ…åŠŸèƒ½åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        // åŠ è½½ç”¨æˆ·è¡¨æƒ…
        function loadUserEmojis(container) {
            try {
                // è·å–è´¦å·é…ç½®
                const accountConfig = JSON.parse(localStorage.getItem('accountConfig') || '{}');
                const storageKey = accountConfig.loggedIn ? `userEmojis_${accountConfig.username}` : 'userEmojis';
                
                const userEmojis = JSON.parse(localStorage.getItem(storageKey) || '[]');
                
                // ä¸Šä¼ æŒ‰é’®
                const uploadBtn = document.createElement('div');
                uploadBtn.style.width = '60px';
                uploadBtn.style.height = '60px';
                uploadBtn.style.display = 'flex';
                uploadBtn.style.alignItems = 'center';
                uploadBtn.style.justifyContent = 'center';
                uploadBtn.style.border = '2px dashed #ccc';
                uploadBtn.style.borderRadius = '8px';
                uploadBtn.style.cursor = 'pointer';
                uploadBtn.style.margin = '5px';
                uploadBtn.innerHTML = '<span style="font-size: 24px;">+</span>';
                uploadBtn.title = 'ä¸Šä¼ è¡¨æƒ…';
                uploadBtn.onclick = function() {
                    uploadEmoji('user');
                };
                container.appendChild(uploadBtn);
                
                // æ˜¾ç¤ºç°æœ‰è¡¨æƒ…
                userEmojis.forEach(emoji => {
                    const emojiItem = document.createElement('div');
                    emojiItem.style.width = '60px';
                    emojiItem.style.height = '60px';
                    emojiItem.style.margin = '5px';
                    emojiItem.style.cursor = 'pointer';
                    emojiItem.style.borderRadius = '8px';
                    emojiItem.style.overflow = 'hidden';
                    emojiItem.title = 'ç‚¹å‡»å‘é€';
                    
                    const img = document.createElement('img');
                    img.src = emoji.url;
                    img.style.width = '100%';
                    img.style.height = '100%';
                    img.style.objectFit = 'cover';
                    
                    img.onclick = function() {
                        sendEmoji(emoji.url);
                        // å…³é—­é¢æ¿
                        const panel = container.closest('div[style*="position: fixed"]');
                        if (panel) {
                            document.body.removeChild(panel);
                        }
                    };
                    
                    emojiItem.appendChild(img);
                    container.appendChild(emojiItem);
                });
                
                // è®¾ç½®å¸ƒå±€
                container.style.display = 'flex';
                container.style.flexWrap = 'wrap';
                container.style.justifyContent = 'flex-start';
                
            } catch (error) {
                console.error("åŠ è½½ç”¨æˆ·è¡¨æƒ…å¤±è´¥ï¼š", error);
            }
        }
        
        // åŠ è½½è§’è‰²è¡¨æƒ…
        function loadRoleEmojis(container) {
            try {
                // è·å–è´¦å·é…ç½®
                const accountConfig = JSON.parse(localStorage.getItem('accountConfig') || '{}');
                const storageKey = accountConfig.loggedIn ? `roleEmojis_${accountConfig.username}` : 'roleEmojis';
                
                const roleEmojis = JSON.parse(localStorage.getItem(storageKey) || '[]');
                
                // ä¸Šä¼ æŒ‰é’®
                const uploadBtn = document.createElement('div');
                uploadBtn.style.width = '60px';
                uploadBtn.style.height = '60px';
                uploadBtn.style.display = 'flex';
                uploadBtn.style.alignItems = 'center';
                uploadBtn.style.justifyContent = 'center';
                uploadBtn.style.border = '2px dashed #ccc';
                uploadBtn.style.borderRadius = '8px';
                uploadBtn.style.cursor = 'pointer';
                uploadBtn.style.margin = '5px';
                uploadBtn.innerHTML = '<span style="font-size: 24px;">+</span>';
                uploadBtn.title = 'ä¸Šä¼ è¡¨æƒ…';
                uploadBtn.onclick = function() {
                    uploadEmoji('role');
                };
                container.appendChild(uploadBtn);
                
                // æ˜¾ç¤ºç°æœ‰è¡¨æƒ…
                roleEmojis.forEach(emoji => {
                    const emojiItem = document.createElement('div');
                    emojiItem.style.width = '60px';
                    emojiItem.style.height = '60px';
                    emojiItem.style.margin = '5px';
                    emojiItem.style.cursor = 'pointer';
                    emojiItem.style.borderRadius = '8px';
                    emojiItem.style.overflow = 'hidden';
                    emojiItem.title = 'ç‚¹å‡»å‘é€';
                    
                    const img = document.createElement('img');
                    img.src = emoji.url;
                    img.style.width = '100%';
                    img.style.height = '100%';
                    img.style.objectFit = 'cover';
                    
                    img.onclick = function() {
                        sendEmoji(emoji.url);
                        // å…³é—­é¢æ¿
                        const panel = container.closest('div[style*="position: fixed"]');
                        if (panel) {
                            document.body.removeChild(panel);
                        }
                    };
                    
                    emojiItem.appendChild(img);
                    container.appendChild(emojiItem);
                });
                
                // è®¾ç½®å¸ƒå±€
                container.style.display = 'flex';
                container.style.flexWrap = 'wrap';
                container.style.justifyContent = 'flex-start';
                
            } catch (error) {
                console.error("åŠ è½½è§’è‰²è¡¨æƒ…å¤±è´¥ï¼š", error);
            }
        }
        
        // ä¸Šä¼ è¡¨æƒ…
        function uploadEmoji(type) {
            try {
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = 'image/*';
                fileInput.onchange = function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const emojiUrl = e.target.result;
                            
                            // åˆ›å»ºè¡¨æƒ…åŒ…å«ä¹‰è¾“å…¥å¼¹çª—
                            const modal = document.createElement('div');
                            modal.style.position = 'fixed';
                            modal.style.top = '0';
                            modal.style.left = '0';
                            modal.style.width = '100%';
                            modal.style.height = '100%';
                            modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
                            modal.style.display = 'flex';
                            modal.style.alignItems = 'center';
                            modal.style.justifyContent = 'center';
                            modal.style.zIndex = '1001';
                            
                            const content = document.createElement('div');
                            content.style.backgroundColor = 'white';
                            content.style.borderRadius = '12px';
                            content.style.width = '90%';
                            content.style.maxWidth = '400px';
                            content.style.padding = '20px';
                            
                            content.innerHTML = `
                                <div style="text-align: center; margin-bottom: 20px;">
                                    <h3 style="font-size: 16px; font-weight: 500; margin-bottom: 10px;">æ·»åŠ è¡¨æƒ…åŒ…</h3>
                                    <div style="width: 100px; height: 100px; margin: 0 auto; border-radius: 8px; overflow: hidden; margin-bottom: 15px;">
                                        <img src="${emojiUrl}" style="width: 100%; height: 100%; object-fit: cover;">
                                    </div>
                                    <input type="text" id="emojiMeaning" placeholder="è¯·è¾“å…¥è¡¨æƒ…åŒ…å«ä¹‰" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px; margin-bottom: 20px;">
                                    <div style="display: flex; gap: 10px;">
                                        <button id="cancelEmojiBtn" style="flex: 1; padding: 10px; background-color: #f0f0f0; border: none; border-radius: 8px; font-size: 14px; cursor: pointer;">å–æ¶ˆ</button>
                                        <button id="saveEmojiBtn" style="flex: 1; padding: 10px; background-color: #ff69b4; border: none; border-radius: 8px; color: white; font-size: 14px; cursor: pointer;">ä¿å­˜</button>
                                    </div>
                                </div>
                            `;
                            
                            modal.appendChild(content);
                            document.body.appendChild(modal);
                            
                            // å–æ¶ˆæŒ‰é’®
                            document.getElementById('cancelEmojiBtn').onclick = function() {
                                document.body.removeChild(modal);
                            };
                            
                            // ä¿å­˜æŒ‰é’®
                            document.getElementById('saveEmojiBtn').onclick = function() {
                                const meaning = document.getElementById('emojiMeaning').value.trim();
                                const emoji = {
                                    id: Date.now().toString(),
                                    url: emojiUrl,
                                    name: file.name,
                                    type: type,
                                    meaning: meaning,
                                    createdAt: new Date().toISOString()
                                };
                                
                                // è·å–è´¦å·é…ç½®
                                const accountConfig = JSON.parse(localStorage.getItem('accountConfig') || '{}');
                                // ä¿å­˜åˆ°localStorage
                                const baseKey = type === 'user' ? 'userEmojis' : 'roleEmojis';
                                const storageKey = accountConfig.loggedIn ? `${baseKey}_${accountConfig.username}` : baseKey;
                                const emojis = JSON.parse(localStorage.getItem(storageKey) || '[]');
                                emojis.push(emoji);
                                localStorage.setItem(storageKey, JSON.stringify(emojis));
                                
                                alert('è¡¨æƒ…ä¸Šä¼ æˆåŠŸï¼');
                                document.body.removeChild(modal);
                                
                                // åˆ·æ–°è¡¨æƒ…é¢æ¿
                                const panel = document.querySelector('div[style*="position: fixed"]');
                                if (panel) {
                                    document.body.removeChild(panel);
                                    showEmojiPanel();
                                }
                            };
                        };
                        reader.readAsDataURL(file);
                    }
                };
                fileInput.click();
            } catch (error) {
                console.error("ä¸Šä¼ è¡¨æƒ…å¤±è´¥ï¼š", error);
                alert('è¡¨æƒ…ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        // å‘é€è¡¨æƒ…
        function sendEmoji(emojiUrl) {
            try {
                // æ·»åŠ è¡¨æƒ…æ¶ˆæ¯
                const chatMessages = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'chat-message own';
                messageDiv.innerHTML = `
                    <div class="bubble own">
                        <img src="${emojiUrl}" style="width: 60px; height: 60px; border-radius: 8px;">
                    </div>
                    <div class="avatar">ğŸ‘¤</div>
                `;
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // æ¨¡æ‹ŸAIå›å¤
                setTimeout(() => {
                    // è·å–è´¦å·é…ç½®
                    const accountConfig = JSON.parse(localStorage.getItem('accountConfig') || '{}');
                    const storageKey = accountConfig.loggedIn ? `roleEmojis_${accountConfig.username}` : 'roleEmojis';
                    
                    // è·å–è§’è‰²ä¸“å±è¡¨æƒ…åº“
                    const roleEmojis = JSON.parse(localStorage.getItem(storageKey) || '[]');
                    
                    // ç”Ÿæˆæ™ºèƒ½å›å¤
                    generateEmojiResponse(roleEmojis, emojiUrl);
                }, 1000);
                
            } catch (error) {
                console.error("å‘é€è¡¨æƒ…å¤±è´¥ï¼š", error);
            }
        }
        
        // ç”Ÿæˆè¡¨æƒ…åŒ…æ™ºèƒ½å›å¤
        function generateEmojiResponse(roleEmojis, userEmojiUrl) {
            try {
                const chatMessages = document.getElementById('chatMessages');
                
                // è·å–è´¦å·é…ç½®
                const accountConfig = JSON.parse(localStorage.getItem('accountConfig') || '{}');
                const storageKey = accountConfig.loggedIn ? `userEmojis_${accountConfig.username}` : 'userEmojis';
                
                // å°è¯•è·å–ç”¨æˆ·å‘é€çš„è¡¨æƒ…åŒ…å«ä¹‰
                const userEmojis = JSON.parse(localStorage.getItem(storageKey) || '[]');
                const userEmoji = userEmojis.find(emoji => emoji.url === userEmojiUrl);
                const userEmojiMeaning = userEmoji ? userEmoji.meaning : '';
                
                // è·å–æœ€è¿‘çš„å¯¹è¯ä¸Šä¸‹æ–‡
                const recentMessages = [];
                const messageElements = chatMessages.querySelectorAll('.chat-message');
                for (let i = messageElements.length - 1; i >= 0 && recentMessages.length < 5; i--) {
                    const messageElement = messageElements[i];
                    const bubble = messageElement.querySelector('.bubble');
                    if (bubble) {
                        const text = bubble.textContent.trim();
                        if (text) {
                            recentMessages.unshift(text);
                        }
                    }
                }
                const context = recentMessages.join(' ');
                
                // å¦‚æœè§’è‰²è¡¨æƒ…åº“ä¸ä¸ºç©ºï¼Œæ ¹æ®ä¸Šä¸‹æ–‡é€‰æ‹©åˆé€‚çš„è¡¨æƒ…åŒ…
                if (roleEmojis.length > 0) {
                    let selectedEmoji = null;
                    
                    // 1. é¦–å…ˆå°è¯•æ ¹æ®ç”¨æˆ·è¡¨æƒ…çš„å«ä¹‰åŒ¹é…
                    if (userEmojiMeaning) {
                        selectedEmoji = findMatchingEmoji(roleEmojis, userEmojiMeaning);
                    }
                    
                    // 2. å¦‚æœæ²¡æœ‰åŒ¹é…åˆ°ï¼Œå°è¯•æ ¹æ®å¯¹è¯ä¸Šä¸‹æ–‡åŒ¹é…
                    if (!selectedEmoji && context) {
                        selectedEmoji = findMatchingEmoji(roleEmojis, context);
                    }
                    
                    // 3. å¦‚æœä»ç„¶æ²¡æœ‰åŒ¹é…åˆ°ï¼Œéšæœºé€‰æ‹©ä¸€ä¸ª
                    if (!selectedEmoji) {
                        selectedEmoji = roleEmojis[Math.floor(Math.random() * roleEmojis.length)];
                    }
                    
                    // åˆ›å»ºè§’è‰²è¡¨æƒ…å›å¤
                    const roleMessageDiv = document.createElement('div');
                    roleMessageDiv.className = 'chat-message';
                    roleMessageDiv.innerHTML = `
                        <div class="avatar">ğŸ‘§</div>
                        <div class="bubble other">
                            <img src="${selectedEmoji.url}" style="width: 60px; height: 60px; border-radius: 8px;">
                        </div>
                    `;
                    chatMessages.appendChild(roleMessageDiv);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                } else {
                    // å¦‚æœè§’è‰²è¡¨æƒ…åº“ä¸ºç©ºï¼Œä½¿ç”¨æ–‡æœ¬å›å¤
                    const responses = [
                        'å“ˆå“ˆï¼Œæœ‰è¶£ï¼',
                        'æˆ‘ä¹Ÿè¿™ä¹ˆè§‰å¾—ï¼',
                        'ä½ çœŸå¯çˆ±ï¼',
                        'æ²¡é”™ï¼',
                        'åŒæ„ï¼',
                        'å¤ªæ£’äº†ï¼',
                        'å¥½çš„ï¼',
                        'æ˜ç™½äº†ï¼'
                    ];
                    
                    const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                    const roleMessageDiv = document.createElement('div');
                    roleMessageDiv.className = 'chat-message';
                    roleMessageDiv.innerHTML = `
                        <div class="avatar">ğŸ‘§</div>
                        <div class="bubble other">${randomResponse}</div>
                    `;
                    chatMessages.appendChild(roleMessageDiv);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
                
            } catch (error) {
                console.error("ç”Ÿæˆè¡¨æƒ…å›å¤å¤±è´¥ï¼š", error);
                // å¤±è´¥æ—¶ä½¿ç”¨é»˜è®¤å›å¤
                const chatMessages = document.getElementById('chatMessages');
                const roleMessageDiv = document.createElement('div');
                roleMessageDiv.className = 'chat-message';
                roleMessageDiv.innerHTML = `
                    <div class="avatar">ğŸ‘§</div>
                    <div class="bubble other">å“ˆå“ˆï¼</div>
                `;
                chatMessages.appendChild(roleMessageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }
        
        // æ ¹æ®æ–‡æœ¬å†…å®¹åŒ¹é…åˆé€‚çš„è¡¨æƒ…åŒ…
        function findMatchingEmoji(emojis, text) {
            // ç®€å•çš„å…³é”®è¯åŒ¹é…
            const keywordMap = {
                'å¼€å¿ƒ': ['happy', 'joy', 'laugh', 'smile', 'å¼€å¿ƒ', 'å¿«ä¹', 'é«˜å…´', 'å“ˆå“ˆ'],
                'ä¼¤å¿ƒ': ['sad', 'cry', 'éš¾è¿‡', 'ä¼¤å¿ƒ', 'å“­'],
                'ç”Ÿæ°”': ['angry', 'mad', 'ç”Ÿæ°”', 'æ„¤æ€’'],
                'æƒŠè®¶': ['surprised', 'shock', 'æƒŠè®¶', 'éœ‡æƒŠ'],
                'çˆ±å¿ƒ': ['love', 'heart', 'çˆ±å¿ƒ', 'å–œæ¬¢'],
                'æ„Ÿè°¢': ['thank', 'thanks', 'æ„Ÿè°¢', 'è°¢è°¢'],
                'åŒæ„': ['agree', 'yes', 'ok', 'å¥½çš„', 'åŒæ„', 'æ˜¯çš„'],
                'æ‹’ç»': ['no', 'æ‹’ç»', 'ä¸è¦', 'ä¸è¡Œ']
            };
            
            // è®¡ç®—æ¯ä¸ªè¡¨æƒ…çš„åŒ¹é…åˆ†æ•°
            let bestMatch = null;
            let highestScore = 0;
            
            emojis.forEach(emoji => {
                let score = 0;
                const emojiMeaning = emoji.meaning || '';
                
                // æ£€æŸ¥è¡¨æƒ…åŒ…å«ä¹‰ä¸æ–‡æœ¬çš„åŒ¹é…åº¦
                for (const [emotion, keywords] of Object.entries(keywordMap)) {
                    for (const keyword of keywords) {
                        if (text.includes(keyword) || emojiMeaning.includes(keyword)) {
                            score += 1;
                        }
                    }
                }
                
                // å¦‚æœåˆ†æ•°æ›´é«˜ï¼Œæ›´æ–°æœ€ä½³åŒ¹é…
                if (score > highestScore) {
                    highestScore = score;
                    bestMatch = emoji;
                }
            });
            
            return bestMatch;
        }
        
        function selectImage() {
            try {
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = 'image/*';
                fileInput.onchange = function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const imageUrl = e.target.result;
                            sendImage(imageUrl, file.name);
                        };
                        reader.readAsDataURL(file);
                    }
                };
                fileInput.click();
            } catch (error) {
                console.error("é€‰æ‹©å›¾ç‰‡å¤±è´¥ï¼š", error);
                alert('å›¾ç‰‡é€‰æ‹©å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        // å‘é€å›¾ç‰‡
        function sendImage(imageUrl, fileName) {
            try {
                // æ·»åŠ å›¾ç‰‡æ¶ˆæ¯
                const chatMessages = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'chat-message own';
                messageDiv.innerHTML = `
                    <div class="bubble own" style="max-width: 70%;">
                        <img src="${imageUrl}" style="max-width: 100%; max-height: 300px; border-radius: 8px; object-fit: cover;">
                        <div style="font-size: 12px; color: rgba(255,255,255,0.7); margin-top: 4px;">${fileName}</div>
                    </div>
                    <div class="avatar">ğŸ‘¤</div>
                `;
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // å°è¯•è¿›è¡Œå›¾ç‰‡è¯†åˆ«
                recognizeImage(imageUrl);
                
            } catch (error) {
                console.error("å‘é€å›¾ç‰‡å¤±è´¥ï¼š", error);
            }
        }
        
        // è¯†åˆ«å›¾ç‰‡
        async function recognizeImage(imageUrl) {
            try {
                // è·å–è¯†å›¾APIé…ç½®
                const imageRecognitionConfig = JSON.parse(localStorage.getItem('imageRecognitionConfig') || '{}');
                const apiKey = imageRecognitionConfig.apiKey;
                const apiUrl = imageRecognitionConfig.apiUrl || 'https://api.openai.com/v1/chat/completions';
                const model = imageRecognitionConfig.model || 'gpt-4-vision-preview';
                
                if (!apiKey) {
                    // å¦‚æœæ²¡æœ‰é…ç½®APIï¼Œä½¿ç”¨æ¨¡æ‹Ÿå›å¤
                    setTimeout(() => {
                        sendImageRecognitionReply('è¿™æ˜¯ä¸€å¼ å›¾ç‰‡');
                    }, 1000);
                    return;
                }
                
                // è°ƒç”¨è¯†å›¾API
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: [
                            {
                                role: 'user',
                                content: [
                                    {
                                        type: 'text',
                                        text: 'è¯·æè¿°è¿™å¼ å›¾ç‰‡çš„å†…å®¹'
                                    },
                                    {
                                        type: 'image_url',
                                        image_url: {
                                            url: imageUrl
                                        }
                                    }
                                ]
                            }
                        ],
                        max_tokens: 300
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const description = data.choices[0].message.content;
                sendImageRecognitionReply(description);
                
            } catch (error) {
                console.error("å›¾ç‰‡è¯†åˆ«å¤±è´¥ï¼š", error);
                // å¤±è´¥æ—¶ä½¿ç”¨æ¨¡æ‹Ÿå›å¤
                sendImageRecognitionReply('è¿™æ˜¯ä¸€å¼ å›¾ç‰‡');
            }
        }
        
        // å‘é€å›¾ç‰‡è¯†åˆ«å›å¤
        function sendImageRecognitionReply(description) {
            try {
                const chatMessages = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'chat-message';
                messageDiv.innerHTML = `
                    <div class="avatar">ğŸ‘§</div>
                    <div class="bubble other">
                        <div>${description}</div>
                    </div>
                `;
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            } catch (error) {
                console.error("å‘é€å›¾ç‰‡è¯†åˆ«å›å¤å¤±è´¥ï¼š", error);
            }
        }
        
        // è¯­éŸ³APIé…ç½®
        function showVoiceSettings() {
            try {
                // è·å–å½“å‰è¯­éŸ³é…ç½®
                const voiceConfig = JSON.parse(localStorage.getItem('voiceConfig') || '{}');
                
                const html = `
                    <div style="padding: 20px;">
                        <h3 style="font-size: 16px; font-weight: 500; margin-bottom: 16px;">è¯­éŸ³è®¾ç½®</h3>
                        
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-size: 14px; color: #999; margin-bottom: 4px;">è¯­éŸ³è¯†åˆ«API</label>
                            <select id="speechRecognitionApi" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px; background-color: white;">
                                <option value="web-speech-api" ${voiceConfig.speechRecognitionApi === 'web-speech-api' ? 'selected' : ''}>Web Speech API</option>
                                <option value="custom" ${voiceConfig.speechRecognitionApi === 'custom' ? 'selected' : ''}>è‡ªå®šä¹‰API</option>
                            </select>
                        </div>
                        
                        <div id="customRecognitionApiItem" style="margin-bottom: 16px; ${voiceConfig.speechRecognitionApi === 'custom' ? 'display: block;' : 'display: none;'}">
                            <label style="display: block; font-size: 14px; color: #999; margin-bottom: 4px;">è‡ªå®šä¹‰APIåœ°å€</label>
                            <input type="text" id="customRecognitionApiUrl" value="${voiceConfig.customRecognitionApiUrl || ''}" placeholder="https://api.example.com/speech-to-text" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                        </div>
                        
                        <div id="customRecognitionApiKeyItem" style="margin-bottom: 16px; ${voiceConfig.speechRecognitionApi === 'custom' ? 'display: block;' : 'display: none;'}">
                            <label style="display: block; font-size: 14px; color: #999; margin-bottom: 4px;">APIå¯†é’¥</label>
                            <input type="password" id="customRecognitionApiKey" value="${voiceConfig.customRecognitionApiKey || ''}" placeholder="è¾“å…¥APIå¯†é’¥" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                        </div>
                        
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-size: 14px; color: #999; margin-bottom: 4px;">è¯­éŸ³åˆæˆAPI</label>
                            <select id="speechSynthesisApi" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px; background-color: white;">
                                <option value="web-speech-api" ${voiceConfig.speechSynthesisApi === 'web-speech-api' ? 'selected' : ''}>Web Speech API</option>
                                <option value="custom" ${voiceConfig.speechSynthesisApi === 'custom' ? 'selected' : ''}>è‡ªå®šä¹‰API</option>
                            </select>
                        </div>
                        
                        <div id="customSynthesisApiItem" style="margin-bottom: 16px; ${voiceConfig.speechSynthesisApi === 'custom' ? 'display: block;' : 'display: none;'}">
                            <label style="display: block; font-size: 14px; color: #999; margin-bottom: 4px;">è‡ªå®šä¹‰APIåœ°å€</label>
                            <input type="text" id="customSynthesisApiUrl" value="${voiceConfig.customSynthesisApiUrl || ''}" placeholder="https://api.example.com/text-to-speech" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                        </div>
                        
                        <div id="customSynthesisApiKeyItem" style="margin-bottom: 16px; ${voiceConfig.speechSynthesisApi === 'custom' ? 'display: block;' : 'display: none;'}">
                            <label style="display: block; font-size: 14px; color: #999; margin-bottom: 4px;">APIå¯†é’¥</label>
                            <input type="password" id="customSynthesisApiKey" value="${voiceConfig.customSynthesisApiKey || ''}" placeholder="è¾“å…¥APIå¯†é’¥" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                        </div>
                        
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-size: 14px; color: #999; margin-bottom: 4px;">è¯­éŸ³è¯†åˆ«è¯­è¨€</label>
                            <select id="recognitionLanguage" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px; background-color: white;">
                                <option value="zh-CN" ${voiceConfig.recognitionLanguage === 'zh-CN' ? 'selected' : ''}>ä¸­æ–‡ (zh-CN)</option>
                                <option value="en-US" ${voiceConfig.recognitionLanguage === 'en-US' ? 'selected' : ''}>è‹±æ–‡ (en-US)</option>
                            </select>
                        </div>
                        
                        <button id="saveVoiceConfigBtn" style="width: 100%; padding: 12px; background-color: #ff69b4; border: none; border-radius: 8px; color: white; font-size: 16px; cursor: pointer;">ä¿å­˜è®¾ç½®</button>
                    </div>
                `;
                
                // åˆ›å»ºå¼¹çª—
                const modal = document.createElement('div');
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.width = '100%';
                modal.style.height = '100%';
                modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
                modal.style.display = 'flex';
                modal.style.alignItems = 'center';
                modal.style.justifyContent = 'center';
                modal.style.zIndex = '1000';
                
                const content = document.createElement('div');
                content.style.backgroundColor = 'white';
                content.style.borderRadius = '12px';
                content.style.width = '90%';
                content.style.maxWidth = '400px';
                content.style.maxHeight = '80%';
                content.style.overflowY = 'auto';
                content.innerHTML = html;
                
                modal.appendChild(content);
                document.body.appendChild(modal);
                
                // æ·»åŠ äº‹ä»¶ç›‘å¬
                document.getElementById('speechRecognitionApi').addEventListener('change', function() {
                    const customItem = document.getElementById('customRecognitionApiItem');
                    const customKeyItem = document.getElementById('customRecognitionApiKeyItem');
                    if (this.value === 'custom') {
                        customItem.style.display = 'block';
                        customKeyItem.style.display = 'block';
                    } else {
                        customItem.style.display = 'none';
                        customKeyItem.style.display = 'none';
                    }
                });
                
                document.getElementById('speechSynthesisApi').addEventListener('change', function() {
                    const customItem = document.getElementById('customSynthesisApiItem');
                    const customKeyItem = document.getElementById('customSynthesisApiKeyItem');
                    if (this.value === 'custom') {
                        customItem.style.display = 'block';
                        customKeyItem.style.display = 'block';
                    } else {
                        customItem.style.display = 'none';
                        customKeyItem.style.display = 'none';
                    }
                });
                
                document.getElementById('saveVoiceConfigBtn').addEventListener('click', function() {
                    const config = {
                        speechRecognitionApi: document.getElementById('speechRecognitionApi').value,
                        customRecognitionApiUrl: document.getElementById('customRecognitionApiUrl').value,
                        customRecognitionApiKey: document.getElementById('customRecognitionApiKey').value,
                        speechSynthesisApi: document.getElementById('speechSynthesisApi').value,
                        customSynthesisApiUrl: document.getElementById('customSynthesisApiUrl').value,
                        customSynthesisApiKey: document.getElementById('customSynthesisApiKey').value,
                        recognitionLanguage: document.getElementById('recognitionLanguage').value
                    };
                    localStorage.setItem('voiceConfig', JSON.stringify(config));
                    alert('è¯­éŸ³è®¾ç½®å·²ä¿å­˜ï¼');
                    document.body.removeChild(modal);
                });
                
                // æ·»åŠ å…³é—­åŠŸèƒ½
                modal.onclick = function(e) {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                };
                
            } catch (error) {
                console.error("æ˜¾ç¤ºè¯­éŸ³è®¾ç½®å¤±è´¥ï¼š", error);
                alert('è¯­éŸ³è®¾ç½®åŠŸèƒ½åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        // è¯­éŸ³è¯†åˆ«åŠŸèƒ½
        function startSpeechRecognition() {
            try {
                // è·å–è¯­éŸ³é…ç½®
                const voiceConfig = JSON.parse(localStorage.getItem('voiceConfig') || '{}');
                const language = voiceConfig.recognitionLanguage || 'zh-CN';
                
                // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒWeb Speech API
                if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    const recognition = new SpeechRecognition();
                    
                    recognition.lang = language;
                    recognition.continuous = false;
                    recognition.interimResults = false;
                    
                    recognition.onstart = function() {
                        console.log('è¯­éŸ³è¯†åˆ«å·²å¼€å§‹');
                    };
                    
                    recognition.onresult = function(event) {
                        const transcript = event.results[0][0].transcript;
                        console.log('è¯†åˆ«ç»“æœ:', transcript);
                        // è¿™é‡Œå¯ä»¥å¤„ç†è¯†åˆ«ç»“æœï¼Œæ¯”å¦‚å‘é€æ¶ˆæ¯
                        if (transcript) {
                            const chatInput = document.getElementById('chatInput');
                            chatInput.value = transcript;
                            // è‡ªåŠ¨å‘é€æ¶ˆæ¯
                            sendChatMessage();
                        }
                    };
                    
                    recognition.onerror = function(event) {
                        console.error('è¯­éŸ³è¯†åˆ«é”™è¯¯:', event.error);
                        alert('è¯­éŸ³è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•');
                    };
                    
                    recognition.onend = function() {
                        console.log('è¯­éŸ³è¯†åˆ«å·²ç»“æŸ');
                    };
                    
                    recognition.start();
                } else {
                    alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«åŠŸèƒ½');
                }
                
            } catch (error) {
                console.error("å¼€å§‹è¯­éŸ³è¯†åˆ«å¤±è´¥ï¼š", error);
                alert('è¯­éŸ³è¯†åˆ«åŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·é‡è¯•');
            }
        }
        
        // è¯­éŸ³åˆæˆåŠŸèƒ½
        function speak(text) {
            try {
                // è·å–è¯­éŸ³é…ç½®
                const voiceConfig = JSON.parse(localStorage.getItem('voiceConfig') || '{}');
                
                // æ£€æŸ¥æ¶ˆæ¯æœ—è¯»æ˜¯å¦å¯ç”¨
                if (voiceConfig.speechEnabled === false) {
                    return;
                }
                
                // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒWeb Speech API
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = voiceConfig.recognitionLanguage || 'zh-CN';
                    utterance.rate = 1;
                    utterance.pitch = 1;
                    utterance.volume = 1;
                    
                    speechSynthesis.speak(utterance);
                } else {
                    console.log('æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åˆæˆåŠŸèƒ½');
                }
                
            } catch (error) {
                console.error("è¯­éŸ³åˆæˆå¤±è´¥ï¼š", error);
            }
        }
        
        function makeCall() {
            try {
                // åˆ›å»ºé€šè¯ç•Œé¢
                const callPanel = document.createElement('div');
                callPanel.style.position = 'fixed';
                callPanel.style.top = '0';
                callPanel.style.left = '0';
                callPanel.style.width = '100%';
                callPanel.style.height = '100%';
                callPanel.style.backgroundColor = '#f5f5f5';
                callPanel.style.display = 'flex';
                callPanel.style.flexDirection = 'column';
                callPanel.style.alignItems = 'center';
                callPanel.style.justifyContent = 'space-between';
                callPanel.style.padding = '40px 20px';
                callPanel.style.zIndex = '1000';
                
                // é€šè¯ä¿¡æ¯åŒºåŸŸ
                const callInfo = document.createElement('div');
                callInfo.style.display = 'flex';
                callInfo.style.flexDirection = 'column';
                callInfo.style.alignItems = 'center';
                callInfo.style.marginTop = '100px';
                
                // å¤´åƒ
                const avatar = document.createElement('div');
                avatar.style.width = '120px';
                avatar.style.height = '120px';
                avatar.style.borderRadius = '50%';
                avatar.style.backgroundColor = '#ff69b4';
                avatar.style.display = 'flex';
                avatar.style.alignItems = 'center';
                avatar.style.justifyContent = 'center';
                avatar.style.fontSize = '48px';
                avatar.textContent = 'ğŸ‘§';
                avatar.style.marginBottom = '20px';
                
                // å§“å
                const name = document.createElement('div');
                name.style.fontSize = '24px';
                name.style.fontWeight = '500';
                name.textContent = currentChatRole ? currentChatRole.nickname : 'AIåŠ©æ‰‹';
                name.style.marginBottom = '10px';
                
                // é€šè¯çŠ¶æ€
                const status = document.createElement('div');
                status.style.fontSize = '14px';
                status.style.color = '#666';
                status.textContent = 'æ­£åœ¨é€šè¯ä¸­...';
                
                // é€šè¯æ—¶é•¿
                const duration = document.createElement('div');
                duration.id = 'callDuration';
                duration.style.fontSize = '16px';
                duration.style.marginTop = '20px';
                duration.textContent = '00:00';
                
                callInfo.appendChild(avatar);
                callInfo.appendChild(name);
                callInfo.appendChild(status);
                callInfo.appendChild(duration);
                
                // æ§åˆ¶æŒ‰é’®åŒºåŸŸ
                const controls = document.createElement('div');
                controls.style.display = 'flex';
                controls.style.gap = '20px';
                controls.style.marginBottom = '100px';
                
                // é™éŸ³æŒ‰é’®
                const muteBtn = document.createElement('button');
                muteBtn.style.width = '60px';
                muteBtn.style.height = '60px';
                muteBtn.style.borderRadius = '50%';
                muteBtn.style.border = 'none';
                muteBtn.style.backgroundColor = 'white';
                muteBtn.style.boxShadow = '0 2px 10px rgba(0,0,0,0.1)';
                muteBtn.style.display = 'flex';
                muteBtn.style.alignItems = 'center';
                muteBtn.style.justifyContent = 'center';
                muteBtn.style.fontSize = '24px';
                muteBtn.textContent = 'ğŸ”‡';
                muteBtn.title = 'é™éŸ³';
                
                let isMuted = false;
                muteBtn.onclick = function() {
                    isMuted = !isMuted;
                    muteBtn.textContent = isMuted ? 'ğŸ”Š' : 'ğŸ”‡';
                    muteBtn.title = isMuted ? 'å–æ¶ˆé™éŸ³' : 'é™éŸ³';
                };
                
                // æ‰¬å£°å™¨æŒ‰é’®
                const speakerBtn = document.createElement('button');
                speakerBtn.style.width = '60px';
                speakerBtn.style.height = '60px';
                speakerBtn.style.borderRadius = '50%';
                speakerBtn.style.border = 'none';
                speakerBtn.style.backgroundColor = 'white';
                speakerBtn.style.boxShadow = '0 2px 10px rgba(0,0,0,0.1)';
                speakerBtn.style.display = 'flex';
                speakerBtn.style.alignItems = 'center';
                speakerBtn.style.justifyContent = 'center';
                speakerBtn.style.fontSize = '24px';
                speakerBtn.textContent = 'ğŸ”Š';
                speakerBtn.title = 'æ‰¬å£°å™¨';
                
                // è¯­éŸ³è¯†åˆ«æŒ‰é’®
                const voiceBtn = document.createElement('button');
                voiceBtn.style.width = '60px';
                voiceBtn.style.height = '60px';
                voiceBtn.style.borderRadius = '50%';
                voiceBtn.style.border = 'none';
                voiceBtn.style.backgroundColor = 'white';
                voiceBtn.style.boxShadow = '0 2px 10px rgba(0,0,0,0.1)';
                voiceBtn.style.display = 'flex';
                voiceBtn.style.alignItems = 'center';
                voiceBtn.style.justifyContent = 'center';
                voiceBtn.style.fontSize = '24px';
                voiceBtn.textContent = 'ğŸ¤';
                voiceBtn.title = 'è¯­éŸ³è¾“å…¥';
                voiceBtn.onclick = function() {
                    startSpeechRecognition();
                };
                
                // ç»“æŸé€šè¯æŒ‰é’®
                const endBtn = document.createElement('button');
                endBtn.style.width = '70px';
                endBtn.style.height = '70px';
                endBtn.style.borderRadius = '50%';
                endBtn.style.border = 'none';
                endBtn.style.backgroundColor = '#ff3b30';
                endBtn.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
                endBtn.style.display = 'flex';
                endBtn.style.alignItems = 'center';
                endBtn.style.justifyContent = 'center';
                endBtn.style.fontSize = '24px';
                endBtn.textContent = 'ğŸ”´';
                endBtn.title = 'ç»“æŸé€šè¯';
                
                endBtn.onclick = function() {
                    // åœæ­¢è®¡æ—¶å™¨
                    clearInterval(timer);
                    // åœæ­¢éŸ³é¢‘å½•åˆ¶
                    if (mediaRecorder) {
                        mediaRecorder.stop();
                    }
                    // åœæ­¢è¯­éŸ³åˆæˆ
                    if ('speechSynthesis' in window) {
                        speechSynthesis.cancel();
                    }
                    // ç§»é™¤é€šè¯é¢æ¿
                    document.body.removeChild(callPanel);
                    // æ˜¾ç¤ºé€šè¯ç»“æŸæç¤º
                    alert('é€šè¯å·²ç»“æŸ');
                };
                
                controls.appendChild(muteBtn);
                controls.appendChild(voiceBtn);
                controls.appendChild(endBtn);
                controls.appendChild(speakerBtn);
                
                // å¼€å§‹é€šè¯è®¡æ—¶å™¨
                let seconds = 0;
                const timer = setInterval(function() {
                    seconds++;
                    const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
                    const secs = (seconds % 60).toString().padStart(2, '0');
                    document.getElementById('callDuration').textContent = `${mins}:${secs}`;
                }, 1000);
                
                // å°è¯•ä½¿ç”¨Web Audio APIè¿›è¡Œè¯­éŸ³å½•åˆ¶
                let mediaRecorder;
                let audioChunks = [];
                
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(stream => {
                        mediaRecorder = new MediaRecorder(stream);
                        
                        mediaRecorder.ondataavailable = function(e) {
                            if (e.data.size > 0) {
                                audioChunks.push(e.data);
                            }
                        };
                        
                        mediaRecorder.onstop = function() {
                            const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                            const audioUrl = URL.createObjectURL(audioBlob);
                            // è¿™é‡Œå¯ä»¥ä¿å­˜å½•éŸ³æˆ–è¿›è¡Œå…¶ä»–å¤„ç†
                            console.log('å½•éŸ³å·²ä¿å­˜:', audioUrl);
                        };
                        
                        // å¼€å§‹å½•åˆ¶
                        mediaRecorder.start();
                    })
                    .catch(error => {
                        console.error('æ— æ³•è®¿é—®éº¦å…‹é£:', error);
                        alert('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œé€šè¯åŠŸèƒ½å¯èƒ½å—é™');
                    });
                
                callPanel.appendChild(callInfo);
                callPanel.appendChild(controls);
                document.body.appendChild(callPanel);
                
                // è‡ªåŠ¨æ’­æ”¾æ¬¢è¿è¯­
                setTimeout(() => {
                    speak('ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„AIåŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ çš„å—ï¼Ÿ');
                }, 1000);
                
            } catch (error) {
                console.error("å‘èµ·é€šè¯å¤±è´¥ï¼š", error);
                alert('é€šè¯åŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·é‡è¯•');
            }
        }
        
        function showTransferModal() {
            alert('è½¬è´¦åŠŸèƒ½å¼€å‘ä¸­');
        }
        
        function showMemoryModal() {
            alert('è®°å¿†åŠŸèƒ½å¼€å‘ä¸­');
        }
        
        function showStoryModal() {
            alert('æ•…äº‹åŠŸèƒ½å¼€å‘ä¸­');
        }
        
        function showActionLineModal() {
            alert('è¡ŒåŠ¨çº¿åŠŸèƒ½å¼€å‘ä¸­');
        }
        
        function showTravelModal() {
            alert('æ—…æ¸¸åŠŸèƒ½å¼€å‘ä¸­');
        }
        
        // è®¾ç½®é¡µé¢ç‚¹å‡»äº‹ä»¶
        function showVoiceSettings() {
            try {
                const voiceTypes = ['default', 'cute', 'mature', 'professional', 'friendly'];
                const selectedType = wechatSettings.voice.type || 'default';
                
                let html = `
                    <div style="padding: 20px;">
                        <h3 style="font-size: 16px; font-weight: 500; margin-bottom: 16px;">è‡ªå®šä¹‰éŸ³è‰²</h3>
                `;
                
                voiceTypes.forEach(type => {
                    html += `
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; border-bottom: 1px solid #e0e0e0;">
                            <div style="font-size: 14px;">${getVoiceTypeName(type)}</div>
                            <div style="width: 20px; height: 20px; border: 2px solid #e0e0e0; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                ${selectedType === type ? '<div style="width: 12px; height: 12px; border-radius: 50%; background-color: #ff69b4;"></div>' : ''}
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        <button style="margin-top: 20px; width: 100%; padding: 12px; background-color: #ff69b4; border: none; border-radius: 8px; color: white; font-size: 16px;">ä¿å­˜</button>
                    </div>
                `;
                
                // åˆ›å»ºå¼¹çª—
                const modal = document.createElement('div');
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.width = '100%';
                modal.style.height = '100%';
                modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
                modal.style.display = 'flex';
                modal.style.alignItems = 'center';
                modal.style.justifyContent = 'center';
                modal.style.zIndex = '1000';
                
                const content = document.createElement('div');
                content.style.backgroundColor = 'white';
                content.style.borderRadius = '12px';
                content.style.width = '90%';
                content.style.maxWidth = '400px';
                content.style.maxHeight = '80%';
                content.style.overflowY = 'auto';
                content.innerHTML = html;
                
                modal.appendChild(content);
                document.body.appendChild(modal);
                
                // æ·»åŠ å…³é—­åŠŸèƒ½
                modal.onclick = function(e) {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                };
            } catch (error) {
                console.error("æ˜¾ç¤ºéŸ³è‰²è®¾ç½®å¤±è´¥ï¼š", error);
            }
        }
        
        function getVoiceTypeName(type) {
            const types = {
                default: 'é»˜è®¤éŸ³è‰²',
                cute: 'å¯çˆ±éŸ³è‰²',
                mature: 'æˆç†ŸéŸ³è‰²',
                professional: 'ä¸“ä¸šéŸ³è‰²',
                friendly: 'å‹å¥½éŸ³è‰²'
            };
            return types[type] || type;
        }
        
        function showActiveTalkSettings() {
            try {
                const enabled = wechatSettings.activeTalk?.enabled || true;
                const frequency = wechatSettings.activeTalk?.frequency || 'medium';
                
                const html = `
                    <div style="padding: 20px;">
                        <h3 style="font-size: 16px; font-weight: 500; margin-bottom: 16px;">ä¸»åŠ¨å‘è¨€è®¾ç½®</h3>
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; border-bottom: 1px solid #e0e0e0;">
                            <div style="font-size: 14px;">å¯ç”¨ä¸»åŠ¨å‘è¨€</div>
                            <label style="position: relative; display: inline-block; width: 50px; height: 24px;">
                                <input type="checkbox" id="activeTalkEnabled" ${enabled ? 'checked' : ''} style="opacity: 0; width: 0; height: 0;">
                                <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px;"></span>
                                <span style="position: absolute; cursor: pointer; top: 2px; left: 2px; bottom: 2px; width: 20px; background-color: white; transition: .4s; border-radius: 50%;"></span>
                            </label>
                        </div>
                        <div style="margin-top: 16px;">
                            <div style="font-size: 14px; margin-bottom: 12px;">å‘è¨€é¢‘ç‡</div>
                            <div style="display: flex; justify-content: space-between;">
                                <button id="freqLow" style="padding: 8px 16px; border: 1px solid #e0e0e0; border-radius: 16px; background-color: ${frequency === 'low' ? '#ff69b4' : 'white'}; color: ${frequency === 'low' ? 'white' : '#333'}; font-size: 14px;">ä½</button>
                                <button id="freqMedium" style="padding: 8px 16px; border: 1px solid #e0e0e0; border-radius: 16px; background-color: ${frequency === 'medium' ? '#ff69b4' : 'white'}; color: ${frequency === 'medium' ? 'white' : '#333'}; font-size: 14px;">ä¸­</button>
                                <button id="freqHigh" style="padding: 8px 16px; border: 1px solid #e0e0e0; border-radius: 16px; background-color: ${frequency === 'high' ? '#ff69b4' : 'white'}; color: ${frequency === 'high' ? 'white' : '#333'}; font-size: 14px;">é«˜</button>
                            </div>
                        </div>
                        <button onclick="saveActiveTalkSettings()" style="margin-top: 20px; width: 100%; padding: 12px; background-color: #ff69b4; border: none; border-radius: 8px; color: white; font-size: 16px;">ä¿å­˜</button>
                    </div>
                `;
                
                // åˆ›å»ºå¼¹çª—
                const modal = document.createElement('div');
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.width = '100%';
                modal.style.height = '100%';
                modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
                modal.style.display = 'flex';
                modal.style.alignItems = 'center';
                modal.style.justifyContent = 'center';
                modal.style.zIndex = '1000';
                
                const content = document.createElement('div');
                content.style.backgroundColor = 'white';
                content.style.borderRadius = '12px';
                content.style.width = '90%';
                content.style.maxWidth = '400px';
                content.innerHTML = html;
                
                modal.appendChild(content);
                document.body.appendChild(modal);
                
                // æ·»åŠ äº‹ä»¶ç›‘å¬
                document.getElementById('freqLow').onclick = function() {
                    setFrequency('low');
                };
                document.getElementById('freqMedium').onclick = function() {
                    setFrequency('medium');
                };
                document.getElementById('freqHigh').onclick = function() {
                    setFrequency('high');
                };
                
                function setFrequency(freq) {
                    const buttons = ['freqLow', 'freqMedium', 'freqHigh'];
                    buttons.forEach(id => {
                        const btn = document.getElementById(id);
                        if (id === 'freq' + freq.charAt(0).toUpperCase() + freq.slice(1)) {
                            btn.style.backgroundColor = '#ff69b4';
                            btn.style.color = 'white';
                        } else {
                            btn.style.backgroundColor = 'white';
                            btn.style.color = '#333';
                        }
                    });
                    wechatSettings.activeTalk.frequency = freq;
                }
                
                // æ·»åŠ å…³é—­åŠŸèƒ½
                modal.onclick = function(e) {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                };
            } catch (error) {
                console.error("æ˜¾ç¤ºä¸»åŠ¨å‘è¨€è®¾ç½®å¤±è´¥ï¼š", error);
            }
        }
        
        function saveActiveTalkSettings() {
            try {
                const enabled = document.getElementById('activeTalkEnabled').checked;
                wechatSettings.activeTalk = {
                    enabled: enabled,
                    frequency: wechatSettings.activeTalk?.frequency || 'medium'
                };
                saveWechatSettings();
                alert('è®¾ç½®å·²ä¿å­˜');
                // å…³é—­å¼¹çª—
                const modal = document.querySelector('div[style*="position: fixed"]');
                if (modal) {
                    document.body.removeChild(modal);
                }
            } catch (error) {
                console.error("ä¿å­˜ä¸»åŠ¨å‘è¨€è®¾ç½®å¤±è´¥ï¼š", error);
                alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        function showThemeSettings() {
            try {
                const currentTheme = wechatSettings.theme || 'light';
                
                const html = `
                    <div style="padding: 20px;">
                        <h3 style="font-size: 16px; font-weight: 500; margin-bottom: 16px;">ä¸»é¢˜æ¨¡å¼</h3>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px;">
                                <div style="font-size: 14px;">æµ…è‰²æ¨¡å¼</div>
                                <div style="width: 20px; height: 20px; border: 2px solid #e0e0e0; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    ${currentTheme === 'light' ? '<div style="width: 12px; height: 12px; border-radius: 50%; background-color: #ff69b4;"></div>' : ''}
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px;">
                                <div style="font-size: 14px;">æ·±è‰²æ¨¡å¼</div>
                                <div style="width: 20px; height: 20px; border: 2px solid #e0e0e0; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    ${currentTheme === 'dark' ? '<div style="width: 12px; height: 12px; border-radius: 50%; background-color: #ff69b4;"></div>' : ''}
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px;">
                                <div style="font-size: 14px;">è·Ÿéšç³»ç»Ÿ</div>
                                <div style="width: 20px; height: 20px; border: 2px solid #e0e0e0; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    ${currentTheme === 'system' ? '<div style="width: 12px; height: 12px; border-radius: 50%; background-color: #ff69b4;"></div>' : ''}
                                </div>
                            </div>
                        </div>
                        <button onclick="saveThemeSettings()" style="margin-top: 20px; width: 100%; padding: 12px; background-color: #ff69b4; border: none; border-radius: 8px; color: white; font-size: 16px;">ä¿å­˜</button>
                    </div>
                `;
                
                // åˆ›å»ºå¼¹çª—
                const modal = document.createElement('div');
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.width = '100%';
                modal.style.height = '100%';
                modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
                modal.style.display = 'flex';
                modal.style.alignItems = 'center';
                modal.style.justifyContent = 'center';
                modal.style.zIndex = '1000';
                
                const content = document.createElement('div');
                content.style.backgroundColor = 'white';
                content.style.borderRadius = '12px';
                content.style.width = '90%';
                content.style.maxWidth = '400px';
                content.innerHTML = html;
                
                modal.appendChild(content);
                document.body.appendChild(modal);
                
                // æ·»åŠ å…³é—­åŠŸèƒ½
                modal.onclick = function(e) {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                };
            } catch (error) {
                console.error("æ˜¾ç¤ºä¸»é¢˜æ¨¡å¼è®¾ç½®å¤±è´¥ï¼š", error);
            }
        }
        
        function saveThemeSettings() {
            try {
                // è¿™é‡Œå¯ä»¥æ·»åŠ ä¸»é¢˜åˆ‡æ¢é€»è¾‘
                saveWechatSettings();
                alert('è®¾ç½®å·²ä¿å­˜');
                // å…³é—­å¼¹çª—
                const modal = document.querySelector('div[style*="position: fixed"]');
                if (modal) {
                    document.body.removeChild(modal);
                }
            } catch (error) {
                console.error("ä¿å­˜ä¸»é¢˜è®¾ç½®å¤±è´¥ï¼š", error);
                alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        function showBubbleSettings() {
            try {
                alert('èŠå¤©æ°”æ³¡è‡ªå®šä¹‰è®¾ç½®å¼€å‘ä¸­');
            } catch (error) {
                console.error("æ˜¾ç¤ºèŠå¤©æ°”æ³¡è®¾ç½®å¤±è´¥ï¼š", error);
            }
        }
        
        function showAIModelSettings() {
            try {
                // è·å–å½“å‰AIé…ç½®
                const aiConfig = JSON.parse(localStorage.getItem('wechatAIConfig') || localStorage.getItem('aiPhoneConfig') || '{}');
                
                const html = `
                    <div style="padding: 20px;">
                        <h3 style="font-size: 16px; font-weight: 500; margin-bottom: 16px;">AIæ¨¡å‹é…ç½®</h3>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-size: 14px; color: #999; margin-bottom: 4px;">åç§°</label>
                            <input type="text" id="wechatConfigName" value="${aiConfig.name || 'å¾®ä¿¡APIè¿æ¥'}" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-size: 14px; color: #999; margin-bottom: 4px;">æ¨¡å‹å¹³å°</label>
                            <select id="wechatPlatformSelect" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px; background-color: white;">
                                <option value="openai" ${aiConfig.platform === 'openai' ? 'selected' : ''}>OpenAI</option>
                                <option value="doubao" ${aiConfig.platform === 'doubao' ? 'selected' : ''}>Doubao (è±†åŒ…/ç«å±±äº‘/å­—èŠ‚è·³åŠ¨)</option>
                                <option value="deepseek" ${aiConfig.platform === 'deepseek' ? 'selected' : ''}>DeepSeek (æ·±åº¦æ±‚ç´¢)</option>
                                <option value="openrouter" ${aiConfig.platform === 'openrouter' ? 'selected' : ''}>OpenRouter</option>
                                <option value="custom-openai" ${aiConfig.platform === 'custom-openai' ? 'selected' : ''}>è‡ªå®šä¹‰ (OpenAI åè®®)</option>
                            </select>
                        </div>
                        <div id="wechatApiUrlItem" style="margin-bottom: 16px; ${aiConfig.platform === 'custom-openai' ? 'display: block;' : 'display: none;'}">
                            <label style="display: block; font-size: 14px; color: #999; margin-bottom: 4px;">API æ¥å£åœ°å€</label>
                            <input type="text" id="wechatApiUrlInput" value="${aiConfig.apiUrl || ''}" placeholder="https://api.example.com/v1" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-size: 14px; color: #999; margin-bottom: 4px;">API å¯†é’¥</label>
                            <input type="password" id="wechatApiKeyInput" value="${aiConfig.apiKey || ''}" placeholder="è¾“å…¥ä½ çš„ API Key" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-size: 14px; color: #999; margin-bottom: 4px;">æ¨¡å‹</label>
                            <select id="wechatModelSelect" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px; background-color: white;">
                                <option value="">è¯·å…ˆæ‹‰å–æ¨¡å‹</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                            <button id="wechatFetchModelsBtn" style="flex: 1; padding: 10px; background-color: #ff69b4; border: none; border-radius: 8px; color: white; font-size: 14px;">æ‹‰å–æ¨¡å‹</button>
                            <button id="wechatTestConnectionBtn" style="flex: 1; padding: 10px; background-color: #333; border: none; border-radius: 8px; color: white; font-size: 14px;">æµ‹è¯•é“¾æ¥</button>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button id="wechatSaveConfigBtn" style="flex: 1; padding: 10px; background-color: #ff69b4; border: none; border-radius: 8px; color: white; font-size: 14px;">ä¿å­˜</button>
                            <button id="wechatCloseConfigBtn" style="flex: 1; padding: 10px; background-color: #333; border: none; border-radius: 8px; color: white; font-size: 14px;">å…³é—­</button>
                        </div>
                    </div>
                `;
                
                // åˆ›å»ºå¼¹çª—
                const modal = document.createElement('div');
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.width = '100%';
                modal.style.height = '100%';
                modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
                modal.style.display = 'flex';
                modal.style.alignItems = 'center';
                modal.style.justifyContent = 'center';
                modal.style.zIndex = '1000';
                
                const content = document.createElement('div');
                content.style.backgroundColor = 'white';
                content.style.borderRadius = '12px';
                content.style.width = '90%';
                content.style.maxWidth = '400px';
                content.style.maxHeight = '80%';
                content.style.overflowY = 'auto';
                content.innerHTML = html;
                
                modal.appendChild(content);
                document.body.appendChild(modal);
                
                // æ·»åŠ äº‹ä»¶ç›‘å¬
                const platformSelect = document.getElementById('wechatPlatformSelect');
                const apiUrlItem = document.getElementById('wechatApiUrlItem');
                
                platformSelect.addEventListener('change', function() {
                    if (this.value === 'custom-openai') {
                        apiUrlItem.style.display = 'block';
                    } else {
                        apiUrlItem.style.display = 'none';
                    }
                });
                
                document.getElementById('wechatFetchModelsBtn').addEventListener('click', function() {
                    fetchWechatModels(modal);
                });
                
                document.getElementById('wechatTestConnectionBtn').addEventListener('click', function() {
                    testWechatConnection(modal);
                });
                
                document.getElementById('wechatSaveConfigBtn').addEventListener('click', function() {
                    saveWechatAIConfig(modal);
                });
                
                document.getElementById('wechatCloseConfigBtn').addEventListener('click', function() {
                    document.body.removeChild(modal);
                });
                
                // åŠ è½½æ¨¡å‹åˆ—è¡¨
                loadWechatModelList(aiConfig);
                
            } catch (error) {
                console.error("æ˜¾ç¤ºAIæ¨¡å‹è®¾ç½®å¤±è´¥ï¼š", error);
                alert('æ˜¾ç¤ºè®¾ç½®å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        function showAPIConfigSettings() {
            showAIModelSettings();
        }
        
        // åŠ è½½å¾®ä¿¡æ¨¡å‹åˆ—è¡¨
        function loadWechatModelList(aiConfig) {
            try {
                const modelSelect = document.getElementById('wechatModelSelect');
                modelSelect.innerHTML = '';
                
                const platform = aiConfig.platform || 'openai';
                let models = [];
                
                // é¦–å…ˆæ£€æŸ¥æ˜¯å¦æœ‰å·²æ‹‰å–çš„æ¨¡å‹
                if (aiConfig.fetchedModels && aiConfig.fetchedModels.length > 0) {
                    models = aiConfig.fetchedModels;
                } else {
                    // å¦‚æœæ²¡æœ‰å·²æ‹‰å–çš„æ¨¡å‹ï¼Œä½¿ç”¨ç¡¬ç¼–ç åˆ—è¡¨
                    models = {
                        openai: ['gpt-3.5-turbo', 'gpt-4', 'gpt-4-turbo'],
                        doubao: ['ep-20240101150000-x1234'],
                        deepseek: ['deepseek-chat'],
                        openrouter: ['openai/gpt-3.5-turbo'],
                        'custom-openai': []
                    }[platform] || [];
                }
                
                if (models.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'è¯·å…ˆæ‹‰å–æ¨¡å‹';
                    modelSelect.appendChild(option);
                } else {
                    models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model;
                        if (model === aiConfig.model) {
                            option.selected = true;
                        }
                        modelSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error("åŠ è½½æ¨¡å‹åˆ—è¡¨å¤±è´¥ï¼š", error);
            }
        }
        
        // æ‹‰å–å¾®ä¿¡æ¨¡å‹
        async function fetchWechatModels(modal) {
            try {
                const apiUrl = document.getElementById('wechatApiUrlInput').value.trim();
                const apiKey = document.getElementById('wechatApiKeyInput').value.trim();
                const platform = document.getElementById('wechatPlatformSelect').value;
                
                if (platform !== 'custom-openai' || !apiUrl || !apiKey) {
                    alert('è¯·é€‰æ‹©è‡ªå®šä¹‰OpenAIå¹³å°å¹¶å¡«å†™APIæ¥å£åœ°å€å’Œå¯†é’¥');
                    return;
                }
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const fetchBtn = document.getElementById('wechatFetchModelsBtn');
                const originalText = fetchBtn.textContent;
                fetchBtn.textContent = 'æ‹‰å–ä¸­...';
                fetchBtn.disabled = true;
                
                // è°ƒç”¨åç«¯APIæ‹‰å–æ¨¡å‹
                const response = await fetch(API_BASE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        platform: 'custom-openai',
                        apiKey: apiKey,
                        apiUrl: apiUrl,
                        action: 'fetchModels'
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const models = data.data || [];
                
                if (models.length === 0) {
                    alert('æœªè·å–åˆ°ä»»ä½•æ¨¡å‹');
                    return;
                }
                
                // æ›´æ–°æ¨¡å‹åˆ—è¡¨
                const modelSelect = document.getElementById('wechatModelSelect');
                modelSelect.innerHTML = '';
                
                const modelIds = [];
                models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.textContent = model.id;
                    modelSelect.appendChild(option);
                    modelIds.push(model.id);
                });
                
                // ä¿å­˜æ¨¡å‹åˆ—è¡¨åˆ°æœ¬åœ°å­˜å‚¨
                const aiConfig = JSON.parse(localStorage.getItem('wechatAIConfig') || '{}');
                aiConfig.fetchedModels = modelIds;
                localStorage.setItem('wechatAIConfig', JSON.stringify(aiConfig));
                
                alert(`æˆåŠŸæ‹‰å–åˆ° ${models.length} ä¸ªæ¨¡å‹`);
                
            } catch (error) {
                console.error("æ‹‰å–æ¨¡å‹å¤±è´¥ï¼š", error);
                alert(`æ‹‰å–æ¨¡å‹å¤±è´¥ï¼š${error.message}`);
            } finally {
                const fetchBtn = document.getElementById('wechatFetchModelsBtn');
                fetchBtn.textContent = 'æ‹‰å–æ¨¡å‹';
                fetchBtn.disabled = false;
            }
        }
        
        // æµ‹è¯•å¾®ä¿¡è¿æ¥
        async function testWechatConnection(modal) {
            try {
                const apiUrl = document.getElementById('wechatApiUrlInput').value.trim();
                const apiKey = document.getElementById('wechatApiKeyInput').value.trim();
                const platform = document.getElementById('wechatPlatformSelect').value;
                
                if (platform !== 'custom-openai' || !apiUrl || !apiKey) {
                    alert('è¯·é€‰æ‹©è‡ªå®šä¹‰OpenAIå¹³å°å¹¶å¡«å†™APIæ¥å£åœ°å€å’Œå¯†é’¥');
                    return;
                }
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const testBtn = document.getElementById('wechatTestConnectionBtn');
                const originalText = testBtn.textContent;
                testBtn.textContent = 'æµ‹è¯•ä¸­...';
                testBtn.disabled = true;
                
                // è°ƒç”¨åç«¯APIæµ‹è¯•è¿æ¥
                const response = await fetch(API_BASE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        platform: 'custom-openai',
                        apiKey: apiKey,
                        apiUrl: apiUrl,
                        action: 'testConnection'
                    })
                });
                
                if (response.ok) {
                    alert('è¿æ¥æˆåŠŸï¼');
                } else {
                    const errorData = await response.json().catch(() => ({ error: 'è¿æ¥å¤±è´¥' }));
                    alert(`è¿æ¥å¤±è´¥ï¼š${errorData.error || 'æœªçŸ¥é”™è¯¯'}`);
                }
                
            } catch (error) {
                console.error("æµ‹è¯•è¿æ¥å¤±è´¥ï¼š", error);
                alert(`æµ‹è¯•è¿æ¥å¤±è´¥ï¼š${error.message}`);
            } finally {
                const testBtn = document.getElementById('wechatTestConnectionBtn');
                testBtn.textContent = 'æµ‹è¯•é“¾æ¥';
                testBtn.disabled = false;
            }
        }
        
        // ä¿å­˜å¾®ä¿¡AIé…ç½®
        function saveWechatAIConfig(modal) {
            try {
                // è·å–å½“å‰é…ç½®ï¼ŒåŒ…å«å·²æ‹‰å–çš„æ¨¡å‹åˆ—è¡¨
                const existingConfig = JSON.parse(localStorage.getItem('wechatAIConfig') || '{}');
                const config = {
                    name: document.getElementById('wechatConfigName').value,
                    platform: document.getElementById('wechatPlatformSelect').value,
                    apiUrl: document.getElementById('wechatApiUrlInput').value,
                    apiKey: document.getElementById('wechatApiKeyInput').value,
                    model: document.getElementById('wechatModelSelect').value,
                    fetchedModels: existingConfig.fetchedModels || []
                };
                
                localStorage.setItem('wechatAIConfig', JSON.stringify(config));
                alert('é…ç½®å·²ä¿å­˜');
                document.body.removeChild(modal);
            } catch (error) {
                console.error("ä¿å­˜é…ç½®å¤±è´¥ï¼š", error);
                alert('ä¿å­˜é…ç½®å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        function showGeneralSettings() {
            try {
                // åˆ›å»ºè®¾ç½®é¢æ¿
                const panel = document.createElement('div');
                panel.style.position = 'fixed';
                panel.style.top = '0';
                panel.style.left = '0';
                panel.style.width = '100%';
                panel.style.height = '100%';
                panel.style.backgroundColor = 'rgba(0,0,0,0.5)';
                panel.style.display = 'flex';
                panel.style.alignItems = 'center';
                panel.style.justifyContent = 'center';
                panel.style.zIndex = '1000';
                
                const content = document.createElement('div');
                content.style.backgroundColor = 'white';
                content.style.borderRadius = '12px';
                content.style.width = '90%';
                content.style.maxWidth = '400px';
                content.style.maxHeight = '80%';
                content.style.overflowY = 'auto';
                content.style.padding = '20px';
                
                // é¢æ¿å¤´éƒ¨
                const header = document.createElement('div');
                header.style.display = 'flex';
                header.style.justifyContent = 'space-between';
                header.style.alignItems = 'center';
                header.style.marginBottom = '20px';
                
                const title = document.createElement('h3');
                title.style.fontSize = '16px';
                title.style.fontWeight = '500';
                title.textContent = 'é€šç”¨è®¾ç½®';
                
                const closeBtn = document.createElement('button');
                closeBtn.style.background = 'none';
                closeBtn.style.border = 'none';
                closeBtn.style.fontSize = '20px';
                closeBtn.style.cursor = 'pointer';
                closeBtn.textContent = 'Ã—';
                closeBtn.onclick = function() {
                    document.body.removeChild(panel);
                };
                
                header.appendChild(title);
                header.appendChild(closeBtn);
                content.appendChild(header);
                
                // æ¶ˆæ¯æœ—è¯»åŠŸèƒ½å¼€å…³
                const speechSection = document.createElement('div');
                speechSection.style.marginBottom = '20px';
                
                const speechSectionTitle = document.createElement('div');
                speechSectionTitle.style.fontSize = '14px';
                speechSectionTitle.style.fontWeight = '500';
                speechSectionTitle.style.marginBottom = '10px';
                speechSectionTitle.textContent = 'æ¶ˆæ¯æœ—è¯»è®¾ç½®';
                
                speechSection.appendChild(speechSectionTitle);
                
                // è·å–å½“å‰è¯­éŸ³è®¾ç½®
                const voiceConfig = JSON.parse(localStorage.getItem('voiceConfig') || '{}');
                const speechEnabled = voiceConfig.speechEnabled !== undefined ? voiceConfig.speechEnabled : true;
                
                // æ¶ˆæ¯æœ—è¯»å¼€å…³
                const speechToggle = document.createElement('div');
                speechToggle.style.display = 'flex';
                speechToggle.style.alignItems = 'center';
                speechToggle.style.justifyContent = 'space-between';
                speechToggle.style.padding = '10px 0';
                speechToggle.innerHTML = `
                    <div style="font-size: 14px;">å¯ç”¨æ¶ˆæ¯æœ—è¯»</div>
                    <label style="position: relative; display: inline-block; width: 50px; height: 24px;">
                        <input type="checkbox" id="speechEnabled" ${speechEnabled ? 'checked' : ''} style="opacity: 0; width: 0; height: 0;">
                        <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: ${speechEnabled ? '#ff69b4' : '#ccc'}; transition: .4s; border-radius: 24px;"></span>
                        <span style="position: absolute; cursor: pointer; top: 2px; left: ${speechEnabled ? '28px' : '2px'}; bottom: 2px; width: 20px; background-color: white; transition: .4s; border-radius: 50%;"></span>
                    </label>
                `;
                speechSection.appendChild(speechToggle);
                
                // ä¿å­˜è¯­éŸ³è®¾ç½®æŒ‰é’®
                const saveSpeechBtn = document.createElement('button');
                saveSpeechBtn.style.width = '100%';
                saveSpeechBtn.style.padding = '12px';
                saveSpeechBtn.style.backgroundColor = '#ff69b4';
                saveSpeechBtn.style.border = 'none';
                saveSpeechBtn.style.borderRadius = '8px';
                saveSpeechBtn.style.color = 'white';
                saveSpeechBtn.style.fontSize = '16px';
                saveSpeechBtn.style.fontWeight = '500';
                saveSpeechBtn.style.cursor = 'pointer';
                saveSpeechBtn.textContent = 'ä¿å­˜æœ—è¯»è®¾ç½®';
                saveSpeechBtn.onclick = function() {
                    const enabled = document.getElementById('speechEnabled').checked;
                    const updatedConfig = {
                        ...voiceConfig,
                        speechEnabled: enabled
                    };
                    localStorage.setItem('voiceConfig', JSON.stringify(updatedConfig));
                    alert('æœ—è¯»è®¾ç½®å·²ä¿å­˜ï¼');
                };
                
                speechSection.appendChild(saveSpeechBtn);
                content.appendChild(speechSection);
                
                // å›¾ç‰‡è¯†åˆ«APIè®¾ç½®
                const imageRecognitionSection = document.createElement('div');
                imageRecognitionSection.style.marginBottom = '20px';
                
                const sectionTitle = document.createElement('div');
                sectionTitle.style.fontSize = '14px';
                sectionTitle.style.fontWeight = '500';
                sectionTitle.style.marginBottom = '10px';
                sectionTitle.textContent = 'è¯†å›¾API';
                
                imageRecognitionSection.appendChild(sectionTitle);
                
                // è·å–å½“å‰é…ç½®
                const imageRecognitionConfig = JSON.parse(localStorage.getItem('imageRecognitionConfig') || '{}');
                
                // APIå¯†é’¥è¾“å…¥
                const apiKeyInput = document.createElement('div');
                apiKeyInput.style.marginBottom = '10px';
                apiKeyInput.innerHTML = `
                    <label style="display: block; font-size: 12px; color: #999; margin-bottom: 4px;">è¾“å…¥ä½ çš„ API Key</label>
                    <input type="password" id="imageApiKey" value="${imageRecognitionConfig.apiKey || ''}" placeholder="è¾“å…¥ä½ çš„ API Key" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                `;
                imageRecognitionSection.appendChild(apiKeyInput);
                
                // APIåœ°å€è¾“å…¥
                const apiUrlInput = document.createElement('div');
                apiUrlInput.style.marginBottom = '10px';
                apiUrlInput.innerHTML = `
                    <label style="display: block; font-size: 12px; color: #999; margin-bottom: 4px;">API æ¥å£åœ°å€</label>
                    <input type="text" id="imageApiUrl" value="${imageRecognitionConfig.apiUrl || 'https://api.openai.com/v1/chat/completions'}" placeholder="https://api.openai.com/v1/chat/completions" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                `;
                imageRecognitionSection.appendChild(apiUrlInput);
                
                // æ¨¡å‹é€‰æ‹©
                const modelSelect = document.createElement('div');
                modelSelect.style.marginBottom = '10px';
                modelSelect.innerHTML = `
                    <label style="display: block; font-size: 12px; color: #999; margin-bottom: 4px;">æ¨¡å‹</label>
                    <select id="imageModelSelect" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px; background-color: white;">
                        <option value="gpt-4-vision-preview" ${imageRecognitionConfig.model === 'gpt-4-vision-preview' ? 'selected' : ''}>gpt-4-vision-preview</option>
                        <option value="gpt-4-turbo" ${imageRecognitionConfig.model === 'gpt-4-turbo' ? 'selected' : ''}>gpt-4-turbo</option>
                    </select>
                `;
                imageRecognitionSection.appendChild(modelSelect);
                
                // ä¿å­˜æŒ‰é’®
                const saveBtn = document.createElement('button');
                saveBtn.style.width = '100%';
                saveBtn.style.padding = '12px';
                saveBtn.style.backgroundColor = '#ff69b4';
                saveBtn.style.border = 'none';
                saveBtn.style.borderRadius = '8px';
                saveBtn.style.color = 'white';
                saveBtn.style.fontSize = '16px';
                saveBtn.style.fontWeight = '500';
                saveBtn.style.cursor = 'pointer';
                saveBtn.textContent = 'ä¿å­˜è®¾ç½®';
                saveBtn.onclick = function() {
                    const config = {
                        apiKey: document.getElementById('imageApiKey').value,
                        apiUrl: document.getElementById('imageApiUrl').value,
                        model: document.getElementById('imageModelSelect').value
                    };
                    localStorage.setItem('imageRecognitionConfig', JSON.stringify(config));
                    alert('è®¾ç½®å·²ä¿å­˜ï¼');
                };
                
                imageRecognitionSection.appendChild(saveBtn);
                content.appendChild(imageRecognitionSection);
                
                // è¯­éŸ³è®¾ç½®
                const voiceSection = document.createElement('div');
                voiceSection.style.marginBottom = '20px';
                
                const voiceSectionTitle = document.createElement('div');
                voiceSectionTitle.style.fontSize = '14px';
                voiceSectionTitle.style.fontWeight = '500';
                voiceSectionTitle.style.marginBottom = '10px';
                voiceSectionTitle.textContent = 'è¯­éŸ³è¯†åˆ«è®¾ç½®';
                
                voiceSection.appendChild(voiceSectionTitle);
                
                // è¯­éŸ³è¯†åˆ«APIé€‰æ‹©
                const speechRecognitionApiSelect = document.createElement('div');
                speechRecognitionApiSelect.style.marginBottom = '10px';
                speechRecognitionApiSelect.innerHTML = `
                    <label style="display: block; font-size: 12px; color: #999; margin-bottom: 4px;">è¯­éŸ³è¯†åˆ«API</label>
                    <select id="speechRecognitionApi" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px; background-color: white;">
                        <option value="web-speech-api" ${voiceConfig.speechRecognitionApi === 'web-speech-api' ? 'selected' : ''}>Web Speech API</option>
                        <option value="custom" ${voiceConfig.speechRecognitionApi === 'custom' ? 'selected' : ''}>è‡ªå®šä¹‰API</option>
                    </select>
                `;
                voiceSection.appendChild(speechRecognitionApiSelect);
                
                // è¯­éŸ³åˆæˆAPIé€‰æ‹©
                const speechSynthesisApiSelect = document.createElement('div');
                speechSynthesisApiSelect.style.marginBottom = '10px';
                speechSynthesisApiSelect.innerHTML = `
                    <label style="display: block; font-size: 12px; color: #999; margin-bottom: 4px;">è¯­éŸ³åˆæˆAPI</label>
                    <select id="speechSynthesisApi" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px; background-color: white;">
                        <option value="web-speech-api" ${voiceConfig.speechSynthesisApi === 'web-speech-api' ? 'selected' : ''}>Web Speech API</option>
                        <option value="custom" ${voiceConfig.speechSynthesisApi === 'custom' ? 'selected' : ''}>è‡ªå®šä¹‰API</option>
                    </select>
                `;
                voiceSection.appendChild(speechSynthesisApiSelect);
                
                // è¯­éŸ³è¯†åˆ«è¯­è¨€é€‰æ‹©
                const languageSelect = document.createElement('div');
                languageSelect.style.marginBottom = '10px';
                languageSelect.innerHTML = `
                    <label style="display: block; font-size: 12px; color: #999; margin-bottom: 4px;">è®¾ç½®è¯†åˆ«è¯­è¨€</label>
                    <select id="recognitionLanguage" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px; background-color: white;">
                        <option value="zh-CN" ${voiceConfig.recognitionLanguage === 'zh-CN' ? 'selected' : ''}>ä¸­æ–‡ (zh-CN)</option>
                        <option value="en-US" ${voiceConfig.recognitionLanguage === 'en-US' ? 'selected' : ''}>è‹±æ–‡ (en-US)</option>
                    </select>
                `;
                voiceSection.appendChild(languageSelect);
                
                // ä¿å­˜è¯­éŸ³è®¾ç½®æŒ‰é’®
                const saveVoiceBtn = document.createElement('button');
                saveVoiceBtn.style.width = '100%';
                saveVoiceBtn.style.padding = '12px';
                saveVoiceBtn.style.backgroundColor = '#ff69b4';
                saveVoiceBtn.style.border = 'none';
                saveVoiceBtn.style.borderRadius = '8px';
                saveVoiceBtn.style.color = 'white';
                saveVoiceBtn.style.fontSize = '16px';
                saveVoiceBtn.style.fontWeight = '500';
                saveVoiceBtn.style.cursor = 'pointer';
                saveVoiceBtn.textContent = 'ä¿å­˜è¯­éŸ³è®¾ç½®';
                saveVoiceBtn.onclick = function() {
                    const config = {
                        ...voiceConfig,
                        speechRecognitionApi: document.getElementById('speechRecognitionApi').value,
                        speechSynthesisApi: document.getElementById('speechSynthesisApi').value,
                        recognitionLanguage: document.getElementById('recognitionLanguage').value
                    };
                    localStorage.setItem('voiceConfig', JSON.stringify(config));
                    alert('è¯­éŸ³è®¾ç½®å·²ä¿å­˜ï¼');
                };
                
                voiceSection.appendChild(saveVoiceBtn);
                content.appendChild(voiceSection);
                
                // ç”¨æˆ·è´¦å·ç³»ç»Ÿè®¾ç½®
                const accountSection = document.createElement('div');
                accountSection.style.marginBottom = '20px';
                
                const accountSectionTitle = document.createElement('div');
                accountSectionTitle.style.fontSize = '14px';
                accountSectionTitle.style.fontWeight = '500';
                accountSectionTitle.style.marginBottom = '10px';
                accountSectionTitle.textContent = 'è´¦å·è®¾ç½®';
                
                accountSection.appendChild(accountSectionTitle);
                
                // è·å–å½“å‰è´¦å·é…ç½®
                const accountConfig = JSON.parse(localStorage.getItem('accountConfig') || '{}');
                
                // è´¦å·ä¿¡æ¯
                const accountInfo = document.createElement('div');
                accountInfo.style.marginBottom = '10px';
                accountInfo.innerHTML = `
                    <div style="font-size: 14px; margin-bottom: 5px;">è´¦å·çŠ¶æ€: ${accountConfig.loggedIn ? 'å·²ç™»å½•' : 'æœªç™»å½•'}</div>
                    <div style="font-size: 12px; color: #999; margin-bottom: 10px;">ç™»å½•åå¯å®ç°æ•°æ®æŒä¹…åŒ–å­˜å‚¨</div>
                `;
                accountSection.appendChild(accountInfo);
                
                // ç™»å½•/æ³¨å†ŒæŒ‰é’®
                const accountBtn = document.createElement('button');
                accountBtn.style.width = '100%';
                accountBtn.style.padding = '12px';
                accountBtn.style.backgroundColor = '#ff69b4';
                accountBtn.style.border = 'none';
                accountBtn.style.borderRadius = '8px';
                accountBtn.style.color = 'white';
                accountBtn.style.fontSize = '16px';
                accountBtn.style.fontWeight = '500';
                accountBtn.style.cursor = 'pointer';
                accountBtn.textContent = accountConfig.loggedIn ? 'é€€å‡ºç™»å½•' : 'ç™»å½•/æ³¨å†Œ';
                accountBtn.onclick = function() {
                    if (accountConfig.loggedIn) {
                        if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                            localStorage.setItem('accountConfig', JSON.stringify({ loggedIn: false }));
                            alert('é€€å‡ºç™»å½•æˆåŠŸ');
                            document.body.removeChild(panel);
                            showGeneralSettings();
                            // é€€å‡ºç™»å½•åé‡æ–°åŠ è½½æ•°æ®
                            reloadWechatData();
                        }
                    } else {
                        // æ˜¾ç¤ºç™»å½•/æ³¨å†Œè¡¨å•
                        showLoginRegisterForm(panel);
                    }
                };
                
                // ç™»å½•/æ³¨å†Œè¡¨å•
                function showLoginRegisterForm(panel) {
                    const formPanel = document.createElement('div');
                    formPanel.style.position = 'fixed';
                    formPanel.style.top = '0';
                    formPanel.style.left = '0';
                    formPanel.style.width = '100%';
                    formPanel.style.height = '100%';
                    formPanel.style.backgroundColor = 'rgba(0,0,0,0.5)';
                    formPanel.style.display = 'flex';
                    formPanel.style.alignItems = 'center';
                    formPanel.style.justifyContent = 'center';
                    formPanel.style.zIndex = '1002';
                    
                    const formContent = document.createElement('div');
                    formContent.style.backgroundColor = 'white';
                    formContent.style.borderRadius = '12px';
                    formContent.style.width = '90%';
                    formContent.style.maxWidth = '400px';
                    formContent.style.padding = '20px';
                    
                    let isRegister = false;
                    
                    function renderForm() {
                        formContent.innerHTML = `
                            <div style="text-align: center; margin-bottom: 20px;">
                                <h3 style="font-size: 18px; font-weight: 500; margin-bottom: 10px;">${isRegister ? 'æ³¨å†Œè´¦å·' : 'ç™»å½•è´¦å·'}</h3>
                                <div style="font-size: 12px; color: #999; margin-bottom: 20px;">
                                    ${isRegister ? 'è¯·å¡«å†™ä»¥ä¸‹ä¿¡æ¯æ³¨å†Œè´¦å·' : 'è¯·è¾“å…¥è´¦å·ä¿¡æ¯ç™»å½•'}
                                </div>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; font-size: 12px; color: #999; margin-bottom: 4px;">ç”¨æˆ·å</label>
                                <input type="text" id="loginUsername" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                                <div style="font-size: 11px; color: #999; margin-top: 4px;">æ”¯æŒä¸­è‹±æ–‡ã€æ•°å­—ï¼Œé•¿åº¦3-20ä½</div>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; font-size: 12px; color: #999; margin-bottom: 4px;">å¯†ç </label>
                                <input type="password" id="loginPassword" placeholder="è¯·è¾“å…¥å¯†ç " style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                                <div style="font-size: 11px; color: #999; margin-top: 4px;">é•¿åº¦8-20ä½ï¼Œéœ€åŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šç¬¦å·</div>
                            </div>
                            ${isRegister ? `
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; font-size: 12px; color: #999; margin-bottom: 4px;">ç¡®è®¤å¯†ç </label>
                                    <input type="password" id="loginConfirmPassword" placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç " style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                                </div>
                            ` : ''}
                            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                                <button id="submitBtn" style="flex: 1; padding: 12px; background-color: #ff69b4; border: none; border-radius: 8px; color: white; font-size: 14px; cursor: pointer;">
                                    ${isRegister ? 'æ³¨å†Œ' : 'ç™»å½•'}
                                </button>
                                <button id="cancelBtn" style="flex: 1; padding: 12px; background-color: #f0f0f0; border: none; border-radius: 8px; font-size: 14px; cursor: pointer;">å–æ¶ˆ</button>
                            </div>
                            <div style="text-align: center;">
                                <button id="toggleBtn" style="background: none; border: none; font-size: 12px; color: #ff69b4; cursor: pointer;">
                                    ${isRegister ? 'å·²æœ‰è´¦å·ï¼Ÿç‚¹å‡»ç™»å½•' : 'æ²¡æœ‰è´¦å·ï¼Ÿç‚¹å‡»æ³¨å†Œ'}
                                </button>
                            </div>
                        `;
                    }
                    
                    renderForm();
                    
                    formPanel.appendChild(formContent);
                    document.body.appendChild(formPanel);
                    
                    // åˆ‡æ¢ç™»å½•/æ³¨å†Œ
                    document.getElementById('toggleBtn').onclick = function() {
                        isRegister = !isRegister;
                        renderForm();
                        bindEvents();
                    };
                    
                    // å–æ¶ˆæŒ‰é’®
                    document.getElementById('cancelBtn').onclick = function() {
                        document.body.removeChild(formPanel);
                    };
                    
                    // æäº¤æŒ‰é’®
                    function bindEvents() {
                        document.getElementById('submitBtn').onclick = function() {
                            const username = document.getElementById('loginUsername').value.trim();
                            const password = document.getElementById('loginPassword').value;
                            
                            if (!validateUsername(username)) {
                                alert('ç”¨æˆ·åä¸ç¬¦åˆè¦æ±‚ï¼Œæ”¯æŒä¸­è‹±æ–‡ã€æ•°å­—ï¼Œé•¿åº¦3-20ä½');
                                return;
                            }
                            
                            const passwordValidation = validatePassword(password);
                            if (!passwordValidation.valid) {
                                alert(passwordValidation.message);
                                return;
                            }
                            
                            if (isRegister) {
                                const confirmPassword = document.getElementById('loginConfirmPassword').value;
                                if (password !== confirmPassword) {
                                    alert('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´ï¼Œè¯·é‡æ–°è¾“å…¥');
                                    return;
                                }
                                
                                // æ³¨å†Œé€»è¾‘
                                registerUser(username, password);
                            } else {
                                // ç™»å½•é€»è¾‘
                                loginUser(username, password);
                            }
                        };
                    }
                    
                    bindEvents();
                    
                    // éªŒè¯ç”¨æˆ·å
                    function validateUsername(username) {
                        // ç”¨æˆ·åé•¿åº¦3-20ä½ï¼Œæ”¯æŒä¸­è‹±æ–‡ã€æ•°å­—
                        const usernameRegex = /^[a-zA-Z0-9\u4e00-\u9fa5]{3,20}$/;
                        return usernameRegex.test(username);
                    }
                    
                    // éªŒè¯å¯†ç 
                    function validatePassword(password) {
                        // å¯†ç é•¿åº¦8-20ä½ï¼ŒåŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šç¬¦å·
                        if (password.length < 8 || password.length > 20) {
                            return { valid: false, message: 'å¯†ç é•¿åº¦å¿…é¡»åœ¨8-20ä½ä¹‹é—´' };
                        }
                        
                        const hasUpper = /[A-Z]/.test(password);
                        const hasLower = /[a-z]/.test(password);
                        const hasNumber = /[0-9]/.test(password);
                        const hasSpecial = /[!@#$%^&*(),.?":{}|<>]/.test(password);
                        
                        if (!hasUpper) {
                            return { valid: false, message: 'å¯†ç å¿…é¡»åŒ…å«å¤§å†™å­—æ¯' };
                        }
                        if (!hasLower) {
                            return { valid: false, message: 'å¯†ç å¿…é¡»åŒ…å«å°å†™å­—æ¯' };
                        }
                        if (!hasNumber) {
                            return { valid: false, message: 'å¯†ç å¿…é¡»åŒ…å«æ•°å­—' };
                        }
                        if (!hasSpecial) {
                            return { valid: false, message: 'å¯†ç å¿…é¡»åŒ…å«ç‰¹æ®Šç¬¦å·' };
                        }
                        
                        return { valid: true };
                    }
                    
                    // æ³¨å†Œç”¨æˆ·
                    function registerUser(username, password) {
                        // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
                        const existingUsers = JSON.parse(localStorage.getItem('registeredUsers') || '{}');
                        if (existingUsers[username]) {
                            alert('ç”¨æˆ·åå·²å­˜åœ¨ï¼Œè¯·é€‰æ‹©å…¶ä»–ç”¨æˆ·å');
                            return;
                        }
                        
                        // ä¿å­˜ç”¨æˆ·ä¿¡æ¯
                        existingUsers[username] = password;
                        localStorage.setItem('registeredUsers', JSON.stringify(existingUsers));
                        
                        // è‡ªåŠ¨ç™»å½•
                        localStorage.setItem('accountConfig', JSON.stringify({ loggedIn: true, username: username }));
                        alert('æ³¨å†ŒæˆåŠŸï¼å·²è‡ªåŠ¨ç™»å½•');
                        document.body.removeChild(formPanel);
                        document.body.removeChild(panel);
                        // ç™»å½•åé‡æ–°åŠ è½½æ•°æ®
                        reloadWechatData();
                        // é‡æ–°æ˜¾ç¤ºè®¾ç½®é¢æ¿ä»¥æ›´æ–°ç™»å½•çŠ¶æ€
                        showGeneralSettings();
                    }
                    
                    // ç™»å½•ç”¨æˆ·
                    function loginUser(username, password) {
                        // éªŒè¯ç”¨æˆ·ä¿¡æ¯
                        const existingUsers = JSON.parse(localStorage.getItem('registeredUsers') || '{}');
                        if (!existingUsers[username] || existingUsers[username] !== password) {
                            alert('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥');
                            return;
                        }
                        
                        // ä¿å­˜ç™»å½•çŠ¶æ€
                        localStorage.setItem('accountConfig', JSON.stringify({ loggedIn: true, username: username }));
                        alert('ç™»å½•æˆåŠŸï¼');
                        document.body.removeChild(formPanel);
                        document.body.removeChild(panel);
                        // ç™»å½•åé‡æ–°åŠ è½½æ•°æ®
                        reloadWechatData();
                        // é‡æ–°æ˜¾ç¤ºè®¾ç½®é¢æ¿ä»¥æ›´æ–°ç™»å½•çŠ¶æ€
                        showGeneralSettings();
                    }
                }
                

                
                accountSection.appendChild(accountBtn);
                content.appendChild(accountSection);
                
                panel.appendChild(content);
                document.body.appendChild(panel);
                
                // æ·»åŠ å¼€å…³äº‹ä»¶ç›‘å¬
                const speechEnabledCheckbox = document.getElementById('speechEnabled');
                if (speechEnabledCheckbox) {
                    speechEnabledCheckbox.addEventListener('change', function() {
                        const slider = this.nextElementSibling;
                        const knob = slider.nextElementSibling;
                        if (this.checked) {
                            slider.style.backgroundColor = '#ff69b4';
                            knob.style.left = '28px';
                        } else {
                            slider.style.backgroundColor = '#ccc';
                            knob.style.left = '2px';
                        }
                    });
                }
                
            } catch (error) {
                console.error("æ˜¾ç¤ºé€šç”¨è®¾ç½®å¤±è´¥ï¼š", error);
                alert('è®¾ç½®åŠŸèƒ½åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        function logout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                // æ¸…é™¤ç™»å½•çŠ¶æ€
                localStorage.setItem('accountConfig', JSON.stringify({ loggedIn: false }));
                alert('é€€å‡ºç™»å½•æˆåŠŸ');
                // é€€å‡ºç™»å½•åé‡æ–°åŠ è½½æ•°æ®
                reloadWechatData();
            }
        }
        
        // é‡æ–°åŠ è½½å¾®ä¿¡æ•°æ®
        function reloadWechatData() {
            loadWechatRoles();
            loadWechatSettings();
            loadMoments();
            renderMessageList();
            renderMomentsList();
            renderProfilePage();
        }
        
        // ==================== é¡µé¢åˆå§‹åŒ– ====================
        window.addEventListener('DOMContentLoaded', function() {
            try {
                // åˆå§‹åŒ–å£çº¸
                initWallpaperConfig();
                initTargetPageButtons();
                loadWallpaperGallery();
                
                // åˆå§‹åŒ–AIåŠŸèƒ½
                initAIConfig();
                
                // åˆå§‹åŒ–å¾®ä¿¡æ¨¡å—
                initWechat();
                
                // åˆå§‹åŒ–é”å±æ—¶é—´
                updateLockTime();
                setInterval(updateLockTime, 1000);
                
                // é»˜è®¤æ˜¾ç¤ºé”å±
                goPage("lockScreen");
            } catch (error) {
                console.error("é¡µé¢åˆå§‹åŒ–å¤±è´¥ï¼š", error);
                alert(`é¡µé¢åŠ è½½å‡ºé”™ï¼š${error.message}`);
            }
        });
    </script>
</body>
</html>
