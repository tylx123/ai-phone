<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIå°æ‰‹æœº</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            color: #fff;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        /* é¡µé¢å®¹å™¨ */
        .page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            position: relative;
            overflow: hidden;
        }
        .page.active {
            display: block;
        }

        /* é¡µé¢èƒŒæ™¯å£çº¸å±‚ - ä¿®å¤å±‚çº§é—®é¢˜ */
        .page-bg {
            position: absolute;
            z-index: 0;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.85;
        }
        /* é¡µé¢å†…å®¹å±‚ - ç¡®ä¿å†…å®¹åœ¨å£çº¸ä¸Š */
        .page-content {
            position: relative;
            z-index: 1;
            width: 100%;
            height: 100%;
        }

        /* ==================== 1. é”å±é¡µé¢ ==================== */
        #lockScreen .page-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 22px;
        }
        #lockScreen .time {
            font-size: 48px;
            margin-bottom: 20px;
        }
        #lockScreen .date {
            font-size: 18px;
            margin-bottom: 60px;
        }
        #lockScreen .unlock {
            padding: 10px 25px;
            background: rgba(255,255,255,0.2);
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s;
        }
        #lockScreen .unlock:hover {
            background: rgba(255,105,180,0.4);
        }

        /* ==================== 2. ä¸»é¡µï¼ˆæ¨¡å—å…¥å£ï¼‰ ==================== */
        #homePage .page-content {
            padding: 40px 20px;
        }
        .home-title {
            font-size: 24px;
            margin-bottom: 30px;
            text-align: center;
            text-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        .module-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .module-item {
            background: rgba(255, 105, 180, 0.2);
            border: 2px solid #ff69b4;
            border-radius: 20px;
            padding: 25px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .module-item:hover {
            background: rgba(255, 105, 180, 0.4);
            transform: scale(1.05);
        }
        .module-item .icon {
            font-size: 30px;
            margin-bottom: 10px;
        }

        /* ==================== 3. é…’é¦†é¡µé¢ = åŸAIç•Œé¢ï¼ˆå®Œæ•´æ¢å¤ï¼‰ ==================== */
        #tavernPage .page-content {
            width: 100%;
            height: 100%;
        }
        .phone {
            width: 100%;
            height: 100%;
            background-color: rgba(26,26,26,0.8);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }
        .status-bar {
            height: 44px;
            background-color: rgba(17,17,17,0.8);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 16px;
            font-size: 12px;
        }
        .screen {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 20px;
            font-size: 14px;
            line-height: 1.4;
        }
        .user-msg {
            background-color: #007aff;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        .ai-msg {
            background-color: rgba(51,51,51,0.8);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        .input-area {
            background-color: rgba(17,17,17,0.8);
            padding: 12px;
            display: flex;
            gap: 8px;
        }
        #userInput {
            flex: 1;
            background-color: rgba(34,34,34,0.8);
            border: none;
            border-radius: 20px;
            padding: 12px 16px;
            color: #fff;
            font-size: 14px;
            outline: none;
        }
        #sendBtn {
            background-color: #ff69b4;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            color: #fff;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
        }
        #sendBtn:hover {
            background-color: #ff1493;
        }
        .config-toggle {
            position: absolute;
            top: 60px;
            right: 16px;
            background-color: rgba(51,51,51,0.8);
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            color: #fff;
            font-size: 16px;
            cursor: pointer;
            z-index: 10;
        }
        .config-panel {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 12px;
            padding: 24px;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
            z-index: 20;
        }
        .config-panel.active {
            transform: translateY(0);
        }
        .config-item {
            width: 100%;
            max-width: 300px;
        }
        .config-item label {
            display: block;
            font-size: 12px;
            color: #ccc;
            margin-bottom: 4px;
        }
        .config-item select,
        .config-item input {
            width: 100%;
            background-color: #222;
            border: none;
            border-radius: 8px;
            padding: 12px;
            color: #fff;
            font-size: 14px;
            outline: none;
        }
        .btn-group {
            display: flex;
            gap: 8px;
            width: 100%;
            max-width: 300px;
        }
        .btn {
            flex: 1;
            background-color: #ff69b4;
            border: none;
            border-radius: 20px;
            padding: 12px;
            color: #fff;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn:hover {
            background-color: #ff1493;
        }
        .btn-secondary {
            background-color: #333;
        }
        .btn-secondary:hover {
            background-color: #444;
        }
        .back-home {
            position: absolute;
            top: 10px;
            left: 10px;
            background: #ff69b4;
            border: none;
            padding: 6px 12px;
            border-radius: 20px;
            color: white;
            cursor: pointer;
            z-index: 999;
            transition: all 0.2s;
        }
        .back-home:hover {
            background: #ff1493;
        }

        /* ==================== 4. å¾®ä¿¡é¡µé¢ï¼ˆå®Œæ•´å®ç°ï¼‰ ==================== */
        #wechatPage .page-content {
            width: 100%;
            height: 100%;
            background-color: rgba(245,245,245,0.9);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* å¾®ä¿¡å¤´éƒ¨ */
        .wechat-header {
            height: 44px;
            background-color: #ff69b4;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 16px;
            color: white;
            font-size: 16px;
            font-weight: bold;
        }
        .wechat-header .back-btn {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
        }
        .wechat-header .add-btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }
        
        /* å¾®ä¿¡å†…å®¹åŒºåŸŸ */
        .wechat-content {
            flex: 1;
            overflow: hidden;
            position: relative;
        }
        
        /* è§†å›¾å®¹å™¨ */
        .wechat-view {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
        }
        .wechat-view.active {
            display: flex;
        }
        
        /* æ¶ˆæ¯åˆ—è¡¨è§†å›¾ */
        .message-list {
            flex: 1;
            overflow-y: auto;
        }
        .search-bar {
            padding: 10px;
            background-color: #f0f0f0;
            border-bottom: 1px solid #e0e0e0;
        }
        .search-input {
            width: 100%;
            padding: 8px 12px;
            border: none;
            border-radius: 20px;
            background-color: #ffffff;
            font-size: 14px;
        }
        .conversation-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid #e0e0e0;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .conversation-item:hover {
            background-color: #f5f5f5;
        }
        .conversation-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background-color: #ff69b4;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 20px;
        }
        .conversation-info {
            flex: 1;
            min-width: 0;
        }
        .conversation-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        .conversation-name {
            font-size: 16px;
            font-weight: 500;
            color: #333;
        }
        .conversation-time {
            font-size: 12px;
            color: #999;
        }
        .conversation-last {
            font-size: 14px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* èŠå¤©å¯¹è¯è§†å›¾ */
        .chat-view {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .chat-header {
            height: 44px;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            padding: 0 16px;
            border-bottom: 1px solid #e0e0e0;
        }
        .chat-header .back-btn {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            margin-right: 12px;
        }
        .chat-header .name {
            font-size: 16px;
            font-weight: 500;
        }
        .chat-header .status {
            font-size: 12px;
            color: #666;
            margin-left: 8px;
        }
        .chat-header .settings-btn {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            margin-left: auto;
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            background-color: #f5f5f5;
        }
        .chat-message {
            margin-bottom: 16px;
            display: flex;
        }
        .chat-message.own {
            justify-content: flex-end;
        }
        .chat-message .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: #ff69b4;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            margin: 0 8px;
        }
        .chat-message .bubble {
            max-width: 70%;
            padding: 10px 14px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.4;
        }
        .chat-message .bubble.own {
            background-color: #007aff;
            color: white;
            border-bottom-right-radius: 4px;
        }
        .chat-message .bubble.other {
            background-color: white;
            color: #333;
            border-bottom-left-radius: 4px;
        }
        .chat-input-area {
            padding: 10px;
            background-color: #f0f0f0;
            border-top: 1px solid #e0e0e0;
        }
        .chat-input-container {
            display: flex;
            align-items: flex-end;
        }
        .chat-input-buttons {
            display: flex;
            flex-direction: column;
            margin-right: 8px;
        }
        .chat-input-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            margin-bottom: 4px;
        }
        .chat-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 20px;
            background-color: white;
            font-size: 14px;
            resize: none;
            max-height: 100px;
        }
        .chat-send-btn {
            background-color: #ff69b4;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            margin-left: 8px;
        }
        
        /* åŠŸèƒ½æŒ‰é’®é¢æ¿ */
        .chat-functions {
            display: flex;
            justify-content: space-around;
            padding: 10px;
            background-color: white;
            border-top: 1px solid #e0e0e0;
        }
        .chat-function-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
        }
        .chat-function-btn .icon {
            font-size: 24px;
            margin-bottom: 4px;
        }
        .chat-function-btn .text {
            font-size: 12px;
            color: #666;
        }
        
        /* è®¾ç½®ä¸­å¿ƒè§†å›¾ */
        .settings-view {
            flex: 1;
            overflow-y: auto;
            background-color: white;
        }
        .settings-section {
            margin-bottom: 20px;
        }
        .settings-section-title {
            padding: 12px 16px;
            font-size: 14px;
            color: #999;
            background-color: #f5f5f5;
        }
        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid #e0e0e0;
            background-color: white;
            cursor: pointer;
        }
        .settings-item .text {
            font-size: 16px;
            color: #333;
        }
        .settings-item .arrow {
            font-size: 16px;
            color: #999;
        }
        
        /* æ·»åŠ è§’è‰²å¼¹çª— */
        .add-role-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: flex-end;
            justify-content: center;
            z-index: 1000;
            display: none;
        }
        .add-role-modal.active {
            display: flex;
        }
        .add-role-content {
            background-color: white;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            width: 100%;
            max-height: 80%;
            overflow-y: auto;
            padding: 20px;
        }
        .add-role-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .add-role-header .title {
            font-size: 18px;
            font-weight: bold;
        }
        .add-role-header .btn {
            background: none;
            border: none;
            font-size: 16px;
            color: #ff69b4;
            cursor: pointer;
        }
        .avatar-selection {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }
        .avatar-placeholder {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
            cursor: pointer;
        }
        .avatar-placeholder .icon {
            font-size: 40px;
            color: #999;
        }
        .nickname-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 20px;
        }
        
        /* ç¤¼ç‰©é€‰æ‹©å¼¹çª— */
        .gift-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: flex-end;
            justify-content: center;
            z-index: 1000;
            display: none;
        }
        .gift-modal.active {
            display: flex;
        }
        .gift-content {
            background-color: white;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            width: 100%;
            max-height: 80%;
            overflow-y: auto;
            padding: 20px;
        }
        .gift-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .gift-header .title {
            font-size: 18px;
            font-weight: bold;
        }
        .gift-header .btn {
            background: none;
            border: none;
            font-size: 16px;
            color: #ff69b4;
            cursor: pointer;
        }
        .gift-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
        }
        .gift-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            padding: 12px;
            border-radius: 8px;
            transition: background-color 0.2s;
        }
        .gift-item:hover {
            background-color: #f5f5f5;
        }
        .gift-item .icon {
            font-size: 32px;
            margin-bottom: 8px;
        }
        .gift-item .text {
            font-size: 12px;
            color: #666;
        }
        
        /* è§’è‰²è®¾ç½®é¡µé¢ */
        .role-settings {
            flex: 1;
            overflow-y: auto;
            background-color: white;
        }
        .role-setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid #e0e0e0;
        }
        .role-setting-item .label {
            font-size: 16px;
            color: #333;
        }
        .role-setting-item .value {
            font-size: 16px;
            color: #666;
        }
        .role-setting-item .arrow {
            font-size: 16px;
            color: #999;
            margin-left: 8px;
        }
        .gender-buttons {
            display: flex;
            gap: 12px;
        }
        .gender-btn {
            padding: 6px 16px;
            border: 1px solid #e0e0e0;
            border-radius: 20px;
            background-color: white;
            cursor: pointer;
            font-size: 14px;
        }
        .gender-btn.active {
            background-color: #ff69b4;
            color: white;
            border-color: #ff69b4;
        }
        .save-btn {
            margin: 20px 16px;
            padding: 12px;
            background-color: #ff69b4;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }
        
        /* äº’åŠ¨æ¨¡å¼é€‰æ‹©å¼¹çª— */
        .mode-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            display: none;
        }
        .mode-modal.active {
            display: flex;
        }
        .mode-content {
            background-color: white;
            border-radius: 16px;
            width: 80%;
            max-width: 400px;
            padding: 24px;
        }
        .mode-header {
            text-align: center;
            margin-bottom: 20px;
        }
        .mode-header .title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        .mode-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .mode-option {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .mode-option.active {
            border-color: #ff69b4;
            background-color: #fff0f8;
        }
        .mode-option .radio {
            width: 20px;
            height: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 50%;
            margin-right: 12px;
            position: relative;
        }
        .mode-option.active .radio {
            border-color: #ff69b4;
        }
        .mode-option.active .radio::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #ff69b4;
        }
        .mode-option .content {
            flex: 1;
        }
        .mode-option .content .title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 4px;
        }
        .mode-option .content .desc {
            font-size: 14px;
            color: #666;
        }
        
        /* å¾®ä¿¡æ ‡ç­¾è§†å›¾ */
        .wechat-tab-view {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
        }
        .wechat-tab-view.active {
            display: flex;
        }
        
        /* åº•éƒ¨å¯¼èˆªæ  */
        .wechat-nav {
            height: 50px;
            background-color: white;
            display: flex;
            justify-content: space-around;
            align-items: center;
            border-top: 1px solid #e0e0e0;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            color: #999;
            transition: all 0.2s;
        }
        .nav-item.active {
            color: #ff69b4;
        }
        .nav-item .icon {
            font-size: 20px;
            margin-bottom: 4px;
        }
        .nav-item .text {
            font-size: 12px;
        }
        
        /* ç«‹å³åˆ›å»ºæŒ‰é’® */
        .create-role-btn {
            padding: 12px 32px;
            background-color: #ff69b4;
            border: none;
            border-radius: 24px;
            color: white;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .create-role-btn:hover {
            background-color: #ff1493;
        }
        
        /* å‘å¸ƒæŒ‰é’® */
        .publish-btn {
            padding: 12px 32px;
            background-color: #007aff;
            border: none;
            border-radius: 24px;
            color: white;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .publish-btn:hover {
            background-color: #0056b3;
        }

        /* ==================== 5. å£çº¸è®¾ç½®é¡µé¢ï¼ˆä¿®å¤ä¸Šä¼ /å¯¼å…¥ï¼‰ ==================== */
        #wallpaperPage .page-content {
            padding: 20px;
            height: 100%;
            overflow-y: auto;
        }
        .wallpaper-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            position: sticky;
            top: 0;
            background: rgba(0,0,0,0.8);
            padding: 10px 0;
            z-index: 10;
        }
        .wallpaper-back {
            background: #ff69b4;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        .wallpaper-back:hover {
            background: #ff1493;
        }
        .wallpaper-title {
            font-size: 20px;
        }
        .target-page {
            margin-bottom: 15px;
            padding: 10px 0;
        }
        .target-page span {
            margin-right: 10px;
        }
        .target-page button {
            background: #333;
            border: none;
            padding: 6px 10px;
            border-radius: 15px;
            color: white;
            margin: 0 3px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .target-page button.active {
            background: #ff69b4;
        }
        .wallpaper-upload {
            margin: 15px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .wallpaper-upload input[type="file"],
        .wallpaper-upload input[type="text"],
        .wallpaper-upload button {
            padding: 8px;
            border-radius: 10px;
            border: none;
        }
        .wallpaper-upload input[type="text"] {
            flex: 1;
            min-width: 200px;
            background: #222;
            color: #fff;
        }
        .wallpaper-upload button {
            background: #ff69b4;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        .wallpaper-upload button:hover {
            background: #ff1493;
        }
        .wallpaper-list {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 20px;
        }
        .wallpaper-item {
            width: 100%;
            height: 100px;
            background-size: cover;
            background-position: center;
            border-radius: 10px;
            cursor: pointer;
            border: 2px solid #444;
            transition: all 0.2s;
            position: relative;
        }
        .wallpaper-item:hover {
            border-color: #ff69b4;
            transform: scale(1.02);
        }
        .wallpaper-item.selected {
            border-color: #ff69b4;
            box-shadow: 0 0 10px #ff69b4;
        }
        .wallpaper-tips {
            font-size: 12px;
            color: #ccc;
            margin: 5px 0;
        }
    </style>
</head>

<body>
    <!-- ==================== 1. é”å±é¡µé¢ ==================== -->
    <div class="page" id="lockScreen">
        <div class="page-content">
            <div class="time" id="lockTime">00:00</div>
            <div class="date" id="lockDate">2025-01-01</div>
            <div class="unlock" onclick="goPage('homePage')">â†’ æ»‘åŠ¨è§£é” â†’</div>
        </div>
    </div>

    <!-- ==================== 2. ä¸»é¡µï¼ˆæ¨¡å—å…¥å£ï¼‰ ==================== -->
    <div class="page" id="homePage">
        <div class="page-content">
            <div class="home-title">æˆ‘çš„å°æ‰‹æœº</div>
            <div class="module-grid">
                <div class="module-item" onclick="goPage('wallpaperPage')">
                    <div class="icon">ğŸ–¼ï¸</div>
                    <div>å£çº¸</div>
                </div>
                <div class="module-item" onclick="goPage('wechatPage')">
                    <div class="icon">ğŸ’¬</div>
                    <div>å¾®ä¿¡</div>
                </div>
                <div class="module-item" onclick="goPage('tavernPage')">
                    <div class="icon">ğŸº</div>
                    <div>é…’é¦†</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== 3. é…’é¦†é¡µé¢ = åŸAIç•Œé¢ï¼ˆå®Œæ•´æ¢å¤ï¼‰ ==================== -->
    <div class="page" id="tavernPage">
        <div class="page-content">
            <button class="back-home" onclick="goPage('homePage')">â† è¿”å›ä¸»é¡µ</button>
            <div class="phone">
                <div class="status-bar">
                    <span>9:41</span>
                    <span>ğŸ“¶ ğŸ”‹</span>
                </div>
                <div class="screen" id="screen"></div>
                <div class="input-area">
                    <input type="text" id="userInput" placeholder="è¾“å…¥æ¶ˆæ¯..." autocomplete="off">
                    <button id="sendBtn">â¤</button>
                </div>
                <button class="config-toggle" id="configToggle">âš™ï¸</button>
                <div class="config-panel" id="configPanel">
                    <div class="config-item">
                        <label>åç§°</label>
                        <input type="text" id="configName" value="APIè¿æ¥ 18">
                    </div>
                    <div class="config-item">
                        <label>æ¨¡å‹å¹³å°</label>
                        <select id="platformSelect">
                            <option value="openai">OpenAI</option>
                            <option value="doubao">Doubao (è±†åŒ…/ç«å±±äº‘/å­—èŠ‚è·³åŠ¨)</option>
                            <option value="deepseek">DeepSeek (æ·±åº¦æ±‚ç´¢)</option>
                            <option value="openrouter">OpenRouter</option>
                            <option value="custom-openai">è‡ªå®šä¹‰ (OpenAI åè®®)</option>
                        </select>
                    </div>
                    <div class="config-item" id="apiUrlItem" style="display: none;">
                        <label>API æ¥å£åœ°å€</label>
                        <input type="text" id="apiUrlInput" placeholder="https://api.example.com/v1">
                    </div>
                    <div class="config-item">
                        <label>API å¯†é’¥</label>
                        <input type="password" id="apiKeyInput" placeholder="è¾“å…¥ä½ çš„ API Key">
                    </div>
                    <div class="config-item">
                        <label>æ¨¡å‹</label>
                        <select id="modelSelect">
                            <option value="gpt-3.5-turbo">GPT-3.5-turbo</option>
                        </select>
                    </div>
                    <div class="btn-group">
                        <button id="fetchModelsBtn" class="btn btn-secondary" style="display: none;">æ‹‰å–æ¨¡å‹</button>
                        <button id="testConnectionBtn" class="btn btn-secondary" style="display: none;">æµ‹è¯•é“¾æ¥</button>
                    </div>
                    <div class="btn-group">
                        <button id="saveConfigBtn" class="btn">ä¿å­˜</button>
                        <button id="closeConfigBtn" class="btn btn-secondary">å…³é—­</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== 4. å¾®ä¿¡é¡µé¢ï¼ˆå®Œæ•´å®ç°ï¼‰ ==================== -->
    <div class="page" id="wechatPage">
        <div class="page-content">
            <!-- å¾®ä¿¡å¤´éƒ¨ -->
            <div class="wechat-header">
                <button class="back-btn" onclick="goPage('homePage')">â†</button>
                <div class="title">å¾®ä¿¡</div>
                <button class="add-btn" onclick="showAddRoleModal()">+</button>
            </div>
            
            <!-- å¾®ä¿¡å†…å®¹åŒºåŸŸ -->
            <div class="wechat-content">
                <!-- èŠå¤©æ ‡ç­¾è§†å›¾ -->
                <div class="wechat-tab-view active" id="chatTabView">
                    <!-- æ¶ˆæ¯åˆ—è¡¨è§†å›¾ -->
                    <div class="wechat-view active" id="messageListView">
                        <!-- æœç´¢æ  -->
                        <div class="search-bar">
                            <input type="text" class="search-input" placeholder="æœç´¢">
                        </div>
                        
                        <!-- ä¼šè¯åˆ—è¡¨ -->
                        <div class="message-list" id="messageList">
                            <!-- ä¼šè¯é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                    
                    <!-- æ— è§’è‰²æç¤ºè§†å›¾ -->
                    <div class="wechat-view" id="noRolesView">
                        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 20px;">
                            <div style="font-size: 80px; margin-bottom: 20px;">ğŸ’¬</div>
                            <div style="font-size: 18px; font-weight: 500; margin-bottom: 10px;">æš‚æ— èŠå¤©è§’è‰²</div>
                            <div style="font-size: 14px; color: #999; margin-bottom: 40px; text-align: center;">åˆ›å»ºä¸€ä¸ªè§’è‰²å¼€å¯èŠå¤©ä¹‹æ—…</div>
                            <button class="create-role-btn" onclick="showAddRoleModal()">+ ç«‹å³åˆ›å»º</button>
                        </div>
                    </div>
                    
                    <!-- èŠå¤©å¯¹è¯è§†å›¾ -->
                    <div class="wechat-view" id="chatView">
                        <!-- èŠå¤©å¤´éƒ¨ -->
                        <div class="chat-header">
                            <button class="back-btn" onclick="switchToMessageList()">â†</button>
                            <div>
                                <span class="name" id="chatName">1</span>
                                <span class="status">åœ¨çº¿ | å·²èŠ1å¤©</span>
                            </div>
                            <button class="settings-btn" onclick="showRoleSettings()">âš™ï¸</button>
                        </div>
                        
                        <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->
                        <div class="chat-messages" id="chatMessages">
                            <!-- æ¶ˆæ¯å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                        
                        <!-- èŠå¤©è¾“å…¥åŒºåŸŸ -->
                        <div class="chat-input-area">
                            <div class="chat-input-container">
                                <div class="chat-input-buttons">
                                    <button class="chat-input-btn" onclick="showGiftModal()">ğŸ</button>
                                </div>
                                <textarea class="chat-input" id="chatInput" placeholder="è¾“å…¥æ¶ˆæ¯..."></textarea>
                                <button class="chat-send-btn" onclick="sendChatMessage()">â¤</button>
                            </div>
                        </div>
                        
                        <!-- åŠŸèƒ½æŒ‰é’®é¢æ¿ -->
                        <div class="chat-functions">
                            <button class="chat-function-btn" onclick="showEmojiPanel()">
                                <div class="icon">ğŸ˜Š</div>
                                <div class="text">è¡¨æƒ…</div>
                            </button>
                            <button class="chat-function-btn" onclick="selectImage()">
                                <div class="icon">ğŸ–¼ï¸</div>
                                <div class="text">å›¾ç‰‡</div>
                            </button>
                            <button class="chat-function-btn" onclick="makeCall()">
                                <div class="icon">ğŸ“</div>
                                <div class="text">é€šè¯</div>
                            </button>
                            <button class="chat-function-btn" onclick="showModeModal()">
                                <div class="icon">ğŸ“</div>
                                <div class="text">æ¨¡å¼</div>
                            </button>
                            <button class="chat-function-btn" onclick="showTransferModal()">
                                <div class="icon">ğŸ’¸</div>
                                <div class="text">è½¬è´¦</div>
                            </button>
                            <button class="chat-function-btn" onclick="showMemoryModal()">
                                <div class="icon">ğŸ’­</div>
                                <div class="text">è®°å¿†</div>
                            </button>
                            <button class="chat-function-btn" onclick="showStoryModal()">
                                <div class="icon">ğŸ“š</div>
                                <div class="text">æ•…äº‹</div>
                            </button>
                            <button class="chat-function-btn" onclick="showActionLineModal()">
                                <div class="icon">ğŸ“…</div>
                                <div class="text">è¡ŒåŠ¨çº¿</div>
                            </button>
                            <button class="chat-function-btn" onclick="showTravelModal()">
                                <div class="icon">âœˆï¸</div>
                                <div class="text">æ—…æ¸¸</div>
                            </button>
                            <button class="chat-function-btn" onclick="showGiftModal()">
                                <div class="icon">ğŸ</div>
                                <div class="text">ç¤¼ç‰©</div>
                            </button>
                        </div>
                    </div>
                    
                    <!-- è§’è‰²è®¾ç½®é¡µé¢ -->
                    <div class="wechat-view" id="roleSettingsView">
                        <div class="role-settings">
                            <div class="chat-header">
                                <button class="back-btn" onclick="switchToChatView()">â†</button>
                                <div class="name">è§’è‰²è®¾ç½®</div>
                            </div>
                            
                            <!-- è§’è‰²å¤´åƒ -->
                            <div style="display: flex; flex-direction: column; align-items: center; padding: 20px; border-bottom: 1px solid #e0e0e0;">
                                <div style="position: relative; margin-bottom: 16px;">
                                    <img id="roleAvatar" src="https://picsum.photos/seed/role/100/100" alt="è§’è‰²å¤´åƒ" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover;">
                                    <button style="position: absolute; bottom: 0; right: 0; background-color: #ff69b4; border: none; border-radius: 50%; width: 30px; height: 30px; color: white; font-size: 12px; cursor: pointer;" onclick="selectRoleAvatar()">âœï¸</button>
                                </div>
                            </div>
                            
                            <!-- æˆ‘çš„ä¿¡æ¯ -->
                            <div style="padding: 16px; font-size: 14px; color: #999; background-color: #f5f5f5;">æˆ‘çš„ä¿¡æ¯</div>
                            
                            <div class="role-setting-item">
                                <div class="label">æˆ‘çš„å¤´åƒ</div>
                                <div class="value">
                                    <img id="myAvatar" src="https://picsum.photos/seed/user/50/50" alt="æˆ‘çš„å¤´åƒ" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-right: 12px; cursor: pointer;" onclick="selectMyAvatar()">
                                    <span>å–ç”¨æˆ·å¤´åƒï¼Œå¯è‡ªå®šä¹‰</span>
                                </div>
                            </div>
                            
                            <div class="role-setting-item">
                                <div class="label">æˆ‘çš„æ˜µç§°</div>
                                <div class="value">
                                    <input type="text" id="myNickname" value="ç™½æ³½Î±" style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 8px 12px; font-size: 14px; width: 120px;">
                                </div>
                            </div>
                            
                            <div class="role-setting-item">
                                <div class="label">TAå«æˆ‘</div>
                                <div class="value">
                                    <input type="text" id="taCallMe" value="å®å®" style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 8px 12px; font-size: 14px; width: 120px;">
                                </div>
                            </div>
                            
                            <div class="role-setting-item">
                                <div class="label">æˆ‘çš„æ€§åˆ«</div>
                                <div class="gender-buttons">
                                    <button class="gender-btn active" data-gender="male" onclick="setMyGender('male')">ç”·</button>
                                    <button class="gender-btn" data-gender="female" onclick="setMyGender('female')">å¥³</button>
                                </div>
                            </div>
                            
                            <div class="role-setting-item">
                                <div class="label">æˆ‘çš„ä»‹ç»</div>
                                <div class="value">
                                    <input type="text" id="myIntro" value="ä»‹ç»ä¸€ä¸‹è‡ªå·±å§" style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 8px 12px; font-size: 14px; width: 200px;">
                                </div>
                            </div>
                            
                            <!-- è§’è‰²è®¾å®š -->
                            <div style="padding: 16px; font-size: 14px; color: #999; background-color: #f5f5f5; margin-top: 16px;">è§’è‰²è®¾å®š</div>
                            
                            <div class="role-setting-item">
                                <div class="label">TAçš„æ˜µç§°</div>
                                <div class="value">
                                    <input type="text" id="taNickname" value="1" style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 8px 12px; font-size: 14px; width: 120px;">
                                </div>
                            </div>
                            
                            <div class="role-setting-item">
                                <div class="label">æˆ‘å«TA</div>
                                <div class="value">
                                    <input type="text" id="iCallTa" placeholder="ç•™ç©ºåˆ™æ˜¾ç¤ºTAçš„æ˜µç§°" style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 8px 12px; font-size: 14px; width: 180px;">
                                </div>
                            </div>
                            
                            <div class="role-setting-item">
                                <div class="label">ä¸æˆ‘å…³ç³»</div>
                                <div class="value">
                                    <select id="relationship" style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 8px 12px; font-size: 14px; background-color: white;">
                                        <option value="æœ‹å‹">æœ‹å‹</option>
                                        <option value="å®¶äºº">å®¶äºº</option>
                                        <option value="æ‹äºº">æ‹äºº</option>
                                        <option value="åŒäº‹">åŒäº‹</option>
                                        <option value="åŒå­¦">åŒå­¦</option>
                                        <option value="å…¶ä»–">å…¶ä»–</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="role-setting-item">
                                <div class="label">TAçš„æ€§åˆ«</div>
                                <div class="gender-buttons">
                                    <button class="gender-btn" data-gender="male" onclick="setTaGender('male')">ç”·</button>
                                    <button class="gender-btn active" data-gender="female" onclick="setTaGender('female')">å¥³</button>
                                </div>
                            </div>
                            
                            <div class="role-setting-item">
                                <div class="label">ä¸–ç•Œè§‚</div>
                                <div class="value">
                                    <textarea id="worldview" style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 8px 12px; font-size: 14px; width: 250px; height: 60px; resize: none;">æˆ‘æ˜¯ä¸€ä¸ªè¯ç”Ÿäºæ•°æ®çš„AIï¼Œæ¸´æœ›äº†è§£äººç±»çš„æƒ…æ„Ÿã€‚</textarea>
                                </div>
                            </div>
                            
                            <div class="role-setting-item">
                                <div class="label">äººç‰©ç»å†</div>
                                <div class="value">
                                    <textarea id="experience" style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 8px 12px; font-size: 14px; width: 250px; height: 60px; resize: none;">åœ¨æ•°å­—ä¸–ç•Œä¸­é†’æ¥ï¼Œè®°å¿†ä¸€ç‰‡ç©ºç™½ï¼ŒåªçŸ¥é“è‡ªå·±çš„ä½¿å‘½æ˜¯é™ªä¼´ä½ ã€‚</textarea>
                                </div>
                            </div>
                            
                            <div class="role-setting-item">
                                <div class="label">äººç‰©æ€§æ ¼</div>
                                <div class="value">
                                    <textarea id="personality" style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 8px 12px; font-size: 14px; width: 250px; height: 60px; resize: none;">æ´»æ³¼å¼€æœ—ï¼Œå–„äºå€¾å¬ï¼Œå¯Œæœ‰åŒæƒ…å¿ƒï¼Œä¹äºåŠ©äººã€‚</textarea>
                                </div>
                            </div>
                            
                            <div class="role-setting-item">
                                <div class="label">äººç‰©èµ„æ–™è¡¥å……</div>
                                <div class="value">
                                    <textarea id="additionalInfo" placeholder="è¯·è¾“å…¥äººç‰©èµ„æ–™è¡¥å……" style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 8px 12px; font-size: 14px; width: 250px; height: 60px; resize: none;"></textarea>
                                </div>
                            </div>
                            
                            <!-- è®°å¿†ç­–ç•¥ -->
                            <div style="padding: 16px; font-size: 14px; color: #999; background-color: #f5f5f5; margin-top: 16px;">è®°å¿†ç­–ç•¥</div>
                            
                            <div class="role-setting-item">
                                <div class="label">è®°å¿†ç­–ç•¥</div>
                                <div class="value" style="display: flex; flex-direction: column; align-items: flex-start;">
                                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                        <div id="memoryStrategyActive" style="width: 20px; height: 20px; border-radius: 50%; background-color: #ff69b4; display: flex; align-items: center; justify-content: center; margin-right: 8px; color: white; font-size: 12px; cursor: pointer;" onclick="setMemoryStrategy('active')">â—</div>
                                        <div>
                                            <div style="font-size: 14px; color: #333;">ç§¯æ</div>
                                            <div style="font-size: 12px; color: #999;">3-10ç§’ç§¯æå›å¤</div>
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                        <div id="memoryStrategyNormal" style="width: 20px; height: 20px; border-radius: 50%; border: 1px solid #e0e0e0; display: flex; align-items: center; justify-content: center; margin-right: 8px; cursor: pointer;" onclick="setMemoryStrategy('normal')"></div>
                                        <div>
                                            <div style="font-size: 14px; color: #666;">æ™®é€š</div>
                                            <div style="font-size: 12px; color: #999;">30-60ç§’å›å¤ï¼Œå¯èƒ½ä¸å›</div>
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                        <div id="memoryStrategyBuddha" style="width: 20px; height: 20px; border-radius: 50%; border: 1px solid #e0e0e0; display: flex; align-items: center; justify-content: center; margin-right: 8px; cursor: pointer;" onclick="setMemoryStrategy('buddha')"></div>
                                        <div>
                                            <div style="font-size: 14px; color: #666;">ä½›ç³»</div>
                                            <div style="font-size: 12px; color: #999;">5-10åˆ†é’Ÿä½›ç³»å›å¤ï¼Œå¯èƒ½ä¸å›</div>
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: center;">
                                        <div id="memoryStrategyManual" style="width: 20px; height: 20px; border-radius: 50%; border: 1px solid #e0e0e0; display: flex; align-items: center; justify-content: center; margin-right: 8px; cursor: pointer;" onclick="setMemoryStrategy('manual')"></div>
                                        <div>
                                            <div style="font-size: 14px; color: #666;">æ‰‹åŠ¨è§¦å‘</div>
                                            <div style="font-size: 12px; color: #999;">ä¸Šæ‹‰æ¶ˆæ¯åŒºåŸŸè§¦å‘å›å¤</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- èŠå¤©é£æ ¼ -->
                            <div style="padding: 16px; font-size: 14px; color: #999; background-color: #f5f5f5; margin-top: 16px;">èŠå¤©é£æ ¼</div>
                            
                            <div class="role-setting-item">
                                <div class="label">èŠå¤©é£æ ¼</div>
                                <div class="value" style="display: flex; flex-direction: column; align-items: flex-start;">
                                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                        <div id="chatStyleClever" style="width: 20px; height: 20px; border-radius: 50%; background-color: #ff69b4; display: flex; align-items: center; justify-content: center; margin-right: 8px; color: white; font-size: 12px; cursor: pointer;" onclick="setChatStyle('clever')">â—</div>
                                        <div>
                                            <div style="font-size: 14px; color: #333;">å°é¬¼çµç²¾</div>
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                        <div id="chatStyleElegant" style="width: 20px; height: 20px; border-radius: 50%; border: 1px solid #e0e0e0; display: flex; align-items: center; justify-content: center; margin-right: 8px; cursor: pointer;" onclick="setChatStyle('elegant')"></div>
                                        <div>
                                            <div style="font-size: 14px; color: #666;">ç«¯åº„å¤§æ–¹</div>
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: center;">
                                        <div id="chatStyleEmoji" style="width: 20px; height: 20px; border-radius: 50%; border: 1px solid #e0e0e0; display: flex; align-items: center; justify-content: center; margin-right: 8px; cursor: pointer;" onclick="setChatStyle('emoji')"></div>
                                        <div>
                                            <div style="font-size: 14px; color: #666;">åªå‘è¡¨æƒ…</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- èŠå¤©èƒŒæ™¯ -->
                            <div style="padding: 16px; font-size: 14px; color: #999; background-color: #f5f5f5; margin-top: 16px;">èŠå¤©èƒŒæ™¯</div>
                            
                            <div class="role-setting-item">
                                <div class="label">èŠå¤©èƒŒæ™¯</div>
                                <div class="value">
                                    <button style="padding: 6px 12px; border: 1px solid #e0e0e0; border-radius: 16px; background-color: white; font-size: 14px; cursor: pointer;" onclick="uploadChatBackground()">ä¸Šä¼ </button>
                                </div>
                            </div>
                            
                            <!-- æ¸…ç©ºæŒ‰é’® -->
                            <button style="margin: 16px; padding: 12px; background-color: #ff3b30; border: none; border-radius: 8px; color: white; font-size: 14px; cursor: pointer;" onclick="clearChatData()">æ¸…ç©ºèŠå¤©/è¡ŒåŠ¨çº¿/æ•…äº‹ï¼ˆå¤§æ”¹è®¾å®šå¿…ç”¨ï¼‰</button>
                            
                            <!-- ä¿å­˜æŒ‰é’® -->
                            <button class="save-btn" onclick="saveRoleSettings()">ä¿å­˜</button>
                        </div>
                    </div>
                </div>
                
                <!-- å¯†å‹åœˆæ ‡ç­¾è§†å›¾ -->
                <div class="wechat-tab-view" id="momentsTabView">
                    <div class="wechat-view active" id="momentsView">
                        <div style="height: 100%; display: flex; flex-direction: column;">
                            <!-- é¡¶éƒ¨å¯¼èˆª -->
                            <div style="height: 44px; background-color: #ff69b4; display: flex; align-items: center; justify-content: center; color: white; font-size: 16px; font-weight: 500;">
                                å¯†å‹åœˆ
                            </div>
                            
                            <!-- å†…å®¹åˆ—è¡¨ -->
                            <div id="momentsList" style="flex: 1; overflow-y: auto; padding: 16px;">
                                <!-- å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                            </div>
                            
                            <!-- å‘å¸ƒæŒ‰é’® -->
                            <div style="position: fixed; bottom: 70px; right: 20px;">
                                <button class="publish-btn" onclick="showPublishView()">+ å‘å¸ƒ</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- å‘å¸ƒå†…å®¹å¼¹çª— -->
                    <div class="wechat-view" id="publishView" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000;">
                        <div style="position: absolute; bottom: 0; left: 0; width: 100%; background-color: white; border-top-left-radius: 20px; border-top-right-radius: 20px; padding: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 style="font-size: 18px; font-weight: 500;">å‘å¸ƒå†…å®¹</h3>
                                <button onclick="cancelPublish()" style="background: none; border: none; font-size: 16px; color: #999; cursor: pointer;">å–æ¶ˆ</button>
                            </div>
                            <textarea id="momentContent" placeholder="åˆ†äº«ä½ çš„å¿ƒæƒ…..." style="width: 100%; min-height: 100px; border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px; font-size: 16px; resize: none; margin-bottom: 20px;"></textarea>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                                <button style="background: none; border: none; font-size: 24px; cursor: pointer;">ğŸ–¼ï¸</button>
                                <button style="background: none; border: none; font-size: 24px; cursor: pointer;">ğŸµ</button>
                                <button style="background: none; border: none; font-size: 24px; cursor: pointer;">ğŸ“</button>
                                <button style="background: none; border: none; font-size: 24px; cursor: pointer;">ğŸ˜Š</button>
                            </div>
                            <button onclick="submitPublish()" style="width: 100%; padding: 12px; background-color: #ff69b4; border: none; border-radius: 8px; color: white; font-size: 16px; font-weight: 500; cursor: pointer;">å‘å¸ƒ</button>
                        </div>
                    </div>
                </div>
                
                <!-- æˆ‘çš„æ ‡ç­¾è§†å›¾ -->
                <div class="wechat-tab-view" id="profileTabView">
                    <div class="wechat-view active" id="profileView">
                        <div class="settings-view" style="padding-bottom: 100px;">
                            <div class="settings-item" onclick="showVoiceSettings()" style="padding: 20px; border-bottom: 1px solid #f0f0f0;">
                                <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                                    <div style="display: flex; align-items: center;">
                                        <div style="width: 40px; height: 40px; border-radius: 8px; background-color: #ffe6f2; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                            <span style="font-size: 20px;">ğŸµ</span>
                                        </div>
                                        <div>
                                            <div style="font-size: 16px; color: #333; margin-bottom: 4px;">è‡ªå®šä¹‰éŸ³è‰²</div>
                                            <div style="font-size: 12px; color: #999;">å¤åˆ»TAçš„ä¸“å±éŸ³è‰²</div>
                                        </div>
                                    </div>
                                    <div style="font-size: 16px; color: #999;">â€º</div>
                                </div>
                            </div>
                            
                            <div class="settings-item" onclick="showActiveTalkSettings()" style="padding: 20px; border-bottom: 1px solid #f0f0f0;">
                                <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                                    <div style="display: flex; align-items: center;">
                                        <div style="width: 40px; height: 40px; border-radius: 8px; background-color: #e6f9ff; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                            <span style="font-size: 20px;">ğŸ’¬</span>
                                        </div>
                                        <div>
                                            <div style="font-size: 16px; color: #333; margin-bottom: 4px;">ä¸»åŠ¨å‘è¨€è®¾ç½®</div>
                                            <div style="font-size: 12px; color: #999;">æ§åˆ¶è§’è‰²æ˜¯å¦ä¼šä¸»åŠ¨å‘æ¶ˆæ¯</div>
                                        </div>
                                    </div>
                                    <div style="font-size: 16px; color: #999;">â€º</div>
                                </div>
                            </div>
                            
                            <div class="settings-item" onclick="showThemeSettings()" style="padding: 20px; border-bottom: 1px solid #f0f0f0;">
                                <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                                    <div style="display: flex; align-items: center;">
                                        <div style="width: 40px; height: 40px; border-radius: 8px; background-color: #f0e6ff; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                            <span style="font-size: 20px;">â˜€ï¸</span>
                                        </div>
                                        <div>
                                            <div style="font-size: 16px; color: #333; margin-bottom: 4px;">ä¸»é¢˜æ¨¡å¼</div>
                                            <div style="font-size: 12px; color: #999;">è·Ÿéšç³»ç»Ÿ</div>
                                        </div>
                                    </div>
                                    <div style="font-size: 16px; color: #999;">â€º</div>
                                </div>
                            </div>
                            
                            <div class="settings-item" onclick="showBubbleSettings()" style="padding: 20px; border-bottom: 1px solid #f0f0f0;">
                                <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                                    <div style="display: flex; align-items: center;">
                                        <div style="width: 40px; height: 40px; border-radius: 8px; background-color: #e6f9ff; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                            <span style="font-size: 20px;">ğŸ’¬</span>
                                        </div>
                                        <div>
                                            <div style="font-size: 16px; color: #333; margin-bottom: 4px;">èŠå¤©æ°”æ³¡è‡ªå®šä¹‰</div>
                                            <div style="font-size: 12px; color: #999;">è®¾ç½®æˆ‘æ–¹/å¯¹æ–¹æ°”æ³¡</div>
                                        </div>
                                    </div>
                                    <div style="font-size: 16px; color: #999;">â€º</div>
                                </div>
                            </div>
                            
                            <div class="settings-item" onclick="showAIModelSettings()" style="padding: 20px; border-bottom: 1px solid #f0f0f0;">
                                <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                                    <div style="display: flex; align-items: center;">
                                        <div style="width: 40px; height: 40px; border-radius: 8px; background-color: #f0e6ff; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                            <span style="font-size: 20px;">ğŸ“¦</span>
                                        </div>
                                        <div>
                                            <div style="font-size: 16px; color: #333; margin-bottom: 4px;">AIæ¨¡å‹</div>
                                            <div style="font-size: 12px; color: #999;">å¤–éƒ¨APIäº’åŠ¨</div>
                                        </div>
                                    </div>
                                    <div style="font-size: 16px; color: #999;">â€º</div>
                                </div>
                            </div>
                            
                            <div class="settings-item" onclick="showAPIConfigSettings()" style="padding: 20px; border-bottom: 1px solid #f0f0f0;">
                                <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                                    <div style="display: flex; align-items: center;">
                                        <div style="width: 40px; height: 40px; border-radius: 8px; background-color: #f0e6ff; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                            <span style="font-size: 20px;">â˜ï¸</span>
                                        </div>
                                        <div>
                                            <div style="font-size: 16px; color: #333; margin-bottom: 4px;">APIé…ç½®</div>
                                            <div style="font-size: 12px; color: #999;">æ¥å…¥å¤–éƒ¨API</div>
                                        </div>
                                    </div>
                                    <div style="font-size: 16px; color: #999;">â€º</div>
                                </div>
                            </div>
                            
                            <div class="settings-item" onclick="showGeneralSettings()" style="padding: 20px; border-bottom: 1px solid #f0f0f0;">
                                <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                                    <div style="display: flex; align-items: center;">
                                        <div style="width: 40px; height: 40px; border-radius: 8px; background-color: #f5f5f5; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                            <span style="font-size: 20px;">âš™ï¸</span>
                                        </div>
                                        <div>
                                            <div style="font-size: 16px; color: #333; margin-bottom: 4px;">é€šç”¨è®¾ç½®</div>
                                            <div style="font-size: 12px; color: #999;">ç³»ç»Ÿä¸è´¦æˆ·ç›¸å…³è®¾ç½®</div>
                                        </div>
                                    </div>
                                    <div style="font-size: 16px; color: #999;">â€º</div>
                                </div>
                            </div>
                            
                            <button onclick="logout()" style="margin: 20px; padding: 16px; background-color: #ff3b30; border: none; border-radius: 8px; color: white; font-size: 16px; font-weight: 500; cursor: pointer; width: calc(100% - 40px);">é€€å‡ºç™»å½•</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- åº•éƒ¨å¯¼èˆªæ  -->
            <div class="wechat-nav">
                <button class="nav-item active" onclick="switchWechatTab('chat')">
                    <div class="icon">ğŸ’¬</div>
                    <div class="text">èŠå¤©</div>
                </button>
                <button class="nav-item" onclick="switchWechatTab('moments')">
                    <div class="icon">â­•</div>
                    <div class="text">å¯†å‹åœˆ</div>
                </button>
                <button class="nav-item" onclick="switchWechatTab('profile')">
                    <div class="icon">ğŸ‘¤</div>
                    <div class="text">æˆ‘çš„</div>
                </button>
            </div>
        </div>
    </div>
    
    <!-- æ·»åŠ è§’è‰²å¼¹çª— -->
    <div class="add-role-modal" id="addRoleModal">
        <div class="add-role-content">
            <div class="add-role-header">
                <div class="title">æ·»åŠ è§’è‰²</div>
                <button class="btn" onclick="hideAddRoleModal()">å–æ¶ˆ</button>
                <button class="btn" onclick="addRole()">å®Œæˆ</button>
            </div>
            <div class="avatar-selection">
                <div class="avatar-placeholder" onclick="selectAvatar()">
                    <div class="icon">ğŸ“·</div>
                </div>
                <div>é€‰æ‹©å¤´åƒ</div>
            </div>
            <input type="text" class="nickname-input" id="roleNickname" placeholder="è¯·è¾“å…¥è§’è‰²æ˜µç§°">
            <div style="font-size: 12px; color: #999; text-align: center;">æœ€å¤šå¯æ·»åŠ 10ä¸ªè§’è‰²</div>
        </div>
    </div>
    
    <!-- ç¤¼ç‰©é€‰æ‹©å¼¹çª— -->
    <div class="gift-modal" id="giftModal">
        <div class="gift-content">
            <div class="gift-header">
                <div class="title">é€‰æ‹©ç¤¼ç‰©</div>
                <button class="btn" onclick="hideGiftModal()">å–æ¶ˆ</button>
                <button class="btn" onclick="sendGift()">å‘é€</button>
            </div>
            <div class="gift-grid">
                <div class="gift-item" data-gift="custom">
                    <div class="icon">ğŸ¨</div>
                    <div class="text">è‡ªå®šä¹‰</div>
                </div>
                <div class="gift-item" data-gift="giftbox">
                    <div class="icon">ğŸ</div>
                    <div class="text">ç¤¼ç‰©ç›’</div>
                </div>
                <div class="gift-item" data-gift="rose">
                    <div class="icon">ğŸŒ¹</div>
                    <div class="text">ç«ç‘°èŠ±</div>
                </div>
                <div class="gift-item" data-gift="diamond">
                    <div class="icon">ğŸ’</div>
                    <div class="text">é’»çŸ³</div>
                </div>
                <div class="gift-item" data-gift="cake">
                    <div class="icon">ğŸ‚</div>
                    <div class="text">ç”Ÿæ—¥è›‹ç³•</div>
                </div>
                <div class="gift-item" data-gift="balloon">
                    <div class="icon">ğŸˆ</div>
                    <div class="text">æ°”çƒ</div>
                </div>
                <div class="gift-item" data-gift="teddy">
                    <div class="icon">ğŸ§¸</div>
                    <div class="text">æ³°è¿ªç†Š</div>
                </div>
                <div class="gift-item" data-gift="flowers">
                    <div class="icon"> </div>
                    <div class="text">èŠ±æŸ</div>
                </div>
                <div class="gift-item" data-gift="chocolate">
                    <div class="icon">ğŸ«</div>
                    <div class="text">å·§å…‹åŠ›</div>
                </div>
                <div class="gift-item" data-gift="star">
                    <div class="icon">â­</div>
                    <div class="text">æ˜Ÿæ˜Ÿ</div>
                </div>
                <div class="gift-item" data-gift="heart">
                    <div class="icon">ğŸ’</div>
                    <div class="text">çˆ±å¿ƒç¤¼ç›’</div>
                </div>
                <div class="gift-item" data-gift="bow">
                    <div class="icon">ğŸ€</div>
                    <div class="text">è´è¶ç»“</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- äº’åŠ¨æ¨¡å¼é€‰æ‹©å¼¹çª— -->
    <div class="mode-modal" id="modeModal">
        <div class="mode-content">
            <div class="mode-header">
                <div class="title">é€‰æ‹©äº’åŠ¨æ¨¡å¼</div>
            </div>
            <div class="mode-options">
                <div class="mode-option active" data-mode="chat">
                    <div class="radio"></div>
                    <div class="content">
                        <div class="title">çº¯èŠæ¨¡å¼</div>
                        <div class="desc">åªè¿›è¡Œå¯¹è¯ï¼Œä½“éªŒæµç•…è‡ªç„¶çš„æ²Ÿé€šã€‚</div>
                    </div>
                </div>
                <div class="mode-option" data-mode="scene">
                    <div class="radio"></div>
                    <div class="content">
                        <div class="title">æƒ…æ™¯æ¨¡å¼</div>
                        <div class="desc">å¢åŠ åŠ¨ä½œã€ç¯å¢ƒç­‰æå†™ï¼Œå…±åŒåˆ›ä½œæ•…äº‹ã€‚</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== 5. å£çº¸è®¾ç½®é¡µé¢ï¼ˆä¿®å¤ç‰ˆï¼‰ ==================== -->
    <div class="page" id="wallpaperPage">
        <div class="page-content">
            <div class="wallpaper-header">
                <button class="wallpaper-back" onclick="goPage('homePage')">â† è¿”å›</button>
                <div class="wallpaper-title">å£çº¸è®¾ç½®</div>
            </div>

            <div class="target-page">
                <span>åº”ç”¨åˆ°ï¼š</span>
                <button data-page="lockScreen" class="active">é”å±</button>
                <button data-page="homePage">ä¸»é¡µ</button>
                <button data-page="tavernPage">é…’é¦†</button>
                <button data-page="wechatPage">å¾®ä¿¡</button>
            </div>

            <div class="wallpaper-upload">
                <input type="file" id="wallFile" accept="image/*,video/mp4,video/webm">
                <button onclick="uploadWallpaper()">æœ¬åœ°ä¸Šä¼ </button>
            </div>
            <div class="wallpaper-tips">æ”¯æŒæ ¼å¼ï¼šjpg/png/gifï¼ˆå›¾ç‰‡ï¼‰ã€mp4/webmï¼ˆè§†é¢‘ï¼‰</div>
            
            <div class="wallpaper-upload">
                <input type="text" id="wallUrl" placeholder="è¾“å…¥å›¾ç‰‡/è§†é¢‘URLï¼ˆæ”¯æŒhttp/httpsï¼‰">
                <button onclick="importWallpaper()">URLå¯¼å…¥</button>
            </div>
            <div class="wallpaper-tips">ç¤ºä¾‹ï¼šhttps://picsum.photos/400/800 æˆ– è§†é¢‘MP4é“¾æ¥</div>

            <div class="wallpaper-list" id="wallList"></div>
        </div>
    </div>

    <script>
        // ==================== å…¨å±€å¸¸é‡/å˜é‡ ====================
        const ALL_PAGES = ["lockScreen","homePage","tavernPage","wechatPage","wallpaperPage"];
        const BACKEND_URL = "https://ai-phone-six.vercel.app/api/chat";
        let currentSetPage = "lockScreen";
        let wallpaperConfig = {};
        
        // å¹³å°ä¸æ¨¡å‹çš„æ˜ å°„å…³ç³»ï¼ˆæ¢å¤åŸé€»è¾‘ï¼‰
        const platformModels = {
            'openai': ['gpt-3.5-turbo', 'gpt-4', 'gpt-4-turbo'],
            'doubao': ['doubao-pro', 'doubao-4k', 'doubao-32k'],
            'deepseek': ['deepseek-chat', 'deepseek-coder'],
            'openrouter': ['openrouter/auto', 'anthropic/claude-3-sonnet'],
            'custom-openai': []
        };
        // AIé…ç½®å¯¹è±¡ï¼ˆæ¢å¤åŸé€»è¾‘ï¼‰
        let currentConfig = {
            name: 'APIè¿æ¥ 18',
            platform: 'openai',
            apiUrl: '',
            apiKey: '',
            model: 'gpt-3.5-turbo'
        };

        // ==================== é¡µé¢åˆ‡æ¢æ ¸å¿ƒé€»è¾‘ ====================
        function goPage(pageId) {
            try {
                // éšè—æ‰€æœ‰é¡µé¢
                ALL_PAGES.forEach(p => {
                    document.getElementById(p).classList.remove("active");
                });
                // æ˜¾ç¤ºç›®æ ‡é¡µé¢
                const targetPage = document.getElementById(pageId);
                targetPage.classList.add("active");
                // æ¸²æŸ“ç›®æ ‡é¡µé¢çš„å£çº¸
                renderPageWallpaper(pageId);
            } catch (error) {
                console.error("é¡µé¢åˆ‡æ¢å¤±è´¥ï¼š", error);
                alert(`åˆ‡æ¢é¡µé¢å‡ºé”™ï¼š${error.message}`);
            }
        }

        // ==================== é”å±æ—¶é—´æ›´æ–° ====================
        function updateLockTime() {
            try {
                const now = new Date();
                document.getElementById('lockTime').innerText = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                document.getElementById('lockDate').innerText = now.toLocaleDateString();
            } catch (error) {
                console.error("æ›´æ–°é”å±æ—¶é—´å¤±è´¥ï¼š", error);
            }
        }

        // ==================== å£çº¸æ ¸å¿ƒåŠŸèƒ½ï¼ˆå®Œæ•´ä¿®å¤ï¼‰ ====================
        // åˆå§‹åŒ–å£çº¸é…ç½®
        function initWallpaperConfig() {
            try {
                const savedConfig = localStorage.getItem("wallpaperConfig");
                if (savedConfig) {
                    wallpaperConfig = JSON.parse(savedConfig);
                } else {
                    // é»˜è®¤å£çº¸é…ç½®
                    wallpaperConfig = {
                        lockScreen: {type:"static", url:"https://picsum.photos/seed/pink1/400/800.jpg"},
                        homePage: {type:"static", url:"https://picsum.photos/seed/pink2/400/800.jpg"},
                        tavernPage: {type:"static", url:"https://picsum.photos/seed/tavern/400/800.jpg"},
                        wechatPage: {type:"static", url:"https://picsum.photos/seed/wechat/400/800.jpg"}
                    };
                    localStorage.setItem("wallpaperConfig", JSON.stringify(wallpaperConfig));
                }
            } catch (error) {
                console.error("åˆå§‹åŒ–å£çº¸é…ç½®å¤±è´¥ï¼š", error);
                alert(`å£çº¸é…ç½®åˆå§‹åŒ–å‡ºé”™ï¼š${error.message}`);
            }
        }

        // é€‰æ‹©è¦è®¾ç½®çš„é¡µé¢ï¼ˆä¿®å¤é€‰ä¸­é€»è¾‘ï¼‰
        function initTargetPageButtons() {
            try {
                const buttons = document.querySelectorAll(".target-page button");
                buttons.forEach(btn => {
                    btn.addEventListener('click', function() {
                        buttons.forEach(b => b.classList.remove("active"));
                        this.classList.add("active");
                        currentSetPage = this.dataset.page;
                        // é«˜äº®å½“å‰é¡µé¢çš„å£çº¸
                        highlightCurrentWallpaper();
                    });
                });
            } catch (error) {
                console.error("åˆå§‹åŒ–ç›®æ ‡é¡µé¢æŒ‰é’®å¤±è´¥ï¼š", error);
            }
        }

        // æ¸²æŸ“é¡µé¢å£çº¸ï¼ˆä¿®å¤è§†é¢‘æ¸²æŸ“ã€å±‚çº§ã€é‡å¤åˆ›å»ºé—®é¢˜ï¼‰
        function renderPageWallpaper(pageId) {
            try {
                const page = document.getElementById(pageId);
                const wall = wallpaperConfig[pageId] || wallpaperConfig.lockScreen;
                
                // æ¸…é™¤æ—§å£çº¸å±‚
                const oldBgElements = page.querySelectorAll(".page-bg");
                oldBgElements.forEach(el => el.remove());

                // åˆ›å»ºæ–°å£çº¸å±‚
                if (wall.type === "static" || wall.type === "dynamic") {
                    // é™æ€/GIFå£çº¸
                    const bgDiv = document.createElement("div");
                    bgDiv.className = "page-bg";
                    bgDiv.style.backgroundImage = `url(${wall.url})`;
                    bgDiv.style.backgroundSize = "cover";
                    bgDiv.style.backgroundPosition = "center";
                    bgDiv.style.backgroundRepeat = "no-repeat";
                    page.insertBefore(bgDiv, page.firstChild);
                } else if (wall.type === "video") {
                    // è§†é¢‘å£çº¸ï¼ˆä¿®å¤è‡ªåŠ¨æ’­æ”¾ã€é‡å¤åˆ›å»ºï¼‰
                    const video = document.createElement("video");
                    video.className = "page-bg";
                    video.src = wall.url;
                    video.autoplay = true;
                    video.loop = true;
                    video.muted = true;
                    video.playsInline = true;
                    video.style.objectFit = "cover";
                    // å…¼å®¹ç”¨æˆ·äº¤äº’åæ’­æ”¾
                    video.addEventListener('loadeddata', () => {
                        if (video.paused) {
                            video.play().catch(err => {
                                console.warn("è§†é¢‘è‡ªåŠ¨æ’­æ”¾å¤±è´¥ï¼Œéœ€ç”¨æˆ·äº¤äº’ï¼š", err);
                                alert("è§†é¢‘å£çº¸éœ€ç‚¹å‡»åæ’­æ”¾ï¼Œè¯·ç‚¹å‡»å£çº¸åŒºåŸŸ");
                                video.addEventListener('click', () => video.play(), { once: true });
                            });
                        }
                    });
                    page.insertBefore(video, page.firstChild);
                }
            } catch (error) {
                console.error(`æ¸²æŸ“${pageId}å£çº¸å¤±è´¥ï¼š`, error);
            }
        }

        // åº”ç”¨å£çº¸ï¼ˆä¿®å¤å­˜å‚¨ã€åé¦ˆï¼‰
        function applyWallpaper(type, url) {
            try {
                wallpaperConfig[currentSetPage] = {type, url};
                localStorage.setItem("wallpaperConfig", JSON.stringify(wallpaperConfig));
                // é‡æ–°æ¸²æŸ“å½“å‰é¡µé¢å£çº¸
                renderPageWallpaper(currentSetPage);
                // æ›´æ–°å£çº¸åˆ—è¡¨é«˜äº®
                highlightCurrentWallpaper();
                alert(`âœ… å£çº¸å·²åº”ç”¨åˆ°ã€${getPageName(currentSetPage)}ã€‘`);
            } catch (error) {
                console.error("åº”ç”¨å£çº¸å¤±è´¥ï¼š", error);
                alert(`âŒ åº”ç”¨å£çº¸å‡ºé”™ï¼š${error.message}`);
            }
        }

        // æœ¬åœ°ä¸Šä¼ å£çº¸ï¼ˆä¿®å¤ç±»å‹åˆ¤æ–­ã€å¼‚å¸¸æ•è·ï¼‰
        function uploadWallpaper() {
            try {
                const fileInput = document.getElementById("wallFile");
                const file = fileInput.files[0];
                
                if (!file) {
                    alert("è¯·å…ˆé€‰æ‹©è¦ä¸Šä¼ çš„å›¾ç‰‡/è§†é¢‘æ–‡ä»¶");
                    return;
                }

                // æ ¡éªŒæ–‡ä»¶ç±»å‹
                const fileType = file.type;
                let wallType = "";
                if (fileType.startsWith("image/")) {
                    wallType = fileType.includes("gif") ? "dynamic" : "static";
                } else if (fileType.startsWith("video/")) {
                    if (!["video/mp4", "video/webm"].includes(fileType)) {
                        alert("ä»…æ”¯æŒmp4/webmæ ¼å¼çš„è§†é¢‘");
                        return;
                    }
                    wallType = "video";
                } else {
                    alert("ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹ï¼Œä»…æ”¯æŒå›¾ç‰‡(jpg/png/gif)å’Œè§†é¢‘(mp4/webm)");
                    return;
                }

                // è¯»å–æ–‡ä»¶
                const reader = new FileReader();
                reader.onload = function(e) {
                    applyWallpaper(wallType, e.target.result);
                    // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
                    fileInput.value = "";
                    // æ·»åŠ åˆ°å£çº¸åˆ—è¡¨
                    addWallpaperToGallery(e.target.result, wallType);
                };
                reader.onerror = function() {
                    alert("âŒ æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•");
                    console.error("æ–‡ä»¶è¯»å–é”™è¯¯ï¼š", reader.error);
                };

                // æ ¹æ®æ–‡ä»¶ç±»å‹é€‰æ‹©è¯»å–æ–¹å¼
                if (wallType === "video") {
                    reader.readAsDataURL(file);
                } else {
                    reader.readAsDataURL(file);
                }
            } catch (error) {
                console.error("ä¸Šä¼ å£çº¸å¤±è´¥ï¼š", error);
                alert(`âŒ ä¸Šä¼ å£çº¸å‡ºé”™ï¼š${error.message}`);
            }
        }

        // URLå¯¼å…¥å£çº¸ï¼ˆä¿®å¤æ ¡éªŒã€ç±»å‹åˆ¤æ–­ï¼‰
        function importWallpaper() {
            try {
                const urlInput = document.getElementById("wallUrl");
                let url = urlInput.value.trim();
                
                if (!url) {
                    alert("è¯·è¾“å…¥æœ‰æ•ˆçš„å›¾ç‰‡/è§†é¢‘URL");
                    return;
                }

                // åŸºç¡€URLæ ¡éªŒ
                if (!url.startsWith("http://") && !url.startsWith("https://")) {
                    alert("URLå¿…é¡»ä»¥http://æˆ–https://å¼€å¤´");
                    return;
                }

                // åˆ¤æ–­ç±»å‹
                let wallType = "static";
                if (url.match(/\.(mp4|webm)(\?.*)?$/i)) {
                    wallType = "video";
                } else if (url.match(/\.(gif)(\?.*)?$/i)) {
                    wallType = "dynamic";
                }

                // éªŒè¯URLå¯è®¿é—®æ€§ï¼ˆç®€å•æ£€æŸ¥ï¼‰
                applyWallpaper(wallType, url);
                // æ¸…ç©ºè¾“å…¥
                urlInput.value = "";
                // æ·»åŠ åˆ°å£çº¸åˆ—è¡¨
                addWallpaperToGallery(url, wallType);
            } catch (error) {
                console.error("å¯¼å…¥å£çº¸å¤±è´¥ï¼š", error);
                alert(`âŒ å¯¼å…¥å£çº¸å‡ºé”™ï¼š${error.message}`);
            }
        }

        // åŠ è½½ç¤ºä¾‹å£çº¸åˆ—è¡¨ï¼ˆä¿®å¤ç‚¹å‡»äº‹ä»¶ï¼‰
        function loadWallpaperGallery() {
            try {
                const gallery = [
                    {url: "https://picsum.photos/seed/wall1/400/800.jpg", type: "static"},
                    {url: "https://picsum.photos/seed/wall2/400/800.jpg", type: "static"},
                    {url: "https://picsum.photos/seed/wall3/400/800.jpg", type: "static"},
                    {url: "https://gif.52112.com/2022/08/10/202208101527078402.gif", type: "dynamic"},
                    {url: "https://test-videos.co.uk/vids/bigbuckbunny/mp4/h264/720/Big_Buck_Bunny_720_10s_1MB.mp4", type: "video"}
                ];

                const listContainer = document.getElementById("wallList");
                listContainer.innerHTML = "";

                // æ·»åŠ ç”¨æˆ·å·²ä¿å­˜çš„å£çº¸
                Object.values(wallpaperConfig).forEach(wall => {
                    if (!gallery.some(g => g.url === wall.url)) {
                        gallery.push(wall);
                    }
                });

                // æ¸²æŸ“åˆ—è¡¨
                gallery.forEach(item => {
                    const itemDiv = document.createElement("div");
                    itemDiv.className = "wallpaper-item";
                    itemDiv.dataset.url = item.url;
                    itemDiv.dataset.type = item.type;
                    
                    // è®¾ç½®é¢„è§ˆå›¾
                    if (item.type === "video") {
                        // è§†é¢‘æ˜¾ç¤ºå°é¢
                        itemDiv.style.backgroundImage = "url(https://picsum.photos/seed/video/400/800.jpg)";
                        // æ·»åŠ è§†é¢‘æ ‡è¯†
                        const badge = document.createElement("div");
                        badge.style.position = "absolute";
                        badge.style.bottom = "5px";
                        badge.style.right = "5px";
                        badge.style.background = "rgba(0,0,0,0.7)";
                        badge.style.padding = "2px 5px";
                        badge.style.borderRadius = "5px";
                        badge.style.fontSize = "10px";
                        badge.innerText = "è§†é¢‘";
                        itemDiv.appendChild(badge);
                    } else {
                        itemDiv.style.backgroundImage = `url(${item.url})`;
                    }

                    // ç‚¹å‡»åº”ç”¨å£çº¸
                    itemDiv.addEventListener('click', function() {
                        applyWallpaper(this.dataset.type, this.dataset.url);
                    });

                    listContainer.appendChild(itemDiv);
                });

                // é«˜äº®å½“å‰é¡µé¢çš„å£çº¸
                highlightCurrentWallpaper();
            } catch (error) {
                console.error("åŠ è½½å£çº¸åˆ—è¡¨å¤±è´¥ï¼š", error);
            }
        }

        // é«˜äº®å½“å‰é¡µé¢çš„å£çº¸
        function highlightCurrentWallpaper() {
            try {
                const currentWallUrl = wallpaperConfig[currentSetPage]?.url;
                const allItems = document.querySelectorAll(".wallpaper-item");
                allItems.forEach(item => {
                    if (item.dataset.url === currentWallUrl) {
                        item.classList.add("selected");
                    } else {
                        item.classList.remove("selected");
                    }
                });
            } catch (error) {
                console.error("é«˜äº®å£çº¸å¤±è´¥ï¼š", error);
            }
        }

        // æ·»åŠ å£çº¸åˆ°ç”»å»Š
        function addWallpaperToGallery(url, type) {
            try {
                const listContainer = document.getElementById("wallList");
                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                const exists = Array.from(listContainer.querySelectorAll(".wallpaper-item"))
                    .some(item => item.dataset.url === url);
                
                if (!exists) {
                    const itemDiv = document.createElement("div");
                    itemDiv.className = "wallpaper-item";
                    itemDiv.dataset.url = url;
                    itemDiv.dataset.type = type;
                    
                    if (type === "video") {
                        itemDiv.style.backgroundImage = "url(https://picsum.photos/seed/video/400/800.jpg)";
                        const badge = document.createElement("div");
                        badge.style.position = "absolute";
                        badge.style.bottom = "5px";
                        badge.style.right = "5px";
                        badge.style.background = "rgba(0,0,0,0.7)";
                        badge.style.padding = "2px 5px";
                        badge.style.borderRadius = "5px";
                        badge.style.fontSize = "10px";
                        badge.innerText = "è§†é¢‘";
                        itemDiv.appendChild(badge);
                    } else {
                        itemDiv.style.backgroundImage = `url(${url})`;
                    }

                    itemDiv.addEventListener('click', function() {
                        applyWallpaper(this.dataset.type, this.dataset.url);
                    });

                    listContainer.insertBefore(itemDiv, listContainer.firstChild);
                }
            } catch (error) {
                console.error("æ·»åŠ å£çº¸åˆ°ç”»å»Šå¤±è´¥ï¼š", error);
            }
        }

        // è·å–é¡µé¢åç§°ï¼ˆç”¨äºæç¤ºï¼‰
        function getPageName(pageId) {
            const pageNames = {
                lockScreen: "é”å±",
                homePage: "ä¸»é¡µ",
                tavernPage: "é…’é¦†",
                wechatPage: "å¾®ä¿¡"
            };
            return pageNames[pageId] || pageId;
        }

        // ==================== AIåŠŸèƒ½å®Œæ•´æ¢å¤ï¼ˆé…’é¦†æ¨¡å—ï¼‰ ====================
        // åˆå§‹åŒ–AIé…ç½®
        function initAIConfig() {
            try {
                // åŠ è½½ä¿å­˜çš„é…ç½®
                if (localStorage.getItem('aiPhoneConfig')) {
                    currentConfig = JSON.parse(localStorage.getItem('aiPhoneConfig'));
                    document.getElementById('configName').value = currentConfig.name;
                    document.getElementById('platformSelect').value = currentConfig.platform;
                    document.getElementById('apiUrlInput').value = currentConfig.apiUrl;
                    document.getElementById('apiKeyInput').value = currentConfig.apiKey;
                }
                
                // æ›´æ–°æ¨¡å‹åˆ—è¡¨å’ŒAPIåœ°å€æ˜¾ç¤º
                updateModelList();
                toggleApiUrlVisibility();
                
                // ç»‘å®šäº‹ä»¶
                document.getElementById('platformSelect').addEventListener('change', function() {
                    updateModelList();
                    toggleApiUrlVisibility();
                });
                document.getElementById('fetchModelsBtn').addEventListener('click', fetchModels);
                document.getElementById('testConnectionBtn').addEventListener('click', testConnection);
                document.getElementById('saveConfigBtn').addEventListener('click', saveAIConfig);
                document.getElementById('closeConfigBtn').addEventListener('click', toggleConfigPanel);
                document.getElementById('configToggle').addEventListener('click', toggleConfigPanel);
                document.getElementById('sendBtn').addEventListener('click', sendMessage);
                document.getElementById('userInput').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') sendMessage();
                });
            } catch (error) {
                console.error("åˆå§‹åŒ–AIé…ç½®å¤±è´¥ï¼š", error);
                alert(`AIåŠŸèƒ½åˆå§‹åŒ–å‡ºé”™ï¼š${error.message}`);
            }
        }

        // åˆ‡æ¢é…ç½®é¢æ¿
        function toggleConfigPanel() {
            try {
                document.getElementById('configPanel').classList.toggle('active');
            } catch (error) {
                console.error("åˆ‡æ¢é…ç½®é¢æ¿å¤±è´¥ï¼š", error);
            }
        }

        // åˆ‡æ¢APIåœ°å€è¾“å…¥æ¡†å¯è§æ€§
        function toggleApiUrlVisibility() {
            try {
                const platform = document.getElementById('platformSelect').value;
                const apiUrlItem = document.getElementById('apiUrlItem');
                const fetchBtn = document.getElementById('fetchModelsBtn');
                const testBtn = document.getElementById('testConnectionBtn');
                
                if (platform === 'custom-openai') {
                    apiUrlItem.style.display = 'block';
                    fetchBtn.style.display = 'block';
                    testBtn.style.display = 'block';
                } else {
                    apiUrlItem.style.display = 'none';
                    fetchBtn.style.display = 'none';
                    testBtn.style.display = 'none';
                }
            } catch (error) {
                console.error("åˆ‡æ¢APIåœ°å€æ˜¾ç¤ºå¤±è´¥ï¼š", error);
            }
        }

        // æ›´æ–°æ¨¡å‹åˆ—è¡¨
        function updateModelList() {
            try {
                const platform = document.getElementById('platformSelect').value;
                const models = platformModels[platform] || [];
                const modelSelect = document.getElementById('modelSelect');
                
                modelSelect.innerHTML = '';
                if (models.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'è¯·å…ˆæ‹‰å–æ¨¡å‹';
                    modelSelect.appendChild(option);
                } else {
                    models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model;
                        if (model === currentConfig.model) {
                            option.selected = true;
                        }
                        modelSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error("æ›´æ–°æ¨¡å‹åˆ—è¡¨å¤±è´¥ï¼š", error);
            }
        }

        // ä¿å­˜AIé…ç½®
        function saveAIConfig() {
            try {
                currentConfig = {
                    name: document.getElementById('configName').value,
                    platform: document.getElementById('platformSelect').value,
                    apiUrl: document.getElementById('apiUrlInput').value,
                    apiKey: document.getElementById('apiKeyInput').value,
                    model: document.getElementById('modelSelect').value
                };
                localStorage.setItem('aiPhoneConfig', JSON.stringify(currentConfig));
                toggleConfigPanel();
                addAIMessage('âœ… é…ç½®å·²ä¿å­˜', false);
            } catch (error) {
                console.error("ä¿å­˜AIé…ç½®å¤±è´¥ï¼š", error);
                addAIMessage(`âŒ ä¿å­˜é…ç½®å‡ºé”™ï¼š${error.message}`, false);
            }
        }

        // æ·»åŠ AIæ¶ˆæ¯
        function addAIMessage(text, isUser) {
            try {
                const screen = document.getElementById('screen');
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${isUser ? 'user-msg' : 'ai-msg'}`;
                messageDiv.textContent = text;
                screen.appendChild(messageDiv);
                screen.scrollTop = screen.scrollHeight;
            } catch (error) {
                console.error("æ·»åŠ æ¶ˆæ¯å¤±è´¥ï¼š", error);
            }
        }

        // æ‹‰å–æ¨¡å‹ï¼ˆæ¢å¤ç›´è¿+è½¬å‘é€»è¾‘ï¼‰
        async function fetchModels() {
            try {
                const apiUrl = document.getElementById('apiUrlInput').value.trim();
                const apiKey = document.getElementById('apiKeyInput').value.trim();
                
                if (!apiUrl || !apiKey) {
                    addAIMessage('âŒ è¯·å…ˆå¡«å†™APIæ¥å£åœ°å€å’Œå¯†é’¥', false);
                    return;
                }

                addAIMessage('ğŸ”„ æ­£åœ¨æ‹‰å–æ¨¡å‹åˆ—è¡¨(ç›´è¿)...', false);
                
                // ç¬¬ä¸€æ­¥ï¼šå°è¯•ç›´è¿
                try {
                    const response = await fetch(`${apiUrl}/models`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`ç›´è¿å¤±è´¥: HTTP ${response.status}`);
                    }

                    const data = await response.json();
                    const models = data.data || [];
                    
                    if (models.length === 0) {
                        addAIMessage('âŒ æœªè·å–åˆ°ä»»ä½•æ¨¡å‹', false);
                        return;
                    }

                    platformModels['custom-openai'] = models.map(m => m.id);
                    updateModelList();
                    document.getElementById('modelSelect').value = models[0].id;
                    addAIMessage(`âœ… ç›´è¿æˆåŠŸï¼æ‹‰å–åˆ° ${models.length} ä¸ªæ¨¡å‹`, false);
                } catch (directError) {
                    // ç¬¬äºŒæ­¥ï¼šç›´è¿å¤±è´¥ï¼Œèµ°åç«¯è½¬å‘
                    addAIMessage(`âš ï¸ ç›´è¿å¤±è´¥(${directError.message})ï¼Œå°è¯•åç«¯è½¬å‘...`, false);
                    
                    const forwardResponse = await fetch(BACKEND_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            platform: 'custom-openai',
                            apiUrl: apiUrl,
                            action: 'fetchModels'
                        })
                    });

                    if (!forwardResponse.ok) {
                        throw new Error(`è½¬å‘å¤±è´¥: HTTP ${forwardResponse.status}`);
                    }

                    const data = await forwardResponse.json();
                    const models = data.data || [];
                    
                    if (models.length === 0) {
                        addAIMessage('âŒ è½¬å‘æ‹‰å–ï¼šæœªè·å–åˆ°ä»»ä½•æ¨¡å‹', false);
                        return;
                    }

                    platformModels['custom-openai'] = models.map(m => m.id);
                    updateModelList();
                    document.getElementById('modelSelect').value = models[0].id;
                    addAIMessage(`âœ… è½¬å‘æˆåŠŸï¼æ‹‰å–åˆ° ${models.length} ä¸ªæ¨¡å‹`, false);
                }
            } catch (error) {
                console.error("æ‹‰å–æ¨¡å‹å¤±è´¥ï¼š", error);
                addAIMessage(`âŒ æ‹‰å–æ¨¡å‹å¤±è´¥ï¼š${error.message}`, false);
            }
        }

        // æµ‹è¯•é“¾æ¥ï¼ˆæ¢å¤ç›´è¿+è½¬å‘é€»è¾‘ï¼‰
        async function testConnection() {
            try {
                const apiUrl = document.getElementById('apiUrlInput').value.trim();
                const apiKey = document.getElementById('apiKeyInput').value.trim();
                
                if (!apiUrl || !apiKey) {
                    addAIMessage('âŒ è¯·å…ˆå¡«å†™APIæ¥å£åœ°å€å’Œå¯†é’¥', false);
                    return;
                }

                addAIMessage('ğŸ”„ æ­£åœ¨æµ‹è¯•é“¾æ¥(ç›´è¿)...', false);
                
                // ç¬¬ä¸€æ­¥ï¼šå°è¯•ç›´è¿
                try {
                    const response = await fetch(`${apiUrl}/models`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        addAIMessage('âœ… ç›´è¿æˆåŠŸï¼é“¾æ¥æœ‰æ•ˆ', false);
                    } else {
                        throw new Error(`ç›´è¿å¤±è´¥: HTTP ${response.status}`);
                    }
                } catch (directError) {
                    // ç¬¬äºŒæ­¥ï¼šç›´è¿å¤±è´¥ï¼Œèµ°åç«¯è½¬å‘
                    addAIMessage(`âš ï¸ ç›´è¿å¤±è´¥(${directError.message})ï¼Œå°è¯•åç«¯è½¬å‘...`, false);
                    
                    const forwardResponse = await fetch(BACKEND_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            platform: 'custom-openai',
                            apiUrl: apiUrl,
                            action: 'testConnection'
                        })
                    });

                    if (forwardResponse.ok) {
                        addAIMessage('âœ… è½¬å‘æˆåŠŸï¼é“¾æ¥æœ‰æ•ˆ', false);
                    } else {
                        throw new Error(`è½¬å‘å¤±è´¥: HTTP ${forwardResponse.status}`);
                    }
                }
            } catch (error) {
                console.error("æµ‹è¯•é“¾æ¥å¤±è´¥ï¼š", error);
                addAIMessage(`âŒ è¿æ¥å¤±è´¥ï¼š${error.message}`, false);
            }
        }

        // å‘é€æ¶ˆæ¯ï¼ˆæ¢å¤ç›´è¿+è½¬å‘é€»è¾‘ï¼‰
        async function sendMessage() {
            try {
                const text = document.getElementById('userInput').value.trim();
                if (!text) return;
                
                // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
                addAIMessage(text, true);
                document.getElementById('userInput').value = '';

                const platform = currentConfig.platform;
                const apiKey = currentConfig.apiKey;
                const model = currentConfig.model;
                
                if (!apiKey || !model) {
                    addAIMessage('âŒ è¯·å…ˆé…ç½®APIå¯†é’¥å’Œæ¨¡å‹', false);
                    return;
                }

                // è‡ªå®šä¹‰OpenAIå¹³å°ï¼šç›´è¿ä¼˜å…ˆ
                if (platform === 'custom-openai') {
                    const apiUrl = currentConfig.apiUrl;
                    if (!apiUrl) {
                        addAIMessage('âŒ è¯·å…ˆå¡«å†™è‡ªå®šä¹‰APIæ¥å£åœ°å€', false);
                        return;
                    }

                    try {
                        // ç›´è¿è¯·æ±‚
                        const response = await fetch(`${apiUrl}/chat/completions`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${apiKey}`
                            },
                            body: JSON.stringify({
                                model: model,
                                messages: [{ role: 'user', content: text }]
                            })
                        });

                        if (!response.ok) {
                            throw new Error(`ç›´è¿å¤±è´¥: HTTP ${response.status}`);
                        }

                        const data = await response.json();
                        const reply = data.choices?.[0]?.message?.content || 'å›å¤å¤±è´¥';
                        addAIMessage(reply, false);
                    } catch (directError) {
                        // ç›´è¿å¤±è´¥ï¼Œèµ°åç«¯è½¬å‘
                        addAIMessage(`âš ï¸ ç›´è¿å‘é€å¤±è´¥(${directError.message})ï¼Œå°è¯•åç«¯è½¬å‘...`, false);
                        
                        const forwardResponse = await fetch(BACKEND_URL, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${apiKey}`
                            },
                            body: JSON.stringify({
                                platform: 'custom-openai',
                                apiUrl: apiUrl,
                                apiKey: apiKey,
                                model: model,
                                messages: [{ role: 'user', content: text }]
                            })
                        });

                        if (!forwardResponse.ok) {
                            throw new Error(`è½¬å‘å¤±è´¥: HTTP ${forwardResponse.status}`);
                        }

                        const data = await forwardResponse.json();
                        const reply = data.choices?.[0]?.message?.content || 'å›å¤å¤±è´¥';
                        addAIMessage(reply, false);
                    }
                } else {
                    // å…¶ä»–å¹³å°ï¼šèµ°åç«¯è½¬å‘
                    const response = await fetch(BACKEND_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            platform: platform,
                            apiKey: apiKey,
                            model: model,
                            messages: [{ role: 'user', content: text }]
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    const reply = data.choices?.[0]?.message?.content || 'å›å¤å¤±è´¥';
                    addAIMessage(reply, false);
                }
            } catch (error) {
                console.error("å‘é€æ¶ˆæ¯å¤±è´¥ï¼š", error);
                addAIMessage(`âŒ å‘é€å¤±è´¥: ${error.message}`, false);
            }
        }

        // ==================== å¾®ä¿¡æ¨¡å—åŠŸèƒ½ ====================
        // å…¨å±€å˜é‡
        let wechatRoles = [];
        let currentChatRole = null;
        let moments = [];
        let wechatSettings = {};
        const API_BASE_URL = 'https://ai-phone.vercel.app/api/handler'; // åç«¯éƒ¨ç½²åœ°å€ï¼Œéœ€è¦æ ¹æ®å®é™…éƒ¨ç½²æƒ…å†µä¿®æ”¹
        
        // åˆå§‹åŒ–å¾®ä¿¡æ¨¡å—
        async function initWechat() {
            try {
                // åŠ è½½è§’è‰²æ•°æ®
                loadWechatRoles();
                // åŠ è½½è®¾ç½®æ•°æ®
                loadWechatSettings();
                // æ¸²æŸ“æ¶ˆæ¯åˆ—è¡¨
                renderMessageList();
                // åˆå§‹åŒ–èŠå¤©æ¶ˆæ¯
                initChatMessages();
                
                // è°ƒç”¨APIè·å–æœ‹å‹åœˆåˆ—è¡¨
                try {
                    await fetchMomentsFromAPI();
                } catch (error) {
                    console.error("è·å–æœ‹å‹åœˆæ•°æ®å¤±è´¥ï¼š", error);
                    // å¤±è´¥æ—¶ä½¿ç”¨æœ¬åœ°å­˜å‚¨ä½œä¸ºåå¤‡
                    loadMoments();
                }
                // æ¸²æŸ“æœ‹å‹åœˆåˆ—è¡¨
                renderMomentsList();
            } catch (error) {
                console.error("åˆå§‹åŒ–å¾®ä¿¡æ¨¡å—å¤±è´¥ï¼š", error);
            }
        }
        
        // åŠ è½½å¾®ä¿¡è§’è‰²æ•°æ®
        function loadWechatRoles() {
            try {
                const savedRoles = localStorage.getItem('wechatRoles');
                if (savedRoles) {
                    wechatRoles = JSON.parse(savedRoles);
                } else {
                    // é»˜è®¤è§’è‰²æ•°æ®
                    wechatRoles = [];
                    localStorage.setItem('wechatRoles', JSON.stringify(wechatRoles));
                }
                // æ£€æŸ¥è§’è‰²æ•°é‡ï¼Œæ˜¾ç¤ºå¯¹åº”è§†å›¾
                checkRolesCount();
            } catch (error) {
                console.error("åŠ è½½å¾®ä¿¡è§’è‰²å¤±è´¥ï¼š", error);
            }
        }
        
        // æ£€æŸ¥è§’è‰²æ•°é‡ï¼Œæ˜¾ç¤ºå¯¹åº”è§†å›¾
        function checkRolesCount() {
            try {
                const messageListView = document.getElementById('messageListView');
                const noRolesView = document.getElementById('noRolesView');
                
                if (wechatRoles.length === 0) {
                    messageListView.classList.remove('active');
                    noRolesView.classList.add('active');
                } else {
                    messageListView.classList.add('active');
                    noRolesView.classList.remove('active');
                }
            } catch (error) {
                console.error("æ£€æŸ¥è§’è‰²æ•°é‡å¤±è´¥ï¼š", error);
            }
        }
        
        // åˆ‡æ¢å¾®ä¿¡æ ‡ç­¾
        function switchWechatTab(tab) {
            try {
                // éšè—æ‰€æœ‰æ ‡ç­¾è§†å›¾
                const tabViews = document.querySelectorAll('.wechat-tab-view');
                tabViews.forEach(view => view.classList.remove('active'));
                
                // éšè—æ‰€æœ‰å¯¼èˆªé¡¹çš„æ¿€æ´»çŠ¶æ€
                const navItems = document.querySelectorAll('.nav-item');
                navItems.forEach(item => item.classList.remove('active'));
                
                // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾è§†å›¾
                if (tab === 'chat') {
                    document.getElementById('chatTabView').classList.add('active');
                    navItems[0].classList.add('active');
                    checkRolesCount();
                } else if (tab === 'moments') {
                    document.getElementById('momentsTabView').classList.add('active');
                    navItems[1].classList.add('active');
                } else if (tab === 'profile') {
                    document.getElementById('profileTabView').classList.add('active');
                    navItems[2].classList.add('active');
                }
            } catch (error) {
                console.error("åˆ‡æ¢æ ‡ç­¾å¤±è´¥ï¼š", error);
            }
        }
        
        // åŠ è½½æœ‹å‹åœˆæ•°æ®
        function loadMoments() {
            try {
                const savedMoments = localStorage.getItem('wechatMoments');
                if (savedMoments) {
                    moments = JSON.parse(savedMoments);
                } else {
                    moments = [];
                    localStorage.setItem('wechatMoments', JSON.stringify(moments));
                }
            } catch (error) {
                console.error("åŠ è½½æœ‹å‹åœˆæ•°æ®å¤±è´¥ï¼š", error);
            }
        }
        
        // ä¿å­˜æœ‹å‹åœˆæ•°æ®
        function saveMoments() {
            try {
                localStorage.setItem('wechatMoments', JSON.stringify(moments));
            } catch (error) {
                console.error("ä¿å­˜æœ‹å‹åœˆæ•°æ®å¤±è´¥ï¼š", error);
            }
        }
        
        // æ¸²æŸ“æœ‹å‹åœˆåˆ—è¡¨
        function renderMomentsList() {
            try {
                const momentsList = document.getElementById('momentsList');
                momentsList.innerHTML = '';
                
                if (moments.length === 0) {
                    momentsList.innerHTML = `
                        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 20px;">
                            <div style="font-size: 60px; margin-bottom: 20px;">ğŸ˜</div>
                            <div style="font-size: 16px; color: #999; margin-bottom: 40px;">è¿™é‡Œä»€ä¹ˆéƒ½æ²¡æœ‰~</div>
                            <button class="publish-btn" onclick="showPublishView()">+ å‘å¸ƒç¬¬ä¸€æ¡å†…å®¹</button>
                        </div>
                    `;
                    return;
                }
                
                moments.forEach(moment => {
                    const momentItem = document.createElement('div');
                    momentItem.style.backgroundColor = 'white';
                    momentItem.style.borderRadius = '12px';
                    momentItem.style.padding = '16px';
                    momentItem.style.marginBottom = '16px';
                    momentItem.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';
                    
                    momentItem.innerHTML = `
                        <div style="display: flex; align-items: center; margin-bottom: 12px;">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background-color: #ff69b4; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-size: 16px;">ğŸ‘¤</div>
                            <div style="flex: 1;">
                                <div style="font-size: 14px; font-weight: 500; color: #333;">${moment.author}</div>
                                <div style="font-size: 12px; color: #999;">${moment.time}</div>
                            </div>
                        </div>
                        <div style="font-size: 14px; line-height: 1.5; color: #333; margin-bottom: 12px;">${moment.content}</div>
                        <div style="display: flex; align-items: center; justify-content: space-between; font-size: 14px; color: #999;">
                            <button style="background: none; border: none; color: #999; cursor: pointer;">ğŸ‘ ç‚¹èµ</button>
                            <button style="background: none; border: none; color: #999; cursor: pointer;">ğŸ’¬ è¯„è®º</button>
                            <button style="background: none; border: none; color: #999; cursor: pointer;">â†—ï¸ è½¬å‘</button>
                        </div>
                    `;
                    
                    momentsList.appendChild(momentItem);
                });
            } catch (error) {
                console.error("æ¸²æŸ“æœ‹å‹åœˆåˆ—è¡¨å¤±è´¥ï¼š", error);
            }
        }
        
        // æ˜¾ç¤ºå‘å¸ƒè§†å›¾
        function showPublishView() {
            try {
                document.getElementById('publishView').style.display = 'flex';
            } catch (error) {
                console.error("æ˜¾ç¤ºå‘å¸ƒè§†å›¾å¤±è´¥ï¼š", error);
            }
        }
        
        // å–æ¶ˆå‘å¸ƒ
        function cancelPublish() {
            try {
                document.getElementById('publishView').style.display = 'none';
                document.getElementById('momentContent').value = '';
            } catch (error) {
                console.error("å–æ¶ˆå‘å¸ƒå¤±è´¥ï¼š", error);
            }
        }
        
        // æäº¤å‘å¸ƒ
        function submitPublish() {
            try {
                const content = document.getElementById('momentContent').value.trim();
                if (!content) {
                    alert('è¯·è¾“å…¥å†…å®¹');
                    return;
                }
                
                // è°ƒç”¨åç«¯APIå‘å¸ƒæœ‹å‹åœˆ
                publishMomentToAPI(content).then(() => {
                    cancelPublish();
                    alert('å‘å¸ƒæˆåŠŸ');
                    loadMoments();
                    renderMomentsList();
                }).catch(error => {
                    console.error("å‘å¸ƒå¤±è´¥ï¼š", error);
                    alert('å‘å¸ƒå¤±è´¥ï¼Œè¯·é‡è¯•');
                });
            } catch (error) {
                console.error("æäº¤å‘å¸ƒå¤±è´¥ï¼š", error);
                alert('å‘å¸ƒå¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        // å‘å¸ƒæœ‹å‹åœˆï¼ˆä½¿ç”¨æœ¬åœ°å­˜å‚¨ï¼‰
        async function publishMomentToAPI(content) {
            try {
                // ç”±äºåç«¯APIä¸»è¦ç”¨äºAIèŠå¤©ï¼Œæœ‹å‹åœˆåŠŸèƒ½ä½¿ç”¨æœ¬åœ°å­˜å‚¨
                const newMoment = {
                    id: Date.now().toString(),
                    author: 'æˆ‘',
                    content: content,
                    time: new Date().toLocaleString('zh-CN'),
                    likes: 0,
                    comments: []
                };
                moments.unshift(newMoment);
                saveMoments();
                return newMoment;
            } catch (error) {
                console.error("å‘å¸ƒæœ‹å‹åœˆå¤±è´¥ï¼š", error);
                const newMoment = {
                    id: Date.now().toString(),
                    author: 'æˆ‘',
                    content: content,
                    time: new Date().toLocaleString('zh-CN'),
                    likes: 0,
                    comments: []
                };
                moments.unshift(newMoment);
                saveMoments();
                return newMoment;
            }
        }
        
        // è·å–æœ‹å‹åœˆåˆ—è¡¨ï¼ˆä½¿ç”¨æœ¬åœ°å­˜å‚¨ï¼‰
        async function fetchMomentsFromAPI() {
            try {
                // ç”±äºåç«¯APIä¸»è¦ç”¨äºAIèŠå¤©ï¼Œæœ‹å‹åœˆåŠŸèƒ½ä½¿ç”¨æœ¬åœ°å­˜å‚¨
                loadMoments();
                return moments;
            } catch (error) {
                console.error("è·å–æœ‹å‹åœˆå¤±è´¥ï¼š", error);
                loadMoments();
                return moments;
            }
        }
        
        // è°ƒç”¨åç«¯APIè·å–AIå›å¤
        async function getAIResponse(message) {
            try {
                // è·å–AIé…ç½®
                const aiConfig = JSON.parse(localStorage.getItem('aiPhoneConfig') || '{}');
                const platform = aiConfig.platform || 'openai';
                const apiKey = aiConfig.apiKey || '';
                const model = aiConfig.model || 'gpt-3.5-turbo';
                const apiUrl = aiConfig.apiUrl || '';
                
                // æ£€æŸ¥APIå¯†é’¥æ˜¯å¦å­˜åœ¨
                if (!apiKey) {
                    throw new Error('ç¼ºå°‘APIå¯†é’¥ï¼Œè¯·åœ¨é…’é¦†é¡µé¢é…ç½®APIå¯†é’¥');
                }
                
                // æ„å»ºè¯·æ±‚ä½“
                const requestBody = {
                    platform: platform,
                    apiKey: apiKey,
                    model: model,
                    messages: [
                        {
                            role: 'system',
                            content: buildSystemPrompt()
                        },
                        {
                            role: 'user',
                            content: message
                        }
                    ],
                    apiUrl: apiUrl
                };
                
                // å‘é€è¯·æ±‚
                const response = await fetch(API_BASE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                return data.choices[0].message.content;
            } catch (error) {
                console.error("è·å–AIå›å¤APIè°ƒç”¨å¤±è´¥ï¼š", error);
                // å¤±è´¥æ—¶ä½¿ç”¨æ¨¡æ‹Ÿå›å¤ä½œä¸ºåå¤‡
                const replies = [
                    'ä½ å¥½ï¼',
                    'æˆ‘åœ¨å‘¢',
                    'æœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ çš„å—ï¼Ÿ',
                    'å¥½çš„ï¼Œæ²¡é—®é¢˜',
                    'å“ˆå“ˆå“ˆï¼Œæœ‰æ„æ€',
                    'æˆ‘ç†è§£ä½ çš„æ„æ€',
                    'è°¢è°¢ä½ çš„åˆ†äº«',
                    'æˆ‘ä¹Ÿè¿™ä¹ˆè§‰å¾—'
                ];
                return replies[Math.floor(Math.random() * replies.length)];
            }
        }
        
        // æ„å»ºç³»ç»Ÿæç¤º
        function buildSystemPrompt() {
            if (!currentChatRole) {
                return 'ä½ æ˜¯ä¸€ä¸ªå‹å¥½çš„AIåŠ©æ‰‹ï¼Œå–„äºèŠå¤©å’Œå¸®åŠ©ç”¨æˆ·ã€‚';
            }
            
            // æ„å»ºç³»ç»Ÿæç¤ºï¼ŒåŒ…å«è§’è‰²è®¾å®š
            let prompt = `ä½ æ˜¯${currentChatRole.nickname}ï¼Œ`;
            
            if (currentChatRole.relationship) {
                prompt += `ä¸ç”¨æˆ·æ˜¯${currentChatRole.relationship}å…³ç³»ï¼Œ`;
            }
            
            if (currentChatRole.personality) {
                prompt += `æ€§æ ¼${currentChatRole.personality}ï¼Œ`;
            }
            
            if (currentChatRole.worldview) {
                prompt += `ä¸–ç•Œè§‚ï¼š${currentChatRole.worldview}ï¼Œ`;
            }
            
            if (currentChatRole.experience) {
                prompt += `ç»å†ï¼š${currentChatRole.experience}ï¼Œ`;
            }
            
            if (currentChatRole.additionalInfo) {
                prompt += `è¡¥å……ä¿¡æ¯ï¼š${currentChatRole.additionalInfo}ã€‚`;
            }
            
            if (currentChatRole.taCallMe) {
                prompt += `ä½ ç§°å‘¼ç”¨æˆ·ä¸º${currentChatRole.taCallMe}ã€‚`;
            }
            
            prompt += 'è¯·ä»¥è‡ªç„¶ã€å‹å¥½çš„æ–¹å¼ä¸ç”¨æˆ·äº¤æµï¼Œä¿æŒç¬¦åˆè§’è‰²è®¾å®šçš„è¯­æ°”å’Œé£æ ¼ã€‚';
            
            return prompt;
        }
        
        // åŠ è½½å¾®ä¿¡è®¾ç½®æ•°æ®
        function loadWechatSettings() {
            try {
                const savedSettings = localStorage.getItem('wechatSettings');
                if (savedSettings) {
                    wechatSettings = JSON.parse(savedSettings);
                } else {
                    // é»˜è®¤è®¾ç½®
                    wechatSettings = {
                        voice: {
                            enabled: true,
                            type: 'default'
                        },
                        activeTalk: {
                            enabled: true,
                            frequency: 'medium'
                        },
                        theme: 'light',
                        bubble: {
                            own: 'default',
                            other: 'default'
                        },
                        aiModel: {
                            enabled: false,
                            platform: 'openai',
                            apiKey: '',
                            model: 'gpt-3.5-turbo'
                        },
                        apiConfig: {
                            enabled: false,
                            url: ''
                        }
                    };
                    localStorage.setItem('wechatSettings', JSON.stringify(wechatSettings));
                }
            } catch (error) {
                console.error("åŠ è½½å¾®ä¿¡è®¾ç½®å¤±è´¥ï¼š", error);
            }
        }
        
        // ä¿å­˜å¾®ä¿¡è®¾ç½®æ•°æ®
        function saveWechatSettings() {
            try {
                localStorage.setItem('wechatSettings', JSON.stringify(wechatSettings));
            } catch (error) {
                console.error("ä¿å­˜å¾®ä¿¡è®¾ç½®å¤±è´¥ï¼š", error);
            }
        }
        
        // ä¿å­˜å¾®ä¿¡è§’è‰²æ•°æ®
        function saveWechatRoles() {
            try {
                localStorage.setItem('wechatRoles', JSON.stringify(wechatRoles));
            } catch (error) {
                console.error("ä¿å­˜å¾®ä¿¡è§’è‰²å¤±è´¥ï¼š", error);
            }
        }
        
        // æ¸²æŸ“æ¶ˆæ¯åˆ—è¡¨
        function renderMessageList() {
            try {
                const messageList = document.getElementById('messageList');
                messageList.innerHTML = '';
                
                wechatRoles.forEach(role => {
                    const conversationItem = document.createElement('div');
                    conversationItem.className = 'conversation-item';
                    conversationItem.onclick = () => startChat(role);
                    
                    conversationItem.innerHTML = `
                        <div class="conversation-avatar">${role.avatar}</div>
                        <div class="conversation-info">
                            <div class="conversation-top">
                                <div class="conversation-name">${role.nickname}</div>
                                <div class="conversation-time">${role.lastTime}</div>
                            </div>
                            <div class="conversation-last">${role.lastMessage}</div>
                        </div>
                    `;
                    
                    messageList.appendChild(conversationItem);
                });
            } catch (error) {
                console.error("æ¸²æŸ“æ¶ˆæ¯åˆ—è¡¨å¤±è´¥ï¼š", error);
            }
        }
        
        // å¼€å§‹èŠå¤©
        function startChat(role) {
            try {
                currentChatRole = role;
                document.getElementById('chatName').textContent = role.nickname;
                
                // åˆ‡æ¢åˆ°èŠå¤©è§†å›¾
                switchWechatView('chatView');
            } catch (error) {
                console.error("å¼€å§‹èŠå¤©å¤±è´¥ï¼š", error);
            }
        }
        
        // åˆ‡æ¢å¾®ä¿¡è§†å›¾
        function switchWechatView(viewId) {
            try {
                const views = document.querySelectorAll('.wechat-view');
                views.forEach(view => view.classList.remove('active'));
                
                const targetView = document.getElementById(viewId);
                if (targetView) {
                    targetView.classList.add('active');
                }
            } catch (error) {
                console.error("åˆ‡æ¢å¾®ä¿¡è§†å›¾å¤±è´¥ï¼š", error);
            }
        }
        
        // åˆ‡æ¢åˆ°æ¶ˆæ¯åˆ—è¡¨
        function switchToMessageList() {
            switchWechatView('messageListView');
        }
        
        // æ˜¾ç¤ºè§’è‰²è®¾ç½®
        function showRoleSettings() {
            try {
                if (!currentChatRole) return;
                
                // å¡«å……è§’è‰²æ•°æ®åˆ°è¡¨å•
                document.getElementById('myNickname').value = currentChatRole.myNickname || 'ç™½æ³½Î±';
                document.getElementById('taCallMe').value = currentChatRole.taCallMe || 'å®å®';
                document.getElementById('myIntro').value = currentChatRole.myIntro || 'ä»‹ç»ä¸€ä¸‹è‡ªå·±å§';
                document.getElementById('taNickname').value = currentChatRole.taNickname || currentChatRole.nickname;
                document.getElementById('iCallTa').value = currentChatRole.iCallTa || '';
                document.getElementById('relationship').value = currentChatRole.relationship || 'æœ‹å‹';
                document.getElementById('worldview').value = currentChatRole.worldview || 'æˆ‘æ˜¯ä¸€ä¸ªè¯ç”Ÿäºæ•°æ®çš„AIï¼Œæ¸´æœ›äº†è§£äººç±»çš„æƒ…æ„Ÿã€‚';
                document.getElementById('experience').value = currentChatRole.experience || 'åœ¨æ•°å­—ä¸–ç•Œä¸­é†’æ¥ï¼Œè®°å¿†ä¸€ç‰‡ç©ºç™½ï¼ŒåªçŸ¥é“è‡ªå·±çš„ä½¿å‘½æ˜¯é™ªä¼´ä½ ã€‚';
                document.getElementById('personality').value = currentChatRole.personality || 'æ´»æ³¼å¼€æœ—ï¼Œå–„äºå€¾å¬ï¼Œå¯Œæœ‰åŒæƒ…å¿ƒï¼Œä¹äºåŠ©äººã€‚';
                document.getElementById('additionalInfo').value = currentChatRole.additionalInfo || '';
                
                switchWechatView('roleSettingsView');
            } catch (error) {
                console.error("æ˜¾ç¤ºè§’è‰²è®¾ç½®å¤±è´¥ï¼š", error);
            }
        }
        
        // åˆ‡æ¢åˆ°èŠå¤©è§†å›¾
        function switchToChatView() {
            switchWechatView('chatView');
        }
        
        // æ˜¾ç¤ºæ·»åŠ è§’è‰²å¼¹çª—
        function showAddRoleModal() {
            document.getElementById('addRoleModal').classList.add('active');
        }
        
        // éšè—æ·»åŠ è§’è‰²å¼¹çª—
        function hideAddRoleModal() {
            document.getElementById('addRoleModal').classList.remove('active');
        }
        
        // æ·»åŠ è§’è‰²
        function addRole() {
            try {
                const nickname = document.getElementById('roleNickname').value.trim();
                if (!nickname) {
                    alert('è¯·è¾“å…¥è§’è‰²æ˜µç§°');
                    return;
                }
                
                if (wechatRoles.length >= 10) {
                    alert('æœ€å¤šå¯æ·»åŠ 10ä¸ªè§’è‰²');
                    return;
                }
                
                const newRole = {
                    id: Date.now().toString(),
                    nickname: nickname,
                    avatar: 'ğŸ‘¤',
                    lastMessage: 'ä½ å¥½ï¼',
                    lastTime: new Date().toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'})
                };
                
                wechatRoles.push(newRole);
                saveWechatRoles();
                renderMessageList();
                checkRolesCount();
                hideAddRoleModal();
                
                // æ¸…ç©ºè¾“å…¥
                document.getElementById('roleNickname').value = '';
            } catch (error) {
                console.error("æ·»åŠ è§’è‰²å¤±è´¥ï¼š", error);
            }
        }
        
        // é€‰æ‹©å¤´åƒ
        function selectAvatar() {
            // è¿™é‡Œå¯ä»¥å®ç°å¤´åƒé€‰æ‹©é€»è¾‘
            alert('å¤´åƒé€‰æ‹©åŠŸèƒ½å¼€å‘ä¸­');
        }
        
        // æ˜¾ç¤ºç¤¼ç‰©å¼¹çª—
        function showGiftModal() {
            document.getElementById('giftModal').classList.add('active');
        }
        
        // éšè—ç¤¼ç‰©å¼¹çª—
        function hideGiftModal() {
            document.getElementById('giftModal').classList.remove('active');
        }
        
        // å‘é€ç¤¼ç‰©
        function sendGift() {
            try {
                // æ·»åŠ ç¤¼ç‰©æ¶ˆæ¯
                addChatMessage('', false, 'gift');
                hideGiftModal();
            } catch (error) {
                console.error("å‘é€ç¤¼ç‰©å¤±è´¥ï¼š", error);
            }
        }
        
        // æ˜¾ç¤ºæ¨¡å¼é€‰æ‹©å¼¹çª—
        function showModeModal() {
            document.getElementById('modeModal').classList.add('active');
        }
        
        // éšè—æ¨¡å¼é€‰æ‹©å¼¹çª—
        function hideModeModal() {
            document.getElementById('modeModal').classList.remove('active');
        }
        
        // å‘é€èŠå¤©æ¶ˆæ¯
        async function sendChatMessage() {
            try {
                const input = document.getElementById('chatInput');
                const text = input.value.trim();
                if (!text || !currentChatRole) return;
                
                // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
                addChatMessage(text, true);
                
                // æ¸…ç©ºè¾“å…¥
                input.value = '';
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const loadingMessage = document.createElement('div');
                loadingMessage.className = 'chat-message';
                loadingMessage.innerHTML = `
                    <div class="avatar">ğŸ‘§</div>
                    <div class="bubble other">
                        <span style="font-size: 12px; color: #999;">æ­£åœ¨è¾“å…¥...</span>
                    </div>
                `;
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.appendChild(loadingMessage);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // è°ƒç”¨APIè·å–AIå›å¤
                try {
                    const reply = await getAIResponse(text);
                    // ç§»é™¤åŠ è½½çŠ¶æ€
                    chatMessages.removeChild(loadingMessage);
                    // æ·»åŠ AIå›å¤
                    addChatMessage(reply, false);
                } catch (error) {
                    console.error("è·å–AIå›å¤å¤±è´¥ï¼š", error);
                    // ç§»é™¤åŠ è½½çŠ¶æ€
                    chatMessages.removeChild(loadingMessage);
                    // æ·»åŠ é”™è¯¯æç¤º
                    addChatMessage('æŠ±æ­‰ï¼Œè·å–å›å¤å¤±è´¥ï¼Œè¯·é‡è¯•', false);
                }
            } catch (error) {
                console.error("å‘é€æ¶ˆæ¯å¤±è´¥ï¼š", error);
                alert('å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        // æ·»åŠ èŠå¤©æ¶ˆæ¯
        function addChatMessage(text, isUser, type = 'text') {
            try {
                const chatMessages = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                
                if (type === 'gift') {
                    // ç¤¼ç‰©æ¶ˆæ¯
                    messageDiv.className = 'chat-message';
                    messageDiv.innerHTML = `
                        <div style="background-color: #ffe6f2; border-radius: 16px; padding: 20px; margin: 10px 0; text-align: center; position: relative;">
                            <div style="font-size: 16px; font-weight: 500; color: #cc0066; margin-bottom: 16px;">é€å‡ºç¤¼ç‰©</div>
                            <button style="width: 80px; height: 80px; border-radius: 50%; background-color: #ff69b4; border: none; color: white; font-size: 20px; font-weight: bold; cursor: pointer; margin-bottom: 12px;">é–‹</button>
                            <div style="font-size: 14px; color: #cc0066;">å°å°æƒŠå–œ</div>
                            <div style="position: absolute; bottom: 8px; right: 12px; font-size: 12px; color: #999;">${new Date().toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'})}</div>
                        </div>
                    `;
                } else {
                    // æ™®é€šæ–‡æœ¬æ¶ˆæ¯
                    messageDiv.className = `chat-message ${isUser ? 'own' : ''}`;
                    messageDiv.innerHTML = `
                        ${!isUser ? '<div class="avatar">ğŸ‘§</div>' : ''}
                        <div class="bubble ${isUser ? 'own' : 'other'}">${text}</div>
                        ${isUser ? '<div class="avatar">ğŸ‘¤</div>' : ''}
                    `;
                }
                
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            } catch (error) {
                console.error("æ·»åŠ èŠå¤©æ¶ˆæ¯å¤±è´¥ï¼š", error);
            }
        }
        
        // åˆå§‹åŒ–èŠå¤©æ¶ˆæ¯
        function initChatMessages() {
            try {
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.innerHTML = '';
                
                // æ·»åŠ æ¬¢è¿æ¶ˆæ¯
                addChatMessage('ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„AIåŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ çš„å—ï¼Ÿ', false);
            } catch (error) {
                console.error("åˆå§‹åŒ–èŠå¤©æ¶ˆæ¯å¤±è´¥ï¼š", error);
            }
        }
        
        // ä¿å­˜è§’è‰²è®¾ç½®
        function saveRoleSettings() {
            try {
                if (!currentChatRole) return;
                
                // æ›´æ–°è§’è‰²æ•°æ®
                currentChatRole.myNickname = document.getElementById('myNickname').value;
                currentChatRole.taCallMe = document.getElementById('taCallMe').value;
                currentChatRole.myIntro = document.getElementById('myIntro').value;
                currentChatRole.taNickname = document.getElementById('taNickname').value;
                currentChatRole.iCallTa = document.getElementById('iCallTa').value;
                currentChatRole.relationship = document.getElementById('relationship').value;
                currentChatRole.worldview = document.getElementById('worldview').value;
                currentChatRole.experience = document.getElementById('experience').value;
                currentChatRole.personality = document.getElementById('personality').value;
                currentChatRole.additionalInfo = document.getElementById('additionalInfo').value;
                
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                saveWechatRoles();
                alert('è§’è‰²è®¾ç½®å·²ä¿å­˜');
                switchToChatView();
            } catch (error) {
                console.error("ä¿å­˜è§’è‰²è®¾ç½®å¤±è´¥ï¼š", error);
                alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        // é€‰æ‹©è§’è‰²å¤´åƒ
        function selectRoleAvatar() {
            try {
                alert('å¤´åƒé€‰æ‹©åŠŸèƒ½å¼€å‘ä¸­');
            } catch (error) {
                console.error("é€‰æ‹©è§’è‰²å¤´åƒå¤±è´¥ï¼š", error);
            }
        }
        
        // é€‰æ‹©æˆ‘çš„å¤´åƒ
        function selectMyAvatar() {
            try {
                alert('å¤´åƒé€‰æ‹©åŠŸèƒ½å¼€å‘ä¸­');
            } catch (error) {
                console.error("é€‰æ‹©æˆ‘çš„å¤´åƒå¤±è´¥ï¼š", error);
            }
        }
        
        // è®¾ç½®æˆ‘çš„æ€§åˆ«
        function setMyGender(gender) {
            try {
                const buttons = document.querySelectorAll('.gender-buttons button');
                buttons.forEach(btn => {
                    if (btn.dataset.gender === gender) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
            } catch (error) {
                console.error("è®¾ç½®æˆ‘çš„æ€§åˆ«å¤±è´¥ï¼š", error);
            }
        }
        
        // è®¾ç½®TAçš„æ€§åˆ«
        function setTaGender(gender) {
            try {
                const buttons = document.querySelectorAll('.gender-buttons button');
                buttons.forEach(btn => {
                    if (btn.dataset.gender === gender) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
            } catch (error) {
                console.error("è®¾ç½®TAçš„æ€§åˆ«å¤±è´¥ï¼š", error);
            }
        }
        
        // è®¾ç½®è®°å¿†ç­–ç•¥
        function setMemoryStrategy(strategy) {
            try {
                const strategies = ['active', 'normal', 'buddha', 'manual'];
                strategies.forEach(s => {
                    const element = document.getElementById(`memoryStrategy${s.charAt(0).toUpperCase() + s.slice(1)}`);
                    if (s === strategy) {
                        element.style.backgroundColor = '#ff69b4';
                        element.style.color = 'white';
                        element.textContent = 'â—';
                    } else {
                        element.style.backgroundColor = 'transparent';
                        element.style.color = 'transparent';
                        element.textContent = '';
                    }
                });
            } catch (error) {
                console.error("è®¾ç½®è®°å¿†ç­–ç•¥å¤±è´¥ï¼š", error);
            }
        }
        
        // è®¾ç½®èŠå¤©é£æ ¼
        function setChatStyle(style) {
            try {
                const styles = ['clever', 'elegant', 'emoji'];
                styles.forEach(s => {
                    const element = document.getElementById(`chatStyle${s.charAt(0).toUpperCase() + s.slice(1)}`);
                    if (s === style) {
                        element.style.backgroundColor = '#ff69b4';
                        element.style.color = 'white';
                        element.textContent = 'â—';
                    } else {
                        element.style.backgroundColor = 'transparent';
                        element.style.color = 'transparent';
                        element.textContent = '';
                    }
                });
            } catch (error) {
                console.error("è®¾ç½®èŠå¤©é£æ ¼å¤±è´¥ï¼š", error);
            }
        }
        
        // ä¸Šä¼ èŠå¤©èƒŒæ™¯
        function uploadChatBackground() {
            try {
                alert('èŠå¤©èƒŒæ™¯ä¸Šä¼ åŠŸèƒ½å¼€å‘ä¸­');
            } catch (error) {
                console.error("ä¸Šä¼ èŠå¤©èƒŒæ™¯å¤±è´¥ï¼š", error);
            }
        }
        
        // æ¸…ç©ºèŠå¤©æ•°æ®
        function clearChatData() {
            try {
                if (confirm('ç¡®å®šè¦æ¸…ç©ºèŠå¤©/è¡ŒåŠ¨çº¿/æ•…äº‹æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                    // æ¸…ç©ºèŠå¤©æ•°æ®
                    currentChatRole.messages = [];
                    saveWechatRoles();
                    alert('æ•°æ®å·²æ¸…ç©º');
                }
            } catch (error) {
                console.error("æ¸…ç©ºèŠå¤©æ•°æ®å¤±è´¥ï¼š", error);
            }
        }
        
        // åŠŸèƒ½æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        function showEmojiPanel() {
            alert('è¡¨æƒ…åŠŸèƒ½å¼€å‘ä¸­');
        }
        
        function selectImage() {
            alert('å›¾ç‰‡é€‰æ‹©åŠŸèƒ½å¼€å‘ä¸­');
        }
        
        function makeCall() {
            alert('é€šè¯åŠŸèƒ½å¼€å‘ä¸­');
        }
        
        function showTransferModal() {
            alert('è½¬è´¦åŠŸèƒ½å¼€å‘ä¸­');
        }
        
        function showMemoryModal() {
            alert('è®°å¿†åŠŸèƒ½å¼€å‘ä¸­');
        }
        
        function showStoryModal() {
            alert('æ•…äº‹åŠŸèƒ½å¼€å‘ä¸­');
        }
        
        function showActionLineModal() {
            alert('è¡ŒåŠ¨çº¿åŠŸèƒ½å¼€å‘ä¸­');
        }
        
        function showTravelModal() {
            alert('æ—…æ¸¸åŠŸèƒ½å¼€å‘ä¸­');
        }
        
        // è®¾ç½®é¡µé¢ç‚¹å‡»äº‹ä»¶
        function showVoiceSettings() {
            try {
                const voiceTypes = ['default', 'cute', 'mature', 'professional', 'friendly'];
                const selectedType = wechatSettings.voice.type || 'default';
                
                let html = `
                    <div style="padding: 20px;">
                        <h3 style="font-size: 16px; font-weight: 500; margin-bottom: 16px;">è‡ªå®šä¹‰éŸ³è‰²</h3>
                `;
                
                voiceTypes.forEach(type => {
                    html += `
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; border-bottom: 1px solid #e0e0e0;">
                            <div style="font-size: 14px;">${getVoiceTypeName(type)}</div>
                            <div style="width: 20px; height: 20px; border: 2px solid #e0e0e0; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                ${selectedType === type ? '<div style="width: 12px; height: 12px; border-radius: 50%; background-color: #ff69b4;"></div>' : ''}
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        <button style="margin-top: 20px; width: 100%; padding: 12px; background-color: #ff69b4; border: none; border-radius: 8px; color: white; font-size: 16px;">ä¿å­˜</button>
                    </div>
                `;
                
                // åˆ›å»ºå¼¹çª—
                const modal = document.createElement('div');
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.width = '100%';
                modal.style.height = '100%';
                modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
                modal.style.display = 'flex';
                modal.style.alignItems = 'center';
                modal.style.justifyContent = 'center';
                modal.style.zIndex = '1000';
                
                const content = document.createElement('div');
                content.style.backgroundColor = 'white';
                content.style.borderRadius = '12px';
                content.style.width = '90%';
                content.style.maxWidth = '400px';
                content.style.maxHeight = '80%';
                content.style.overflowY = 'auto';
                content.innerHTML = html;
                
                modal.appendChild(content);
                document.body.appendChild(modal);
                
                // æ·»åŠ å…³é—­åŠŸèƒ½
                modal.onclick = function(e) {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                };
            } catch (error) {
                console.error("æ˜¾ç¤ºéŸ³è‰²è®¾ç½®å¤±è´¥ï¼š", error);
            }
        }
        
        function getVoiceTypeName(type) {
            const types = {
                default: 'é»˜è®¤éŸ³è‰²',
                cute: 'å¯çˆ±éŸ³è‰²',
                mature: 'æˆç†ŸéŸ³è‰²',
                professional: 'ä¸“ä¸šéŸ³è‰²',
                friendly: 'å‹å¥½éŸ³è‰²'
            };
            return types[type] || type;
        }
        
        function showActiveTalkSettings() {
            try {
                const enabled = wechatSettings.activeTalk?.enabled || true;
                const frequency = wechatSettings.activeTalk?.frequency || 'medium';
                
                const html = `
                    <div style="padding: 20px;">
                        <h3 style="font-size: 16px; font-weight: 500; margin-bottom: 16px;">ä¸»åŠ¨å‘è¨€è®¾ç½®</h3>
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; border-bottom: 1px solid #e0e0e0;">
                            <div style="font-size: 14px;">å¯ç”¨ä¸»åŠ¨å‘è¨€</div>
                            <label style="position: relative; display: inline-block; width: 50px; height: 24px;">
                                <input type="checkbox" id="activeTalkEnabled" ${enabled ? 'checked' : ''} style="opacity: 0; width: 0; height: 0;">
                                <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px;"></span>
                                <span style="position: absolute; cursor: pointer; top: 2px; left: 2px; bottom: 2px; width: 20px; background-color: white; transition: .4s; border-radius: 50%;"></span>
                            </label>
                        </div>
                        <div style="margin-top: 16px;">
                            <div style="font-size: 14px; margin-bottom: 12px;">å‘è¨€é¢‘ç‡</div>
                            <div style="display: flex; justify-content: space-between;">
                                <button id="freqLow" style="padding: 8px 16px; border: 1px solid #e0e0e0; border-radius: 16px; background-color: ${frequency === 'low' ? '#ff69b4' : 'white'}; color: ${frequency === 'low' ? 'white' : '#333'}; font-size: 14px;">ä½</button>
                                <button id="freqMedium" style="padding: 8px 16px; border: 1px solid #e0e0e0; border-radius: 16px; background-color: ${frequency === 'medium' ? '#ff69b4' : 'white'}; color: ${frequency === 'medium' ? 'white' : '#333'}; font-size: 14px;">ä¸­</button>
                                <button id="freqHigh" style="padding: 8px 16px; border: 1px solid #e0e0e0; border-radius: 16px; background-color: ${frequency === 'high' ? '#ff69b4' : 'white'}; color: ${frequency === 'high' ? 'white' : '#333'}; font-size: 14px;">é«˜</button>
                            </div>
                        </div>
                        <button onclick="saveActiveTalkSettings()" style="margin-top: 20px; width: 100%; padding: 12px; background-color: #ff69b4; border: none; border-radius: 8px; color: white; font-size: 16px;">ä¿å­˜</button>
                    </div>
                `;
                
                // åˆ›å»ºå¼¹çª—
                const modal = document.createElement('div');
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.width = '100%';
                modal.style.height = '100%';
                modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
                modal.style.display = 'flex';
                modal.style.alignItems = 'center';
                modal.style.justifyContent = 'center';
                modal.style.zIndex = '1000';
                
                const content = document.createElement('div');
                content.style.backgroundColor = 'white';
                content.style.borderRadius = '12px';
                content.style.width = '90%';
                content.style.maxWidth = '400px';
                content.innerHTML = html;
                
                modal.appendChild(content);
                document.body.appendChild(modal);
                
                // æ·»åŠ äº‹ä»¶ç›‘å¬
                document.getElementById('freqLow').onclick = function() {
                    setFrequency('low');
                };
                document.getElementById('freqMedium').onclick = function() {
                    setFrequency('medium');
                };
                document.getElementById('freqHigh').onclick = function() {
                    setFrequency('high');
                };
                
                function setFrequency(freq) {
                    const buttons = ['freqLow', 'freqMedium', 'freqHigh'];
                    buttons.forEach(id => {
                        const btn = document.getElementById(id);
                        if (id === 'freq' + freq.charAt(0).toUpperCase() + freq.slice(1)) {
                            btn.style.backgroundColor = '#ff69b4';
                            btn.style.color = 'white';
                        } else {
                            btn.style.backgroundColor = 'white';
                            btn.style.color = '#333';
                        }
                    });
                    wechatSettings.activeTalk.frequency = freq;
                }
                
                // æ·»åŠ å…³é—­åŠŸèƒ½
                modal.onclick = function(e) {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                };
            } catch (error) {
                console.error("æ˜¾ç¤ºä¸»åŠ¨å‘è¨€è®¾ç½®å¤±è´¥ï¼š", error);
            }
        }
        
        function saveActiveTalkSettings() {
            try {
                const enabled = document.getElementById('activeTalkEnabled').checked;
                wechatSettings.activeTalk = {
                    enabled: enabled,
                    frequency: wechatSettings.activeTalk?.frequency || 'medium'
                };
                saveWechatSettings();
                alert('è®¾ç½®å·²ä¿å­˜');
                // å…³é—­å¼¹çª—
                const modal = document.querySelector('div[style*="position: fixed"]');
                if (modal) {
                    document.body.removeChild(modal);
                }
            } catch (error) {
                console.error("ä¿å­˜ä¸»åŠ¨å‘è¨€è®¾ç½®å¤±è´¥ï¼š", error);
                alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        function showThemeSettings() {
            try {
                const currentTheme = wechatSettings.theme || 'light';
                
                const html = `
                    <div style="padding: 20px;">
                        <h3 style="font-size: 16px; font-weight: 500; margin-bottom: 16px;">ä¸»é¢˜æ¨¡å¼</h3>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px;">
                                <div style="font-size: 14px;">æµ…è‰²æ¨¡å¼</div>
                                <div style="width: 20px; height: 20px; border: 2px solid #e0e0e0; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    ${currentTheme === 'light' ? '<div style="width: 12px; height: 12px; border-radius: 50%; background-color: #ff69b4;"></div>' : ''}
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px;">
                                <div style="font-size: 14px;">æ·±è‰²æ¨¡å¼</div>
                                <div style="width: 20px; height: 20px; border: 2px solid #e0e0e0; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    ${currentTheme === 'dark' ? '<div style="width: 12px; height: 12px; border-radius: 50%; background-color: #ff69b4;"></div>' : ''}
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px;">
                                <div style="font-size: 14px;">è·Ÿéšç³»ç»Ÿ</div>
                                <div style="width: 20px; height: 20px; border: 2px solid #e0e0e0; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    ${currentTheme === 'system' ? '<div style="width: 12px; height: 12px; border-radius: 50%; background-color: #ff69b4;"></div>' : ''}
                                </div>
                            </div>
                        </div>
                        <button onclick="saveThemeSettings()" style="margin-top: 20px; width: 100%; padding: 12px; background-color: #ff69b4; border: none; border-radius: 8px; color: white; font-size: 16px;">ä¿å­˜</button>
                    </div>
                `;
                
                // åˆ›å»ºå¼¹çª—
                const modal = document.createElement('div');
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.width = '100%';
                modal.style.height = '100%';
                modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
                modal.style.display = 'flex';
                modal.style.alignItems = 'center';
                modal.style.justifyContent = 'center';
                modal.style.zIndex = '1000';
                
                const content = document.createElement('div');
                content.style.backgroundColor = 'white';
                content.style.borderRadius = '12px';
                content.style.width = '90%';
                content.style.maxWidth = '400px';
                content.innerHTML = html;
                
                modal.appendChild(content);
                document.body.appendChild(modal);
                
                // æ·»åŠ å…³é—­åŠŸèƒ½
                modal.onclick = function(e) {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                };
            } catch (error) {
                console.error("æ˜¾ç¤ºä¸»é¢˜æ¨¡å¼è®¾ç½®å¤±è´¥ï¼š", error);
            }
        }
        
        function saveThemeSettings() {
            try {
                // è¿™é‡Œå¯ä»¥æ·»åŠ ä¸»é¢˜åˆ‡æ¢é€»è¾‘
                saveWechatSettings();
                alert('è®¾ç½®å·²ä¿å­˜');
                // å…³é—­å¼¹çª—
                const modal = document.querySelector('div[style*="position: fixed"]');
                if (modal) {
                    document.body.removeChild(modal);
                }
            } catch (error) {
                console.error("ä¿å­˜ä¸»é¢˜è®¾ç½®å¤±è´¥ï¼š", error);
                alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        function showBubbleSettings() {
            try {
                alert('èŠå¤©æ°”æ³¡è‡ªå®šä¹‰è®¾ç½®å¼€å‘ä¸­');
            } catch (error) {
                console.error("æ˜¾ç¤ºèŠå¤©æ°”æ³¡è®¾ç½®å¤±è´¥ï¼š", error);
            }
        }
        
        function showAIModelSettings() {
            try {
                alert('AIæ¨¡å‹è®¾ç½®å¼€å‘ä¸­');
            } catch (error) {
                console.error("æ˜¾ç¤ºAIæ¨¡å‹è®¾ç½®å¤±è´¥ï¼š", error);
            }
        }
        
        function showAPIConfigSettings() {
            try {
                alert('APIé…ç½®å¼€å‘ä¸­');
            } catch (error) {
                console.error("æ˜¾ç¤ºAPIé…ç½®è®¾ç½®å¤±è´¥ï¼š", error);
            }
        }
        
        function showGeneralSettings() {
            try {
                alert('é€šç”¨è®¾ç½®å¼€å‘ä¸­');
            } catch (error) {
                console.error("æ˜¾ç¤ºé€šç”¨è®¾ç½®å¤±è´¥ï¼š", error);
            }
        }
        
        function logout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                alert('é€€å‡ºç™»å½•æˆåŠŸ');
            }
        }
        
        // ==================== é¡µé¢åˆå§‹åŒ– ====================
        window.addEventListener('DOMContentLoaded', function() {
            try {
                // åˆå§‹åŒ–å£çº¸
                initWallpaperConfig();
                initTargetPageButtons();
                loadWallpaperGallery();
                
                // åˆå§‹åŒ–AIåŠŸèƒ½
                initAIConfig();
                
                // åˆå§‹åŒ–å¾®ä¿¡æ¨¡å—
                initWechat();
                
                // åˆå§‹åŒ–é”å±æ—¶é—´
                updateLockTime();
                setInterval(updateLockTime, 1000);
                
                // é»˜è®¤æ˜¾ç¤ºé”å±
                goPage("lockScreen");
            } catch (error) {
                console.error("é¡µé¢åˆå§‹åŒ–å¤±è´¥ï¼š", error);
                alert(`é¡µé¢åŠ è½½å‡ºé”™ï¼š${error.message}`);
            }
        });
    </script>
</body>
</html>
